{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-sitemap mr-2"></i> Organization Chart
            </h1>
            <p class="text-slate-600 text-sm">Hierarchical tree with connectors, pan & zoom, expand/collapse.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="editModeBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-edit mr-1"></i> Edit Structure
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Controls -->
    <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">View:</label>
                <select id="viewType" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="flow" selected>Hierarchy</option>
                    <option value="departments">Department View</option>
                    <option value="list">List View</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Filter:</label>
                <select id="departmentFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All Departments</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button id="expandAllBtn"
                    class="px-3 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Expand All
                </button>
                <button id="collapseAllBtn"
                    class="px-3 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-minus mr-1"></i> Collapse All
                </button>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-users mr-1"></i> Total Employees</div>
            <div id="totalEmployees" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-crown mr-1"></i> Leadership</div>
            <div id="leadershipCount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-building mr-1"></i> Departments</div>
            <div id="departmentCount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-line mr-1"></i> Avg Team Size</div>
            <div id="avgTeamSize" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Main -->
    <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div id="loadingState" class="text-center py-12">
            <i class="fa-solid fa-spinner fa-spin text-slate-400 text-3xl mb-4"></i>
            <p class="text-slate-600">Loading organizational structure...</p>
        </div>

        <!-- HIERARCHY VIEW -->
        <div id="flowView" class="hidden">
            <div id="flowWrapper" class="relative h-[72vh]">
                <div id="pzContainer" class="absolute inset-0 overflow-hidden bg-slate-50">
                    <svg id="flowSvg" width="2400" height="1400" class="block">
                        <defs>
                            <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6"
                                orient="auto-start-reverse">
                                <path d="M 0 0 L 10 5 L 0 10 z" fill="#cbd5e1"></path>
                            </marker>
                            <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#0f172a"
                                    flood-opacity="0.12" />
                            </filter>
                        </defs>
                        <g id="pzContent" transform="translate(80,80) scale(1)">
                            <g id="edges"></g>
                            <g id="nodes"></g>
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <!-- DEPARTMENT VIEW -->
        <div id="departmentView" class="hidden p-6">
            <div id="departmentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- LIST VIEW -->
        <div id="listView" class="hidden p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Employee</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Position</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Reports To</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Direct Reports
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="listTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">Edit Reporting Structure</h3>
                    <button id="closeModalBtn" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <form id="editForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Employee</label>
                            <select id="employeeSelect"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Reports To</label>
                            <select id="managerSelect" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">No Manager (Top Level)</option>
                            </select>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" id="cancelBtn"
                                class="px-4 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50">Cancel</button>
                            <button type="submit"
                                class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-900">Save
                                Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .node-circle {
        filter: url(#softShadow);
    }

    .node-name {
        font-weight: 600;
        fill: #0f172a;
    }

    .node-role {
        font-size: 12px;
        fill: #475569;
    }

    .node-dept {
        font-size: 11px;
        fill: #64748b;
    }

    .handle {
        cursor: pointer;
    }
</style>

<script>
    /* ======= Globals ======= */
    let orgData = [];   // roots (kept for list/dept views)
    let allUsers = [];
    let editMode = false;
    let expandedSet = new Set();

    /* Rank order: HIGH â†’ LOW */
    const RANKS = [
        'CXOs',
        'Leaders',
        'HR',
        'Employees',
        'Contractors / Remote staff'
    ];

    /* ======= Utils ======= */
    async function fetchJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
    async function postJSON(url, data) { const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
    function getInitials(name) { return (name || '').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase(); }

    const PALETTE = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6', '#84cc16', '#f97316', '#06b6d4'];
    function colorForKey(k) { if (!k) return '#3b82f6'; const i = Math.abs(hashCode(String(k))) % PALETTE.length; return PALETTE[i]; }
    function hashCode(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; } return h; }

    /* ======= Data ======= */
    async function loadOrgData() {
        try { allUsers = await fetchJSON('/api/org/structure'); }
        catch (e) {
            // Fallback
            allUsers = [
                { id: 1, name: 'Aarav Patel', email: 'aarav@acme.com', employee_type: 'CXOs', subposition: 'Executive', designation: 'CEO' },
                { id: 2, name: 'Meera Iyer', email: 'meera@acme.com', employee_type: 'Leaders', subposition: 'Engineering', designation: 'VP Engineering', manager_id: 1 },
                { id: 3, name: 'Rahul Das', email: 'rahul@acme.com', employee_type: 'Leaders', subposition: 'Sales', designation: 'VP Sales', manager_id: 1 },
                { id: 4, name: 'Sara Khan', email: 'sara@acme.com', employee_type: 'HR', subposition: 'HR', designation: 'Head of HR', manager_id: 1 },
                { id: 5, name: 'Charan', email: 'charan@acme.com', employee_type: 'Employees', subposition: 'Engineering', designation: 'Full-stack Dev', manager_id: 2 },
                { id: 6, name: 'Anil', email: 'anil@acme.com', employee_type: 'Employees', subposition: 'Engineering', designation: 'Backend Dev', manager_id: 2 },
                { id: 7, name: 'Priya', email: 'priya@acme.com', employee_type: 'Employees', subposition: 'Sales', designation: 'AE', manager_id: 3 },
                { id: 8, name: 'Elena', email: 'elena@acme.com', employee_type: 'Employees', subposition: 'HR', designation: 'HRBP', manager_id: 4 }
            ];
        }
        processOrgStructure();
        updateStatistics();
        populateFilters();
    }

    /* Keep tree for list/dept views */
    function processOrgStructure() {
        const map = {}; allUsers.forEach(u => map[u.id] = { ...u, children: [] });
        const roots = []; allUsers.forEach(u => {
            if (u.manager_id && map[u.manager_id]) map[u.manager_id].children.push(map[u.id]);
            else roots.push(map[u.id]);
        });
        orgData = roots;
        expandedSet = new Set(allUsers.map(u => u.id)); // default expanded
    }

    /* ======= UI helpers ======= */
    function populateFilters() {
        const sel = document.getElementById('departmentFilter');
        const depts = [...new Set(allUsers.map(u => u.subposition).filter(Boolean))].sort();
        sel.innerHTML = '<option value="">All Departments</option>';
        depts.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o); });
    }
    function updateStatistics() {
        document.getElementById('totalEmployees').textContent = allUsers.length;
        const leadership = allUsers.filter(u => ['Leaders', 'CXOs', 'HR'].includes(u.employee_type || '')).length;
        document.getElementById('leadershipCount').textContent = leadership;
        const departments = new Set(allUsers.map(u => u.subposition).filter(Boolean));
        document.getElementById('departmentCount').textContent = departments.size;
        const mgrs = new Set(allUsers.filter(u => allUsers.some(v => v.manager_id === u.id)).map(u => u.id));
        const rootsCount = allUsers.filter(u => !u.manager_id).length;
        document.getElementById('avgTeamSize').textContent = mgrs.size ? Math.round((allUsers.length - rootsCount) / mgrs.size + 1) : 0;
    }

    /* ======= Views switch ======= */
    function renderCurrentView() {
        const v = document.getElementById('viewType').value;
        document.getElementById('flowView').classList.toggle('hidden', v !== 'flow');
        document.getElementById('departmentView').classList.toggle('hidden', v !== 'departments');
        document.getElementById('listView').classList.toggle('hidden', v !== 'list');
        if (v === 'flow') renderFlowView();
        if (v === 'departments') renderDepartmentView();
        if (v === 'list') renderListView();
    }

    /* ======= RANKED HIERARCHY VIEW (HIGH â†’ LOW) ======= */
    function renderFlowView() {
        const gEdges = document.getElementById('edges');
        const gNodes = document.getElementById('nodes');
        gEdges.innerHTML = ''; gNodes.innerHTML = '';

        const deptFilter = document.getElementById('departmentFilter').value;
        const filteredUsers = deptFilter
            ? allUsers.filter(u => (u.subposition || '') === deptFilter)
            : allUsers.slice();

        // Build groups by rank in required order
        const groups = RANKS.map(rank => ({
            id: `grp_${rank}`,
            name: rank,
            employee_type: rank,
            designation: rank,
            isGroup: true,
            children: filteredUsers.filter(u => (u.employee_type || '') === rank).map(u => ({ ...u, children: [] }))
        })).filter(g => g.children.length > 0);

        if (groups.length === 0) return;

        // Link groups top->down
        for (let i = 0; i < groups.length - 1; i++) {
            groups[i].children.push(groups[i + 1]); // chain group nodes so connectors show HIGHâ†’LOW
        }

        // layout params
        const nodeR = 28, hGap = 70, vGap = 140, labelDy = 14;

        // Tidy-like layout: group node centered above its members; chain goes downward.
        let nextX = 0;
        function assignLayout(node, depth) {
            node.depth = depth;
            const kids = node.children || [];
            if (kids.length === 0) {
                node.x = nextX;
                nextX += (nodeR * 2) + hGap;
            } else {
                kids.forEach(c => assignLayout(c, depth + 1));
                const memberKids = kids.filter(c => !c.isGroup); // only real people define width
                const span = memberKids.length ? memberKids : kids; // fall back to group-to-group chain
                const minX = Math.min(...span.map(c => c.x));
                const maxX = Math.max(...span.map(c => c.x));
                node.x = (minX + maxX) / 2;
            }
            node.y = depth * vGap;
        }
        assignLayout(groups[0], 0); // root is highest rank group

        // collect for centering
        const all = [];
        (function collect(n) { all.push(n); (n.children || []).forEach(collect); })(groups[0]);
        const minX = Math.min(...all.map(n => n.x));
        const offsetX = -minX + 40, offsetY = 0;

        function drawEdge(p, c) {
            const startX = p.x + offsetX, startY = p.y + offsetY + nodeR;
            const endX = c.x + offsetX, endY = c.y + offsetY - nodeR;
            const midY = (startY + endY) / 2;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}`;
            path.setAttribute('d', d);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', '#d1d5db');
            path.setAttribute('stroke-width', '2');
            gEdges.appendChild(path);
        }

        function renderNode(node) {
            const cx = node.x + offsetX, cy = node.y + offsetY;

            // edges
            (node.children || []).forEach(ch => drawEdge(node, ch));

            // group (rank) nodes are bigger circles + label; members are standard
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${cx},${cy})`);
            gNodes.appendChild(g);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('r', node.isGroup ? nodeR + 6 : nodeR);
            circle.setAttribute('class', 'node-circle');
            circle.setAttribute('fill', colorForKey(node.employee_type || node.subposition || ''));
            circle.setAttribute('stroke', '#ffffff'); circle.setAttribute('stroke-width', '3');
            g.appendChild(circle);

            const initials = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            initials.setAttribute('text-anchor', 'middle');
            initials.setAttribute('dominant-baseline', 'central');
            initials.setAttribute('font-size', node.isGroup ? '12' : '14');
            initials.setAttribute('font-weight', '700');
            initials.setAttribute('fill', '#ffffff');
            initials.textContent = node.isGroup ? node.name.split(' ').map(w => w[0]).join('').slice(0, 3).toUpperCase()
                : getInitials(node.name || '');
            g.appendChild(initials);

            const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            name.setAttribute('y', (node.isGroup ? nodeR + 6 : nodeR) + labelDy);
            name.setAttribute('text-anchor', 'middle');
            name.setAttribute('class', 'node-name');
            name.setAttribute('font-size', '13');
            name.textContent = node.isGroup ? node.name : (node.name || '-');
            g.appendChild(name);

            const role = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            role.setAttribute('y', (node.isGroup ? nodeR + 6 : nodeR) + labelDy + 16);
            role.setAttribute('text-anchor', 'middle');
            role.setAttribute('class', 'node-role');
            role.textContent = node.isGroup ? 'Rank' : (node.designation || node.subposition || '');
            g.appendChild(role);

            if (!node.isGroup) {
                const dept = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                dept.setAttribute('y', nodeR + labelDy + 32);
                dept.setAttribute('text-anchor', 'middle');
                dept.setAttribute('class', 'node-dept');
                dept.textContent = node.email || '';
                g.appendChild(dept);
            }

            (node.children || []).forEach(renderNode);
        }

        renderNode(groups[0]);
    }

    /* ======= Department View ======= */
    function renderDepartmentView() {
        const container = document.getElementById('departmentGrid'); container.innerHTML = '';
        const groups = {}; allUsers.forEach(u => { const d = u.subposition || 'Unassigned'; (groups[d] || (groups[d] = [])).push(u); });
        Object.entries(groups).forEach(([dept, users]) => {
            const managers = users.filter(u => users.some(v => v.manager_id === u.id));
            const card = document.createElement('div');
            card.className = 'rounded-xl border border-slate-200 p-5 bg-white';
            card.innerHTML = `
      <div class="flex items-center mb-4">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mr-3" style="background:${colorForKey(dept)}20">
          <i class="fa-solid fa-building text-slate-700"></i>
        </div>
        <div>
          <h3 class="font-semibold text-slate-800">${dept}</h3>
          <p class="text-sm text-slate-600">${users.length} employee${users.length !== 1 ? 's' : ''}</p>
        </div>
      </div>
      <div class="text-sm space-y-1">
        <div class="flex justify-between"><span class="text-slate-600">Managers:</span><span class="font-medium">${managers.length}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">ICs:</span><span class="font-medium">${users.length - managers.length}</span></div>
      </div>`;
            container.appendChild(card);
        });
    }

    /* ======= List View ======= */
    function renderListView() {
        const tbody = document.getElementById('listTableBody'); tbody.innerHTML = '';
        allUsers.forEach(u => {
            const mgr = allUsers.find(x => x.id === u.manager_id);
            const drCount = allUsers.filter(x => x.manager_id === u.id).length;
            const tr = document.createElement('tr'); tr.className = 'hover:bg-slate-50';
            tr.innerHTML = `
      <td class="px-4 py-3">
        <div class="flex items-center">
          <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 text-xs text-white" style="background:${colorForKey(u.subposition)}">${getInitials(u.name)}</div>
          <div>
            <div class="font-medium text-slate-800">${u.name}</div>
            <div class="text-sm text-slate-500">${u.email || ''}</div>
          </div>
        </div>
      </td>
      <td class="px-4 py-3 text-sm text-slate-600">${u.designation || u.subposition || '-'}</td>
      <td class="px-4 py-3 text-sm text-slate-600">${u.subposition || '-'}</td>
      <td class="px-4 py-3 text-sm text-slate-600">${mgr ? mgr.name : 'None'}</td>
      <td class="px-4 py-3 text-sm text-slate-600">${drCount}</td>
      <td class="px-4 py-3"><button onclick="editEmployee(${u.id})" class="text-slate-600 hover:text-slate-800"><i class="fa-solid fa-edit"></i></button></td>`;
            tbody.appendChild(tr);
        });
    }

    /* ======= Edit helpers ======= */
    function editEmployee(userId) {
        const user = allUsers.find(u => u.id === userId); if (!user) return;
        const eSel = document.getElementById('employeeSelect'); eSel.innerHTML = '';
        allUsers.forEach(u => {
            const o = document.createElement('option');
            o.value = u.id; o.textContent = `${u.name} (${u.subposition || u.employee_type})`;
            if (u.id === userId) o.selected = true; eSel.appendChild(o);
        });
        const mSel = document.getElementById('managerSelect'); mSel.innerHTML = '<option value="">No Manager (Top Level)</option>';
        allUsers.forEach(u => {
            if (u.id !== userId) {
                const o = document.createElement('option');
                o.value = u.id; o.textContent = `${u.name} (${u.subposition || u.employee_type})`;
                if (u.id === user.manager_id) o.selected = true; mSel.appendChild(o);
            }
        });
        document.getElementById('editModal').classList.remove('hidden');
    }
    async function saveReportingChange() {
        const employee_id = document.getElementById('employeeSelect').value;
        const manager_id = document.getElementById('managerSelect').value || null;
        try {
            await postJSON('/api/org/update-reporting', { employee_id, manager_id });
            document.getElementById('editModal').classList.add('hidden');
            await loadOrgData(); renderCurrentView(); alert('Success: Reporting structure updated');
        } catch (e) { alert('Error: Failed to update reporting structure'); }
    }

    /* ======= Pan & Zoom (SVG) ======= */
    function setupPanZoom() {
        const svg = document.getElementById('flowSvg');
        const g = document.getElementById('pzContent');
        let scale = 1, min = 0.5, max = 2;
        let isPanning = false, start = { x: 0, y: 0 }, translate = { x: 80, y: 80 };
        function apply() { g.setAttribute('transform', `translate(${translate.x},${translate.y}) scale(${scale})`); }
        svg.addEventListener('wheel', (e) => { e.preventDefault(); const dir = e.deltaY > 0 ? -1 : 1; const ns = Math.min(max, Math.max(min, scale * (1 + dir * 0.1))); scale = ns; apply(); }, { passive: false });
        svg.addEventListener('mousedown', (e) => { isPanning = true; start.x = e.clientX; start.y = e.clientY; svg.style.cursor = 'grabbing'; });
        window.addEventListener('mousemove', (e) => { if (!isPanning) return; translate.x += (e.clientX - start.x); translate.y += (e.clientY - start.y); start.x = e.clientX; start.y = e.clientY; apply(); });
        window.addEventListener('mouseup', () => { isPanning = false; svg.style.cursor = 'default'; });
        apply();
    }

    /* ======= Events ======= */
    function setupEventListeners() {
        document.getElementById('viewType').addEventListener('change', renderCurrentView);
        document.getElementById('departmentFilter').addEventListener('change', renderCurrentView);

        document.getElementById('expandAllBtn').addEventListener('click', () => { expandedSet = new Set(allUsers.map(u => u.id)); renderFlowView(); });
        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            // collapse members under groups (chain remains)
            expandedSet = new Set(); renderFlowView();
        });

        document.getElementById('editModeBtn').addEventListener('click', () => {
            editMode = !editMode; const btn = document.getElementById('editModeBtn');
            if (editMode) { btn.innerHTML = '<i class="fa-solid fa-eye mr-1"></i> View Mode'; btn.classList.add('bg-slate-800', 'text-white'); }
            else { btn.innerHTML = '<i class="fa-solid fa-edit mr-1"></i> Edit Structure'; btn.classList.remove('bg-slate-800', 'text-white'); }
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => document.getElementById('editModal').classList.add('hidden'));
        document.getElementById('cancelBtn').addEventListener('click', () => document.getElementById('editModal').classList.add('hidden'));
        document.getElementById('editForm').addEventListener('submit', (e) => { e.preventDefault(); saveReportingChange(); });

        setupPanZoom();
    }

    /* ======= Init ======= */
    async function initializePage() {
        document.getElementById('loadingState').classList.remove('hidden');
        try {
            await loadOrgData();
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('flowView').classList.remove('hidden');
            setupEventListeners();
            renderCurrentView();
        } catch (e) {
            document.getElementById('loadingState').innerHTML = `
      <div class="text-center py-12">
        <i class="fa-solid fa-exclamation-triangle text-red-400 text-3xl mb-4"></i>
        <p class="text-red-600 mb-4">Failed to load organizational chart</p>
        <button onclick="initializePage()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Try Again</button>
      </div>`;
        }
    }
    document.addEventListener('DOMContentLoaded', initializePage);
</script>
{% endblock %}