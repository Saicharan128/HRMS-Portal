{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-file-invoice-dollar mr-2"></i> Expense Reports
            </h1>
            <p class="text-slate-600 text-sm">Department/BU summaries with quick approvals, exports & charts.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="resetSeed"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-seedling mr-1"></i> Reset Demo Data
            </button>
            <button id="exportCSV"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export (filtered)
            </button>
            <label
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm cursor-pointer">
                <i class="fa-solid fa-file-import mr-1"></i> Import (.json)
                <input id="importJSON" type="file" accept="application/json" class="hidden">
            </label>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Add Expense (Dummy) -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6 mb-8">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-plus-square mr-2"></i> Add Expense (Dummy)
        </h2>
        <form id="expForm" class="grid grid-cols-1 md:grid-cols-8 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Employee *</label>
                <input name="employee" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="E001 - Charan">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Department *</label>
                <input name="department" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Engineering">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">BU *</label>
                <input name="bu" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Products / Services">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Date *</label>
                <input name="date" type="date" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Category *</label>
                <select name="category" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <option>Travel</option>
                    <option>Meals</option>
                    <option>Office</option>
                    <option>Software</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Amount *</label>
                <input name="amount" type="number" step="0.01" min="0" required
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Currency</label>
                <input name="currency" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="INR">
            </div>
            <div class="flex items-center gap-2">
                <input id="reimb" name="reimb" type="checkbox" class="h-4 w-4">
                <label for="reimb" class="text-sm text-slate-700">Reimbursable</label>
            </div>
            <div class="md:col-span-8">
                <label class="block text-sm text-slate-600 mb-1">Notes</label>
                <input name="notes" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Optional">
            </div>
            <div class="md:col-span-8 flex items-center gap-3">
                <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                    <i class="fa-solid fa-plus mr-1"></i> Add
                </button>
                <span id="formMsg" class="text-sm text-slate-600"></span>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-9 gap-2">
        <input id="q" placeholder="Search employee / notes…"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fDept" placeholder="Department"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fBU" placeholder="BU" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fCat" placeholder="Category" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fStatus" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">Any Status</option>
            <option>Pending</option>
            <option>Approved</option>
            <option>Rejected</option>
        </select>
        <input id="fFrom" type="date" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fTo" type="date" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fCurrency" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">Any Currency</option>
            <option>INR</option>
            <option>USD</option>
            <option>EUR</option>
        </select>
        <button id="clearFilters"
            class="rounded-xl border border-slate-300 bg-white hover:bg-slate-50 px-3 py-2 text-sm">
            <i class="fa-solid fa-broom mr-1"></i> Clear
        </button>
    </div>

    <!-- Toolbar -->
    <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-slate-600"><span id="selCount">0</span> selected</div>
        <div class="flex items-center gap-2">
            <button id="bulkApprove"
                class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm disabled:opacity-40" disabled>
                <i class="fa-solid fa-check mr-1"></i> Approve
            </button>
            <button id="bulkReject" class="px-3 py-1.5 rounded-lg bg-rose-600 text-white text-sm disabled:opacity-40"
                disabled>
                <i class="fa-solid fa-xmark mr-1"></i> Reject
            </button>
            <button id="bulkDelete" class="px-3 py-1.5 rounded-lg border border-slate-300 text-sm disabled:opacity-40"
                disabled>
                <i class="fa-solid fa-trash-can mr-1"></i> Delete
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Total Amount</div>
            <div id="kpiTotal" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Reimbursable</div>
            <div id="kpiReimb" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Non-reimb.</div>
            <div id="kpiNonReimb" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Pending</div>
            <div id="kpiPending" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Avg / Employee</div>
            <div id="kpiAvgEmp" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Reports</div>
            <div id="kpiCount" class="text-xl font-semibold text-slate-800">0</div>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white mb-6">
        <table class="min-w-full text-sm text-left text-slate-700">
            <thead class="bg-slate-50 text-slate-600">
                <tr>
                    <th class="px-4 py-2 w-10"><input id="checkAll" type="checkbox" class="h-4 w-4"></th>
                    <th class="px-4 py-2">Employee</th>
                    <th class="px-4 py-2">Dept</th>
                    <th class="px-4 py-2">BU</th>
                    <th class="px-4 py-2">Date</th>
                    <th class="px-4 py-2">Category</th>
                    <th class="px-4 py-2">Amount</th>
                    <th class="px-4 py-2">Curr</th>
                    <th class="px-4 py-2">Reimb</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2 w-64">Notes</th>
                    <th class="px-4 py-2 w-56">Actions</th>
                </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-slate-200"></tbody>
        </table>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-chart-pie mr-2"></i> Spend by Category
            </h3>
            <canvas id="catChart" height="200"></canvas>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-calendar-day mr-2"></i> Spend by Day
            </h3>
            <canvas id="dayChart" height="200"></canvas>
        </div>
    </div>

    <!-- Department Summary -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4 mb-4">
        <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-building mr-2"></i> Department Summary</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-slate-700">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-2">Department</th>
                        <th class="px-4 py-2">Reports</th>
                        <th class="px-4 py-2">Total</th>
                        <th class="px-4 py-2">Reimbursable</th>
                        <th class="px-4 py-2">Non-reimb.</th>
                        <th class="px-4 py-2">Approved</th>
                        <th class="px-4 py-2">Pending</th>
                    </tr>
                </thead>
                <tbody id="deptRows" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </div>

    <!-- BU Summary -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-sitemap mr-2"></i> BU Summary</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-slate-700">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-2">BU</th>
                        <th class="px-4 py-2">Reports</th>
                        <th class="px-4 py-2">Total</th>
                        <th class="px-4 py-2">Reimbursable</th>
                        <th class="px-4 py-2">Non-reimb.</th>
                        <th class="px-4 py-2">Approved</th>
                        <th class="px-4 py-2">Pending</th>
                    </tr>
                </thead>
                <tbody id="buRows" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </div>

    <div id="listMsg" class="mt-3 text-sm text-slate-600"></div>
</div>

<script>
    /* ---------- Dummy store (localStorage) ---------- */
    const KEY = "dummy_expense_reports";
    const SEED = [
        { id: 1, employee: "E001 - Charan", department: "Engineering", bu: "Products", date: "2025-09-12", category: "Software", amount: 2499, currency: "INR", reimb: true, status: "Approved", notes: "Git hosting" },
        { id: 2, employee: "E014 - Priya", department: "Finance", bu: "Corporate", date: "2025-09-11", category: "Meals", amount: 1200, currency: "INR", reimb: true, status: "Pending", notes: "Client lunch" },
        { id: 3, employee: "E009 - Arjun", department: "Engineering", bu: "Services", date: "2025-09-10", category: "Travel", amount: 5400, currency: "INR", reimb: true, status: "Rejected", notes: "Cab - missing bill" },
        { id: 4, employee: "E021 - Meera", department: "HR", bu: "Corporate", date: "2025-09-09", category: "Office", amount: 1800, currency: "INR", reimb: false, status: "Approved", notes: "Stationery" }
    ];
    let STORE = JSON.parse(localStorage.getItem(KEY) || "null") || SEED.slice();
    function persist() { localStorage.setItem(KEY, JSON.stringify(STORE)); }

    /* ---------- Elements ---------- */
    const rows = $('rows'), deptRows = $('deptRows'), buRows = $('buRows'), listMsg = $('listMsg');
    const expForm = $('expForm'), formMsg = $('formMsg');
    const q = $('q'), fDept = $('fDept'), fBU = $('fBU'), fCat = $('fCat'), fStatus = $('fStatus'), fFrom = $('fFrom'), fTo = $('fTo'), fCurrency = $('fCurrency');
    const kpiTotal = $('kpiTotal'), kpiReimb = $('kpiReimb'), kpiNonReimb = $('kpiNonReimb'), kpiPending = $('kpiPending'), kpiAvgEmp = $('kpiAvgEmp'), kpiCount = $('kpiCount');
    const checkAll = $('checkAll'), selCount = $('selCount');
    const bulkApprove = $('bulkApprove'), bulkReject = $('bulkReject'), bulkDelete = $('bulkDelete');
    const resetSeed = $('resetSeed'), exportCSV = $('exportCSV'), importJSON = $('importJSON'), clearFilters = $('clearFilters');

    /* ---------- Charts ---------- */
    let catChart, dayChart;
    function ensureChart(cb) {
        if (typeof Chart !== 'undefined') return cb();
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = cb; document.head.appendChild(s);
    }

    /* ---------- Helpers ---------- */
    function $(id) { return document.getElementById(id); }
    function td(el) { const c = document.createElement('td'); c.className = 'px-4 py-2'; c.appendChild(el); return c; }
    function mkInput(v, cls = 'w-32') { const i = document.createElement('input'); i.value = v ?? ''; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function mkTextArea(v) { const t = document.createElement('textarea'); t.value = v ?? ''; t.rows = 1; t.className = 'w-full rounded-lg border border-slate-300 px-2 py-1 text-sm'; return t; }
    function mkSelect(opts, cur) { const s = document.createElement('select'); s.className = 'rounded-lg border border-slate-300 px-2 py-1 text-sm'; opts.forEach(o => { const op = document.createElement('option'); op.value = o; op.textContent = o; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }
    function money(n, cur) { const v = Number(n || 0); return (cur || 'INR') + ' ' + v.toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    function withinDate(d) {
        const v = new Date(d).setHours(0, 0, 0, 0);
        const f1 = fFrom.value ? new Date(fFrom.value).setHours(0, 0, 0, 0) : null;
        const f2 = fTo.value ? new Date(fTo.value).setHours(23, 59, 59, 999) : null;
        if (f1 && v < f1) return false; if (f2 && v > f2) return false; return true;
    }
    function download(filename, text) {
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' }); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = filename; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }

    /* ---------- Filtering ---------- */
    function filtered() {
        const qv = (q.value || '').toLowerCase().trim();
        const d = (fDept.value || '').toLowerCase().trim();
        const b = (fBU.value || '').toLowerCase().trim();
        const c = (fCat.value || '').toLowerCase().trim();
        const st = fStatus.value;
        const cur = fCurrency.value;

        return STORE.filter(r => {
            if (qv && !(`${r.employee} ${r.notes}`.toLowerCase().includes(qv))) return false;
            if (d && !(r.department || '').toLowerCase().includes(d)) return false;
            if (b && !(r.bu || '').toLowerCase().includes(b)) return false;
            if (c && !(r.category || '').toLowerCase().includes(c)) return false;
            if (st && r.status !== st) return false;
            if (cur && (r.currency || '') !== cur) return false;
            if (!withinDate(r.date)) return false;
            return true;
        });
    }

    /* ---------- KPIs ---------- */
    function updateKPIs(data) {
        const tot = data.reduce((a, r) => a + Number(r.amount || 0), 0);
        const reimb = data.filter(r => r.reimb).reduce((a, r) => a + Number(r.amount || 0), 0);
        const non = tot - reimb;
        const pend = data.filter(r => r.status === 'Pending').length;
        const byEmp = {};
        data.forEach(r => { byEmp[r.employee] = (byEmp[r.employee] || 0) + Number(r.amount || 0); });
        const avg = Object.keys(byEmp).length ? Object.values(byEmp).reduce((a, b) => a + b, 0) / Object.keys(byEmp).length : 0;
        const cur = data[0]?.currency || 'INR';

        kpiTotal.textContent = money(tot, cur);
        kpiReimb.textContent = money(reimb, cur);
        kpiNonReimb.textContent = money(non, cur);
        kpiPending.textContent = String(pend);
        kpiAvgEmp.textContent = money(avg, cur);
        kpiCount.textContent = String(data.length);
    }

    /* ---------- Summaries ---------- */
    function buildSummary(data, key) {
        const map = {};
        data.forEach(r => {
            const k = (r[key] || '—');
            map[k] = map[k] || { count: 0, total: 0, reimb: 0, non: 0, approved: 0, pending: 0 };
            map[k].count += 1;
            map[k].total += Number(r.amount || 0);
            if (r.reimb) map[k].reimb += Number(r.amount || 0); else map[k].non += Number(r.amount || 0);
            if (r.status === 'Approved') map[k].approved += Number(r.amount || 0);
            if (r.status === 'Pending') map[k].pending += Number(r.amount || 0);
        });
        return map;
    }
    function renderSummary(tbody, map, currency) {
        tbody.innerHTML = '';
        Object.entries(map).sort(([a], [b]) => a.localeCompare(b)).forEach(([name, v]) => {
            const tr = document.createElement('tr');
            const tdC = (txt) => { const x = document.createElement('td'); x.className = 'px-4 py-2'; x.textContent = txt; return x; };
            tr.append(
                tdC(name), tdC(v.count),
                tdC(money(v.total, currency)), tdC(money(v.reimb, currency)),
                tdC(money(v.non, currency)), tdC(money(v.approved, currency)), tdC(money(v.pending, currency))
            );
            tbody.appendChild(tr);
        });
    }

    /* ---------- Row rendering ---------- */
    let selectedIds = new Set();
    function load() {
        const data = filtered();
        const cur = data[0]?.currency || 'INR';
        rows.innerHTML = '';

        data.forEach(r => {
            const tr = document.createElement('tr');

            // Select checkbox
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'h-4 w-4';
            cb.checked = selectedIds.has(r.id);
            cb.addEventListener('change', () => { cb.checked ? selectedIds.add(r.id) : selectedIds.delete(r.id); updateBulkState(); });
            tr.appendChild(td(cb));

            const empI = mkInput(r.employee, 'w-44');
            const depI = mkInput(r.department, 'w-36');
            const buI = mkInput(r.bu, 'w-36');
            const dateI = mkInput(r.date, 'w-36'); dateI.type = 'date';
            const catI = mkInput(r.category, 'w-32');
            const amtI = mkInput(r.amount, 'w-28'); amtI.type = 'number'; amtI.step = '0.01'; amtI.min = 0;
            const curI = mkInput(r.currency || cur, 'w-20');
            const reimbS = mkSelect(['true', 'false'], r.reimb ? 'true' : 'false');
            const statusS = mkSelect(['Pending', 'Approved', 'Rejected'], r.status || 'Pending');
            const notesT = mkTextArea(r.notes || '');

            const actions = document.createElement('div');
            const approveBtn = btn('Approve', 'bg-emerald-600 hover:bg-emerald-700 text-white', 'fa-check');
            const rejectBtn = btn('Reject', 'bg-rose-600 hover:bg-rose-700 text-white', 'fa-xmark');
            const saveBtn = btn('Save', 'bg-slate-800 hover:bg-slate-900 text-white', 'fa-floppy-disk');
            const delBtn = btn('Delete', 'border border-slate-300 hover:bg-slate-50', 'fa-trash-can', false);

            actions.append(approveBtn, rejectBtn, saveBtn, delBtn);

            tr.append(
                td(empI), td(depI), td(buI), td(dateI), td(catI),
                td(amtI), td(curI), td(reimbS), td(statusS), td(notesT), td(actions)
            );
            rows.appendChild(tr);

            function save() {
                r.employee = empI.value.trim();
                r.department = depI.value.trim();
                r.bu = buI.value.trim();
                r.date = dateI.value;
                r.category = catI.value.trim();
                r.amount = Number(amtI.value || 0);
                r.currency = curI.value.trim() || 'INR';
                r.reimb = (reimbS.value === 'true');
                r.status = statusS.value;
                r.notes = notesT.value;
                persist(); refresh();
                flash('Saved.');
            }
            approveBtn.addEventListener('click', () => { statusS.value = 'Approved'; save(); });
            rejectBtn.addEventListener('click', () => { statusS.value = 'Rejected'; save(); });
            saveBtn.addEventListener('click', save);
            delBtn.addEventListener('click', () => { if (!confirm('Delete this expense?')) return; STORE = STORE.filter(x => x.id !== r.id); selectedIds.delete(r.id); persist(); refresh(); });
        });

        updateKPIs(data);
        renderSummary(deptRows, buildSummary(data, 'department'), cur);
        renderSummary(buRows, buildSummary(data, 'bu'), cur);
        listMsg.textContent = data.length ? '' : 'No expenses.';
        renderCharts(data);
        updateBulkState();
    }
    function refresh() { load(); }
    function btn(txt, cls, icon, solid = true) {
        const b = document.createElement('button');
        b.className = `px-2 py-1 mr-2 rounded-md text-xs ${cls}`;
        b.innerHTML = `<i class="fa-solid ${icon} mr-1"></i>${txt}`;
        return b;
    }

    /* ---------- Create ---------- */
    expForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(expForm);
        const employee = (fd.get('employee') || '').toString().trim();
        const department = (fd.get('department') || '').toString().trim();
        const bu = (fd.get('bu') || '').toString().trim();
        const date = (fd.get('date') || '').toString();
        const category = (fd.get('category') || '').toString();
        const amount = Number(fd.get('amount') || 0);
        const currency = (fd.get('currency') || 'INR').toString().trim();
        const reimb = !!fd.get('reimb');
        const notes = (fd.get('notes') || '').toString().trim();
        if (!employee || !department || !bu || !date || !category || !amount) { formFlash('Missing required fields.', true); return; }
        const id = Math.max(0, ...STORE.map(x => x.id)) + 1;
        STORE.unshift({ id, employee, department, bu, date, category, amount, currency, reimb, status: 'Pending', notes });
        persist(); expForm.reset(); formFlash('Added ✓'); refresh();
    });
    function formFlash(msg, bad = false) {
        formMsg.textContent = msg; formMsg.className = 'text-sm ' + (bad ? 'text-rose-700' : 'text-emerald-700');
        setTimeout(() => { formMsg.textContent = ''; formMsg.className = 'text-sm text-slate-600'; }, 1500);
    }

    /* ---------- Bulk actions ---------- */
    checkAll.addEventListener('change', () => {
        const data = filtered();
        if (checkAll.checked) selectedIds = new Set(data.map(r => r.id)); else selectedIds.clear();
        refresh();
    });
    bulkApprove.addEventListener('click', () => bulkSetStatus('Approved'));
    bulkReject.addEventListener('click', () => bulkSetStatus('Rejected'));
    bulkDelete.addEventListener('click', () => {
        if (!selectedIds.size) return;
        if (!confirm(`Delete ${selectedIds.size} expense(s)?`)) return;
        STORE = STORE.filter(r => !selectedIds.has(r.id));
        selectedIds.clear(); persist(); refresh();
    });
    function bulkSetStatus(status) {
        if (!selectedIds.size) return;
        STORE.forEach(r => { if (selectedIds.has(r.id)) r.status = status; });
        persist(); refresh();
    }
    function updateBulkState() {
        selCount.textContent = String(selectedIds.size);
        const on = selectedIds.size > 0;
        [bulkApprove, bulkReject, bulkDelete].forEach(b => b.disabled = !on);
        checkAll.checked = on && filtered().every(r => selectedIds.has(r.id));
    }

    /* ---------- Export / Import ---------- */
    exportCSV.addEventListener('click', () => {
        const data = filtered();
        const rows = [['ID', 'Employee', 'Department', 'BU', 'Date', 'Category', 'Amount', 'Currency', 'Reimb', 'Status', 'Notes']];
        data.forEach(r => rows.push([r.id, r.employee, r.department, r.bu, r.date, r.category, r.amount, r.currency, r.reimb, r.status, (r.notes || '').replace(/\n/g, ' ')]));
        const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(',')).join('\n');
        download('expense_reports_filtered.csv', csv);
    });
    importJSON.addEventListener('change', (e) => {
        const f = e.target.files?.[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                if (!Array.isArray(data)) throw new Error('Expected array');
                // Lightweight shape guard
                STORE = data.map((r, i) => ({
                    id: Number(r.id ?? Date.now() + i),
                    employee: String(r.employee || 'Unknown'),
                    department: String(r.department || '—'),
                    bu: String(r.bu || '—'),
                    date: String(r.date || new Date().toISOString().slice(0, 10)),
                    category: String(r.category || 'Other'),
                    amount: Number(r.amount || 0),
                    currency: String(r.currency || 'INR'),
                    reimb: !!r.reimb,
                    status: ['Pending', 'Approved', 'Rejected'].includes(String(r.status)) ? String(r.status) : 'Pending',
                    notes: String(r.notes || '')
                }));
                persist(); refresh(); flash('Imported JSON ✓');
            } catch { flash('Invalid JSON', true); }
        };
        reader.readAsText(f); e.target.value = '';
    });
    resetSeed.addEventListener('click', () => {
        if (!confirm('Reset demo data?')) return;
        STORE = SEED.slice(); selectedIds.clear(); persist(); refresh();
    });
    clearFilters.addEventListener('click', () => {
        [q, fDept, fBU, fCat, fStatus, fFrom, fTo, fCurrency].forEach(el => el.value = ''); refresh();
    });

    /* ---------- Charts ---------- */
    function renderCharts(data) {
        ensureChart(() => {
            // Category
            const byCat = {};
            data.forEach(r => byCat[r.category] = (byCat[r.category] || 0) + Number(r.amount || 0));
            const catCtx = $('catChart').getContext('2d');
            if (catChart) catChart.destroy();
            catChart = new Chart(catCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(byCat), datasets: [{
                        data: Object.values(byCat), borderWidth: 2, borderColor: '#fff',
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, responsive: true, maintainAspectRatio: false }
            });

            // By Day
            const byDay = {};
            data.forEach(r => { const d = r.date; byDay[d] = (byDay[d] || 0) + Number(r.amount || 0); });
            const sortedDays = Object.keys(byDay).sort();
            const dayCtx = $('dayChart').getContext('2d');
            if (dayChart) dayChart.destroy();
            dayChart = new Chart(dayCtx, {
                type: 'bar',
                data: { labels: sortedDays, datasets: [{ label: 'Amount', data: sortedDays.map(d => byDay[d]), backgroundColor: 'rgba(2,132,199,0.5)', borderColor: 'rgba(2,132,199,1)', borderWidth: 2 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
            });
        });
    }

    /* ---------- Live filters + init ---------- */
    [q, fDept, fBU, fCat, fStatus, fFrom, fTo, fCurrency].forEach(el => el.addEventListener('input', load));
    document.addEventListener('DOMContentLoaded', load);

    /* ---------- UI feedback ---------- */
    function flash(msg, bad = false) {
        listMsg.textContent = msg;
        listMsg.className = 'mt-3 text-sm ' + (bad ? 'text-rose-700' : 'text-emerald-700');
        setTimeout(() => { listMsg.textContent = ''; listMsg.className = 'mt-3 text-sm text-slate-600'; }, 1400);
    }
</script>
{% endblock %}