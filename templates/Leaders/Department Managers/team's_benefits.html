{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-gift mr-2"></i> Team's benefits
            </h1>
            <p class="text-slate-600 text-sm">Manage employee perks, benefits, and eligibility.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="syncVendors"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-rotate mr-1"></i> Sync vendors
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="plansTab" class="tb-tab active px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-layer-group mr-1"></i> Plans</button>
            <button id="eligibilityTab" class="tb-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-id-badge mr-1"></i> Eligibility</button>
            <button id="enrollTab" class="tb-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-user-check mr-1"></i> Enrollments</button>
            <button id="claimsTab" class="tb-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-file-invoice-dollar mr-1"></i> Claims</button>
            <button id="complianceTab" class="tb-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-shield-halved mr-1"></i> Compliance</button>
            <button id="reportsTab" class="tb-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-chart-line mr-1"></i> Reports</button>
        </div>
    </div>

    <!-- Plans -->
    <section id="plansPanel" class="tb-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-layer-group mr-2"></i>
                        Benefit Plans</h3>
                    <div class="flex items-center gap-2">
                        <select id="planFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                        <button id="newPlan"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                            <i class="fa-solid fa-plus mr-1"></i> New Plan
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">Plan</th>
                                <th class="py-2 px-4">Type</th>
                                <th class="py-2 px-4">Employer %</th>
                                <th class="py-2 px-4">Employee %</th>
                                <th class="py-2 px-4">Status</th>
                                <th class="py-2 px-4 w-24"></th>
                            </tr>
                        </thead>
                        <tbody id="planRows" class="text-slate-800"><!-- injected --></tbody>
                    </table>
                </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-circle-info mr-2"></i> Plan
                    Summary</h3>
                <ul id="planSummary" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Eligibility -->
    <section id="eligibilityPanel" class="tb-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-id-badge mr-2"></i> Rules
                    </h3>
                    <div class="flex items-center gap-2">
                        <select id="eligPlan"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"></select>
                        <button id="newRule"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"><i
                                class="fa-solid fa-plus mr-1"></i> Add Rule</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">Condition</th>
                                <th class="py-2 px-4">Operator</th>
                                <th class="py-2 px-4">Value</th>
                                <th class="py-2 px-4">Applies To</th>
                                <th class="py-2 px-4 w-20"></th>
                            </tr>
                        </thead>
                        <tbody id="ruleRows" class="text-slate-800"><!-- injected --></tbody>
                    </table>
                </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-wand-magic-sparkles mr-2"></i> Preview</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <input id="pvDept" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Department e.g., Engineering">
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="pvLoc" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Location e.g., IN/US">
                    </div>
                    <button id="runPreview"
                        class="w-full px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 text-sm">Check
                        eligibility</button>
                    <div id="pvResult" class="text-slate-700"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enrollments -->
    <section id="enrollPanel" class="tb-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-user-check mr-2"></i> Active
                    Enrollments</h3>
                <div class="flex items-center gap-2">
                    <select id="enrPlan" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm"></select>
                    <button id="bulkEnroll"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50"><i
                            class="fa-solid fa-user-plus mr-1"></i> Bulk Enroll</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4">Employee</th>
                            <th class="py-2 px-4">Plan</th>
                            <th class="py-2 px-4">Coverage</th>
                            <th class="py-2 px-4">Employee Share</th>
                            <th class="py-2 px-4">Employer Share</th>
                            <th class="py-2 px-4 w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="enrRows" class="text-slate-800"><!-- injected --></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Claims -->
    <section id="claimsPanel" class="tb-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i
                            class="fa-solid fa-file-invoice-dollar mr-2"></i> Claims</h3>
                    <div class="flex items-center gap-2">
                        <select id="clStatus" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                            <option value="all">All</option>
                            <option value="submitted">Submitted</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="paid">Paid</option>
                        </select>
                        <button id="newClaim"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"><i
                                class="fa-solid fa-circle-plus mr-1"></i> New</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">ID</th>
                                <th class="py-2 px-4">Employee</th>
                                <th class="py-2 px-4">Plan</th>
                                <th class="py-2 px-4">Amount</th>
                                <th class="py-2 px-4">Status</th>
                                <th class="py-2 px-4 w-24"></th>
                            </tr>
                        </thead>
                        <tbody id="claimRows" class="text-slate-800"><!-- injected --></tbody>
                    </table>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-stopwatch mr-2"></i> SLA
                </h3>
                <ul id="slaBox" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Compliance -->
    <section id="compliancePanel" class="tb-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-shield-halved mr-2"></i>
                    Checklist</h3>
                <div id="compList" class="space-y-3"><!-- injected --></div>
                <button id="compAll"
                    class="mt-2 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm"><i
                        class="fa-solid fa-check mr-1"></i> Mark All</button>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-scale-balanced mr-2"></i>
                    Tax & Statutory</h3>
                <ul id="taxList" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-file-shield mr-2"></i>
                    Documents</h3>
                <ul id="docList" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Reports -->
    <section id="reportsPanel" class="tb-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-chart-pie mr-2"></i> Spend
                    by Plan</h3>
                <canvas id="spendChart" height="220"></canvas>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-heart-pulse mr-2"></i>
                    Adoption & Usage</h3>
                <canvas id="adoptChart" height="220"></canvas>
            </div>
        </div>
    </section>
</div>

<!-- New Plan Modal -->
<div id="planModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Create Benefit Plan</h3>
                    <button id="closePlan" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <input id="plName" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Plan name">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="plType" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option>Health</option>
                            <option>Dental</option>
                            <option>Vision</option>
                            <option>Life</option>
                            <option>Wellness</option>
                            <option>Retirement</option>
                        </select>
                        <select id="plStatus" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="plEr" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Employer %">
                        <input id="plEe" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Employee %">
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelPlan"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="savePlan" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i
                                class="fa-solid fa-floppy-disk mr-1"></i> Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Rule Modal -->
<div id="ruleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Add Eligibility Rule</h3>
                    <button id="closeRule" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <select id="rField" class="rounded-lg border border-slate-300 px-3 py-2">
                            <option value="department">Department</option>
                            <option value="location">Location</option>
                            <option value="tenure">Tenure (months)</option>
                            <option value="level">Level</option>
                        </select>
                        <select id="rOp" class="rounded-lg border border-slate-300 px-3 py-2">
                            <option value="is">is</option>
                            <option value="is_not">is not</option>
                            <option value="gt">â‰¥</option>
                            <option value="lt">â‰¤</option>
                        </select>
                        <input id="rVal" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Value">
                    </div>
                    <div class="flex items-center justify-end gap-2">
                        <button id="saveRule" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i
                                class="fa-solid fa-plus mr-1"></i> Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Claim Modal -->
<div id="claimModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">New Claim</h3>
                    <button id="closeClaim" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="clEmp" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Employee name">
                        <select id="clPlan" class="w-full rounded-lg border border-slate-300 px-3 py-2"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="clAmt" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Amount">
                        <input id="clDate" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <input id="clDesc" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Description">
                    <div class="flex items-center justify-end gap-2">
                        <button id="saveClaim" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i
                                class="fa-solid fa-floppy-disk mr-1"></i> Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------- Mock Data ---------- */
    let PLANS = [
        { id: 1, name: 'Silver Health', type: 'Health', er: 60, ee: 40, status: 'active' },
        { id: 2, name: 'Vision Basic', type: 'Vision', er: 80, ee: 20, status: 'active' },
        { id: 3, name: 'Wellness Wallet', type: 'Wellness', er: 100, ee: 0, status: 'archived' },
        { id: 4, name: 'Retirement 401k', type: 'Retirement', er: 4, ee: 6, status: 'active' }
    ];
    let RULES = [
        { plan: 1, field: 'location', op: 'is', value: 'IN', who: 'Full-time' },
        { plan: 1, field: 'tenure', op: 'gt', value: '3', who: 'All' },
        { plan: 2, field: 'department', op: 'is', value: 'Engineering', who: 'All' }
    ];
    let ENROLL = [
        { emp: 'Aarav Mehta', plan: 1, cov: 'Employee+Spouse', ee: 1800, er: 2700 },
        { emp: 'Riya Patel', plan: 2, cov: 'Employee', ee: 200, er: 800 },
        { emp: 'Noah Kim', plan: 4, cov: 'Employee', ee: 3000, er: 2000 }
    ];
    let CLAIMS = [
        { id: 'CLM-101', emp: 'Aarav Mehta', plan: 1, amt: 4500, st: 'submitted' },
        { id: 'CLM-102', emp: 'Riya Patel', plan: 2, amt: 120, st: 'approved' },
        { id: 'CLM-103', emp: 'Noah Kim', plan: 1, amt: 980, st: 'paid' }
    ];
    let COMPLIANCE = [
        { id: 301, text: 'Policy document published', done: true },
        { id: 302, text: 'Open enrollment notice sent', done: false },
        { id: 303, text: 'Section 125 / Cafeteria plan compliant', done: true }
    ];

    /* ---------- Helpers ---------- */
    const $ = (id) => document.getElementById(id);
    const money = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(n || 0));
    function pill(s) { return s === 'active' ? 'bg-emerald-50 text-emerald-700' : s === 'archived' ? 'bg-slate-100 text-slate-700' : 'bg-amber-50 text-amber-700'; }
    function statusPill(s) { return s === 'approved' ? 'bg-emerald-50 text-emerald-700' : s === 'submitted' ? 'bg-amber-50 text-amber-700' : s === 'paid' ? 'bg-blue-50 text-blue-700' : 'bg-red-50 text-red-700'; }

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Tabs
        document.querySelectorAll('.tb-tab').forEach(b => {
            b.addEventListener('click', e => {
                document.querySelectorAll('.tb-tab').forEach(x => x.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                document.querySelectorAll('.tb-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(name + 'Panel').classList.remove('hidden');
                if (name === 'reports') { ensureCharts(); drawCharts(); }
            });
        });

        // Plans
        $('planFilter').addEventListener('change', renderPlans);
        $('newPlan').addEventListener('click', () => $('planModal').classList.remove('hidden'));
        $('closePlan').addEventListener('click', closePlan);
        $('cancelPlan').addEventListener('click', closePlan);
        $('savePlan').addEventListener('click', savePlan);

        // Eligibility
        $('newRule').addEventListener('click', () => $('ruleModal').classList.remove('hidden'));
        $('closeRule').addEventListener('click', () => $('ruleModal').classList.add('hidden'));
        $('saveRule').addEventListener('click', saveRule);
        $('runPreview').addEventListener('click', runPreview);

        // Enrollments
        $('bulkEnroll').addEventListener('click', () => alert('âœ… Bulk enroll queued'));

        // Claims
        $('clStatus').addEventListener('change', renderClaims);
        $('newClaim').addEventListener('click', () => { syncPlanSelects(); $('claimModal').classList.remove('hidden'); });
        $('closeClaim').addEventListener('click', () => $('claimModal').classList.add('hidden'));
        $('saveClaim').addEventListener('click', saveClaim);

        // Compliance
        $('compAll').addEventListener('click', () => { COMPLIANCE = COMPLIANCE.map(x => ({ ...x, done: true })); renderCompliance(); });

        // Top
        $('syncVendors').addEventListener('click', () => alert('ðŸ”— Vendor sync started'));

        // Seed selects + paint
        syncPlanSelects();
        renderPlans(); renderPlanSummary();
        renderRules();
        renderEnrollments();
        renderClaims();
        renderCompliance(); renderTax(); renderDocs();
    });

    /* ---------- Plans ---------- */
    function renderPlans() {
        const f = $('planFilter').value;
        const data = PLANS.filter(p => f === 'all' || p.status === f);
        $('planRows').innerHTML = data.map(p => `
    <tr class="border-b last:border-0">
      <td class="py-2 px-4 font-medium">${p.name}</td>
      <td class="py-2 px-4">${p.type}</td>
      <td class="py-2 px-4">${p.er}%</td>
      <td class="py-2 px-4">${p.ee}%</td>
      <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${pill(p.status)}">${p.status}</span></td>
      <td class="py-2 px-4 text-right">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Open ${p.name}')">Open</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No plans</td></tr>`;
    }
    function renderPlanSummary() {
        const active = PLANS.filter(p => p.status === 'active');
        const byType = active.reduce((m, p) => (m[p.type] = (m[p.type] || 0) + 1, m), {});
        const avgEr = Math.round(active.reduce((s, p) => s + p.er, 0) / (active.length || 1));
        $('planSummary').innerHTML = `
    <li class="flex items-center justify-between"><span>Active plans</span><span class="font-semibold">${active.length}</span></li>
    <li class="flex items-center justify-between"><span>Avg employer share</span><span class="font-semibold">${avgEr}%</span></li>
    ${Object.entries(byType).map(([k, v]) => `<li class="flex items-center justify-between"><span>${k}</span><span class="font-semibold">${v}</span></li>`).join('')}
  `;
    }
    function savePlan() {
        const name = $('plName').value.trim(); const type = $('plType').value; const status = $('plStatus').value;
        const er = Number($('plEr').value || 0), ee = Number($('plEe').value || 0);
        if (!name) { alert('Plan name required'); return; }
        PLANS.push({ id: Date.now(), name, type, er, ee, status });
        closePlan(); syncPlanSelects(); renderPlans(); renderPlanSummary();
    }
    function closePlan() { $('planModal').classList.add('hidden'); $('plName').value = ''; $('plEr').value = ''; $('plEe').value = ''; }

    /* ---------- Eligibility ---------- */
    function syncPlanSelects() {
        const opts = PLANS.filter(p => p.status !== 'archived').map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        $('eligPlan').innerHTML = opts; $('enrPlan').innerHTML = '<option value="all">All</option>' + opts; $('clPlan').innerHTML = opts;
    }
    function renderRules() {
        const pid = Number($('eligPlan').value || PLANS[0]?.id); if (!pid) { $('ruleRows').innerHTML = ''; return; }
        const data = RULES.filter(r => r.plan === pid);
        $('ruleRows').innerHTML = data.map((r, i) => `
    <tr class="border-b last:border-0">
      <td class="py-2 px-4">${cap(r.field)}</td>
      <td class="py-2 px-4">${opText(r.op)}</td>
      <td class="py-2 px-4">${r.value}</td>
      <td class="py-2 px-4">${r.who}</td>
      <td class="py-2 px-4 text-right">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="delRule(${pid},${i})">Delete</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="5" class="py-6 text-center text-slate-500">No rules</td></tr>`;
    }
    $('eligPlan').addEventListener('change', renderRules);
    function saveRule() {
        const pid = Number($('eligPlan').value || PLANS[0]?.id); if (!pid) return;
        RULES.push({ plan: pid, field: val('rField'), op: val('rOp'), value: val('rVal'), who: 'All' });
        $('ruleModal').classList.add('hidden'); $('rVal').value = ''; renderRules();
    }
    function delRule(pid, idx) {
        const filtered = RULES.filter(r => r.plan === pid);
        const del = filtered[idx]; const i = RULES.indexOf(del); if (i > -1) RULES.splice(i, 1);
        renderRules();
    }
    function runPreview() {
        const dept = $('pvDept').value.trim(); const loc = $('pvLoc').value.trim();
        const pid = Number($('eligPlan').value || PLANS[0]?.id);
        const matches = RULES.filter(r => r.plan === pid).filter(r => {
            if (r.field === 'location' && r.op === 'is') return r.value.toLowerCase() === loc.toLowerCase();
            if (r.field === 'department' && r.op === 'is') return r.value.toLowerCase() === dept.toLowerCase();
            if (r.field === 'tenure' && r.op === 'gt') return Number(r.value || 0) <= 12; // mock
            return true;
        }).length;
        $('pvResult').innerHTML = matches ? `<div class="p-2 rounded bg-emerald-50 text-emerald-700">Eligible</div>` : `<div class="p-2 rounded bg-red-50 text-red-700">Not eligible</div>`;
    }

    /* ---------- Enrollments ---------- */
    function renderEnrollments() {
        const pid = $('enrPlan').value;
        const data = pid === 'all' || !pid ? ENROLL : ENROLL.filter(e => e.plan === Number(pid));
        $('enrRows').innerHTML = data.map(e => {
            const p = PLANS.find(p => p.id === e.plan);
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${e.emp}</td>
        <td class="py-2 px-4">${p?.name || 'â€”'}</td>
        <td class="py-2 px-4">${e.cov}</td>
        <td class="py-2 px-4">${money(e.ee)}</td>
        <td class="py-2 px-4">${money(e.er)}</td>
        <td class="py-2 px-4 text-right"><button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Edit enrollment')">Edit</button></td>
      </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No enrollments</td></tr>`;
    }
    $('enrPlan').addEventListener('change', renderEnrollments);

    /* ---------- Claims ---------- */
    function renderClaims() {
        const f = $('clStatus').value;
        const data = f === 'all' ? CLAIMS : CLAIMS.filter(c => c.st === f);
        $('claimRows').innerHTML = data.map(c => {
            const p = PLANS.find(p => p.id === c.plan);
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${c.id}</td>
        <td class="py-2 px-4">${c.emp}</td>
        <td class="py-2 px-4">${p?.name || 'â€”'}</td>
        <td class="py-2 px-4">${money(c.amt)}</td>
        <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${statusPill(c.st)} capitalize">${c.st}</span></td>
        <td class="py-2 px-4 text-right"><button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="approveClaim('${c.id}')">Approve</button></td>
      </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No claims</td></tr>`;
    }
    function approveClaim(id) { const x = CLAIMS.find(c => c.id === id); if (!x) return; x.st = 'approved'; renderClaims(); }
    function saveClaim() {
        const emp = val('clEmp') || 'Unknown', plan = Number(val('clPlan')), amt = Number(val('clAmt') || 0), date = val('clDate') || new Date().toISOString().slice(0, 10), desc = val('clDesc') || 'â€”';
        if (!amt || !plan) { alert('Plan & amount required'); return; }
        CLAIMS.push({ id: 'CLM-' + Date.now(), emp, plan, amt, st: 'submitted', date, desc });
        $('claimModal').classList.add('hidden'); renderClaims();
    }

    /* ---------- Compliance ---------- */
    function renderCompliance() {
        $('compList').innerHTML = COMPLIANCE.map(c => `
    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" ${c.done ? 'checked' : ''} onchange="toggleComp(${c.id}, this.checked)"> ${c.text}</label>
      ${c.done ? '<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-xs">Done</span>' : ''}
    </div>`).join('');
    }
    function toggleComp(id, on) { const x = COMPLIANCE.find(c => c.id === id); if (x) { x.done = on; renderCompliance(); } }
    function renderTax() {
        $('taxList').innerHTML = `
    <li class="flex items-center justify-between"><span>India â€¢ ESIC/EPF mappings</span><span class="font-medium">OK</span></li>
    <li class="flex items-center justify-between"><span>US â€¢ ACA eligibility (FTE)</span><span class="font-medium">Monitor</span></li>
  `;
    }
    function renderDocs() {
        $('docList').innerHTML = `
    <li class="flex items-center justify-between"><span>Plan Summary PDFs</span><button class="text-sm px-2 py-1 rounded border border-slate-300 bg-white hover:bg-slate-50">Open</button></li>
    <li class="flex items-center justify-between"><span>Open Enrollment Notice</span><button class="text-sm px-2 py-1 rounded border border-slate-300 bg-white hover:bg-slate-50">Open</button></li>
  `;
    }

    /* ---------- Reports ---------- */
    let chartsReady = false, spendC, adoptC;
    function ensureCharts() {
        if (typeof Chart !== 'undefined') { chartsReady = true; return; }
        if (chartsReady) return;
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = () => { chartsReady = true; drawCharts(); };
        document.head.appendChild(s);
    }
    function drawCharts() {
        if (!chartsReady) return;
        const ctx1 = document.getElementById('spendChart'); const ctx2 = document.getElementById('adoptChart');
        spendC && spendC.destroy(); adoptC && adoptC.destroy();

        const byPlan = { 'Health': 52000, 'Vision': 6500, 'Wellness': 2400, 'Retirement': 31000 };
        spendC = new Chart(ctx1, {
            type: 'pie',
            data: { labels: Object.keys(byPlan), datasets: [{ data: Object.values(byPlan), borderWidth: 2, borderColor: '#fff', backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'] }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        const adopt = { 'Silver Health': 32, 'Vision Basic': 18, 'Wellness Wallet': 9, 'Retirement 401k': 26 };
        adoptC = new Chart(ctx2, {
            type: 'bar',
            data: { labels: Object.keys(adopt), datasets: [{ data: Object.values(adopt), backgroundColor: '#06b6d4' }] },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    /* ---------- Utils ---------- */
    function val(id) { const el = $(id); return el ? el.value : ''; }
    function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function opText(o) { return o === 'is_not' ? 'is not' : (o === 'gt' ? 'â‰¥' : (o === 'lt' ? 'â‰¤' : 'is')); }
</script>

<style>
    .tb-tab.active {
        background-color: #1e293b;
        color: white;
    }

    .tb-tab:not(.active) {
        color: #64748b;
    }

    .tb-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}