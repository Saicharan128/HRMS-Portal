{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-calendar-days mr-2"></i> Holiday calendar (upload)
            </h1>
            <p class="text-slate-600 text-sm">Upload official holiday list.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportCsv"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Upload (Dummy) -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6 mb-8">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-file-arrow-up mr-2"></i> Upload Holiday List (PDF)
        </h2>

        <!-- Drag & drop -->
        <div id="dropZone" class="mb-4 rounded-xl border-2 border-dashed border-slate-300 bg-slate-50 p-4 text-center">
            <div class="text-slate-600 text-sm"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> Drag & drop PDF here
            </div>
            <div class="text-xs text-slate-500 mt-1">or use the form below</div>
        </div>

        <form id="uploadForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm text-slate-600 mb-1">Title *</label>
                <input name="title" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="e.g., India Holidays 2026">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Year *</label>
                <input name="year" type="number" min="2000" max="2100" required
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Region / Country</label>
                <input name="region" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="India / APAC">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Notes</label>
                <input name="notes" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Optional notes (observed rules, exceptions)">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">PDF File *</label>
                <input id="fileInput" name="file" type="file" accept="application/pdf" required
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 bg-white">
                <div class="text-xs text-slate-500 mt-1">PDF • max 5 MB</div>
            </div>

            <div class="md:col-span-3 flex items-center gap-3">
                <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                    <i class="fa-solid fa-upload mr-1"></i> Upload (Dummy)
                </button>
                <span id="uploadMsg" class="text-sm text-slate-600"></span>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-7 gap-2">
        <input id="q" placeholder="Search title, notes…"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fYear" type="number" placeholder="Year"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fRegion" placeholder="Region" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fStatus" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">All</option>
            <option value="Active">Active</option>
            <option value="Archived">Archived</option>
        </select>
        <select id="sortBy" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="year_desc">Sort: Year ↓</option>
            <option value="year_asc">Sort: Year ↑</option>
            <option value="created_desc">Sort: Uploaded ↓</option>
            <option value="created_asc">Sort: Uploaded ↑</option>
        </select>
        <button id="clearFilters"
            class="rounded-xl border border-slate-300 bg-white hover:bg-slate-50 px-3 py-2 text-sm">
            Clear
        </button>
        <div class="text-sm text-slate-600 flex items-center">Showing <span id="countN"
                class="mx-1 font-medium">0</span> item(s)</div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white">
        <table class="min-w-full text-sm text-left text-slate-700">
            <thead class="bg-slate-50 text-slate-600">
                <tr>
                    <th class="px-4 py-2"><input id="selAll" type="checkbox"></th>
                    <th class="px-4 py-2">Title</th>
                    <th class="px-4 py-2">Year</th>
                    <th class="px-4 py-2">Region</th>
                    <th class="px-4 py-2">Uploaded</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">File</th>
                    <th class="px-4 py-2 w-64">Actions</th>
                </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-slate-200"></tbody>
        </table>
    </div>
    <div class="flex items-center gap-2 mt-3">
        <button id="bulkActivate"
            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm"><i
                class="fa-solid fa-toggle-on mr-1"></i> Activate</button>
        <button id="bulkArchive"
            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm"><i
                class="fa-solid fa-box-archive mr-1"></i> Archive</button>
        <button id="bulkDelete"
            class="px-3 py-2 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50 text-sm"><i
                class="fa-solid fa-trash-can mr-1"></i> Delete</button>
        <button id="bulkDownload" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm"><i
                class="fa-solid fa-file-arrow-down mr-1"></i> Download</button>
        <div id="listMsg" class="ml-auto text-sm text-slate-600"></div>
    </div>
</div>

<script>
    /* ---------- Dummy store (in-memory + localStorage) ---------- */
    const STORAGE_KEY = "dummy_holiday_lists";
    let STORE = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null") || [
        {
            id: 1, title: "India Holidays 2025", year: "2025", region: "India", notes: "Govt + optional", status: "Active",
            file_name: "india_2025.pdf", file_url: "#", created_at: new Date().toISOString()
        },
        {
            id: 2, title: "US Holidays 2025", year: "2025", region: "USA", notes: "", status: "Archived",
            file_name: "us_2025.pdf", file_url: "#", created_at: new Date(Date.now() - 86400000).toISOString()
        }
    ];
    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); }

    /* ---------- Elements ---------- */
    const uploadForm = document.getElementById("uploadForm");
    const uploadMsg = document.getElementById("uploadMsg");
    const rows = document.getElementById("rows");
    const listMsg = document.getElementById("listMsg");
    const qEl = document.getElementById("q");
    const fYear = document.getElementById("fYear");
    const fRegion = document.getElementById("fRegion");
    const fStatus = document.getElementById("fStatus");
    const sortBy = document.getElementById("sortBy");
    const clearBtn = document.getElementById("clearFilters");
    const selAll = document.getElementById("selAll");
    const countN = document.getElementById("countN");

    /* ---------- Helpers ---------- */
    const $ = (s, root = document) => root.querySelector(s);
    function tdWrap(el) { const td = document.createElement("td"); td.className = "px-4 py-2 align-top"; td.appendChild(el); return td; }
    function input(v, cls = "w-44") { const i = document.createElement("input"); i.value = v ?? ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function select(opts, cur) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; opts.forEach(o => { const op = document.createElement("option"); op.value = o; op.textContent = o || "—"; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }
    function a(href, text) { const x = document.createElement("a"); x.href = href; x.target = "_blank"; x.rel = "noopener"; x.className = "text-slate-700 underline"; x.textContent = text; return x; }
    function pill(status) { const m = { Active: "bg-emerald-50 text-emerald-700", Archived: "bg-slate-100 text-slate-700" }; const span = document.createElement("span"); span.className = `px-2 py-0.5 rounded-full text-xs ${m[status] || 'bg-slate-100 text-slate-700'}`; span.textContent = status; return span; }
    function toast(msg, bad = false) { const t = document.createElement('div'); t.className = 'fixed bottom-5 right-5 px-3 py-2 rounded-lg shadow text-sm ' + (bad ? 'bg-rose-600 text-white' : 'bg-slate-800 text-white'); t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 1500); }

    /* ---------- Filtering / Sorting ---------- */
    function filtered() {
        const q = (qEl.value || "").toLowerCase().trim();
        const y = (fYear.value || "").trim();
        const r = (fRegion.value || "").toLowerCase().trim();
        const s = fStatus.value;
        return STORE.filter(it => {
            if (q && !(`${it.title} ${it.notes}`.toLowerCase().includes(q))) return false;
            if (y && it.year !== y) return false;
            if (r && !(it.region || "").toLowerCase().includes(r)) return false;
            if (s && it.status !== s) return false;
            return true;
        });
    }
    function sortData(arr) {
        switch (sortBy.value) {
            case 'year_asc': return arr.slice().sort((a, b) => a.year.localeCompare(b.year) || b.created_at.localeCompare(a.created_at));
            case 'created_desc': return arr.slice().sort((a, b) => b.created_at.localeCompare(a.created_at));
            case 'created_asc': return arr.slice().sort((a, b) => a.created_at.localeCompare(b.created_at));
            default: /* year_desc */ return arr.slice().sort((a, b) => b.year.localeCompare(a.year) || b.created_at.localeCompare(a.created_at));
        }
    }

    /* ---------- Render ---------- */
    function loadList() {
        rows.innerHTML = "";
        const data = sortData(filtered());
        countN.textContent = data.length;
        data.forEach(r => {
            const tr = document.createElement("tr");
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'rowChk'; chk.value = r.id;

            const titleI = input(r.title, "w-56");
            const yearI = input(r.year, "w-24");
            const regionI = input(r.region, "w-40");
            const uploaded = document.createElement("span"); uploaded.textContent = new Date(r.created_at).toLocaleString();
            const statusS = select(["Active", "Archived"], r.status);
            const fileLnk = r.file_url ? a(r.file_url, r.file_name || "PDF") : document.createElement("span"); if (!r.file_url) fileLnk.textContent = "—";

            const actions = document.createElement("div");
            const saveBtn = btn("bg-slate-800 text-white", "<i class='fa-solid fa-floppy-disk mr-1'></i>Save");
            const actBtn = btn("border border-slate-300", "<i class='fa-solid fa-toggle-on mr-1'></i>Activate");
            const arcBtn = btn("border border-slate-300", "<i class='fa-solid fa-box-archive mr-1'></i>Archive");
            const delBtn = btn("border border-rose-300 text-rose-700", "<i class='fa-solid fa-trash-can mr-1'></i>Delete");
            const prevBtn = btn("border border-slate-300", "<i class='fa-solid fa-eye mr-1'></i>Preview", true, r.file_url || "#");
            actions.append(saveBtn, actBtn, arcBtn, prevBtn, delBtn);

            tr.append(tdWrap(chk), tdWrap(titleI), tdWrap(yearI), tdWrap(regionI), tdWrap(uploaded),
                tdWrap(pill(r.status)), tdWrap(fileLnk), tdWrap(actions));
            rows.appendChild(tr);

            saveBtn.addEventListener("click", () => {
                if (!yearI.value.trim()) { toast("Year required", true); return; }
                if (isDup(yearI.value.trim(), (regionI.value || "").trim(), r.id)) { toast("Duplicate year+region exists", true); return; }
                r.title = titleI.value.trim();
                r.year = yearI.value.trim();
                r.region = regionI.value.trim();
                r.status = statusS.value; // from select not shown? keep pill for visual, but persist change
                persist(); toast("Saved ✓"); loadList();
            });
            actBtn.addEventListener("click", () => { r.status = 'Active'; persist(); loadList(); });
            arcBtn.addEventListener("click", () => { r.status = 'Archived'; persist(); loadList(); });
            delBtn.addEventListener("click", () => { if (!confirm("Delete this holiday list?")) return; STORE = STORE.filter(x => x.id !== r.id); persist(); loadList(); });
        });

        listMsg.textContent = data.length ? "" : "No holiday lists yet.";
    }
    function btn(cls, html, asLink = false, href = "#") {
        if (asLink) { const a = document.createElement('a'); a.href = href; a.target = "_blank"; a.rel = "noopener"; a.className = `px-2 py-1 mr-2 rounded-md text-xs hover:bg-slate-50 ${cls}`; a.innerHTML = html; return a; }
        const b = document.createElement('button'); b.className = `px-2 py-1 mr-2 rounded-md text-xs hover:bg-slate-50 ${cls}`; b.innerHTML = html; return b;
    }
    function isDup(year, region, id) {
        const key = `${year}__${(region || '').toLowerCase().trim()}`;
        return STORE.some(x => `${x.year}__${(x.region || '').toLowerCase().trim()}` === key && x.id !== id);
    }

    /* ---------- Upload (Dummy) ---------- */
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ["dragenter", "dragover"].forEach(evt => dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.add("ring", "ring-slate-300"); }));
    ["dragleave", "drop"].forEach(evt => dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.remove("ring", "ring-slate-300"); }));
    dropZone.addEventListener('drop', (e) => { const f = e.dataTransfer.files?.[0]; if (f) { fileInput.files = e.dataTransfer.files; toast('File selected: ' + f.name); } });

    uploadForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(uploadForm);
        const title = (fd.get("title") || "").toString().trim();
        const year = (fd.get("year") || "").toString().trim();
        const region = (fd.get("region") || "").toString().trim();
        const notes = (fd.get("notes") || "").toString().trim();
        const file = fd.get("file");
        if (!title || !year || !file) { flash("Missing required fields.", true); return; }
        if (file.type !== "application/pdf") { flash("Only PDF allowed.", true); return; }
        if (file.size > 5 * 1024 * 1024) { flash("File too large (max 5 MB).", true); return; }
        if (isDup(year, region, null)) { flash("A list for this Year+Region already exists.", true); return; }

        const id = Math.max(0, ...STORE.map(x => x.id)) + 1;
        STORE.unshift({
            id, title, year, region, notes, status: "Active",
            file_name: file.name || "uploaded.pdf",
            file_url: "#", // dummy
            created_at: new Date().toISOString()
        });
        persist();
        uploadForm.reset();
        flash("Uploaded ✓");
        loadList();
    });
    function flash(msg, bad = false) {
        uploadMsg.textContent = msg;
        uploadMsg.className = "text-sm " + (bad ? "text-rose-700" : "text-emerald-700");
        setTimeout(() => { uploadMsg.textContent = ""; uploadMsg.className = "text-sm text-slate-600"; }, 1500);
    }

    /* ---------- Bulk actions & utilities ---------- */
    function selectedIds() { return Array.from(document.querySelectorAll('.rowChk:checked')).map(x => Number(x.value)); }
    document.getElementById('bulkActivate').addEventListener('click', () => { const ids = selectedIds(); if (!ids.length) return toast("Select rows", true); STORE = STORE.map(x => ids.includes(x.id) ? { ...x, status: 'Active' } : x); persist(); loadList(); });
    document.getElementById('bulkArchive').addEventListener('click', () => { const ids = selectedIds(); if (!ids.length) return toast("Select rows", true); STORE = STORE.map(x => ids.includes(x.id) ? { ...x, status: 'Archived' } : x); persist(); loadList(); });
    document.getElementById('bulkDelete').addEventListener('click', () => { const ids = selectedIds(); if (!ids.length) return toast("Select rows", true); if (!confirm("Delete selected?")) return; STORE = STORE.filter(x => !ids.includes(x.id)); persist(); loadList(); });
    document.getElementById('bulkDownload').addEventListener('click', () => { const ids = selectedIds(); if (!ids.length) return toast("Select rows", true); const n = STORE.filter(x => ids.includes(x.id) && x.file_url).length; toast("📦 Downloading " + n + " file(s) (demo)"); });
    selAll.addEventListener('change', e => { document.querySelectorAll('.rowChk').forEach(c => c.checked = e.target.checked); });

    /* ---------- Filters, sort, export ---------- */
    [qEl, fYear, fRegion, fStatus, sortBy].forEach(el => el.addEventListener("input", loadList));
    clearBtn.addEventListener("click", () => { qEl.value = ""; fYear.value = ""; fRegion.value = ""; fStatus.value = ""; sortBy.value = "year_desc"; loadList(); });

    document.getElementById('exportCsv').addEventListener('click', () => {
        const data = sortData(filtered());
        const rows = [["id", "title", "year", "region", "status", "file_name", "uploaded", "notes"]];
        data.forEach(r => rows.push([r.id, r.title, r.year, r.region || "", r.status, r.file_name || "", r.created_at, r.notes || ""]));
        const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'holiday_lists.csv'; a.click(); URL.revokeObjectURL(url);
    });

    /* ---------- Init ---------- */
    loadList();
</script>
{% endblock %}