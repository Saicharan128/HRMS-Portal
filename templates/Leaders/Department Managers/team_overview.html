{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-people-group mr-2"></i> Team overview
            </h1>
            <p class="text-slate-600 text-sm">Get a snapshot of team composition, capacity, and status.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Summary cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-user-group mr-1"></i> Total Headcount</div>
            <div id="headcount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-briefcase mr-1"></i> Open Jobs</div>
            <div id="openJobs" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-person-digging mr-1"></i> In Pipeline</div>
            <div id="pipeline" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-user-check mr-1"></i> Recent Hires</div>
            <div id="recentHires" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Team Composition -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-pie mr-2"></i> By Employee Type
            </h2>
            <div id="typeComposition" class="space-y-3"></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-layer-group mr-2"></i> By Department
            </h2>
            <div id="deptComposition" class="space-y-3"></div>
        </div>
    </div>

    <!-- Team Members Table -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
            <h2 class="text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-users mr-2"></i> Team Members
            </h2>
            <div class="flex flex-wrap items-center gap-2">
                <input id="searchInput" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"
                    placeholder="Search name, email, or ID...">
                <select id="typeFilter" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                    <option value="">All Types</option>
                    <option value="Employees">Employees</option>
                    <option value="HR">HR</option>
                    <option value="Leaders">Leaders</option>
                    <option value="CXOs">CXOs</option>
                    <option value="Contractors / Remote staff">Contractors</option>
                </select>
                <button id="refreshBtn"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-refresh mr-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <i class="fa-solid fa-spinner fa-spin text-slate-400 text-2xl mb-2"></i>
            <p class="text-slate-600">Loading team data...</p>
        </div>

        <!-- Table -->
        <div id="tableContainer" class="hidden overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Employee ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Type
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Position</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Designation</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Email</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Joined</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Status</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody" class="bg-white divide-y divide-slate-200">
                    <!-- Dynamic rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-8">
            <i class="fa-solid fa-users-slash text-slate-300 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No team members found</h3>
            <p class="text-slate-600">Try adjusting your search criteria or filters.</p>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-8 rounded-2xl border border-slate-200 bg-white p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-clock-rotate-left mr-2"></i> Recent Activity
        </h2>
        <div id="recentActivity" class="space-y-4">
            <!-- Activity items will be loaded here -->
        </div>
    </div>
</div>

<script>
    // Global variables
    let teamData = [];
    let jobsData = [];
    let candidatesData = [];

    // Utility functions
    async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function getEmployeeStatus(createdAt) {
        const created = new Date(createdAt);
        const now = new Date();
        const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));

        if (daysDiff <= 30) return { text: 'New', class: 'bg-green-100 text-green-800' };
        if (daysDiff <= 90) return { text: 'Recent', class: 'bg-blue-100 text-blue-800' };
        return { text: 'Active', class: 'bg-slate-100 text-slate-800' };
    }

    function createProgressBar(current, total, label) {
        const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
        return `
        <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium text-slate-600">${label}</span>
            <span class="text-sm text-slate-600">${current}/${total}</span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2">
            <div class="bg-slate-600 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
        </div>
    `;
    }

    // Data loading functions
    async function loadTeamData() {
        try {
            teamData = await fetchJSON('/api/users');
            updateSummaryCards();
            updateComposition();
            renderTeamTable();
        } catch (error) {
            console.error('Error loading team data:', error);
            showError('Failed to load team data');
        }
    }

    async function loadJobsData() {
        try {
            jobsData = await fetchJSON('/api/jobs');
            const openJobs = jobsData.filter(job => job.status === 'Open').length;
            document.getElementById('openJobs').textContent = openJobs;
        } catch (error) {
            console.error('Error loading jobs data:', error);
            document.getElementById('openJobs').textContent = '0';
        }
    }

    async function loadCandidatesData() {
        try {
            candidatesData = await fetchJSON('/api/candidates');
            const inPipeline = candidatesData.filter(c =>
                !['Rejected', 'Onboarding'].includes(c.stage)
            ).length;
            const recentHires = candidatesData.filter(c =>
                c.stage === 'Onboarding' && c.created_at
            ).length;

            document.getElementById('pipeline').textContent = inPipeline;
            document.getElementById('recentHires').textContent = recentHires;
        } catch (error) {
            console.error('Error loading candidates data:', error);
            document.getElementById('pipeline').textContent = '0';
            document.getElementById('recentHires').textContent = '0';
        }
    }

    // UI update functions
    function updateSummaryCards() {
        document.getElementById('headcount').textContent = teamData.length;
    }

    function updateComposition() {
        // By Employee Type
        const typeComposition = {};
        const deptComposition = {};

        teamData.forEach(member => {
            // Type composition
            const type = member.employee_type || 'Unknown';
            typeComposition[type] = (typeComposition[type] || 0) + 1;

            // Department composition (using subposition as department)
            const dept = member.subposition || 'Unassigned';
            deptComposition[dept] = (deptComposition[dept] || 0) + 1;
        });

        renderComposition('typeComposition', typeComposition);
        renderComposition('deptComposition', deptComposition);
    }

    function renderComposition(elementId, data) {
        const container = document.getElementById(elementId);
        const total = Object.values(data).reduce((sum, count) => sum + count, 0);

        container.innerHTML = Object.entries(data)
            .sort(([, a], [, b]) => b - a)
            .map(([key, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                return `
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-slate-400 mr-3"></div>
                        <span class="text-sm font-medium text-slate-700">${key}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-slate-800">${count}</div>
                        <div class="text-xs text-slate-500">${percentage}%</div>
                    </div>
                </div>
            `;
            }).join('');
    }

    function renderTeamTable() {
        const tbody = document.getElementById('teamTableBody');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;

        // Filter data
        let filteredData = teamData.filter(member => {
            const matchesSearch = !searchTerm ||
                (member.name || '').toLowerCase().includes(searchTerm) ||
                (member.email || '').toLowerCase().includes(searchTerm) ||
                (member.employee_id || '').toLowerCase().includes(searchTerm) ||
                (member.username || '').toLowerCase().includes(searchTerm);

            const matchesType = !typeFilter || member.employee_type === typeFilter;

            return matchesSearch && matchesType;
        });

        // Show/hide states
        if (filteredData.length === 0) {
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }

        document.getElementById('tableContainer').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');

        // Render rows
        tbody.innerHTML = filteredData.map(member => {
            const status = getEmployeeStatus(member.created_at);
            return `
            <tr class="hover:bg-slate-50">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center mr-3">
                            <i class="fa-solid fa-user text-slate-500 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-slate-800">${member.name || '-'}</div>
                            <div class="text-sm text-slate-500">@${member.username || '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${member.employee_id || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${member.employee_type || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${member.subposition || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${member.designation || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${member.email || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${formatDate(member.created_at)}</td>
                <td class="px-4 py-3">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${status.class}">
                        ${status.text}
                    </span>
                </td>
            </tr>
        `;
        }).join('');
    }

    function loadRecentActivity() {
        const activityContainer = document.getElementById('recentActivity');

        // Generate some sample recent activity
        const activities = [];

        // Recent hires
        const recentHires = teamData
            .filter(member => {
                const created = new Date(member.created_at);
                const daysAgo = Math.floor((new Date() - created) / (1000 * 60 * 60 * 24));
                return daysAgo <= 30;
            })
            .slice(0, 3);

        recentHires.forEach(hire => {
            activities.push({
                type: 'hire',
                icon: 'fa-user-plus',
                iconClass: 'text-green-600 bg-green-100',
                title: `${hire.name} joined as ${hire.subposition}`,
                time: formatDate(hire.created_at),
                description: `New ${hire.employee_type} team member`
            });
        });

        // If no recent activity, show message
        if (activities.length === 0) {
            activityContainer.innerHTML = `
            <div class="text-center py-6">
                <i class="fa-solid fa-clock text-slate-300 text-2xl mb-2"></i>
                <p class="text-slate-500">No recent activity to display</p>
            </div>
        `;
            return;
        }

        activityContainer.innerHTML = activities.map(activity => `
        <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-slate-50">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 rounded-full ${activity.iconClass} flex items-center justify-center">
                    <i class="fa-solid ${activity.icon} text-sm"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-slate-800">${activity.title}</div>
                <div class="text-sm text-slate-500">${activity.description}</div>
                <div class="text-xs text-slate-400 mt-1">${activity.time}</div>
            </div>
        </div>
    `).join('');
    }

    function showError(message) {
        // Simple error display - you can enhance this with toast notifications
        console.error(message);
        // You could add a toast notification system here
    }

    async function initializePage() {
        // Show loading state
        document.getElementById('loadingState').classList.remove('hidden');

        try {
            // Load all data in parallel
            await Promise.all([
                loadTeamData(),
                loadJobsData(),
                loadCandidatesData()
            ]);

            // Load recent activity
            loadRecentActivity();

            // Hide loading state
            document.getElementById('loadingState').classList.add('hidden');
        } catch (error) {
            console.error('Error initializing page:', error);
            document.getElementById('loadingState').innerHTML = `
            <div class="text-center py-8">
                <i class="fa-solid fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                <p class="text-red-600">Failed to load team overview data</p>
                <button onclick="initializePage()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Try Again
                </button>
            </div>
        `;
        }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderTeamTable);
    document.getElementById('typeFilter').addEventListener('change', renderTeamTable);
    document.getElementById('refreshBtn').addEventListener('click', initializePage);

    // Initialize page when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

{% endblock %}