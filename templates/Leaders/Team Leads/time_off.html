{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-plane-departure mr-2"></i> Time off
            </h1>
            <p class="text-slate-600 text-sm">Centralize leave requests, balances, and approvals.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Balances -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-scale-balanced mr-2"></i> My balances
            </h2>
            <div id="adminBalanceTools" class="hidden flex items-center gap-2">
                <input id="balUser" placeholder="username" class="rounded-xl border border-slate-300 px-3 py-2 text-sm">
                <button id="balLoad"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">Load</button>
                <button id="balSave"
                    class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">Save</button>
            </div>
        </div>
        <div id="balances" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3"></div>
        <div id="balMsg" class="mt-2 text-sm"></div>
    </div>

    <!-- Request form -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-3">
            <i class="fa-solid fa-file-pen mr-2"></i> Request time off
        </h2>
        <form id="reqForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-slate-600 mb-1">Type</label>
                <select name="leave_type" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                    <option>Annual</option>
                    <option>Sick</option>
                    <option>Casual</option>
                    <option>Unpaid</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Reason</label>
                <input name="reason" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Start date</label>
                <input name="start_date" type="date" required
                    class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">End date</label>
                <input name="end_date" type="date" required
                    class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div class="md:col-span-2 flex items-center justify-end">
                <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900"
                    type="submit">Submit</button>
            </div>
        </form>
        <div id="reqMsg" class="mt-2 text-sm"></div>
    </div>

    <!-- My requests -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-800">
                <i class="fa-regular fa-calendar-check mr-2"></i> My requests
            </h2>
            <div class="flex items-center gap-2">
                <select id="myStatus" class="rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All</option>
                    <option>Pending</option>
                    <option>Approved</option>
                    <option>Rejected</option>
                    <option>Cancelled</option>
                </select>
                <button id="myReload"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-rotate mr-1"></i> Reload
                </button>
            </div>
        </div>
        <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">Type</th>
                        <th class="py-2 pr-3">Dates</th>
                        <th class="py-2 pr-3">Days</th>
                        <th class="py-2 pr-3">Reason</th>
                        <th class="py-2 pr-3">Status</th>
                        <th class="py-2 pr-3 w-40">Action</th>
                    </tr>
                </thead>
                <tbody id="myRows"></tbody>
            </table>
        </div>
    </div>

    <!-- Approvals (HR/Leaders) -->
    <div id="approvalsBlock" class="mt-6 rounded-2xl border border-slate-200 bg-white p-6 hidden">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-user-check mr-2"></i> Approvals (Pending)
            </h2>
            <button id="apReload"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-rotate mr-1"></i> Reload
            </button>
        </div>
        <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">User</th>
                        <th class="py-2 pr-3">Type</th>
                        <th class="py-2 pr-3">Dates</th>
                        <th class="py-2 pr-3">Days</th>
                        <th class="py-2 pr-3">Reason</th>
                        <th class="py-2 pr-3 w-56">Action</th>
                    </tr>
                </thead>
                <tbody id="apRows"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const IS_APPROVER = ["HR", "Leaders"].includes("{{ session.get('employee_type') }}");

    // ---- balances ----
    const balancesDiv = document.getElementById("balances");
    const balMsg = document.getElementById("balMsg");
    const adminTools = document.getElementById("adminBalanceTools");
    const balUser = document.getElementById("balUser");
    const balLoad = document.getElementById("balLoad");
    const balSave = document.getElementById("balSave");

    let CURRENT_BAL_USER = null;
    let BALANCES = []; // [{leave_type,balance_days}]

    function renderBalances() {
        balancesDiv.innerHTML = "";
        BALANCES.forEach(b => {
            const card = document.createElement("div");
            card.className = "rounded-xl border border-slate-200 bg-white p-3";
            card.innerHTML = `
      <div class="text-xs text-slate-500">${b.leave_type}</div>
      <div class="text-xl font-semibold text-slate-800 mt-1">
        <input data-type="${b.leave_type}" type="number" min="0" ${IS_APPROVER && CURRENT_BAL_USER ? "" : "readonly"}
         value="${b.balance_days}" class="w-20 rounded-lg border border-slate-300 px-2 py-1 text-sm text-right">
      </div>`;
            balancesDiv.appendChild(card);
        });
    }

    async function loadBalances(username) {
        const q = username ? `?user=${encodeURIComponent(username)}` : "";
        const r = await fetch(`/api/leave/balances${q}`);
        if (!r.ok) { balMsg.className = "mt-2 text-sm text-rose-700"; balMsg.textContent = "Failed to load balances"; return; }
        BALANCES = await r.json();
        renderBalances();
        balMsg.textContent = "";
    }

    // admin tools
    if (IS_APPROVER) { adminTools.classList.remove("hidden"); }
    balLoad?.addEventListener("click", () => { CURRENT_BAL_USER = balUser.value.trim(); loadBalances(CURRENT_BAL_USER); });
    balSave?.addEventListener("click", async () => {
        if (!IS_APPROVER || !CURRENT_BAL_USER) return;
        const payload = { user: CURRENT_BAL_USER, balances: {} };
        balancesDiv.querySelectorAll("input[data-type]").forEach(inp => {
            payload.balances[inp.dataset.type] = parseInt(inp.value || 0);
        });
        const r = await fetch("/api/leave/balances/set", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (r.ok) { balMsg.className = "mt-2 text-sm text-emerald-700"; balMsg.textContent = "Balances saved ✓"; }
        else { balMsg.className = "mt-2 text-sm text-rose-700"; balMsg.textContent = "Save failed"; }
    });

    // ---- request form ----
    const reqForm = document.getElementById("reqForm");
    const reqMsg = document.getElementById("reqMsg");
    reqForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        reqMsg.textContent = "Submitting…";
        const payload = Object.fromEntries(new FormData(reqForm).entries());
        const r = await fetch("/api/leaves", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (r.ok) {
            reqMsg.className = "mt-2 text-sm text-emerald-700"; reqMsg.textContent = "Request submitted ✓";
            reqForm.reset(); loadMy(); loadBalances(); // refresh
        } else {
            const t = await r.text(); reqMsg.className = "mt-2 text-sm text-rose-700"; reqMsg.textContent = t || "Failed";
        }
    });

    // ---- my requests ----
    const myRows = document.getElementById("myRows");
    const myStatus = document.getElementById("myStatus");
    const myReload = document.getElementById("myReload");

    async function loadMy() {
        const params = new URLSearchParams();
        if (myStatus.value) params.set("status", myStatus.value);
        const r = await fetch(`/api/leaves${params.toString() ? `?${params.toString()}` : ""}`);
        if (!r.ok) return;
        const rows = await r.json();
        myRows.innerHTML = "";
        rows.forEach(x => {
            const tr = document.createElement("tr");
            const cancelBtn = (x.status === "Pending")
                ? `<button data-id="${x.id}" class="px-2 py-1 rounded-md border border-slate-300 text-xs hover:bg-slate-50">Cancel</button>`
                : "";
            tr.innerHTML = `
      <td class="py-2 pr-3">${x.leave_type}</td>
      <td class="py-2 pr-3">${x.start_date} → ${x.end_date}</td>
      <td class="py-2 pr-3">${x.days}</td>
      <td class="py-2 pr-3">${x.reason || "—"}</td>
      <td class="py-2 pr-3">${x.status}${x.approver ? ` <span class="text-xs text-slate-500">(by ${x.approver})</span>` : ""}</td>
      <td class="py-2 pr-3">${cancelBtn}</td>`;
            myRows.appendChild(tr);
        });
        // wire cancel
        myRows.querySelectorAll("button[data-id]").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const r = await fetch(`/api/leaves/${id}/cancel`, { method: "POST" });
                if (r.ok) { loadMy(); } else { alert("Cancel failed"); }
            });
        });
    }

    myReload.addEventListener("click", () => loadMy().catch(console.error));
    myStatus.addEventListener("change", () => loadMy().catch(console.error));

    // ---- approvals ----
    const approvalsBlock = document.getElementById("approvalsBlock");
    const apRows = document.getElementById("apRows");
    const apReload = document.getElementById("apReload");

    if (IS_APPROVER) { approvalsBlock.classList.remove("hidden"); }

    async function loadApprovals() {
        if (!IS_APPROVER) return;
        const r = await fetch(`/api/leaves?scope=all&status=Pending`);
        if (!r.ok) return;
        const rows = await r.json();
        apRows.innerHTML = "";
        rows.forEach(x => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td class="py-2 pr-3 font-medium">${x.username}</td>
      <td class="py-2 pr-3">${x.leave_type}</td>
      <td class="py-2 pr-3">${x.start_date} → ${x.end_date}</td>
      <td class="py-2 pr-3">${x.days}</td>
      <td class="py-2 pr-3">${x.reason || "—"}</td>
      <td class="py-2 pr-3">
        <button data-id="${x.id}" data-a="approve" class="px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900">Approve</button>
        <button data-id="${x.id}" data-a="reject" class="px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50">Reject</button>
      </td>`;
            apRows.appendChild(tr);
        });

        apRows.querySelectorAll("button[data-id]").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id, action = btn.dataset.a;
                const r = await fetch(`/api/leaves/${id}/decision`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action }) });
                if (r.ok) { loadApprovals(); } else { alert("Action failed"); }
            });
        });
    }

    apReload.addEventListener("click", () => loadApprovals().catch(console.error));

    // boot
    Promise.all([loadBalances(), loadMy(), loadApprovals()]).catch(console.error);
</script>
{% endblock %}