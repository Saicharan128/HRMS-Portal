{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-money-bill-trend-up mr-2"></i> Salary Explorer
            </h1>
            <p class="text-slate-600 text-sm">Compare salary benchmarks and analyze pay structures.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportAnalysisBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export Analysis
            </button>
            <button id="benchmarkToolBtn"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-chart-line mr-1"></i> Benchmark Tool
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-dollar-sign mr-1"></i> Avg Salary</div>
            <div id="avgSalary" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
            <div class="text-xs text-green-600 mt-1">↑ 5.2% vs market</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-line mr-1"></i> Median Salary</div>
            <div id="medianSalary" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
            <div class="text-xs text-blue-600 mt-1">Market aligned</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-balance-scale mr-1"></i> Pay Equity Score</div>
            <div id="equityScore" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
            <div class="text-xs text-green-600 mt-1">Within range</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-trophy mr-1"></i> Top Quartile</div>
            <div id="topQuartile" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
            <div class="text-xs text-slate-600 mt-1">High performers</div>
        </div>
    </div>

    <!-- Analysis Controls -->
    <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Analysis Type:</label>
                <select id="analysisType" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="internal">Internal Analysis</option>
                    <option value="market">Market Comparison</option>
                    <option value="equity">Pay Equity Analysis</option>
                    <option value="bands">Salary Bands</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Department:</label>
                <select id="departmentFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All Departments</option>
                    <option value="engineering">Engineering</option>
                    <option value="sales">Sales</option>
                    <option value="marketing">Marketing</option>
                    <option value="hr">Human Resources</option>
                    <option value="finance">Finance</option>
                    <option value="operations">Operations</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Level:</label>
                <select id="levelFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All Levels</option>
                    <option value="entry">Entry Level</option>
                    <option value="mid">Mid Level</option>
                    <option value="senior">Senior Level</option>
                    <option value="lead">Lead/Manager</option>
                    <option value="director">Director</option>
                    <option value="executive">Executive</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Location:</label>
                <select id="locationFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All Locations</option>
                    <option value="san-francisco">San Francisco</option>
                    <option value="new-york">New York</option>
                    <option value="austin">Austin</option>
                    <option value="remote">Remote</option>
                </select>
            </div>
            <button id="refreshAnalysis" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                <i class="fa-solid fa-rotate mr-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Main Analysis Dashboard -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Salary Distribution Chart -->
        <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-chart-bar mr-2"></i> Salary Distribution
                </h3>
                <div class="flex items-center gap-2">
                    <button id="chartTypeBtn"
                        class="px-2 py-1 rounded text-xs border border-slate-300 hover:bg-slate-50">
                        <i class="fa-solid fa-chart-column"></i>
                    </button>
                    <button id="fullscreenChart"
                        class="px-2 py-1 rounded text-xs border border-slate-300 hover:bg-slate-50">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="relative h-80">
                <canvas id="salaryChart"></canvas>
            </div>
        </div>

        <!-- Market Comparison -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-bullseye mr-2"></i> Market Position
            </h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div>
                        <div class="text-sm font-medium text-slate-800">25th Percentile</div>
                        <div class="text-xs text-slate-600">Below market</div>
                    </div>
                    <div class="text-lg font-bold text-slate-800" id="percentile25">$65K</div>
                </div>
                <div class="flex items-center justify-between p-3 rounded-lg bg-blue-50">
                    <div>
                        <div class="text-sm font-medium text-slate-800">50th Percentile</div>
                        <div class="text-xs text-slate-600">Market rate</div>
                    </div>
                    <div class="text-lg font-bold text-blue-600" id="percentile50">$85K</div>
                </div>
                <div class="flex items-center justify-between p-3 rounded-lg bg-green-50">
                    <div>
                        <div class="text-sm font-medium text-slate-800">75th Percentile</div>
                        <div class="text-xs text-slate-600">Above market</div>
                    </div>
                    <div class="text-lg font-bold text-green-600" id="percentile75">$105K</div>
                </div>
                <div class="flex items-center justify-between p-3 rounded-lg bg-purple-50">
                    <div>
                        <div class="text-sm font-medium text-slate-800">90th Percentile</div>
                        <div class="text-xs text-slate-600">Top tier</div>
                    </div>
                    <div class="text-lg font-bold text-purple-600" id="percentile90">$130K</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Comparison & Pay Equity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Department Comparison -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-building mr-2"></i> Department Analysis
            </h3>
            <div class="space-y-3" id="departmentAnalysis">
                <!-- Department data will be populated here -->
            </div>
        </div>

        <!-- Pay Equity Analysis -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-balance-scale mr-2"></i> Pay Equity Analysis
            </h3>
            <div class="space-y-4">
                <div class="p-3 rounded-lg bg-green-50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-800">Gender Pay Gap</span>
                        <span class="text-sm font-bold text-green-600">2.3%</span>
                    </div>
                    <div class="w-full bg-green-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 97.7%"></div>
                    </div>
                    <div class="text-xs text-slate-600 mt-1">Within acceptable range (< 5%)</div>
                    </div>

                    <div class="p-3 rounded-lg bg-yellow-50">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-800">Experience Gap</span>
                            <span class="text-sm font-bold text-yellow-600">7.1%</span>
                        </div>
                        <div class="w-full bg-yellow-200 rounded-full h-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 92.9%"></div>
                        </div>
                        <div class="text-xs text-slate-600 mt-1">Review recommended</div>
                    </div>

                    <div class="p-3 rounded-lg bg-blue-50">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-800">Department Variance</span>
                            <span class="text-sm font-bold text-blue-600">4.8%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 95.2%"></div>
                        </div>
                        <div class="text-xs text-slate-600 mt-1">Good alignment across teams</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Salary Benchmarking Table -->
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-table mr-2"></i> Position Benchmarks
                    </h2>
                    <div class="flex items-center gap-2">
                        <input id="searchPositions" type="text" placeholder="Search positions..."
                            class="rounded-lg border border-slate-300 px-3 py-2 text-sm" />
                        <select id="benchmarkView" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="all">All Positions</option>
                            <option value="outdated">Need Review</option>
                            <option value="competitive">Competitive</option>
                            <option value="below-market">Below Market</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="benchmarkLoadingState" class="p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
                <p class="mt-2 text-sm text-slate-600">Loading benchmark data...</p>
            </div>

            <!-- Benchmarks Table -->
            <div id="benchmarksTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Position</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Level</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Our Range</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Market Range</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Variance</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Employees</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Last Updated</th>
                                <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="benchmarksTableBody" class="divide-y divide-slate-200">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Benchmark Tool Modal -->
    <div id="benchmarkToolModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="fixed inset-0 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-slate-800">
                                <i class="fa-solid fa-chart-line mr-2"></i> Salary Benchmark Tool
                            </h3>
                            <button id="closeBenchmarkModal" class="text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Position Details -->
                            <div class="space-y-4">
                                <h4 class="font-medium text-slate-800">Position Details</h4>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Job Title *</label>
                                    <input type="text" id="benchmarkJobTitle" required
                                        class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                                        <select id="benchmarkDepartment"
                                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                            <option value="">Select Department</option>
                                            <option value="engineering">Engineering</option>
                                            <option value="sales">Sales</option>
                                            <option value="marketing">Marketing</option>
                                            <option value="hr">Human Resources</option>
                                            <option value="finance">Finance</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Level</label>
                                        <select id="benchmarkLevel"
                                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                            <option value="">Select Level</option>
                                            <option value="entry">Entry Level</option>
                                            <option value="mid">Mid Level</option>
                                            <option value="senior">Senior Level</option>
                                            <option value="lead">Lead/Manager</option>
                                            <option value="director">Director</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                                        <select id="benchmarkLocation"
                                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                            <option value="">Select Location</option>
                                            <option value="san-francisco">San Francisco</option>
                                            <option value="new-york">New York</option>
                                            <option value="austin">Austin</option>
                                            <option value="remote">Remote</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Experience
                                            (Years)</label>
                                        <input type="number" id="benchmarkExperience" min="0" max="30"
                                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Skills
                                        (comma-separated)</label>
                                    <textarea id="benchmarkSkills" rows="3"
                                        placeholder="e.g., JavaScript, React, Node.js, Python"
                                        class="w-full rounded-lg border border-slate-300 px-3 py-2"></textarea>
                                </div>

                                <button id="runBenchmarkBtn"
                                    class="w-full px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">
                                    <i class="fa-solid fa-search mr-2"></i> Run Benchmark Analysis
                                </button>
                            </div>

                            <!-- Results -->
                            <div class="space-y-4">
                                <h4 class="font-medium text-slate-800">Market Analysis Results</h4>

                                <div id="benchmarkResults" class="hidden">
                                    <!-- Salary Range Card -->
                                    <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                                        <h5 class="font-medium text-slate-800 mb-3">Recommended Salary Range</h5>
                                        <div class="grid grid-cols-2 gap-4 text-center">
                                            <div class="p-3 rounded bg-white">
                                                <div class="text-xs text-slate-500 mb-1">Minimum</div>
                                                <div id="benchmarkMin" class="text-lg font-bold text-slate-800">$75,000
                                                </div>
                                            </div>
                                            <div class="p-3 rounded bg-white">
                                                <div class="text-xs text-slate-500 mb-1">Maximum</div>
                                                <div id="benchmarkMax" class="text-lg font-bold text-slate-800">$95,000
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Market Percentiles -->
                                    <div class="p-4 rounded-lg border border-slate-200">
                                        <h5 class="font-medium text-slate-800 mb-3">Market Percentiles</h5>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-sm">25th Percentile:</span>
                                                <span class="font-medium">$68,000</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm">50th Percentile:</span>
                                                <span class="font-medium">$82,000</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm">75th Percentile:</span>
                                                <span class="font-medium">$98,000</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm">90th Percentile:</span>
                                                <span class="font-medium">$115,000</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Data Sources -->
                                    <div class="p-4 rounded-lg border border-slate-200">
                                        <h5 class="font-medium text-slate-800 mb-3">Data Sources</h5>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-check text-green-500"></i>
                                                <span>Glassdoor (1,247 data points)</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-check text-green-500"></i>
                                                <span>PayScale (892 data points)</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-check text-green-500"></i>
                                                <span>Indeed (543 data points)</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-check text-green-500"></i>
                                                <span>LinkedIn (376 data points)</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex gap-3">
                                        <button id="saveBenchmarkBtn"
                                            class="flex-1 px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">
                                            <i class="fa-solid fa-save mr-1"></i> Save Analysis
                                        </button>
                                        <button id="exportBenchmarkBtn"
                                            class="flex-1 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">
                                            <i class="fa-solid fa-download mr-1"></i> Export
                                        </button>
                                    </div>
                                </div>

                                <!-- Loading State -->
                                <div id="benchmarkAnalysisLoading" class="hidden text-center py-8">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="mt-2 text-sm text-slate-600">Analyzing market data...</p>
                                </div>

                                <!-- Empty State -->
                                <div id="benchmarkEmptyState" class="text-center py-8 text-slate-500">
                                    <i class="fa-solid fa-chart-line text-4xl mb-4"></i>
                                    <p>Fill out the position details and click "Run Benchmark Analysis" to see market
                                        data.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize salary explorer
        document.addEventListener('DOMContentLoaded', function () {
            initializeSalaryExplorer();
        });

        // Global state
        let salaryData = [];
        let benchmarkData = [];
        let currentAnalysis = 'internal';

        async function initializeSalaryExplorer() {
            await loadSalaryData();
            setupEventListeners();
            renderAnalysis();
        }

        async function loadSalaryData() {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Mock salary data
                const mockData = {
                    summary: {
                        avgSalary: 87500,
                        medianSalary: 82000,
                        equityScore: 94,
                        topQuartile: 105000
                    },
                    distribution: [
                        { range: '40K-60K', count: 12, percentage: 8.5 },
                        { range: '60K-80K', count: 45, percentage: 32.1 },
                        { range: '80K-100K', count: 58, percentage: 41.4 },
                        { range: '100K-120K', count: 18, percentage: 12.9 },
                        { range: '120K+', count: 7, percentage: 5.0 }
                    ],
                    departments: [
                        { name: 'Engineering', avgSalary: 95000, count: 45, variance: 2.3 },
                        { name: 'Sales', avgSalary: 78000, count: 28, variance: -5.2 },
                        { name: 'Marketing', avgSalary: 72000, count: 22, variance: -1.8 },
                        { name: 'HR', avgSalary: 68000, count: 15, variance: 3.1 },
                        { name: 'Finance', avgSalary: 83000, count: 18, variance: 1.7 }
                    ],
                    benchmarks: [
                        {
                            id: 1,
                            position: 'Software Engineer',
                            level: 'Senior',
                            ourRange: { min: 85000, max: 110000 },
                            marketRange: { min: 90000, max: 115000 },
                            variance: -5.2,
                            employees: 12,
                            lastUpdated: '2024-01-10'
                        },
                        {
                            id: 2,
                            position: 'Product Manager',
                            level: 'Mid',
                            ourRange: { min: 75000, max: 95000 },
                            marketRange: { min: 80000, max: 100000 },
                            variance: -6.7,
                            employees: 8,
                            lastUpdated: '2024-01-08'
                        },
                        {
                            id: 3,
                            position: 'Sales Representative',
                            level: 'Entry',
                            ourRange: { min: 45000, max: 65000 },
                            marketRange: { min: 42000, max: 62000 },
                            variance: 4.8,
                            employees: 15,
                            lastUpdated: '2024-01-12'
                        }
                    ]
                };

                salaryData = mockData;
                updateSummaryCards();

            } catch (error) {
                console.error('Error loading salary data:', error);
                showError('Failed to load salary data');
            }
        }

        function updateSummaryCards() {
            const { summary } = salaryData;

            document.getElementById('avgSalary').textContent = `${(summary.avgSalary / 1000).toFixed(0)}K`;
            document.getElementById('medianSalary').textContent = `${(summary.medianSalary / 1000).toFixed(0)}K`;
            document.getElementById('equityScore').textContent = `${summary.equityScore}%`;
            document.getElementById('topQuartile').textContent = `${(summary.topQuartile / 1000).toFixed(0)}K`;
        }

        function setupEventListeners() {
            // Analysis type change
            document.getElementById('analysisType').addEventListener('change', (e) => {
                currentAnalysis = e.target.value;
                renderAnalysis();
            });

            // Filter changes
            ['departmentFilter', 'levelFilter', 'locationFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', renderAnalysis);
            });

            // Modal controls
            document.getElementById('benchmarkToolBtn').addEventListener('click', openBenchmarkModal);
            document.getElementById('closeBenchmarkModal').addEventListener('click', closeBenchmarkModal);
            document.getElementById('runBenchmarkBtn').addEventListener('click', runBenchmarkAnalysis);
            document.getElementById('saveBenchmarkBtn').addEventListener('click', saveBenchmarkAnalysis);
            document.getElementById('exportBenchmarkBtn').addEventListener('click', exportBenchmarkAnalysis);

            // Other controls
            document.getElementById('refreshAnalysis').addEventListener('click', loadSalaryData);
            document.getElementById('exportAnalysisBtn').addEventListener('click', exportAnalysis);
            document.getElementById('searchPositions').addEventListener('input', debounce(filterBenchmarks, 300));
            document.getElementById('benchmarkView').addEventListener('change', filterBenchmarks);

            // Chart controls
            document.getElementById('chartTypeBtn').addEventListener('click', toggleChartType);
            document.getElementById('fullscreenChart').addEventListener('click', fullscreenChart);
        }

        function renderAnalysis() {
            renderSalaryChart();
            renderDepartmentAnalysis();
            renderBenchmarksTable();
            updateMarketComparison();
        }

        function renderSalaryChart() {
            const ctx = document.getElementById('salaryChart').getContext('2d');

            // Destroy existing chart
            if (window.salaryChartInstance) {
                window.salaryChartInstance.destroy();
            }

            const chartData = {
                labels: salaryData.distribution.map(d => d.range),
                datasets: [{
                    label: 'Number of Employees',
                    data: salaryData.distribution.map(d => d.count),
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            };

            window.salaryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const percentage = salaryData.distribution[context.dataIndex].percentage;
                                    return `${percentage}% of workforce`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderDepartmentAnalysis() {
            const container = document.getElementById('departmentAnalysis');
            container.innerHTML = '';

            salaryData.departments.forEach(dept => {
                const isPositive = dept.variance > 0;
                const varianceClass = isPositive ? 'text-green-600' : 'text-red-600';
                const varianceIcon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';

                const deptCard = document.createElement('div');
                deptCard.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors';

                deptCard.innerHTML = `
            <div>
                <div class="font-medium text-slate-800">${dept.name}</div>
                <div class="text-sm text-slate-600">${dept.count} employees</div>
            </div>
            <div class="text-right">
                <div class="font-bold text-slate-800">${(dept.avgSalary / 1000).toFixed(0)}K</div>
                <div class="text-xs ${varianceClass} flex items-center gap-1">
                    <i class="fa-solid ${varianceIcon}"></i>
                    ${Math.abs(dept.variance)}% vs market
                </div>
            </div>
        `;

                container.appendChild(deptCard);
            });
        }

        function renderBenchmarksTable() {
            const tbody = document.getElementById('benchmarksTableBody');
            tbody.innerHTML = '';

            document.getElementById('benchmarkLoadingState').classList.add('hidden');
            document.getElementById('benchmarksTable').classList.remove('hidden');

            salaryData.benchmarks.forEach(benchmark => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';

                const isBelow = benchmark.variance < -5;
                const isAbove = benchmark.variance > 5;
                let varianceClass = 'text-slate-600';
                let statusBadge = 'bg-green-100 text-green-700';
                let statusText = 'Competitive';

                if (isBelow) {
                    varianceClass = 'text-red-600';
                    statusBadge = 'bg-red-100 text-red-700';
                    statusText = 'Below Market';
                } else if (isAbove) {
                    varianceClass = 'text-blue-600';
                    statusBadge = 'bg-blue-100 text-blue-700';
                    statusText = 'Above Market';
                }

                row.innerHTML = `
            <td class="px-6 py-4">
                <div class="font-medium text-slate-800">${benchmark.position}</div>
                <div class="text-sm text-slate-600">ID: ${benchmark.id}</div>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 text-slate-700">
                    ${benchmark.level}
                </span>
            </td>
            <td class="px-6 py-4 text-slate-800">
                ${(benchmark.ourRange.min / 1000).toFixed(0)}K - ${(benchmark.ourRange.max / 1000).toFixed(0)}K
            </td>
            <td class="px-6 py-4 text-slate-800">
                ${(benchmark.marketRange.min / 1000).toFixed(0)}K - ${(benchmark.marketRange.max / 1000).toFixed(0)}K
            </td>
            <td class="px-6 py-4">
                <span class="font-medium ${varianceClass}">
                    ${benchmark.variance > 0 ? '+' : ''}${benchmark.variance.toFixed(1)}%
                </span>
            </td>
            <td class="px-6 py-4 text-slate-800">${benchmark.employees}</td>
            <td class="px-6 py-4 text-slate-600">${formatDate(benchmark.lastUpdated)}</td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <button onclick="editBenchmark(${benchmark.id})" 
                        class="text-blue-600 hover:text-blue-800" title="Edit">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button onclick="refreshBenchmark(${benchmark.id})" 
                        class="text-green-600 hover:text-green-800" title="Refresh Data">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    <button onclick="viewBenchmarkDetails(${benchmark.id})" 
                        class="text-purple-600 hover:text-purple-800" title="View Details">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </td>
        `;

                tbody.appendChild(row);
            });
        }

        function updateMarketComparison() {
            // Update percentile values based on current filters
            document.getElementById('percentile25').textContent = '$65K';
            document.getElementById('percentile50').textContent = '$82K';
            document.getElementById('percentile75').textContent = '$105K';
            document.getElementById('percentile90').textContent = '$130K';
        }

        function openBenchmarkModal() {
            document.getElementById('benchmarkToolModal').classList.remove('hidden');
            document.getElementById('benchmarkEmptyState').classList.remove('hidden');
            document.getElementById('benchmarkResults').classList.add('hidden');
            document.getElementById('benchmarkAnalysisLoading').classList.add('hidden');
        }

        function closeBenchmarkModal() {
            document.getElementById('benchmarkToolModal').classList.add('hidden');
            // Reset form
            document.getElementById('benchmarkJobTitle').value = '';
            document.getElementById('benchmarkDepartment').value = '';
            document.getElementById('benchmarkLevel').value = '';
            document.getElementById('benchmarkLocation').value = '';
            document.getElementById('benchmarkExperience').value = '';
            document.getElementById('benchmarkSkills').value = '';
        }

        async function runBenchmarkAnalysis() {
            const jobTitle = document.getElementById('benchmarkJobTitle').value.trim();

            if (!jobTitle) {
                showError('Please enter a job title');
                return;
            }

            try {
                // Show loading state
                document.getElementById('benchmarkEmptyState').classList.add('hidden');
                document.getElementById('benchmarkResults').classList.add('hidden');
                document.getElementById('benchmarkAnalysisLoading').classList.remove('hidden');

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Show results
                document.getElementById('benchmarkAnalysisLoading').classList.add('hidden');
                document.getElementById('benchmarkResults').classList.remove('hidden');

                // Update results with mock data
                document.getElementById('benchmarkMin').textContent = '$75,000';
                document.getElementById('benchmarkMax').textContent = '$95,000';

                showSuccess('Benchmark analysis completed successfully!');

            } catch (error) {
                console.error('Error running benchmark:', error);
                document.getElementById('benchmarkAnalysisLoading').classList.add('hidden');
                document.getElementById('benchmarkEmptyState').classList.remove('hidden');
                showError('Failed to run benchmark analysis');
            }
        }

        function saveBenchmarkAnalysis() {
            showSuccess('Benchmark analysis saved successfully!');
        }

        function exportBenchmarkAnalysis() {
            showInfo('Exporting benchmark analysis...');
        }

        function exportAnalysis() {
            showInfo('Exporting salary analysis...');
        }

        function toggleChartType() {
            // Toggle between bar chart and line chart
            if (window.salaryChartInstance) {
                const currentType = window.salaryChartInstance.config.type;
                const newType = currentType === 'bar' ? 'line' : 'bar';

                window.salaryChartInstance.config.type = newType;

                if (newType === 'line') {
                    window.salaryChartInstance.data.datasets[0].fill = true;
                    window.salaryChartInstance.data.datasets[0].tension = 0.4;
                } else {
                    window.salaryChartInstance.data.datasets[0].fill = false;
                    window.salaryChartInstance.data.datasets[0].tension = 0;
                }

                window.salaryChartInstance.update();

                // Update button icon
                const icon = document.getElementById('chartTypeBtn').querySelector('i');
                icon.className = newType === 'bar' ? 'fa-solid fa-chart-line' : 'fa-solid fa-chart-column';
            }
        }

        function fullscreenChart() {
            showInfo('Fullscreen chart functionality would be implemented here');
        }

        function filterBenchmarks() {
            const searchTerm = document.getElementById('searchPositions').value.toLowerCase();
            const viewFilter = document.getElementById('benchmarkView').value;

            // In a real implementation, this would filter the table rows
            console.log('Filtering benchmarks:', { searchTerm, viewFilter });
        }

        function editBenchmark(benchmarkId) {
            showInfo(`Edit benchmark ${benchmarkId} functionality would be implemented here`);
        }

        function refreshBenchmark(benchmarkId) {
            showInfo(`Refreshing benchmark data for ${benchmarkId}...`);
            // In a real implementation, this would fetch updated market data
        }

        function viewBenchmarkDetails(benchmarkId) {
            const benchmark = salaryData.benchmarks.find(b => b.id === benchmarkId);
            if (benchmark) {
                showInfo(`Viewing details for ${benchmark.position} (${benchmark.level})`);
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Utility functions
        function showSuccess(message) {
            console.log('Success:', message);
            alert('✅ ' + message);
        }

        function showError(message) {
            console.log('Error:', message);
            alert('❌ ' + message);
        }

        function showInfo(message) {
            console.log('Info:', message);
            alert('ℹ️ ' + message);
        }

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('benchmarkToolModal');
            if (event.target === modal) {
                closeBenchmarkModal();
            }
        });

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            loadSalaryData();
        }, 5 * 60 * 1000);

        // Load Chart.js if not already loaded
        if (typeof Chart === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
            script.onload = () => {
                initializeSalaryExplorer();
            };
            document.head.appendChild(script);
        }
    </script>
    {% endblock %}