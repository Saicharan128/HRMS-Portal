{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Categories (unchanged) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- HR -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-blue-100 rounded-lg mr-3"><i class="fa-solid fa-users text-blue-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">HR Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('employee_roster')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-user-group mr-2 text-slate-500"></i> Employee Roster</button>
                <button onclick="generateQuickReport('headcount_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-chart-line mr-2 text-slate-500"></i> Headcount Analysis</button>
                <button onclick="generateQuickReport('turnover_report')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-door-open mr-2 text-slate-500"></i> Turnover Report</button>
                <button onclick="generateQuickReport('diversity_metrics')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> Diversity Metrics</button>
                <button onclick="generateQuickReport('recruitment_pipeline')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-funnel-dollar mr-2 text-slate-500"></i> Recruitment Pipeline</button>
            </div>
        </div>

        <!-- Performance -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-green-100 rounded-lg mr-3"><i class="fa-solid fa-chart-line text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Performance Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('performance_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-star mr-2 text-slate-500"></i> Performance Summary</button>
                <button onclick="generateQuickReport('goal_achievement')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-target mr-2 text-slate-500"></i> Goal Achievement</button>
                <button onclick="generateQuickReport('review_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-clipboard-check mr-2 text-slate-500"></i> Review Completion</button>
                <button onclick="generateQuickReport('top_performers')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-trophy mr-2 text-slate-500"></i> Top Performers</button>
                <button onclick="generateQuickReport('training_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-graduation-cap mr-2 text-slate-500"></i> Training Completion</button>
            </div>
        </div>

        <!-- Financial -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-yellow-100 rounded-lg mr-3"><i class="fa-solid fa-dollar-sign text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Financial Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('payroll_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-money-bill mr-2 text-slate-500"></i> Payroll Summary</button>
                <button onclick="generateQuickReport('cost_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-calculator mr-2 text-slate-500"></i> Cost Analysis</button>
                <button onclick="generateQuickReport('expense_reports')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-receipt mr-2 text-slate-500"></i> Expense Reports</button>
                <button onclick="generateQuickReport('budget_variance')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-chart-pie mr-2 text-slate-500"></i> Budget Variance</button>
                <button onclick="generateQuickReport('contractor_payments')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-handshake mr-2 text-slate-500"></i> Contractor Payments</button>
            </div>
        </div>
    </div>

    <!-- T&A + Compliance (unchanged content) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-purple-100 rounded-lg mr-3"><i class="fa-solid fa-clock text-purple-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Time & Attendance</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('attendance_summary')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-calendar-days mr-2 text-slate-500"></i> Attendance Summary</button>
                <button onclick="generateQuickReport('leave_analysis')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-plane-departure mr-2 text-slate-500"></i> Leave Analysis</button>
                <button onclick="generateQuickReport('overtime_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-clock mr-2 text-slate-500"></i> Overtime Report</button>
                <button onclick="generateQuickReport('tardiness_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-exclamation-triangle mr-2 text-slate-500"></i> Tardiness Report</button>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-red-100 rounded-lg mr-3"><i class="fa-solid fa-shield-halved text-red-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Compliance & Legal</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('eeo_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> EEO Report</button>
                <button onclick="generateQuickReport('safety_incidents')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-hard-hat mr-2 text-slate-500"></i> Safety Incidents</button>
                <button onclick="generateQuickReport('policy_compliance')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-file-contract mr-2 text-slate-500"></i> Policy Compliance</button>
                <button onclick="generateQuickReport('audit_trail')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-search mr-2 text-slate-500"></i> Audit Trail</button>
            </div>
        </div>
    </div>

    <!-- Reports Dashboard -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="p-6 border-b border-slate-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                <h2 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-list mr-2"></i> Generated Reports
                </h2>
                <div class="flex flex-col md:flex-row md:items-center gap-2">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Filter:</label>
                        <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="">All Types</option>
                            <option value="hr">HR Reports</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="attendance">Time & Attendance</option>
                            <option value="compliance">Compliance</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Period:</label>
                        <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Search:</label>
                        <input id="searchInput" placeholder="name / by / format…"
                            class="rounded-lg border border-slate-300 px-3 py-2 text-sm w-56">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Per page:</label>
                        <select id="pageSize" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                    </div>
                    <button id="exportCsv"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                    </button>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <!-- Empty -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Generated Yet</h3>
            <p class="text-slate-600 mb-4">Start by generating your first report from the categories above.</p>
        </div>

        <!-- Table -->
        <div id="reportsTable" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3">
                                <input id="selectAll" type="checkbox" class="rounded border-slate-300">
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="name">Report
                                Name <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="type">Type <i
                                    class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable"
                                data-key="generated_date">Generated <i class="fa-solid fa-sort text-slate-400 ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="generated_by">
                                Generated By <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Size</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="status">Status
                                <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Footer actions + Pagination -->
            <div class="p-6 border-t border-slate-200 flex flex-col sm:flex-row gap-3 items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="bulkDelete"
                        class="px-3 py-1.5 rounded border border-rose-300 text-rose-700 text-sm hover:bg-rose-50"
                        disabled>
                        <i class="fa-solid fa-trash-can mr-1"></i> Delete selected
                    </button>
                    <span id="selectionCount" class="text-sm text-slate-500 hidden">0 selected</span>
                </div>
                <div class="text-sm text-slate-600">Showing <span id="pageInfo">0-0 of 0</span> reports</div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Previous</button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal (same UI as before) -->
<!-- ... keep your existing generate + preview modals & toasts; script below wires them ... -->

<script>
    // ======= state =======
    let reports = [];
    let filteredReports = [];
    let currentPage = 1;
    let totalPages = 1;
    let reportIdCounter = 6;
    let sortKey = "generated_date";
    let sortDir = "desc"; // 'asc' | 'desc'
    const LSKEY = "all_reports_state";

    // ======= boot =======
    document.addEventListener('DOMContentLoaded', () => {
        initializeReports();
    });

    async function initializeReports() {
        restoreState();
        await loadReportsData();
        setupEventListeners();
        renderReports();
    }

    // ======= data =======
    async function loadReportsData() {
        try {
            document.getElementById('loadingState').classList.remove('hidden');
            await new Promise(r => setTimeout(r, 600)); // simulate
            reports = [
                { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", format: "pdf", status: "completed", download_count: 15 },
                { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", format: "excel", status: "completed", download_count: 8 },
                { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", format: "pdf", status: "completed", download_count: 22 },
                { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", format: "csv", status: "processing", download_count: 0 },
                { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "987 KB", format: "pdf", status: "failed", download_count: 5 }
            ];
            filteredReports = [...reports];
            updateSummaryStats();
        } catch (e) {
            showError('Failed to load reports data');
            console.error(e);
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
        }
    }

    // ======= summary =======
    function updateSummaryStats() {
        const today = new Date().toDateString();
        const todayCnt = reports.filter(r => new Date(r.generated_date).toDateString() === today).length;
        const downloads = reports.reduce((s, r) => s + (r.download_count || 0), 0);
        const scheduled = 3; // mock
        document.getElementById('totalReports').textContent = reports.length;
        document.getElementById('todayReports').textContent = todayCnt;
        document.getElementById('totalDownloads').textContent = downloads;
        document.getElementById('scheduledReports').textContent = scheduled;
    }

    // ======= filters/search/sort/persistence =======
    function applyFilters() {
        const typeFilter = document.getElementById('reportTypeFilter').value;
        const periodFilter = document.getElementById('periodFilter').value;
        const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();

        filteredReports = reports.filter(report => {
            // type
            const okType = !typeFilter || report.type === typeFilter;
            // period
            let okPeriod = true;
            if (periodFilter && periodFilter !== 'all') {
                const cutoff = new Date(Date.now() - parseInt(periodFilter) * 86400000);
                okPeriod = new Date(report.generated_date) >= cutoff;
            }
            // search: name, by, format
            const hay = `${report.name} ${report.generated_by} ${report.format}`.toLowerCase();
            const okQ = !q || hay.includes(q);
            return okType && okPeriod && okQ;
        });

        sortCurrent();
        currentPage = 1;
        persistState();
        renderReports();
    }

    function sortCurrent() {
        filteredReports.sort((a, b) => {
            let va = a[sortKey], vb = b[sortKey];
            if (sortKey === 'generated_date') { va = new Date(va).getTime(); vb = new Date(vb).getTime(); }
            if (typeof va === 'string') va = va.toLowerCase();
            if (typeof vb === 'string') vb = vb.toLowerCase();
            if (va < vb) return sortDir === 'asc' ? -1 : 1;
            if (va > vb) return sortDir === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function persistState() {
        const state = {
            type: document.getElementById('reportTypeFilter').value,
            period: document.getElementById('periodFilter').value,
            q: document.getElementById('searchInput').value || '',
            pageSize: document.getElementById('pageSize').value,
            page: currentPage,
            sortKey, sortDir
        };
        try { localStorage.setItem(LSKEY, JSON.stringify(state)); } catch { }
    }
    function restoreState() {
        try {
            const s = JSON.parse(localStorage.getItem(LSKEY) || '{}');
            if (s.type) document.getElementById('reportTypeFilter').value = s.type;
            if (s.period) document.getElementById('periodFilter').value = s.period;
            if (s.q) document.getElementById('searchInput').value = s.q;
            if (s.pageSize) document.getElementById('pageSize').value = s.pageSize;
            if (s.sortKey) sortKey = s.sortKey;
            if (s.sortDir) sortDir = s.sortDir;
            if (s.page) currentPage = s.page;
        } catch { }
    }

    // ======= render =======
    function renderReports() {
        const table = document.getElementById('reportsTable');
        const empty = document.getElementById('emptyState');
        if (filteredReports.length === 0) {
            empty.classList.remove('hidden'); table.classList.add('hidden'); return;
        }
        empty.classList.add('hidden'); table.classList.remove('hidden');

        renderTableBody();
        updatePagination();
        updateBulkUI();
        paintSortIcons();
    }

    function renderTableBody() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '';
        const pageSize = parseInt(document.getElementById('pageSize').value || '10', 10);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageReports = filteredReports.slice(start, end);

        pageReports.forEach(report => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50';
            tr.innerHTML = `
        <td class="px-6 py-4"><input type="checkbox" class="rowSel rounded border-slate-300" data-id="${report.id}"></td>
        <td class="px-6 py-4">
          <div>
            <div class="font-medium text-slate-800">${report.name}</div>
            <div class="text-sm text-slate-600">ID: #${report.id}</div>
          </div>
        </td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(report.type)}">${formatType(report.type)}</span>
        </td>
        <td class="px-6 py-4 text-slate-800">${formatDate(report.generated_date)}</td>
        <td class="px-6 py-4 text-slate-800">${report.generated_by}</td>
        <td class="px-6 py-4 text-slate-800">${report.file_size}</td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(report.status)}">
            ${formatStatus(report.status)} ${statusIcon(report.status)}
          </span>
        </td>
        <td class="px-6 py-4">
          <div class="flex items-center gap-2">
            ${report.status === 'completed' ? `
              <button onclick="previewReport(${report.id})" class="text-blue-600 hover:text-blue-800" title="Preview"><i class="fa-solid fa-eye"></i></button>
              <button onclick="downloadReport(${report.id})" class="text-green-600 hover:text-green-800" title="Download"><i class="fa-solid fa-download"></i></button>
              <button onclick="shareReport(${report.id})" class="text-purple-600 hover:text-purple-800" title="Share"><i class="fa-solid fa-share"></i></button>
            ` : `
              <button onclick="retryReport(${report.id})" class="text-slate-600 hover:text-slate-800" title="Retry"><i class="fa-solid fa-rotate-right"></i></button>
            `}
            <button onclick="deleteReport(${report.id})" class="text-red-600 hover:text-red-800" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </td>
      `;
            tbody.appendChild(tr);
        });

        // row selection wiring
        document.querySelectorAll('.rowSel').forEach(cb => cb.addEventListener('change', updateBulkUI));
        document.getElementById('selectAll').checked = false;
    }

    function updatePagination() {
        const pageSize = parseInt(document.getElementById('pageSize').value || '10', 10);
        totalPages = Math.max(1, Math.ceil(filteredReports.length / pageSize));
        currentPage = Math.min(currentPage, totalPages);

        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, filteredReports.length);
        document.getElementById('pageInfo').textContent = `${filteredReports.length ? start : 0}-${end} of ${filteredReports.length}`;

        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages;

        // page numbers (condensed)
        const pn = document.getElementById('pageNumbers'); pn.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                const b = document.createElement('button');
                b.textContent = i;
                b.className = i === currentPage ? 'px-3 py-1 rounded bg-slate-800 text-white text-sm' : 'px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50';
                b.onclick = () => { currentPage = i; persistState(); renderReports(); };
                pn.appendChild(b);
            } else if (Math.abs(i - currentPage) === 3) {
                const s = document.createElement('span'); s.textContent = '...'; s.className = 'px-2 text-slate-400'; pn.appendChild(s);
            }
        }
    }

    // ======= helpers =======
    function getTypeBadgeClass(type) { return ({ hr: 'bg-blue-100 text-blue-700', performance: 'bg-green-100 text-green-700', financial: 'bg-yellow-100 text-yellow-700', attendance: 'bg-purple-100 text-purple-700', compliance: 'bg-red-100 text-red-700' })[type] || 'bg-slate-100 text-slate-700'; }
    function formatType(type) { return ({ hr: 'HR Report', performance: 'Performance', financial: 'Financial', attendance: 'Time & Attendance', compliance: 'Compliance' })[type] || type; }
    function getStatusBadgeClass(s) { return ({ completed: 'bg-green-100 text-green-700', processing: 'bg-blue-100 text-blue-700', failed: 'bg-red-100 text-red-700', scheduled: 'bg-yellow-100 text-yellow-700' })[s] || 'bg-slate-100 text-slate-700'; }
    function formatStatus(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function formatDate(d) { return new Date(d).toLocaleString(); }
    function statusIcon(s) { if (s === 'completed') return '✔️'; if (s === 'processing') return '⏳'; if (s === 'failed') return '⚠️'; if (s === 'scheduled') return '🗓️'; return ''; }

    // ======= events =======
    function setupEventListeners() {
        // filters/search
        document.getElementById('reportTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 200));
        document.getElementById('pageSize').addEventListener('change', () => { currentPage = 1; persistState(); renderReports(); });

        // pagination
        document.getElementById('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; persistState(); renderReports(); } });
        document.getElementById('nextPageBtn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; persistState(); renderReports(); } });

        // table sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.style.cursor = 'pointer';
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
                else { sortKey = key; sortDir = (key === 'generated_date') ? 'desc' : 'asc'; }
                persistState();
                sortCurrent();
                renderReports();
            });
        });

        // select all & bulk delete
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.rowSel').forEach(cb => cb.checked = e.target.checked);
            updateBulkUI();
        });
        document.getElementById('bulkDelete').addEventListener('click', bulkDelete);

        // export
        document.getElementById('exportCsv').addEventListener('click', exportCsv);

        // refresh
        document.getElementById('refreshReports').addEventListener('click', async () => {
            await loadReportsData(); applyFilters();
        });

        // existing modal controls (from your template)
        document.getElementById('newReportBtn')?.addEventListener('click', openGenerateReportModal);
        document.getElementById('closeGenerateModal')?.addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('cancelGenerate')?.addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('closePreviewModal')?.addEventListener('click', () => closeModal('reportPreviewModal'));
        document.getElementById('generateReportForm')?.addEventListener('submit', handleGenerateReport);
        document.querySelector('select[name="report_type"]')?.addEventListener('change', updateTemplateOptions);
        document.querySelector('select[name="date_range"]')?.addEventListener('change', toggleCustomDateRange);
        document.getElementById('scheduleReport')?.addEventListener('change', toggleScheduleOptions);
        document.getElementById('downloadReportBtn')?.addEventListener('click', () => showInfo('Download functionality would be implemented here'));
        window.addEventListener('click', (e) => { ['generateReportModal', 'reportPreviewModal'].forEach(id => { const m = document.getElementById(id); if (e.target === m) closeModal(id); }); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { ['generateReportModal', 'reportPreviewModal'].forEach(id => document.getElementById(id)?.classList.add('hidden')); } });
    }

    function paintSortIcons() {
        document.querySelectorAll('th.sortable i').forEach(i => i.className = "fa-solid fa-sort text-slate-400 ml-1");
        const active = document.querySelector(`th.sortable[data-key="${sortKey}"] i`);
        if (active) active.className = sortDir === 'asc' ? "fa-solid fa-sort-up text-slate-700 ml-1" : "fa-solid fa-sort-down text-slate-700 ml-1";
    }

    function updateBulkUI() {
        const selected = selectedIds();
        const any = selected.length > 0;
        document.getElementById('bulkDelete').disabled = !any;
        const sc = document.getElementById('selectionCount');
        sc.textContent = `${selected.length} selected`;
        sc.classList.toggle('hidden', !any);
    }
    function selectedIds() {
        return Array.from(document.querySelectorAll('.rowSel:checked')).map(cb => Number(cb.dataset.id));
    }
    function bulkDelete() {
        const ids = selectedIds();
        if (!ids.length) return;
        if (!confirm(`Delete ${ids.length} selected report(s)? This cannot be undone.`)) return;
        reports = reports.filter(r => !ids.includes(r.id));
        filteredReports = filteredReports.filter(r => !ids.includes(r.id));
        updateSummaryStats();
        renderReports();
        showSuccess('Selected reports deleted');
    }

    // ======= export CSV (current filtered page view) =======
    function exportCsv() {
        const pageSize = parseInt(document.getElementById('pageSize').value || '10', 10);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageReports = filteredReports.slice(start, end);
        const rows = [["ID", "Name", "Type", "Generated", "By", "Size", "Format", "Status", "Downloads"]];
        pageReports.forEach(r => rows.push([r.id, r.name, formatType(r.type), new Date(r.generated_date).toISOString(), r.generated_by, r.file_size, r.format, r.status, r.download_count]));
        const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `reports_page_${currentPage}.csv`; a.click();
        URL.revokeObjectURL(url);
        showSuccess('CSV exported for current page');
    }

    // ======= quick generate & existing actions (kept, with small add-ons) =======
    async function handleGenerateReport(e) {
        e.preventDefault();
        try {
            const formData = new FormData(e.target);
            const reportData = Object.fromEntries(formData.entries());
            const btn = e.target.querySelector('button[type="submit"]');
            const orig = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating...'; btn.disabled = true;
            await new Promise(r => setTimeout(r, 1200));
            const newReport = {
                id: reportIdCounter++,
                name: reportData.report_name || `${formatReportName(reportData.template_id)} - ${new Date().toLocaleDateString()}`,
                type: reportData.report_type,
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: reportData.format,
                status: "completed",
                download_count: 0
            };
            reports.unshift(newReport); showSuccess('Report generated successfully!');
            closeModal('generateReportModal'); updateSummaryStats(); applyFilters();
            btn.innerHTML = orig; btn.disabled = false;
        } catch (e2) {
            showError('Failed to generate report');
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<i class="fa-solid fa-cog mr-1"></i> Generate Report'; btn.disabled = false;
        }
    }

    async function generateQuickReport(reportType) {
        try {
            showInfo(`Generating ${formatReportName(reportType)} report...`);
            await new Promise(r => setTimeout(r, 800));
            const newReport = {
                id: reportIdCounter++,
                name: `${formatReportName(reportType)} - ${new Date().toLocaleDateString()}`,
                type: getReportTypeFromTemplate(reportType),
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: "pdf",
                status: Math.random() < 0.12 ? "failed" : "completed",
                download_count: 0
            };
            reports.unshift(newReport);
            updateSummaryStats(); applyFilters();
            showSuccess(`${formatReportName(reportType)} report generated!`);
        } catch { showError('Failed to generate report'); }
    }

    function retryReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo('Retrying…');
        r.status = 'processing';
        renderReports();
        setTimeout(() => { r.status = 'completed'; renderReports(); showSuccess('Report ready'); }, 1200);
    }

    function getReportTypeFromTemplate(t) { return ({ employee_roster: 'hr', headcount_analysis: 'hr', turnover_report: 'hr', diversity_metrics: 'hr', recruitment_pipeline: 'hr', performance_summary: 'performance', goal_achievement: 'performance', review_completion: 'performance', top_performers: 'performance', training_completion: 'performance', payroll_summary: 'financial', cost_analysis: 'financial', expense_reports: 'financial', budget_variance: 'financial', contractor_payments: 'financial', attendance_summary: 'attendance', leave_analysis: 'attendance', overtime_report: 'attendance', tardiness_report: 'attendance', eeo_report: 'compliance', safety_incidents: 'compliance', policy_compliance: 'compliance', audit_trail: 'compliance' })[t] || 'hr'; }
    function formatReportName(s) { return (s || '').split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }

    // ======= preview/download/share/delete (kept behavior) =======
    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        document.getElementById('reportPreviewContent').innerHTML = generateReportPreview(r);
        document.getElementById('reportPreviewModal').classList.remove('hidden');
    }
    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}...`);
        setTimeout(() => { r.download_count = (r.download_count || 0) + 1; updateSummaryStats(); renderReports(); showSuccess('Report downloaded'); }, 800);
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const url = window.location.href + `?report=${r.id}`;
        if (navigator.share) navigator.share({ title: r.name, text: `Check out this report: ${r.name}`, url });
        else navigator.clipboard.writeText(url).then(() => showSuccess('Report link copied')).catch(() => showInfo('Share not available'));
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"? This action cannot be undone.`)) return;
        reports = reports.filter(q => q.id !== id);
        filteredReports = filteredReports.filter(q => q.id !== id);
        updateSummaryStats(); renderReports(); showSuccess('Report deleted');
    }

    // ======= existing preview generators (unchanged) =======
    function generateReportPreview(report) {
        switch (report.type) {
            case 'hr': return generateHRReportPreview(report);
            case 'performance': return generatePerformanceReportPreview(report);
            case 'financial': return generateFinancialReportPreview(report);
            case 'attendance': return generateAttendanceReportPreview(report);
            case 'compliance': return generateComplianceReportPreview(report);
            default: return '<p class="text-slate-600">Report preview not available.</p>';
        }
    }
    // reusing your existing preview generators:
    /* BEGIN previews from your original script */
    function generateHRReportPreview(report) {
        return `
    <div class="space-y-6">
      <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${report.name}</h4><p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Employees</h5><p class="text-2xl font-bold text-blue-600">247</p></div>
        <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">New Hires</h5><p class="text-2xl font-bold text-green-600">15</p></div>
        <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Departures</h5><p class="text-2xl font-bold text-red-600">8</p></div>
      </div>
      <div class="bg-slate-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800 mb-3">Department Breakdown</h5>
        <div class="space-y-2">
          <div class="flex justify-between"><span>Engineering</span><span class="font-medium">95 employees</span></div>
          <div class="flex justify-between"><span>Sales</span><span class="font-medium">42 employees</span></div>
          <div class="flex justify-between"><span>Marketing</span><span class="font-medium">28 employees</span></div>
        </div>
      </div>
    </div>`;
    }
    function generatePerformanceReportPreview(report) {
        return `
    <div class="space-y-6">
      <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${report.name}</h4><p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p></div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Rating</h5><p class="text-2xl font-bold text-green-600">4.2/5</p></div>
        <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Reviews Completed</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
        <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Goals Achieved</h5><p class="text-2xl font-bold text-yellow-600">76%</p></div>
        <div class="bg-purple-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Top Performers</h5><p class="text-2xl font-bold text-purple-600">23</p></div>
      </div>
      <div class="bg-slate-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800 mb-3">Performance Distribution</h5>
        <div class="space-y-2">
          <div class="flex justify-between"><span>Exceeds Expectations (4.5-5.0)</span><span class="font-medium">18%</span></div>
          <div class="flex justify-between"><span>Meets Expectations (3.5-4.4)</span><span class="font-medium">67%</span></div>
          <div class="flex justify-between"><span>Below Expectations (2.0-3.4)</span><span class="font-medium">15%</span></div>
        </div>
      </div>
    </div>`;
    }
    function generateFinancialReportPreview(report) {
        return `
    <div class="space-y-6">
      <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${report.name}</h4><p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Payroll</h5><p class="text-2xl font-bold text-green-600">$1.2M</p></div>
        <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Benefits Cost</h5><p class="text-2xl font-bold text-blue-600">$245K</p></div>
        <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Expenses</h5><p class="text-2xl font-bold text-yellow-600">$89K</p></div>
      </div>
      <div class="bg-slate-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800 mb-3">Department Costs</h5>
        <div class="space-y-2">
          <div class="flex justify-between"><span>Engineering</span><span class="font-medium">$687,500</span></div>
          <div class="flex justify-between"><span>Sales</span><span class="font-medium">$312,000</span></div>
          <div class="flex justify-between"><span>Marketing</span><span class="font-medium">$156,000</span></div>
        </div>
      </div>
    </div>`;
    }
    function generateAttendanceReportPreview(report) {
        return `
    <div class="space-y-6">
      <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${report.name}</h4><p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p></div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Attendance</h5><p class="text-2xl font-bold text-green-600">94.2%</p></div>
        <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">On Time %</h5><p class="text-2xl font-bold text-blue-600">87.5%</p></div>
        <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Leave Days</h5><p class="text-2xl font-bold text-yellow-600">156</p></div>
        <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Sick Days</h5><p class="text-2xl font-bold text-red-600">89</p></div>
      </div>
      <div class="bg-slate-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800 mb-3">Attendance Trends</h5>
        <div class="space-y-2">
          <div class="flex justify-between"><span>Perfect Attendance</span><span class="font-medium">42 employees</span></div>
          <div class="flex justify-between"><span>1-2 Absences</span><span class="font-medium">128 employees</span></div>
          <div class="flex justify-between"><span>3+ Absences</span><span class="font-medium">77 employees</span></div>
        </div>
      </div>
    </div>`;
    }
    function generateComplianceReportPreview(report) {
        return `
    <div class="space-y-6">
      <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${report.name}</h4><p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Compliance Score</h5><p class="text-2xl font-bold text-green-600">96%</p></div>
        <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Open Issues</h5><p class="text-2xl font-bold text-yellow-600">3</p></div>
        <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Training Complete</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
      </div>
      <div class="bg-slate-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800 mb-3">Compliance Areas</h5>
        <div class="space-y-2">
          <div class="flex justify-between"><span>Equal Opportunity</span><span class="font-medium text-green-600">✓ Compliant</span></div>
          <div class="flex justify-between"><span>Safety Training</span><span class="font-medium text-green-600">✓ Compliant</span></div>
          <div class="flex justify-between"><span>Data Privacy</span><span class="font-medium text-yellow-600">⚠ Review Required</span></div>
        </div>
      </div>
    </div>`;
    }
    /* END previews */

    // ======= modals/toasts from your page =======
    function openGenerateReportModal() { document.getElementById('generateReportModal').classList.remove('hidden'); }
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'generateReportModal') {
            document.getElementById('generateReportForm').reset();
            document.getElementById('customDateRange').classList.add('hidden');
            document.getElementById('scheduleOptions').classList.add('hidden');
        }
    }
    function updateTemplateOptions() {
        const reportType = document.querySelector('select[name="report_type"]').value;
        const templateSelect = document.querySelector('select[name="template_id"]');
        templateSelect.innerHTML = '<option value="">Select Template</option>';
        const templates = {
            'hr': [{ value: 'employee_roster', text: 'Employee Roster' }, { value: 'headcount_analysis', text: 'Headcount Analysis' }, { value: 'turnover_report', text: 'Turnover Report' }, { value: 'diversity_metrics', text: 'Diversity Metrics' }],
            'performance': [{ value: 'performance_summary', text: 'Performance Summary' }, { value: 'goal_achievement', text: 'Goal Achievement' }, { value: 'review_completion', text: 'Review Completion' }, { value: 'top_performers', text: 'Top Performers' }],
            'financial': [{ value: 'payroll_summary', text: 'Payroll Summary' }, { value: 'cost_analysis', text: 'Cost Analysis' }, { value: 'expense_reports', text: 'Expense Reports' }, { value: 'budget_variance', text: 'Budget Variance' }],
            'attendance': [{ value: 'attendance_summary', text: 'Attendance Summary' }, { value: 'leave_analysis', text: 'Leave Analysis' }, { value: 'overtime_report', text: 'Overtime Report' }, { value: 'tardiness_report', text: 'Tardiness Report' }],
            'compliance': [{ value: 'eeo_report', text: 'EEO Report' }, { value: 'safety_incidents', text: 'Safety Incidents' }, { value: 'policy_compliance', text: 'Policy Compliance' }, { value: 'audit_trail', text: 'Audit Trail' }]
        };
        (templates[reportType] || []).forEach(t => { const op = document.createElement('option'); op.value = t.value; op.textContent = t.text; templateSelect.appendChild(op); });
    }
    function toggleCustomDateRange() {
        const val = document.querySelector('select[name="date_range"]').value;
        document.getElementById('customDateRange').classList.toggle('hidden', val !== 'custom');
    }
    function toggleScheduleOptions() {
        const cb = document.getElementById('scheduleReport');
        document.getElementById('scheduleOptions').classList.toggle('hidden', !cb.checked);
    }

    // toasts
    function showToast(type, message) {
        const toast = document.getElementById(`${type}Toast`);
        const msg = document.getElementById(`${type}Message`);
        msg.textContent = message; toast.classList.remove('translate-x-full');
        setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }
    function showSuccess(m) { showToast('success', m); }
    function showError(m) { showToast('error', m); }
    function showInfo(m) { showToast('info', m); }

    // ======= misc utils =======
    function debounce(fn, t = 200) { let h; return (...a) => { clearTimeout(h); h = setTimeout(() => fn.apply(this, a), t); }; }
</script>
{% endblock %}