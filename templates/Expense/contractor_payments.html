{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-file-invoice-dollar mr-2"></i> Contractor Payments
            </h1>
            <p class="text-slate-600 text-sm">Manage payments and contracts for freelance/contract staff.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button id="newVendorBtn"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm w-full xs:w-auto">
                <i class="fa-solid fa-user-plus mr-1"></i> New Vendor
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full xs:w-auto text-center">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div
            class="flex space-x-1 bg-slate-100 p-1 rounded-xl overflow-x-auto whitespace-nowrap scrollbar-thin scrollbar-thumb-slate-300">
            <button id="vendorsTab"
                class="cp-tab active px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-people-line mr-1"></i> Vendors</button>
            <button id="contractsTab"
                class="cp-tab px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-file-contract mr-1"></i> Contracts</button>
            <button id="invoicesTab"
                class="cp-tab px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-file-invoice mr-1"></i> Invoices</button>
            <button id="paymentsTab"
                class="cp-tab px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-building-columns mr-1"></i> Payments</button>
            <button id="complianceTab"
                class="cp-tab px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-shield-halved mr-1"></i> Compliance</button>
            <button id="reportsTab"
                class="cp-tab px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium shrink-0"><i
                    class="fa-solid fa-chart-line mr-1"></i> Reports</button>
        </div>
    </div>

    <!-- Vendors -->
    <section id="vendorsPanel" class="cp-panel">
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div
                class="flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between p-4 border-b border-slate-200">
                <div class="relative w-full lg:w-96">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input id="vendorSearch" placeholder="Search vendor, skill, or location"
                        class="w-full pl-10 pr-10 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-slate-200">
                    <button id="vendorClear"
                        class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                        aria-label="Clear search">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <select id="vendorStatus" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button id="inviteVendor"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                        <i class="fa-solid fa-paper-plane mr-1"></i> Invite
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs sm:text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4">Vendor</th>
                            <th class="py-2 px-4">Skill</th>
                            <th class="py-2 px-4 hidden md:table-cell">Rate</th>
                            <th class="py-2 px-4 hidden lg:table-cell">Location</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4 w-28"></th>
                        </tr>
                    </thead>
                    <tbody id="vendorRows" class="text-slate-800"><!-- injected --></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Contracts -->
    <section id="contractsPanel" class="cp-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800"><i
                            class="fa-solid fa-file-contract mr-2"></i>
                        Contract Register</h3>
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="newContract"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"><i
                                class="fa-solid fa-plus mr-1"></i> New</button>
                        <select id="contractFilter"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="expiring_30">Expiring ≤30d</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs sm:text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">Vendor</th>
                                <th class="py-2 px-4 hidden sm:table-cell">Type</th>
                                <th class="py-2 px-4 hidden md:table-cell">Start</th>
                                <th class="py-2 px-4">End</th>
                                <th class="py-2 px-4 hidden lg:table-cell">Cap</th>
                                <th class="py-2 px-4 hidden lg:table-cell">Used</th>
                                <th class="py-2 px-4 w-28"></th>
                            </tr>
                        </thead>
                        <tbody id="contractRows" class="text-slate-800"><!-- injected --></tbody>
                    </table>
                </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-triangle-exclamation mr-2"></i> Contract Health</h3>
                <ul id="contractHealth" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Invoices -->
    <section id="invoicesPanel" class="cp-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800"><i
                        class="fa-solid fa-file-invoice mr-2"></i> Invoices
                </h3>
                <div class="flex flex-wrap items-center gap-2">
                    <select id="invoiceFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button id="uploadInvoice"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-upload mr-1"></i> Upload
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs sm:text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4">Invoice #</th>
                            <th class="py-2 px-4">Vendor</th>
                            <th class="py-2 px-4 hidden sm:table-cell">Period</th>
                            <th class="py-2 px-4">Amount</th>
                            <th class="py-2 px-4 hidden md:table-cell">Status</th>
                            <th class="py-2 px-4 w-24 sm:w-28"></th>
                        </tr>
                    </thead>
                    <tbody id="invoiceRows" class="text-slate-800"><!-- injected --></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Payments -->
    <section id="paymentsPanel" class="cp-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800"><i
                            class="fa-solid fa-building-columns mr-2"></i>
                        Payment Batches</h3>
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="payFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                            <option value="all">All</option>
                            <option value="queued">Queued</option>
                            <option value="sent">Sent</option>
                        </select>
                        <button id="genFile"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"><i
                                class="fa-solid fa-file-arrow-down mr-1"></i> Generate File</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs sm:text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">Batch</th>
                                <th class="py-2 px-4">Count</th>
                                <th class="py-2 px-4">Amount</th>
                                <th class="py-2 px-4 hidden md:table-cell">Status</th>
                                <th class="py-2 px-4 w-20 sm:w-24"></th>
                            </tr>
                        </thead>
                        <tbody id="payRows" class="text-slate-800"><!-- injected --></tbody>
                    </table>
                </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-wallet mr-2"></i> Next
                    Disbursement</h3>
                <ul id="nextDisb" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Compliance -->
    <section id="compliancePanel" class="cp-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-file-shield mr-2"></i>
                    Compliance Checklist</h3>
                <div id="compList" class="space-y-3"><!-- injected --></div>
                <button id="compAll"
                    class="mt-2 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm"><i
                        class="fa-solid fa-check mr-1"></i> Mark All Complete</button>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-scale-balanced mr-2"></i>
                    Withholding Summary</h3>
                <ul id="withholdList" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-user-shield mr-2"></i>
                    Classification</h3>
                <ul id="classRisk" class="space-y-2 text-sm"><!-- injected --></ul>
            </div>
        </div>
    </section>

    <!-- Reports -->
    <section id="reportsPanel" class="cp-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-chart-pie mr-2"></i> Spend
                    by Category</h3>
                <div class="h-64 sm:h-72">
                    <canvas id="spendChart"></canvas>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-stopwatch mr-2"></i>
                    Approval SLA</h3>
                <div class="h-64 sm:h-72">
                    <canvas id="slaChart"></canvas>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- New Vendor Modal -->
<div id="vendorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-end sm:items-center justify-center p-2 sm:p-4">
            <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-4 sm:p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Create Vendor</h3>
                    <button id="closeVendorModal" class="text-slate-400 hover:text-slate-600" aria-label="Close">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-4 sm:p-6 space-y-4">
                    <input id="vName" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Vendor name">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input id="vSkill" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Skill e.g., UI/UX">
                        <input id="vRate" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Rate / hr">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input id="vLoc" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Location">
                        <select id="vStatus" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center justify-end gap-2 pt-2">
                        <button id="cancelVendor"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 w-full sm:w-auto">Cancel</button>
                        <button id="saveVendor"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-full sm:w-auto"><i
                                class="fa-solid fa-floppy-disk mr-1"></i> Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ------ Mock Data ------ */
    let VENDORS = [
        { id: 1, name: 'PixelCraft Studio', skill: 'UI/UX', rate: 55, loc: 'Remote (IN)', status: 'active' },
        { id: 2, name: 'CloudForge LLC', skill: 'DevOps', rate: 80, loc: 'Remote (US)', status: 'active' },
        { id: 3, name: 'WordWeave', skill: 'Content', rate: 35, loc: 'Remote (UK)', status: 'inactive' }
    ];
    let CONTRACTS = [
        { id: 101, vendor: 1, type: 'T&M', start: '2025-07-01', end: '2025-10-15', cap: 20000, used: 12000 },
        { id: 102, vendor: 2, type: 'Retainer', start: '2025-08-01', end: '2025-12-31', cap: 40000, used: 18000 }
    ];
    let INVOICES = [
        { id: 'INV-2301', vendor: 1, period: '2025-08', amt: 4200, status: 'approved' },
        { id: 'INV-2302', vendor: 2, period: '2025-08', amt: 9600, status: 'pending' },
        { id: 'INV-2303', vendor: 3, period: '2025-07', amt: 2100, status: 'rejected' }
    ];
    let BATCHES = [
        { id: 'CP-0007', count: 5, amount: 13800, status: 'sent' },
        { id: 'CP-0008', count: 3, amount: 9600, status: 'queued' }
    ];
    let COMPLIANCE = [
        { id: 301, text: 'Contract signed & stored', done: true },
        { id: 302, text: 'Tax form (e.g., W-8BEN/15CA) on file', done: false },
        { id: 303, text: 'Bank/KYC verified', done: true },
        { id: 304, text: 'Rate & SOW approved', done: false }
    ];

    /* ------ Elements & Init ------ */
    const $ = (id) => document.getElementById(id);
    document.addEventListener('DOMContentLoaded', () => {
        // Tabs
        document.querySelectorAll('.cp-tab').forEach(b => {
            b.addEventListener('click', (e) => {
                document.querySelectorAll('.cp-tab').forEach(x => x.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                document.querySelectorAll('.cp-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(name + 'Panel').classList.remove('hidden');
                if (name === 'reports') { ensureCharts(); drawCharts(); }
            });
        });

        // Vendors
        $('newVendorBtn').addEventListener('click', openVendorModal);
        $('closeVendorModal').addEventListener('click', closeVendorModal);
        $('cancelVendor').addEventListener('click', closeVendorModal);
        $('saveVendor').addEventListener('click', saveVendor);
        $('inviteVendor').addEventListener('click', () => alert('✉️ Invite sent'));
        $('vendorStatus').addEventListener('change', () => { renderVendors(); });
        const vs = $('vendorSearch'), vc = $('vendorClear');
        vs.addEventListener('input', () => { vc.classList.toggle('hidden', !vs.value.trim()); renderVendors(); });
        vc.addEventListener('click', () => { vs.value = ''; vc.classList.add('hidden'); renderVendors(); });

        // Contracts / Invoices / Payments / Compliance
        $('contractFilter').addEventListener('change', renderContracts);
        $('invoiceFilter').addEventListener('change', () => { renderInvoices(); renderNextDisb(); renderWithhold(); });
        $('payFilter').addEventListener('change', renderPayments);
        $('genFile').addEventListener('click', () => alert('✅ Bank file generated'));
        $('compAll').addEventListener('click', () => { COMPLIANCE = COMPLIANCE.map(c => ({ ...c, done: true })); renderCompliance(); });

        // Initial renders
        renderVendors(); renderContracts(); renderHealth(); renderInvoices(); renderPayments(); renderNextDisb();
        renderCompliance(); renderWithhold(); renderClassRisk();
    });

    /* ------ Vendors ------ */
    function renderVendors() {
        const f = $('vendorStatus').value;
        const q = ($('vendorSearch').value || '').toLowerCase();
        const data = VENDORS.filter(v => (f === 'all' || v.status === f) && (!q || [v.name, v.skill, v.loc].some(x => x.toLowerCase().includes(q))));
        $('vendorRows').innerHTML = data.map(v => {
            const pill = v.status === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-700';
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${v.name}</td>
        <td class="py-2 px-4">${v.skill}</td>
        <td class="py-2 px-4 hidden md:table-cell">${fmt(v.rate)}/hr</td>
        <td class="py-2 px-4 hidden lg:table-cell">${v.loc}</td>
        <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${capitalize(v.status)}</span></td>
        <td class="py-2 px-4 text-right">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Open ${v.name}')">Open</button>
        </td>
      </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No vendors</td></tr>`;
    }
    function openVendorModal() { $('vendorModal').classList.remove('hidden'); }
    function closeVendorModal() { $('vendorModal').classList.add('hidden'); }
    function saveVendor() {
        const name = val('vName'); if (!name) return alert('Name required');
        VENDORS.push({ id: Date.now(), name, skill: val('vSkill') || 'General', rate: Number(val('vRate') || 0), loc: val('vLoc') || 'Remote', status: val('vStatus') || 'active' });
        closeVendorModal(); renderVendors();
    }

    /* ------ Contracts ------ */
    function renderContracts() {
        const f = $('contractFilter').value;
        const now = new Date();
        const data = CONTRACTS.filter(c => {
            if (f === 'active') return new Date(c.end) >= now;
            if (f === 'expiring_30') return (new Date(c.end) - now) / (1000 * 60 * 60 * 24) <= 30 && (new Date(c.end) - now) >= 0;
            return true;
        });
        $('contractRows').innerHTML = data.map(c => {
            const v = VENDORS.find(v => v.id === c.vendor);
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${v?.name || '—'}</td>
        <td class="py-2 px-4 hidden sm:table-cell">${c.type}</td>
        <td class="py-2 px-4 hidden md:table-cell">${c.start}</td>
        <td class="py-2 px-4">${c.end} <span class="text-[10px] sm:text-xs text-slate-500">(${daysFromNow(c.end)}d)</span></td>
        <td class="py-2 px-4 hidden lg:table-cell">${fmt(c.cap)}</td>
        <td class="py-2 px-4 hidden lg:table-cell">${fmt(c.used)}</td>
        <td class="py-2 px-4 text-right">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Contract details')">Details</button>
        </td>
      </tr>`;
        }).join('') || `<tr><td colspan="7" class="py-6 text-center text-slate-500">No contracts</td></tr>`;
    }
    function renderHealth() {
        const soon = CONTRACTS.filter(c => daysFromNow(c.end) <= 30);
        const over = CONTRACTS.filter(c => c.used >= c.cap);
        $('contractHealth').innerHTML = `
    <li class="flex items-center justify-between"><span>Contracts expiring ≤30d</span><span class="font-medium">${soon.length}</span></li>
    <li class="flex items-center justify-between"><span>Contracts over cap</span><span class="font-medium">${over.length}</span></li>
    <li class="flex items-center justify-between"><span>Total committed</span><span class="font-medium">${fmt(CONTRACTS.reduce((s, c) => s + c.cap, 0))}</span></li>
  `;
    }

    /* ------ Invoices ------ */
    function renderInvoices() {
        const f = $('invoiceFilter').value;
        const data = f === 'all' ? INVOICES : INVOICES.filter(i => i.status === f);
        $('invoiceRows').innerHTML = data.map(i => {
            const v = VENDORS.find(v => v.id === i.vendor);
            const pill = i.status === 'approved' ? 'bg-emerald-50 text-emerald-700' : i.status === 'pending' ? 'bg-amber-50 text-amber-700' : 'bg-red-50 text-red-700';
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${i.id}</td>
        <td class="py-2 px-4">${v?.name || '—'}</td>
        <td class="py-2 px-4 hidden sm:table-cell">${i.period}</td>
        <td class="py-2 px-4">${fmt(i.amt)}</td>
        <td class="py-2 px-4 hidden md:table-cell"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${labelStatus(i.status)}</span></td>
        <td class="py-2 px-4 text-right">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="approve('${i.id}')">Approve</button>
        </td>
      </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No invoices</td></tr>`;
    }
    function approve(id) { const inv = INVOICES.find(x => x.id === id); if (!inv) return; inv.status = 'approved'; renderInvoices(); }

    /* ------ Payments ------ */
    function renderPayments() {
        const f = $('payFilter').value;
        const data = f === 'all' ? BATCHES : BATCHES.filter(b => b.status === f);
        $('payRows').innerHTML = data.map(b => {
            const pill = b.status === 'sent' ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700';
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${b.id}</td>
        <td class="py-2 px-4">${b.count}</td>
        <td class="py-2 px-4">${fmt(b.amount)}</td>
        <td class="py-2 px-4 hidden md:table-cell"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${capitalize(b.status)}</span></td>
        <td class="py-2 px-4 text-right"><button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Batch details coming soon')">Details</button></td>
      </tr>`;
        }).join('') || `<tr><td colspan="5" class="py-6 text-center text-slate-500">No batches</td></tr>`;
    }
    function renderNextDisb() {
        const due = INVOICES.filter(i => i.status === 'approved').slice(0, 4);
        $('nextDisb').innerHTML = due.map(i => {
            const v = VENDORS.find(v => v.id === i.vendor);
            return `<li class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <div><div class="font-medium text-slate-800">${v?.name || '—'}</div><div class="text-xs text-slate-600">Invoice ${i.id} • ${i.period}</div></div>
      <div class="text-sm font-semibold">${fmt(i.amt)}</div>
    </li>`;
        }).join('') || `<li class="text-slate-500">No approved invoices</li>`;
    }

    /* ------ Compliance ------ */
    function renderCompliance() {
        $('compList').innerHTML = COMPLIANCE.map(c => `
    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" ${c.done ? 'checked' : ''} onchange="toggleComp(${c.id}, this.checked)"> ${c.text}</label>
      ${c.done ? '<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-xs">Done</span>' : ''}
    </div>`).join('');
    }
    function toggleComp(id, on) { const x = COMPLIANCE.find(c => c.id === id); if (x) { x.done = on; renderCompliance(); } }
    function renderWithhold() {
        const sums = [
            { k: 'Tax withheld (if applicable)', v: Math.round(INVOICES.reduce((s, i) => s + (i.status === 'approved' ? i.amt * 0.05 : 0), 0)) },
            { k: 'Platform fees', v: 0 },
            { k: 'FX fees (est.)', v: 120 }
        ];
        $('withholdList').innerHTML = sums.map(s => `<li class="flex items-center justify-between"><span>${s.k}</span><span class="font-medium">${fmt(s.v)}</span></li>`).join('');
    }
    function renderClassRisk() {
        const items = [
            { txt: '>30hrs/week for 8+ weeks', risk: 'medium' },
            { txt: 'Company email used', risk: 'low' },
            { txt: 'Manager assigns daily tasks', risk: 'high' }
        ];
        $('classRisk').innerHTML = items.map(i => {
            const tone = i.risk === 'high' ? 'bg-red-50 text-red-700' : i.risk === 'medium' ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700';
            return `<li class="flex items-center justify-between p-2 rounded ${tone}"><span>${i.txt}</span><span class="text-xs capitalize">${i.risk}</span></li>`;
        }).join('');
    }

    /* ------ Reports (Charts) ------ */
    let chartsReady = false, spendC, slaC;
    function ensureCharts() {
        if (typeof Chart !== 'undefined') { chartsReady = true; return; }
        if (chartsReady) return;
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = () => { chartsReady = true; drawCharts(); };
        document.head.appendChild(s);
    }
    function drawCharts() {
        const c1 = document.getElementById('spendChart').getContext('2d');
        const c2 = document.getElementById('slaChart').getContext('2d');
        spendC && spendC.destroy(); slaC && slaC.destroy();
        const byCat = { 'Design': 6200, 'Engineering': 9800, 'Content': 2100, 'Ops': 700 };
        spendC = new Chart(c1, {
            type: 'pie',
            data: { labels: Object.keys(byCat), datasets: [{ data: Object.values(byCat), borderWidth: 2, borderColor: '#fff' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
        slaC = new Chart(c2, {
            type: 'bar',
            data: { labels: ['Submit', 'Approve', 'Pay'], datasets: [{ label: 'Median Hours', data: [6, 18, 10] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    /* ------ Utils ------ */
    function fmt(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(n || 0)); }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function val(id) { return $(id).value; }
    function daysFromNow(d) { const x = new Date(d), n = new Date(); return Math.max(0, Math.ceil((x - n) / (1000 * 60 * 60 * 24))); }
    function labelStatus(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
</script>

<style>
    .cp-tab.active {
        background-color: #1e293b;
        color: white;
    }

    .cp-tab:not(.active) {
        color: #64748b;
    }

    .cp-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    /* Minimal scrollbar for horizontal tab scroller (optional) */
    .scrollbar-thin::-webkit-scrollbar {
        height: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 9999px;
    }
</style>
{% endblock %}