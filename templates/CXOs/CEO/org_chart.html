{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-sitemap mr-2"></i> Organizational Chart
            </h1>
            <p class="text-slate-600 text-sm">Visualize reporting structures and organizational hierarchy.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="editModeBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-edit mr-1"></i> Edit Structure
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- View Controls -->
    <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">View:</label>
                <select id="viewType" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="hierarchy">Hierarchy View</option>
                    <option value="departments">Department View</option>
                    <option value="list">List View</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Filter by:</label>
                <select id="departmentFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All Departments</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button id="expandAllBtn"
                    class="px-3 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-expand mr-1"></i> Expand All
                </button>
                <button id="collapseAllBtn"
                    class="px-3 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-compress mr-1"></i> Collapse All
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-users mr-1"></i> Total Employees</div>
            <div id="totalEmployees" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-crown mr-1"></i> Leadership</div>
            <div id="leadershipCount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-building mr-1"></i> Departments</div>
            <div id="departmentCount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-line mr-1"></i> Avg Team Size</div>
            <div id="avgTeamSize" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Main Org Chart Container -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6">
        <div id="loadingState" class="text-center py-12">
            <i class="fa-solid fa-spinner fa-spin text-slate-400 text-3xl mb-4"></i>
            <p class="text-slate-600">Loading organizational structure...</p>
        </div>

        <!-- Hierarchy View -->
        <div id="hierarchyView" class="hidden">
            <div id="orgChart" class="overflow-x-auto">
                <!-- Dynamic org chart will be rendered here -->
            </div>
        </div>

        <!-- Department View -->
        <div id="departmentView" class="hidden">
            <div id="departmentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Department cards will be rendered here -->
            </div>
        </div>

        <!-- List View -->
        <div id="listView" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Employee</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Position</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Reports To</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Direct Reports
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="listTableBody" class="bg-white divide-y divide-slate-200">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Structure Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">Edit Reporting Structure</h3>
                    <button id="closeModalBtn" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <form id="editForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Employee</label>
                            <select id="employeeSelect" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <!-- Options will be populated -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Reports To</label>
                            <select id="managerSelect" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">No Manager (Top Level)</option>
                                <!-- Options will be populated -->
                            </select>
                        </div>

                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" id="cancelBtn"
                                class="px-4 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50">
                                Cancel
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-900">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Org Chart Styling */
    .org-node {
        position: relative;
        display: inline-block;
        margin: 10px;
    }

    .org-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        min-width: 200px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .org-card:hover {
        border-color: #64748b;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .org-card.cxo {
        border-color: #dc2626;
        background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
    }

    .org-card.leader {
        border-color: #2563eb;
        background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
    }

    .org-card.hr {
        border-color: #059669;
        background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
    }

    .org-card.employee {
        border-color: #7c3aed;
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
    }

    .org-lines {
        position: absolute;
        pointer-events: none;
    }

    .org-line {
        position: absolute;
        background: #cbd5e1;
        z-index: 1;
    }

    .org-line.vertical {
        width: 2px;
    }

    .org-line.horizontal {
        height: 2px;
    }

    .employee-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        items-center: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 18px;
        color: #64748b;
    }

    .department-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .department-card:hover {
        border-color: #64748b;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .collapsible {
        cursor: pointer;
    }

    .collapsible .collapse-icon {
        transition: transform 0.3s ease;
    }

    .collapsible.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }

    .collapsible.collapsed+.org-children {
        display: none;
    }
</style>

<script>
    // Global variables
    let orgData = [];
    let allUsers = [];
    let editMode = false;

    // Utility functions
    async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    async function postJSON(url, data) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    function getInitials(name) {
        return name.split(' ')
            .map(word => word.charAt(0))
            .join('')
            .toUpperCase()
            .substring(0, 2);
    }

    function getEmployeeTypeClass(employeeType) {
        switch (employeeType?.toLowerCase()) {
            case 'cxos': return 'cxo';
            case 'leaders': return 'leader';
            case 'hr': return 'hr';
            default: return 'employee';
        }
    }

    function getEmployeeTypeColor(employeeType) {
        switch (employeeType?.toLowerCase()) {
            case 'cxos': return '#dc2626';
            case 'leaders': return '#2563eb';
            case 'hr': return '#059669';
            default: return '#7c3aed';
        }
    }

    // Data loading and processing
    async function loadOrgData() {
        try {
            allUsers = await fetchJSON('/api/org/structure');
            processOrgStructure();
            updateStatistics();
            renderCurrentView();
        } catch (error) {
            console.error('Error loading org data:', error);
            showError('Failed to load organizational structure');
        }
    }

    function processOrgStructure() {
        // Build hierarchy from flat user data
        const userMap = {};
        const rootNodes = [];

        // First pass: create user map
        allUsers.forEach(user => {
            userMap[user.id] = {
                ...user,
                children: [],
                directReports: 0
            };
        });

        // Second pass: build relationships
        allUsers.forEach(user => {
            if (user.manager_id && userMap[user.manager_id]) {
                userMap[user.manager_id].children.push(userMap[user.id]);
                userMap[user.manager_id].directReports++;
            } else {
                rootNodes.push(userMap[user.id]);
            }
        });

        orgData = rootNodes;
        populateFilters();
    }

    function populateFilters() {
        const departmentFilter = document.getElementById('departmentFilter');
        const departments = [...new Set(allUsers.map(user => user.subposition).filter(Boolean))];

        departmentFilter.innerHTML = '<option value="">All Departments</option>';
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            departmentFilter.appendChild(option);
        });
    }

    function updateStatistics() {
        document.getElementById('totalEmployees').textContent = allUsers.length;

        const leadership = allUsers.filter(user =>
            ['Leaders', 'CXOs', 'HR'].includes(user.employee_type) &&
            ['Managers', 'Executives', 'CEO', 'CHRO', 'CFO', 'CTO/COO'].includes(user.subposition)
        ).length;
        document.getElementById('leadershipCount').textContent = leadership;

        const departments = new Set(allUsers.map(user => user.subposition).filter(Boolean));
        document.getElementById('departmentCount').textContent = departments.size;

        const usersWithReports = allUsers.filter(user =>
            allUsers.some(other => other.manager_id === user.id)
        );
        const avgTeamSize = usersWithReports.length > 0
            ? Math.round(allUsers.length / usersWithReports.length)
            : 0;
        document.getElementById('avgTeamSize').textContent = avgTeamSize;
    }

    // Rendering functions
    function renderCurrentView() {
        const viewType = document.getElementById('viewType').value;

        // Hide all views
        document.getElementById('hierarchyView').classList.add('hidden');
        document.getElementById('departmentView').classList.add('hidden');
        document.getElementById('listView').classList.add('hidden');

        // Show selected view
        switch (viewType) {
            case 'hierarchy':
                document.getElementById('hierarchyView').classList.remove('hidden');
                renderHierarchyView();
                break;
            case 'departments':
                document.getElementById('departmentView').classList.remove('hidden');
                renderDepartmentView();
                break;
            case 'list':
                document.getElementById('listView').classList.remove('hidden');
                renderListView();
                break;
        }
    }

    function renderHierarchyView() {
        const container = document.getElementById('orgChart');
        container.innerHTML = '';

        if (orgData.length === 0) {
            container.innerHTML = `
            <div class="text-center py-12">
                <i class="fa-solid fa-users-slash text-slate-300 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-slate-800 mb-2">No organizational structure found</h3>
                <p class="text-slate-600">Click "Edit Structure" to set up reporting relationships.</p>
            </div>
        `;
            return;
        }

        const orgTree = document.createElement('div');
        orgTree.className = 'org-tree';

        orgData.forEach(rootUser => {
            orgTree.appendChild(createNodeElement(rootUser, 0));
        });

        container.appendChild(orgTree);
    }

    function createNodeElement(user, level) {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'org-node';
        nodeDiv.style.marginLeft = `${level * 40}px`;

        const card = document.createElement('div');
        card.className = `org-card ${getEmployeeTypeClass(user.employee_type)}`;

        const hasChildren = user.children && user.children.length > 0;

        card.innerHTML = `
        <div class="employee-avatar">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="font-semibold text-slate-800">${user.name}</div>
        <div class="text-sm text-slate-600 mb-2">${user.subposition || user.employee_type}</div>
        <div class="text-xs text-slate-500">${user.designation || '-'}</div>
        ${hasChildren ? `
            <div class="mt-2 text-xs text-slate-400">
                <i class="fa-solid fa-users mr-1"></i>
                ${user.children.length} direct report${user.children.length !== 1 ? 's' : ''}
            </div>
        ` : ''}
        ${hasChildren ? `
            <button class="collapse-btn mt-2 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-chevron-down collapse-icon"></i>
            </button>
        ` : ''}
    `;

        nodeDiv.appendChild(card);

        if (hasChildren) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'org-children ml-8 mt-4';

            user.children.forEach(child => {
                childrenContainer.appendChild(createNodeElement(child, level + 1));
            });

            nodeDiv.appendChild(childrenContainer);

            // Add collapse functionality
            const collapseBtn = card.querySelector('.collapse-btn');
            if (collapseBtn) {
                collapseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const icon = collapseBtn.querySelector('.collapse-icon');
                    const children = childrenContainer;

                    if (children.style.display === 'none') {
                        children.style.display = 'block';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        children.style.display = 'none';
                        icon.style.transform = 'rotate(-90deg)';
                    }
                });
            }
        }

        return nodeDiv;
    }

    function renderDepartmentView() {
        const container = document.getElementById('departmentGrid');
        container.innerHTML = '';

        // Group users by department
        const departments = {};
        allUsers.forEach(user => {
            const dept = user.subposition || 'Unassigned';
            if (!departments[dept]) {
                departments[dept] = [];
            }
            departments[dept].push(user);
        });

        Object.entries(departments).forEach(([deptName, users]) => {
            const deptCard = document.createElement('div');
            deptCard.className = 'department-card';

            const managers = users.filter(user =>
                users.some(other => other.manager_id === user.id)
            );

            deptCard.innerHTML = `
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center mr-3">
                    <i class="fa-solid fa-building text-slate-600"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-slate-800">${deptName}</h3>
                    <p class="text-sm text-slate-600">${users.length} employee${users.length !== 1 ? 's' : ''}</p>
                </div>
            </div>
            
            ${managers.length > 0 ? `
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-700 mb-2">Management</h4>
                    <div class="space-y-2">
                        ${managers.map(manager => `
                            <div class="flex items-center text-sm">
                                <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center mr-2 text-xs">
                                    ${getInitials(manager.name)}
                                </div>
                                <span class="text-slate-800">${manager.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <div class="text-sm space-y-1">
                <div class="flex justify-between">
                    <span class="text-slate-600">Total Staff:</span>
                    <span class="font-medium">${users.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Managers:</span>
                    <span class="font-medium">${managers.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Individual Contributors:</span>
                    <span class="font-medium">${users.length - managers.length}</span>
                </div>
            </div>
        `;

            container.appendChild(deptCard);
        });
    }

    function renderListView() {
        const tbody = document.getElementById('listTableBody');
        tbody.innerHTML = '';

        allUsers.forEach(user => {
            const manager = allUsers.find(u => u.id === user.manager_id);
            const directReports = allUsers.filter(u => u.manager_id === user.id);

            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-50';

            row.innerHTML = `
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center mr-3 text-sm">
                        ${getInitials(user.name)}
                    </div>
                    <div>
                        <div class="font-medium text-slate-800">${user.name}</div>
                        <div class="text-sm text-slate-500">${user.email}</div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">
                ${user.designation || user.subposition || '-'}
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">
                ${user.subposition || '-'}
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">
                ${manager ? manager.name : 'None'}
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">
                ${directReports.length}
            </td>
            <td class="px-4 py-3">
                <button onclick="editEmployee(${user.id})" class="text-slate-600 hover:text-slate-800">
                    <i class="fa-solid fa-edit"></i>
                </button>
            </td>
        `;

            tbody.appendChild(row);
        });
    }

    // Edit functionality
    function editEmployee(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;

        // Populate employee select
        const employeeSelect = document.getElementById('employeeSelect');
        employeeSelect.innerHTML = '';
        allUsers.forEach(u => {
            const option = document.createElement('option');
            option.value = u.id;
            option.textContent = `${u.name} (${u.subposition || u.employee_type})`;
            option.selected = u.id === userId;
            employeeSelect.appendChild(option);
        });

        // Populate manager select
        const managerSelect = document.getElementById('managerSelect');
        managerSelect.innerHTML = '<option value="">No Manager (Top Level)</option>';
        allUsers.forEach(u => {
            if (u.id !== userId) { // Can't report to themselves
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.name} (${u.subposition || u.employee_type})`;
                option.selected = u.id === user.manager_id;
                managerSelect.appendChild(option);
            }
        });

        document.getElementById('editModal').classList.remove('hidden');
    }

    async function saveReportingChange() {
        const employeeId = document.getElementById('employeeSelect').value;
        const managerId = document.getElementById('managerSelect').value || null;

        try {
            await postJSON('/api/org/update-reporting', {
                employee_id: employeeId,
                manager_id: managerId
            });

            document.getElementById('editModal').classList.add('hidden');
            await loadOrgData(); // Refresh the data
            showSuccess('Reporting structure updated successfully');
        } catch (error) {
            console.error('Error updating reporting structure:', error);
            showError('Failed to update reporting structure');
        }
    }

    // Event handlers
    function setupEventListeners() {
        // View type change
        document.getElementById('viewType').addEventListener('change', renderCurrentView);

        // Department filter
        document.getElementById('departmentFilter').addEventListener('change', () => {
            // Filter implementation can be added here
            renderCurrentView();
        });

        // Expand/Collapse buttons
        document.getElementById('expandAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.org-children').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.collapse-icon').forEach(icon => {
                icon.style.transform = 'rotate(0deg)';
            });
        });

        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.org-children').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.collapse-icon').forEach(icon => {
                icon.style.transform = 'rotate(-90deg)';
            });
        });

        // Edit mode
        document.getElementById('editModeBtn').addEventListener('click', () => {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            if (editMode) {
                btn.innerHTML = '<i class="fa-solid fa-eye mr-1"></i> View Mode';
                btn.classList.add('bg-slate-800', 'text-white');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-edit mr-1"></i> Edit Structure';
                btn.classList.remove('bg-slate-800', 'text-white');
            }
        });

        // Modal controls
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveReportingChange();
        });
    }

    function showError(message) {
        // You can implement toast notifications here
        console.error(message);
        alert('Error: ' + message);
    }

    function showSuccess(message) {
        // You can implement toast notifications here
        console.log(message);
        alert('Success: ' + message);
    }

    async function initializePage() {
        document.getElementById('loadingState').classList.remove('hidden');

        try {
            await loadOrgData();
            setupEventListeners();
            document.getElementById('loadingState').classList.add('hidden');
        } catch (error) {
            console.error('Error initializing org chart:', error);
            document.getElementById('loadingState').innerHTML = `
            <div class="text-center py-12">
                <i class="fa-solid fa-exclamation-triangle text-red-400 text-3xl mb-4"></i>
                <p class="text-red-600 mb-4">Failed to load organizational chart</p>
                <button onclick="initializePage()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Try Again
                </button>
            </div>
        `;
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

{% endblock %}