{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
        <div>
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-user-shield mr-2"></i> RBAC
            </h1>
            <p class="text-slate-600 text-sm">Role-based access control for secure feature access.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="w-full sm:w-auto px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm text-center">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Create (Dummy) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-8">
        <!-- Role -->
        <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-id-badge mr-2"></i> Create Role
            </h2>
            <form id="roleForm" class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Role Name *</label>
                    <input name="name" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Manager">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Description</label>
                    <input name="desc" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Approves expenses & timesheets">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Attach Permissions (comma)</label>
                    <input name="perms" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="expense.read, expense.approve">
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                        <i class="fa-solid fa-plus mr-1"></i>Add
                    </button>
                    <span id="roleMsg" class="text-sm text-slate-600"></span>
                </div>
            </form>
        </div>

        <!-- Permission -->
        <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-key mr-2"></i> Create Permission
            </h2>
            <form id="permForm" class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Permission Key *</label>
                    <input name="key" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="expense.approve">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Description</label>
                    <input name="desc" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Approve expense reports">
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                        <i class="fa-solid fa-plus mr-1"></i>Add
                    </button>
                    <span id="permMsg" class="text-sm text-slate-600"></span>
                </div>
            </form>
        </div>

        <!-- Assign -->
        <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-user-plus mr-2"></i> Assign Role to User
            </h2>
            <form id="assignForm" class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-sm text-slate-600 mb-1">User (ID - Name) *</label>
                    <input name="user" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="U001 - Charan">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">Role *</label>
                    <input name="role" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Manager">
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                        <i class="fa-solid fa-plus mr-1"></i>Assign
                    </button>
                    <span id="assignMsg" class="text-sm text-slate-600"></span>
                </div>
            </form>
        </div>
    </div>

    <!-- Filters + KPIs -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-6 gap-2">
        <input id="q" placeholder="Search role/perm/user…"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fRole" placeholder="Role" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fPerm" placeholder="Permission"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fUser" placeholder="User" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fStatus" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">Any Status</option>
            <option>Active</option>
            <option>Paused</option>
        </select>
        <button id="clearFilters"
            class="rounded-xl border border-slate-300 bg-white hover:bg-slate-50 px-3 py-2 text-sm">Clear</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Users</div>
            <div id="kpiUsers" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Roles</div>
            <div id="kpiRoles" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Permissions</div>
            <div id="kpiPerms" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Active Policies</div>
            <div id="kpiPolicies" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
        </div>
    </div>

    <!-- Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
        <!-- Roles -->
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div class="p-4 border-b border-slate-200 text-slate-800 font-semibold">
                <i class="fa-solid fa-id-badge mr-2"></i> Roles
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-[900px] w-full text-sm text-left text-slate-700">
                    <thead class="bg-slate-50 text-slate-600 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2">Role</th>
                            <th class="px-4 py-2">Description</th>
                            <th class="px-4 py-2">Perms</th>
                            <th class="px-4 py-2">Status</th>
                            <th class="px-4 py-2 w-56">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roleRows" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>
            <div id="roleListMsg" class="p-3 text-sm text-slate-600"></div>
        </div>

        <!-- Permissions -->
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div class="p-4 border-b border-slate-200 text-slate-800 font-semibold">
                <i class="fa-solid fa-key mr-2"></i> Permissions
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-[720px] w-full text-sm text-left text-slate-700">
                    <thead class="bg-slate-50 text-slate-600 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2">Key</th>
                            <th class="px-4 py-2">Description</th>
                            <th class="px-4 py-2 w-40">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="permRows" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>
            <div id="permListMsg" class="p-3 text-sm text-slate-600"></div>
        </div>

        <!-- Users -->
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div class="p-4 border-b border-slate-200 text-slate-800 font-semibold">
                <i class="fa-solid fa-users mr-2"></i> Users & Roles
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-[960px] w-full text-sm text-left text-slate-700">
                    <thead class="bg-slate-50 text-slate-600 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2">User</th>
                            <th class="px-4 py-2">Roles</th>
                            <th class="px-4 py-2">Effective Perms</th>
                            <th class="px-4 py-2 w-56">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userRows" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>
            <div id="userListMsg" class="p-3 text-sm text-slate-600"></div>
        </div>

        <!-- Policy Simulator -->
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div class="p-4 border-b border-slate-200 text-slate-800 font-semibold">
                <i class="fa-solid fa-vial mr-2"></i> Policy Simulator
            </div>
            <div class="p-4 grid grid-cols-1 md:grid-cols-5 gap-3">
                <input id="simUser" class="md:col-span-2 rounded-lg border border-slate-300 px-3 py-2 text-sm"
                    placeholder="U001 - Charan">
                <input id="simResource" class="md:col-span-2 rounded-lg border border-slate-300 px-3 py-2 text-sm"
                    placeholder="expense">
                <select id="simAction" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <option>read</option>
                    <option>create</option>
                    <option>approve</option>
                    <option>edit</option>
                </select>
                <div class="md:col-span-5 flex flex-col sm:flex-row sm:items-center gap-3">
                    <button id="simBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
                        <i class="fa-solid fa-play mr-1"></i>Simulate
                    </button>
                    <span id="simMsg" class="text-sm text-slate-600"></span>
                </div>
            </div>
            <div class="px-4 pb-4 text-xs text-slate-500">
                Simulator checks permission key =
                &lt;resource&gt;.&lt;action&gt; (e.g., <span class="font-mono">expense.approve</span>).
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------- Dummy store (localStorage) ---------- */
    const KEY = "dummy_rbac";
    let STORE = JSON.parse(localStorage.getItem(KEY) || "null") || {
        roles: [
            { name: "Admin", desc: "Full access", perms: ["*"], status: "Active" },
            { name: "Manager", desc: "Approve finance/time", perms: ["expense.read", "expense.approve", "timesheet.read", "timesheet.approve"], status: "Active" },
            { name: "Employee", desc: "Basic usage", perms: ["expense.read", "timesheet.read", "attendance.correct"], status: "Active" }
        ],
        perms: [
            { key: "expense.read", desc: "View expenses" },
            { key: "expense.approve", desc: "Approve expenses" },
            { key: "timesheet.read", desc: "View timesheets" },
            { key: "timesheet.approve", desc: "Approve timesheets" },
            { key: "workflow.manage", desc: "Manage workflows" },
            { key: "attendance.correct", desc: "Make admin corrections" },
            { key: "dependencies.view", desc: "View dependency graph" }
        ],
        users: [
            { user: "U001 - Charan", roles: ["Admin"] },
            { user: "U014 - Priya", roles: ["Manager"] },
            { user: "U009 - Arjun", roles: ["Employee"] }
        ]
    };
    function persist() { localStorage.setItem(KEY, JSON.stringify(STORE)); }

    /* ---------- Elements ---------- */
    const q = document.getElementById("q"), fRole = document.getElementById("fRole"), fPerm = document.getElementById("fPerm"), fUser = document.getElementById("fUser"), fStatus = document.getElementById("fStatus"), clearFilters = document.getElementById("clearFilters");
    const roleRows = document.getElementById("roleRows"), roleListMsg = document.getElementById("roleListMsg"), roleForm = document.getElementById("roleForm"), roleMsg = document.getElementById("roleMsg");
    const permRows = document.getElementById("permRows"), permListMsg = document.getElementById("permListMsg"), permForm = document.getElementById("permForm"), permMsg = document.getElementById("permMsg");
    const userRows = document.getElementById("userRows"), userListMsg = document.getElementById("userListMsg"), assignForm = document.getElementById("assignForm"), assignMsg = document.getElementById("assignMsg");
    const kpiUsers = document.getElementById("kpiUsers"), kpiRoles = document.getElementById("kpiRoles"), kpiPerms = document.getElementById("kpiPerms"), kpiPolicies = document.getElementById("kpiPolicies");
    const simUser = document.getElementById("simUser"), simResource = document.getElementById("simResource"), simAction = document.getElementById("simAction"), simBtn = document.getElementById("simBtn"), simMsg = document.getElementById("simMsg");

    /* ---------- Helpers ---------- */
    function td(el) { const x = document.createElement("td"); x.className = "px-4 py-2 align-top"; x.appendChild(el); return x; }
    function input(v, cls = "w-40") { const i = document.createElement("input"); i.value = v ?? ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function select(opts, cur) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; opts.forEach(o => { const op = document.createElement("option"); op.value = o; op.textContent = o; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }
    function flash(el, msg, ok = true) { el.textContent = msg; el.className = "text-sm " + (ok ? "text-emerald-700" : "text-rose-700"); setTimeout(() => { el.textContent = ""; el.className = "text-sm text-slate-600"; }, 1500); }
    const uniq = a => Array.from(new Set(a));

    /* ---------- Filters ---------- */
    function passRoleFilter(r) {
        const term = (q.value || "").toLowerCase().trim(), ro = (fRole.value || "").toLowerCase().trim(), st = fStatus.value;
        if (term && !(`${r.name} ${r.desc}`.toLowerCase().includes(term))) return false;
        if (ro && r.name.toLowerCase().indexOf(ro) === -1) return false;
        if (st && r.status !== st) return false;
        return true;
    }
    function passPermFilter(p) {
        const term = (q.value || "").toLowerCase().trim(), pe = (fPerm.value || "").toLowerCase().trim();
        if (term && !(`${p.key} ${p.desc}`.toLowerCase().includes(term))) return false;
        if (pe && p.key.toLowerCase().indexOf(pe) === -1) return false;
        return true;
    }
    function passUserFilter(u) {
        const term = (q.value || "").toLowerCase().trim(), us = (fUser.value || "").toLowerCase().trim(), ro = (fRole.value || "").toLowerCase().trim();
        if (term && !(`${u.user} ${u.roles.join(",")}`.toLowerCase().includes(term))) return false;
        if (us && u.user.toLowerCase().indexOf(us) === -1) return false;
        if (ro && !u.roles.some(r => r.toLowerCase().includes(ro))) return false;
        return true;
    }

    /* ---------- Effective Permissions ---------- */
    function rolePerms(roleName) {
        const r = STORE.roles.find(x => x.name === roleName); if (!r) return [];
        return r.perms.includes("*") ? ["*"] : uniq(r.perms);
    }
    function userEffectivePerms(userName) {
        const u = STORE.users.find(x => x.user === userName); if (!u) return [];
        const sets = u.roles.flatMap(rolePerms);
        return sets.includes("*") ? ["*"] : uniq(sets);
    }
    function isAllowed(userName, resource, action) {
        const key = resource.trim() + "." + action.trim();
        const perms = userEffectivePerms(userName);
        if (perms.includes("*")) return true;
        return perms.includes(key);
    }

    /* ---------- KPIs ---------- */
    function updateKPIs() {
        kpiUsers.textContent = String(STORE.users.length);
        kpiRoles.textContent = String(STORE.roles.length);
        kpiPerms.textContent = String(STORE.perms.length);
        const policies = STORE.roles.reduce((a, r) => a + (r.perms.includes("*") ? 1 : r.perms.length), 0);
        kpiPolicies.textContent = String(policies);
    }

    /* ---------- RENDER: Roles ---------- */
    function loadRoles() {
        roleRows.innerHTML = "";
        const data = STORE.roles.filter(passRoleFilter);
        data.forEach(r => {
            const tr = document.createElement("tr");
            const nameI = input(r.name, "w-40");
            const descI = input(r.desc || "", "w-48");
            const permsI = input(r.perms.join(", "), "w-64");
            const statusS = select(["Active", "Paused"], r.status || "Active");

            const actions = document.createElement("div");
            const saveBtn = document.createElement("button"); saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900"; saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i>Save';
            const delBtn = document.createElement("button"); delBtn.className = "px-2 py-1 rounded-md border border-slate-300 text-xs hover:bg-slate-50"; delBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Delete';
            actions.append(saveBtn, delBtn);

            tr.append(td(nameI), td(descI), td(permsI), td(statusS), td(actions));
            roleRows.appendChild(tr);

            saveBtn.addEventListener("click", () => {
                const newName = nameI.value.trim();
                if (!newName) { flash(roleListMsg, "Role name required", true); return; }
                if (newName !== r.name && STORE.roles.some(x => x.name === newName)) { flash(roleListMsg, "Role exists", true); return; }
                // update user role refs if renamed
                STORE.users.forEach(u => { u.roles = u.roles.map(x => x === r.name ? newName : x); });
                r.name = newName; r.desc = descI.value.trim();
                r.perms = uniq(permsI.value.split(",").map(s => s.trim()).filter(Boolean));
                r.status = statusS.value;
                persist(); updateKPIs(); loadUsers(); flash(roleListMsg, "Saved ✓");
            });
            delBtn.addEventListener("click", () => {
                if (!confirm("Delete role?")) return;
                STORE.roles = STORE.roles.filter(x => x !== r);
                STORE.users.forEach(u => { u.roles = u.roles.filter(x => x !== r.name); });
                persist(); updateKPIs(); loadRoles(); loadUsers();
            });
        });
        roleListMsg.textContent = data.length ? "" : "No roles.";
    }

    /* ---------- RENDER: Permissions ---------- */
    function loadPerms() {
        permRows.innerHTML = "";
        const data = STORE.perms.filter(passPermFilter);
        data.forEach(p => {
            const tr = document.createElement("tr");
            const keyI = input(p.key, "w-56");
            const descI = input(p.desc || "", "w-64");

            const actions = document.createElement("div");
            const saveBtn = document.createElement("button"); saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900"; saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i>Save';
            const delBtn = document.createElement("button"); delBtn.className = "px-2 py-1 rounded-md border border-slate-300 text-xs hover:bg-slate-50"; delBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Delete';
            actions.append(saveBtn, delBtn);

            tr.append(td(keyI), td(descI), td(actions));
            permRows.appendChild(tr);

            saveBtn.addEventListener("click", () => {
                const newKey = keyI.value.trim();
                if (!newKey) { flash(permListMsg, "Key required", true); return; }
                if (newKey !== p.key && STORE.perms.some(x => x.key === newKey)) { flash(permListMsg, "Permission exists", true); return; }
                // rewrite role permissions if key changed
                STORE.roles.forEach(r => { r.perms = r.perms.map(k => k === p.key ? newKey : k); });
                p.key = newKey; p.desc = descI.value.trim();
                persist(); updateKPIs(); loadRoles(); flash(permListMsg, "Saved ✓");
            });
            delBtn.addEventListener("click", () => {
                if (!confirm("Delete permission?")) return;
                STORE.roles.forEach(r => { r.perms = r.perms.filter(k => k !== p.key); });
                STORE.perms = STORE.perms.filter(x => x !== p);
                persist(); updateKPIs(); loadPerms(); loadRoles();
            });
        });
        permListMsg.textContent = data.length ? "" : "No permissions.";
    }

    /* ---------- RENDER: Users ---------- */
    function loadUsers() {
        userRows.innerHTML = "";
        const data = STORE.users.filter(passUserFilter);
        data.forEach(u => {
            const tr = document.createElement("tr");
            const userI = input(u.user, "w-48");
            const rolesI = input(u.roles.join(", "), "w-48");
            const eff = document.createElement("div"); eff.className = "text-xs text-slate-700";
            eff.textContent = userEffectivePerms(u.user).join(", ") || "—";

            const actions = document.createElement("div");
            const saveBtn = document.createElement("button"); saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900"; saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i>Save';
            const delBtn = document.createElement("button"); delBtn.className = "px-2 py-1 rounded-md border border-slate-300 text-xs hover:bg-slate-50"; delBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Delete';
            actions.append(saveBtn, delBtn);

            tr.append(td(userI), td(rolesI), td(eff), td(actions));
            userRows.appendChild(tr);

            function refreshEff() { eff.textContent = userEffectivePerms(userI.value.trim()).join(", ") || "—"; }

            saveBtn.addEventListener("click", () => {
                const newUser = userI.value.trim();
                if (!newUser) { flash(userListMsg, "User required", true); return; }
                if (newUser !== u.user && STORE.users.some(x => x.user === newUser)) { flash(userListMsg, "User exists", true); return; }
                u.user = newUser;
                u.roles = uniq(rolesI.value.split(",").map(s => s.trim()).filter(Boolean));
                persist(); updateKPIs(); refreshEff(); flash(userListMsg, "Saved ✓");
            });
            delBtn.addEventListener("click", () => {
                if (!confirm("Delete user mapping?")) return;
                STORE.users = STORE.users.filter(x => x !== u); persist(); updateKPIs(); loadUsers();
            });
        });
        userListMsg.textContent = data.length ? "" : "No users.";
    }

    /* ---------- Create handlers (dummy) ---------- */
    roleForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(roleForm);
        const name = (fd.get("name") || "").toString().trim();
        if (!name) { flash(roleMsg, "Name required", true); return; }
        if (STORE.roles.some(r => r.name === name)) { flash(roleMsg, "Role exists", true); return; }
        const desc = (fd.get("desc") || "").toString().trim();
        const perms = uniq((fd.get("perms") || "").toString().split(",").map(s => s.trim()).filter(Boolean));
        STORE.roles.unshift({ name, desc, perms, status: "Active" }); persist();
        roleForm.reset(); flash(roleMsg, "Role added ✓"); updateKPIs(); loadRoles();
    });

    permForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(permForm);
        const key = (fd.get("key") || "").toString().trim();
        if (!key) { flash(permMsg, "Key required", true); return; }
        if (STORE.perms.some(p => p.key === key)) { flash(permMsg, "Permission exists", true); return; }
        const desc = (fd.get("desc") || "").toString().trim();
        STORE.perms.unshift({ key, desc }); persist();
        permForm.reset(); flash(permMsg, "Permission added ✓"); updateKPIs(); loadPerms();
    });

    assignForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(assignForm);
        const user = (fd.get("user") || "").toString().trim();
        const role = (fd.get("role") || "").toString().trim();
        if (!user || !role) { flash(assignMsg, "User & Role required", true); return; }
        if (!STORE.roles.some(r => r.name === role)) { flash(assignMsg, "Role not found", true); return; }
        let u = STORE.users.find(x => x.user === user);
        if (!u) { u = { user, roles: [] }; STORE.users.unshift(u); }
        if (!u.roles.includes(role)) u.roles.push(role);
        persist(); assignForm.reset(); flash(assignMsg, "Assigned ✓"); updateKPIs(); loadUsers();
    });

    /* ---------- Simulator ---------- */
    simBtn.addEventListener("click", () => {
        const user = simUser.value.trim(), res = simResource.value.trim(), act = simAction.value.trim();
        if (!user || !res || !act) { flash(simMsg, "Fill all fields", true); return; }
        const ok = isAllowed(user, res, act);
        flash(simMsg, ok ? "✅ Allowed" : "⛔ Not allowed", ok);
    });

    /* ---------- Live filters ---------- */
    [q, fRole, fPerm, fUser, fStatus].forEach(el => el.addEventListener("input", () => {
        loadRoles(); loadPerms(); loadUsers();
    }));

    clearFilters.addEventListener("click", () => {
        q.value = ""; fRole.value = ""; fPerm.value = ""; fUser.value = ""; fStatus.value = "";
        loadRoles(); loadPerms(); loadUsers();
    });

    /* ---------- Init ---------- */
    function init() { updateKPIs(); loadRoles(); loadPerms(); loadUsers(); }
    init();
</script>
{% endblock %}