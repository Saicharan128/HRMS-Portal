{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
            </button>
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Report Categories (unchanged) -->
    <!-- … keep your categories exactly as-is … -->

    <!-- Reports Dashboard -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-list mr-2"></i> Generated Reports
                </h2>
                <div class="flex items-center gap-2">
                    <div class="hidden md:flex items-center gap-2">
                        <label class="text-sm text-slate-600">Search:</label>
                        <input id="searchInput" placeholder="Name / user / type…"
                            class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Filter:</label>
                        <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="">All Types</option>
                            <option value="hr">HR Reports</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="attendance">Time & Attendance</option>
                            <option value="compliance">Compliance</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Period:</label>
                        <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk actions bar -->
        <div id="bulkBar"
            class="hidden px-6 py-3 border-b border-slate-200 bg-slate-50 text-sm flex items-center justify-between">
            <div><span id="bulkCount" class="font-medium">0</span> selected</div>
            <div class="flex items-center gap-2">
                <button id="bulkDownload"
                    class="px-3 py-1 rounded border border-slate-300 hover:bg-white">Download</button>
                <button id="bulkShare" class="px-3 py-1 rounded border border-slate-300 hover:bg-white">Share</button>
                <button id="bulkDelete"
                    class="px-3 py-1 rounded border border-rose-300 text-rose-700 hover:bg-white">Delete</button>
                <button id="clearSelection"
                    class="px-3 py-1 rounded border border-slate-300 hover:bg-white">Clear</button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <!-- Empty -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Generated Yet</h3>
            <p class="text-slate-600 mb-4">Start by generating your first report from the categories above.</p>
        </div>

        <!-- Table -->
        <div id="reportsTable" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3">
                                <input id="selectAll" type="checkbox" class="rounded border-slate-300">
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="name">Report
                                Name <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="type">Type <i
                                    class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable"
                                data-key="generated_date">Generated <i class="fa-solid fa-sort text-slate-400 ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable" data-key="generated_by">
                                Generated By <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700 sortable"
                                data-key="file_size_num">Size <i class="fa-solid fa-sort text-slate-400 ml-1"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Status</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="p-6 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">
                    Showing <span id="pageInfo">0-0 of 0</span> reports
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Previous</button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal (unchanged markup) -->
<!-- Report Preview Modal (unchanged markup) -->
<!-- Toasts (unchanged markup) -->

<script>
    document.addEventListener('DOMContentLoaded', initializeReports);

    /* ---------- State ---------- */
    const LS_KEY = "all_reports_store_v1";
    let reports = [];
    let filteredReports = [];
    let currentPage = 1;
    let totalPages = 1;
    let reportIdCounter = 100;
    let sortState = { key: "generated_date", dir: "desc" };
    let selectedIds = new Set();

    /* ---------- Boot ---------- */
    async function initializeReports() {
        await loadReportsData();
        setupEventListeners();
        renderReports();
        ensureCharts(); // for preview charts
    }

    /* ---------- Persistence ---------- */
    function loadFromLS() {
        try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; }
    }
    function saveToLS() {
        localStorage.setItem(LS_KEY, JSON.stringify({ reports, reportIdCounter }));
    }

    /* ---------- Mock Load ---------- */
    async function loadReportsData() {
        document.getElementById('loadingState').classList.remove('hidden');

        // Simulate network
        await new Promise(r => setTimeout(r, 400));

        const saved = loadFromLS();
        if (saved && Array.isArray(saved.reports)) {
            reports = saved.reports;
            reportIdCounter = saved.reportIdCounter || reportIdCounter;
        } else {
            const mockReports = [
                { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", file_size_num: 2.4, format: "pdf", status: "completed", download_count: 15 },
                { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", file_size_num: 1.8, format: "excel", status: "completed", download_count: 8 },
                { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", file_size_num: 3.2, format: "pdf", status: "completed", download_count: 22 },
                { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", file_size_num: 1.5, format: "csv", status: "processing", progress: 42, download_count: 0 },
                { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "0.98 MB", file_size_num: 0.98, format: "pdf", status: "completed", download_count: 5 }
            ];
            reports = mockReports;
            reportIdCounter = 6;
            saveToLS();
        }

        filteredReports = [...reports];
        updateSummaryStats();
        document.getElementById('loadingState').classList.add('hidden');

        // Drive processing items forward
        tickProcessing();
    }

    /* ---------- Stats ---------- */
    function updateSummaryStats() {
        const today = new Date().toDateString();
        const todayCnt = reports.filter(r => new Date(r.generated_date).toDateString() === today).length;
        const totalDl = reports.reduce((s, r) => s + (r.download_count || 0), 0);
        const scheduled = reports.filter(r => r.status === 'scheduled').length;

        document.getElementById('totalReports').textContent = reports.length;
        document.getElementById('todayReports').textContent = todayCnt;
        document.getElementById('totalDownloads').textContent = totalDl;
        document.getElementById('scheduledReports').textContent = scheduled;
    }

    /* ---------- UI Events ---------- */
    function setupEventListeners() {
        // Existing buttons
        document.getElementById('newReportBtn').addEventListener('click', openGenerateReportModal);
        document.getElementById('closeGenerateModal').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('cancelGenerate').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('closePreviewModal').addEventListener('click', () => closeModal('reportPreviewModal'));
        document.getElementById('generateReportForm').addEventListener('submit', handleGenerateReport);

        // Filters
        document.getElementById('reportTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('refreshReports').addEventListener('click', async () => { await loadReportsData(); renderReports(); });
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', applyFilters);

        // Download in preview
        document.getElementById('downloadReportBtn').addEventListener('click', () => showInfo('Download from preview initiated'));

        // Modals click-outside
        window.addEventListener('click', (e) => {
            ['generateReportModal', 'reportPreviewModal'].forEach(id => {
                const m = document.getElementById(id);
                if (e.target === m) closeModal(id);
            });
        });

        // Sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                sortState.dir = (sortState.key === key && sortState.dir === 'asc') ? 'desc' : 'asc';
                sortState.key = key;
                renderReports();
            });
        });

        // Pagination
        document.getElementById('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderReports(); } });
        document.getElementById('nextPageBtn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderReports(); } });

        // Select all & bulk bar
        document.getElementById('selectAll').addEventListener('change', (e) => {
            const pageIds = currentPageIds();
            if (e.target.checked) pageIds.forEach(id => selectedIds.add(id));
            else pageIds.forEach(id => selectedIds.delete(id));
            updateBulkBar(); renderReportsTable();
        });
        document.getElementById('bulkDownload').addEventListener('click', () => bulkAction('download'));
        document.getElementById('bulkShare').addEventListener('click', () => bulkAction('share'));
        document.getElementById('bulkDelete').addEventListener('click', () => bulkAction('delete'));
        document.getElementById('clearSelection').addEventListener('click', () => { selectedIds.clear(); updateBulkBar(); renderReportsTable(); });

        // CSV export
        document.getElementById('exportCsvBtn').addEventListener('click', exportCurrentPageCsv);

        // Form dynamic controls (from your original)
        document.querySelector('select[name="report_type"]').addEventListener('change', updateTemplateOptions);
        document.querySelector('select[name="date_range"]').addEventListener('change', toggleCustomDateRange);
        document.getElementById('scheduleReport').addEventListener('change', toggleScheduleOptions);
    }

    /* ---------- Filters + Search ---------- */
    function applyFilters() {
        const typeFilter = document.getElementById('reportTypeFilter').value;
        const periodFilter = document.getElementById('periodFilter').value;
        const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();

        filteredReports = reports.filter(report => {
            const matchesType = !typeFilter || report.type === typeFilter;

            let matchesPeriod = true;
            if (periodFilter && periodFilter !== 'all') {
                const reportDate = new Date(report.generated_date);
                const now = new Date();
                const daysAgo = parseInt(periodFilter);
                const cutoffDate = new Date(now.getTime() - daysAgo * 86400000);
                matchesPeriod = reportDate >= cutoffDate;
            }

            const matchesSearch = !q || [
                report.name, report.type, report.generated_by, formatType(report.type)
            ].join(' ').toLowerCase().includes(q);

            return matchesType && matchesPeriod && matchesSearch;
        });

        currentPage = 1;
        renderReports();
    }

    /* ---------- Rendering ---------- */
    function renderReports() {
        if (filteredReports.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('reportsTable').classList.add('hidden');
            updateBulkBar();
            return;
        }
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('reportsTable').classList.remove('hidden');
        renderReportsTable();
        updatePagination();
    }

    function sortArray(arr) {
        const { key, dir } = sortState;
        const mult = dir === 'asc' ? 1 : -1;
        return [...arr].sort((a, b) => {
            const va = (key === 'generated_date') ? new Date(a[key]).getTime()
                : (key === 'file_size_num') ? (a.file_size_num || parseFloat(a.file_size) || 0)
                    : String(a[key] ?? '').toLowerCase();
            const vb = (key === 'generated_date') ? new Date(b[key]).getTime()
                : (key === 'file_size_num') ? (b.file_size_num || parseFloat(b.file_size) || 0)
                    : String(b[key] ?? '').toLowerCase();
            if (va < vb) return -1 * mult;
            if (va > vb) return 1 * mult;
            return 0;
        });
    }

    function renderReportsTable() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '';

        const itemsPerPage = 10;
        const sorted = sortArray(filteredReports);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageReports = sorted.slice(startIndex, endIndex);

        pageReports.forEach(report => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50';

            const checked = selectedIds.has(report.id) ? 'checked' : '';
            const progressBar = (report.status === 'processing')
                ? `<div class="w-36"><div class="h-2 bg-slate-200 rounded"><div class="h-2 rounded bg-blue-500" style="width:${report.progress || 0}%;"></div></div><div class="text-xs text-slate-500 mt-1">${report.progress || 0}%</div></div>`
                : '';

            tr.innerHTML = `
            <td class="px-6 py-4">
                <input type="checkbox" class="rowChk rounded border-slate-300" data-id="${report.id}" ${checked}>
            </td>
            <td class="px-6 py-4">
                <div>
                    <div class="font-medium text-slate-800">${report.name}</div>
                    <div class="text-sm text-slate-600">ID: #${report.id}</div>
                </div>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(report.type)}">
                    ${formatType(report.type)}
                </span>
            </td>
            <td class="px-6 py-4 text-slate-800">${formatDate(report.generated_date)}</td>
            <td class="px-6 py-4 text-slate-800">${report.generated_by}</td>
            <td class="px-6 py-4 text-slate-800">${report.file_size}</td>
            <td class="px-6 py-4">
                ${report.status === 'processing' ? progressBar :
                    `<span class="px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(report.status)}">
                        ${formatStatus(report.status)}
                    </span>`}
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    ${report.status === 'completed' ? `
                        <button onclick="previewReport(${report.id})" class="text-blue-600 hover:text-blue-800" title="Preview"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="downloadReport(${report.id})" class="text-green-600 hover:text-green-800" title="Download"><i class="fa-solid fa-download"></i></button>
                        <button onclick="shareReport(${report.id})" class="text-purple-600 hover:text-purple-800" title="Share"><i class="fa-solid fa-share"></i></button>
                    ` : report.status === 'failed' ? `
                        <button onclick="retryReport(${report.id})" class="text-amber-600 hover:text-amber-800" title="Retry"><i class="fa-solid fa-rotate-right"></i></button>
                    ` : `
                        <span class="text-slate-400"><i class="fa-solid fa-clock" title="Processing"></i></span>
                    `}
                    <button onclick="deleteReport(${report.id})" class="text-red-600 hover:text-red-800" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </div>
            </td>
        `;
            tbody.appendChild(tr);
        });

        // row checkbox events
        tbody.querySelectorAll('.rowChk').forEach(chk => {
            chk.addEventListener('change', (e) => {
                const id = Number(e.target.dataset.id);
                if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
                updateBulkBar();
            });
        });

        // sync selectAll checkbox
        const pageIds = pageReports.map(r => r.id);
        const allOnPageSelected = pageIds.every(id => selectedIds.has(id)) && pageIds.length > 0;
        document.getElementById('selectAll').checked = allOnPageSelected;

        updateBulkBar();
    }

    function updatePagination() {
        const itemsPerPage = 10;
        totalPages = Math.ceil(filteredReports.length / itemsPerPage) || 1;
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredReports.length);
        document.getElementById('pageInfo').textContent =
            `${filteredReports.length ? start : 0}-${filteredReports.length ? end : 0} of ${filteredReports.length}`;

        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages;

        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ? 'px-3 py-1 rounded bg-slate-800 text-white text-sm'
                    : 'px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50';
                btn.onclick = () => { currentPage = i; renderReports(); };
                pageNumbers.appendChild(btn);
            } else if (Math.abs(i - currentPage) === 3) {
                const span = document.createElement('span'); span.textContent = '...'; span.className = 'px-2 text-slate-400'; pageNumbers.appendChild(span);
            }
        }
    }

    function currentPageIds() {
        const itemsPerPage = 10;
        const sorted = sortArray(filteredReports);
        const startIndex = (currentPage - 1) * itemsPerPage;
        return sorted.slice(startIndex, startIndex + itemsPerPage).map(r => r.id);
    }

    function updateBulkBar() {
        const bar = document.getElementById('bulkBar');
        const count = selectedIds.size;
        document.getElementById('bulkCount').textContent = count;
        bar.classList.toggle('hidden', count === 0);
    }

    /* ---------- CSV Export ---------- */
    function exportCurrentPageCsv() {
        const itemsPerPage = 10;
        const sorted = sortArray(filteredReports);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const page = sorted.slice(startIndex, startIndex + itemsPerPage);
        if (!page.length) { showInfo('Nothing to export'); return; }
        const header = ["id", "name", "type", "generated_date", "generated_by", "file_size", "format", "status", "download_count"];
        const lines = [header.join(",")].concat(page.map(r => header.map(k => `"${String(r[k] ?? '').replace(/"/g, '""')}"`).join(",")));
        const blob = new Blob([lines.join("\n")], { type: "text/csv" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `reports_page_${currentPage}.csv`;
        a.click(); URL.revokeObjectURL(a.href);
    }

    /* ---------- Quick Report (keep your map) ---------- */
    async function generateQuickReport(reportType) {
        try {
            showInfo(`Generating ${formatReportName(reportType)} report...`);
            await new Promise(r => setTimeout(r, 600));
            const now = new Date();
            const size = +(Math.random() * 3 + 0.5).toFixed(2);
            const newReport = {
                id: reportIdCounter++,
                name: `${formatReportName(reportType)} - ${now.toLocaleDateString()}`,
                type: getReportTypeFromTemplate(reportType),
                generated_date: now.toISOString(),
                generated_by: "Current User",
                file_size: `${size} MB`,
                file_size_num: size,
                format: "pdf",
                status: Math.random() < 0.15 ? "failed" : "processing",
                progress: 0,
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            saveToLS();
            showSuccess('Report queued!');
            updateSummaryStats();
            renderReports();
            tickProcessing();
        } catch (e) { console.error(e); showError('Failed to generate report'); }
    }

    /* ---------- Generate Modal handlers (use your existing form) ---------- */
    function openGenerateReportModal() { document.getElementById('generateReportModal').classList.remove('hidden'); }
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'generateReportModal') {
            document.getElementById('generateReportForm').reset();
            document.getElementById('customDateRange').classList.add('hidden');
            document.getElementById('scheduleOptions').classList.add('hidden');
        }
    }
    function updateTemplateOptions() {
        const rt = document.querySelector('select[name="report_type"]').value;
        const sel = document.querySelector('select[name="template_id"]');
        sel.innerHTML = '<option value="">Select Template</option>';
        const templates = {
            'hr': [{ value: 'employee_roster', text: 'Employee Roster' }, { value: 'headcount_analysis', text: 'Headcount Analysis' }, { value: 'turnover_report', text: 'Turnover Report' }, { value: 'diversity_metrics', text: 'Diversity Metrics' }],
            'performance': [{ value: 'performance_summary', text: 'Performance Summary' }, { value: 'goal_achievement', text: 'Goal Achievement' }, { value: 'review_completion', text: 'Review Completion' }, { value: 'top_performers', text: 'Top Performers' }],
            'financial': [{ value: 'payroll_summary', text: 'Payroll Summary' }, { value: 'cost_analysis', text: 'Cost Analysis' }, { value: 'expense_reports', text: 'Expense Reports' }, { value: 'budget_variance', text: 'Budget Variance' }],
            'attendance': [{ value: 'attendance_summary', text: 'Attendance Summary' }, { value: 'leave_analysis', text: 'Leave Analysis' }, { value: 'overtime_report', text: 'Overtime Report' }, { value: 'tardiness_report', text: 'Tardiness Report' }],
            'compliance': [{ value: 'eeo_report', text: 'EEO Report' }, { value: 'safety_incidents', text: 'Safety Incidents' }, { value: 'policy_compliance', text: 'Policy Compliance' }, { value: 'audit_trail', text: 'Audit Trail' }]
        };
        (templates[rt] || []).forEach(t => { const o = document.createElement('option'); o.value = t.value; o.textContent = t.text; sel.appendChild(o); });
    }
    function toggleCustomDateRange() {
        const v = document.querySelector('select[name="date_range"]').value;
        document.getElementById('customDateRange').classList.toggle('hidden', v !== 'custom');
    }
    function toggleScheduleOptions() {
        const on = document.getElementById('scheduleReport').checked;
        document.getElementById('scheduleOptions').classList.toggle('hidden', !on);
    }
    async function handleGenerateReport(e) {
        e.preventDefault();
        try {
            const fd = new FormData(e.target);
            const d = Object.fromEntries(fd.entries());
            const btn = e.target.querySelector('button[type="submit"]');
            const txt = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating...'; btn.disabled = true;

            await new Promise(r => setTimeout(r, 900));

            const now = new Date();
            const size = +(Math.random() * 3 + 0.5).toFixed(2);
            const newReport = {
                id: reportIdCounter++,
                name: d.report_name || `${formatReportName(d.template_id)} - ${now.toLocaleDateString()}`,
                type: d.report_type,
                generated_date: now.toISOString(),
                generated_by: "Current User",
                file_size: `${size} MB`,
                file_size_num: size,
                format: d.format,
                status: d.schedule_report ? "scheduled" : "processing",
                progress: d.schedule_report ? 0 : 5,
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            saveToLS();

            showSuccess(d.schedule_report ? 'Report scheduled!' : 'Report queued!');
            closeModal('generateReportModal');
            updateSummaryStats(); renderReports();
            btn.innerHTML = txt; btn.disabled = false;

            if (newReport.status === 'processing') tickProcessing();
        } catch (err) {
            console.error(err); showError('Failed to generate report');
        }
    }

    /* ---------- Processing Engine ---------- */
    let ticking = false;
    function tickProcessing() {
        if (ticking) return;
        ticking = true;
        const step = () => {
            let any = false;
            reports.forEach(r => {
                if (r.status === 'processing') {
                    any = true;
                    r.progress = Math.min(100, (r.progress || 0) + (5 + Math.floor(Math.random() * 12)));
                    if (r.progress >= 100) {
                        r.status = Math.random() < 0.08 ? 'failed' : 'completed';
                        r.progress = undefined;
                    }
                }
            });
            if (any) {
                saveToLS();
                updateSummaryStats();
                // only re-render current page for perf
                renderReportsTable();
                setTimeout(step, 600);
            } else {
                ticking = false;
            }
        };
        setTimeout(step, 600);
    }
    function retryReport(id) {
        const r = reports.find(x => x.id === id);
        if (!r) return;
        r.status = 'processing'; r.progress = 0; saveToLS();
        showInfo('Retrying…'); renderReportsTable(); tickProcessing();
    }

    /* ---------- Actions ---------- */
    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const modal = document.getElementById('reportPreviewModal');
        const content = document.getElementById('reportPreviewContent');
        content.innerHTML = generateReportPreview(r);
        modal.classList.remove('hidden');
    }
    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}…`);
        // real file blob
        const payload = `Report: ${r.name}\nType: ${r.type}\nGenerated: ${r.generated_date}\nBy: ${r.generated_by}\nFormat: ${r.format}`;
        const blob = new Blob([payload], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = r.name.replace(/[^a-z0-9-_ ]/gi, '_') + '.txt'; a.click(); URL.revokeObjectURL(a.href);
        setTimeout(() => { r.download_count = (r.download_count || 0) + 1; saveToLS(); updateSummaryStats(); renderReportsTable(); showSuccess('Report downloaded'); }, 400);
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const url = location.href.split('?')[0] + `?report=${id}`;
        if (navigator.share) {
            navigator.share({ title: r.name, text: `Check out this report: ${r.name}`, url });
        } else {
            navigator.clipboard.writeText(url).then(() => showSuccess('Link copied to clipboard!')).catch(() => showInfo('Share not available'));
        }
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"?`)) return;
        reports = reports.filter(x => x.id !== id);
        filteredReports = filteredReports.filter(x => x.id !== id);
        selectedIds.delete(id);
        saveToLS(); updateSummaryStats(); renderReports();
        showSuccess('Report deleted');
    }

    /* ---------- Bulk ---------- */
    function bulkAction(type) {
        if (!selectedIds.size) return;
        const items = reports.filter(r => selectedIds.has(r.id));
        if (type === 'delete') {
            if (!confirm(`Delete ${items.length} selected reports?`)) return;
            reports = reports.filter(r => !selectedIds.has(r.id));
            filteredReports = filteredReports.filter(r => !selectedIds.has(r.id));
            selectedIds.clear(); saveToLS(); updateSummaryStats(); renderReports(); showSuccess('Deleted selected');
            return;
        }
        if (type === 'download') {
            items.forEach(r => downloadReport(r.id));
            return;
        }
        if (type === 'share') {
            items.forEach(r => shareReport(r.id));
            return;
        }
    }

    /* ---------- Preview Builders (reuse yours; add charts) ---------- */
    function generateReportPreview(report) {
        switch (report.type) {
            case 'hr': return generateHRReportPreview(report);
            case 'performance': return generatePerformanceReportPreview(report);
            case 'financial': return generateFinancialReportPreview(report);
            case 'attendance': return generateAttendanceReportPreview(report);
            case 'compliance': return generateComplianceReportPreview(report);
            default: return '<p class="text-slate-600">Report preview not available.</p>';
        }
    }
    function generateHRReportPreview(report) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Employees</h5><p class="text-2xl font-bold text-blue-600">247</p></div>
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">New Hires</h5><p class="text-2xl font-bold text-green-600">15</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Departures</h5><p class="text-2xl font-bold text-red-600">8</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Breakdown</h5>
      <canvas id="hrDeptChart" height="180"></canvas>
    </div>
  </div>`; setTimeout(() => drawMiniBar('hrDeptChart', [95, 42, 28, 22, 15], ['Eng', 'Sales', 'Mkt', 'Ops', 'HR']), 0);
    }
    function generatePerformanceReportPreview(report) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Rating</h5><p class="text-2xl font-bold text-green-600">4.2/5</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Reviews Completed</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Goals Achieved</h5><p class="text-2xl font-bold text-yellow-600">76%</p></div>
      <div class="bg-purple-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Top Performers</h5><p class="text-2xl font-bold text-purple-600">23</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Performance Distribution</h5>
      <canvas id="perfPie" height="180"></canvas>
    </div>
  </div>`; setTimeout(() => drawMiniPie('perfPie', [18, 67, 15], ['Exceeds', 'Meets', 'Below']), 0);
    }
    function generateFinancialReportPreview(report) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Payroll</h5><p class="text-2xl font-bold text-green-600">$1.2M</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Benefits Cost</h5><p class="text-2xl font-bold text-blue-600">$245K</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Expenses</h5><p class="text-2xl font-bold text-yellow-600">$89K</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Costs</h5>
      <canvas id="finLine" height="180"></canvas>
    </div>
  </div>`; setTimeout(() => drawMiniLine('finLine', [687.5, 312, 156], ['Eng', 'Sales', 'Mkt']), 0);
    }
    function generateAttendanceReportPreview(report) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Attendance</h5><p class="text-2xl font-bold text-green-600">94.2%</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">On Time %</h5><p class="text-2xl font-bold text-blue-600">87.5%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Leave Days</h5><p class="text-2xl font-bold text-yellow-600">156</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Sick Days</h5><p class="text-2xl font-bold text-red-600">89</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Attendance Trends</h5>
      <canvas id="attBar" height="180"></canvas>
    </div>
  </div>`; setTimeout(() => drawMiniBar('attBar', [42, 128, 77], ['Perfect', '1-2 Abs', '3+ Abs']), 0);
    }
    function generateComplianceReportPreview(report) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(report.generated_date)} by ${report.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Compliance Score</h5><p class="text-2xl font-bold text-green-600">96%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Open Issues</h5><p class="text-2xl font-bold text-yellow-600">3</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Training Complete</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Compliance Areas</h5>
      <canvas id="compPie" height="180"></canvas>
    </div>
  </div>`; setTimeout(() => drawMiniPie('compPie', [1, 1, 1], ['EEO', 'Safety', 'Privacy']), 0);
    }

    /* ---------- Mini Charts ---------- */
    let chartsReady = false;
    function ensureCharts() {
        if (typeof Chart !== 'undefined') { chartsReady = true; return; }
        if (chartsReady) return;
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = () => { chartsReady = true; };
        document.head.appendChild(s);
    }
    function drawMiniBar(id, data, labels) {
        if (!chartsReady) return setTimeout(() => drawMiniBar(id, data, labels), 150);
        const ctx = document.getElementById(id); if (!ctx) return;
        new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ data }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
    }
    function drawMiniPie(id, data, labels) {
        if (!chartsReady) return setTimeout(() => drawMiniPie(id, data, labels), 150);
        const ctx = document.getElementById(id); if (!ctx) return;
        new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data }] }, options: { plugins: { legend: { position: 'bottom' } } } });
    }
    function drawMiniLine(id, data, labels) {
        if (!chartsReady) return setTimeout(() => drawMiniLine(id, data, labels), 150);
        const ctx = document.getElementById(id); if (!ctx) return;
        new Chart(ctx, { type: 'line', data: { labels, datasets: [{ data, fill: false }] }, options: { plugins: { legend: { display: false } } } });
    }

    /* ---------- Helpers from your page ---------- */
    function getReportTypeFromTemplate(t) {
        const map = {
            'employee_roster': 'hr', 'headcount_analysis': 'hr', 'turnover_report': 'hr', 'diversity_metrics': 'hr', 'recruitment_pipeline': 'hr',
            'performance_summary': 'performance', 'goal_achievement': 'performance', 'review_completion': 'performance', 'top_performers': 'performance', 'training_completion': 'performance',
            'payroll_summary': 'financial', 'cost_analysis': 'financial', 'expense_reports': 'financial', 'budget_variance': 'financial', 'contractor_payments': 'financial',
            'attendance_summary': 'attendance', 'leave_analysis': 'attendance', 'overtime_report': 'attendance', 'tardiness_report': 'attendance',
            'eeo_report': 'compliance', 'safety_incidents': 'compliance', 'policy_compliance': 'compliance', 'audit_trail': 'compliance'
        }; return map[t] || 'hr';
    }
    function formatReportName(s) { return (s || 'Report').split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
    function getTypeBadgeClass(type) { const c = { hr: 'bg-blue-100 text-blue-700', performance: 'bg-green-100 text-green-700', financial: 'bg-yellow-100 text-yellow-700', attendance: 'bg-purple-100 text-purple-700', compliance: 'bg-red-100 text-red-700' }; return c[type] || 'bg-slate-100 text-slate-700'; }
    function getStatusBadgeClass(st) { const c = { completed: 'bg-green-100 text-green-700', processing: 'bg-blue-100 text-blue-700', failed: 'bg-red-100 text-red-700', scheduled: 'bg-yellow-100 text-yellow-700' }; return c[st] || 'bg-slate-100 text-slate-700'; }
    function formatStatus(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function formatDate(d) { return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }

    /* ---------- Toasts (reuse yours) ---------- */
    function showToast(type, message) {
        const toast = document.getElementById(`${type}Toast`); const msg = document.getElementById(`${type}Message`);
        msg.textContent = message; toast.classList.remove('translate-x-full'); setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }
    function showSuccess(m) { showToast('success', m); }
    function showError(m) { showToast('error', m); }
    function showInfo(m) { showToast('info', m); }
</script>
{% endblock %}