{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-money-check-dollar mr-2"></i> Payroll
            </h1>
            <p class="text-slate-600 text-sm">Automate salary calculations, compliance, and disbursements.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="runPayrollBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-play mr-1"></i> Run Payroll
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex flex-wrap gap-1 bg-slate-100 p-1 rounded-xl">
            <button id="runsTab" class="py-tab active px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-list-ul mr-1"></i> Runs</button>
            <button id="employeesTab" class="py-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-users mr-1"></i> Employees</button>
            <button id="calcTab" class="py-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-calculator mr-1"></i> Calculations</button>
            <button id="complianceTab" class="py-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-scale-balanced mr-1"></i> Compliance</button>
            <button id="disbTab" class="py-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-building-columns mr-1"></i> Disbursements</button>
            <button id="reportsTab" class="py-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-chart-line mr-1"></i> Reports</button>
        </div>
    </div>

    <!-- Runs -->
    <section id="runsPanel" class="py-panel">
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div
                class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between p-4 border-b border-slate-200">
                <div class="flex items-center gap-2">
                    <select id="cycleSelect" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                        <option value="monthly">Monthly</option>
                        <option value="biweekly">Bi-weekly</option>
                    </select>
                    <input id="periodInput" type="month" class="px-3 py-2 rounded-lg border border-slate-300 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <button id="recalcRuns"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-rotate mr-1"></i> Recalculate last draft
                    </button>
                    <button id="postAll"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                        <i class="fa-solid fa-paper-plane mr-1"></i> Post all drafts
                    </button>
                    <button id="exportRuns"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                    </button>
                </div>
                <div class="text-sm text-slate-600">
                    <span id="kpiNet">Net: â€”</span> â€¢ <span id="kpiTax">Taxes: â€”</span> â€¢ <span id="kpiHeadcount">HC:
                        â€”</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="sticky top-0 bg-slate-50 text-slate-500 border-b z-10">
                        <tr>
                            <th class="py-2 px-4">Run ID</th>
                            <th class="py-2 px-4">Period</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4">Gross</th>
                            <th class="py-2 px-4">Taxes</th>
                            <th class="py-2 px-4">Net</th>
                            <th class="py-2 px-4 w-28"></th>
                        </tr>
                    </thead>
                    <tbody id="runRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Employees -->
    <section id="employeesPanel" class="py-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-users mr-2"></i> Employees</h3>
                <div class="flex items-center gap-2">
                    <button id="addEmpBtn"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                        <i class="fa-solid fa-plus mr-1"></i> Add
                    </button>
                    <select id="empFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button id="exportEmp"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="sticky top-0 bg-slate-50 text-slate-500 border-b z-10">
                        <tr>
                            <th class="py-2 px-4">Employee</th>
                            <th class="py-2 px-4">Role</th>
                            <th class="py-2 px-4">Base</th>
                            <th class="py-2 px-4">Allowance</th>
                            <th class="py-2 px-4">Deductions</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4 w-48">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="empRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Calculations -->
    <section id="calcPanel" class="py-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6 lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-calculator mr-2"></i>
                        Calculator</h3>
                    <button id="recalcBtn"
                        class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Recalculate
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Employee</label>
                        <select id="calcEmp" class="w-full rounded-lg border border-slate-300 px-3 py-2"></select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Basic Pay</label>
                        <input id="calcBasic" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Allowances</label>
                        <input id="calcAllow" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Overtime (hrs)</label>
                        <input id="calcOtHrs" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">OT Rate (/hr)</label>
                        <input id="calcOtRate" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">LOP (days)</label>
                        <input id="calcLop" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Deductions (pre-tax)</label>
                        <input id="calcDedPre" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Deductions (post-tax)</label>
                        <input id="calcDedPost" type="number"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Tax Rate (%)</label>
                        <input id="calcTax" type="number" step="0.1" value="15"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Cycle</label>
                        <select id="calcCycle" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="monthly">Monthly</option>
                            <option value="biweekly">Bi-weekly</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Prorate (%)</label>
                        <input id="calcProrate" type="number" step="1" value="100"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Currency (display)</label>
                        <input id="calcCur" class="w-full rounded-lg border border-slate-300 px-3 py-2" value="USD">
                    </div>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Gross</div>
                        <div id="outGross" class="text-lg font-semibold text-slate-800">â€”</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Taxes</div>
                        <div id="outTax" class="text-lg font-semibold text-slate-800">â€”</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Net</div>
                        <div id="outNet" class="text-lg font-semibold text-slate-800">â€”</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Employer Costs</div>
                        <div id="outEr" class="text-lg font-semibold text-slate-800">â€”</div>
                    </div>
                </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-gear mr-2"></i> Rules</h3>
                <div class="space-y-3 text-sm">
                    <label class="flex items-center gap-2"><input id="rulePF" type="checkbox" checked> PF/401k employer
                        match 4%</label>
                    <label class="flex items-center gap-2"><input id="ruleESIC" type="checkbox"> ESIC/Health contrib
                        3%</label>
                    <label class="flex items-center gap-2"><input id="ruleBonus" type="checkbox"> Include performance
                        bonus (10%)</label>
                </div>
            </div>
        </div>
    </section>

    <!-- Compliance -->
    <section id="compliancePanel" class="py-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-receipt mr-2"></i> Statutory
                        Checklist</h3>
                    <span id="compCount" class="text-xs text-slate-500"></span>
                </div>
                <div id="compList" class="space-y-3"></div>
                <button id="markAllComp"
                    class="mt-2 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                    <i class="fa-solid fa-check mr-1"></i> Mark All Complete
                </button>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i
                        class="fa-solid fa-file-invoice-dollar mr-2"></i> Tax Summary</h3>
                <ul id="taxSummary" class="space-y-2 text-sm"></ul>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-shield-halved mr-2"></i>
                    Audit Log</h3>
                <ul id="auditLog" class="space-y-2 text-xs text-slate-600"></ul>
            </div>
        </div>
    </section>

    <!-- Disbursements -->
    <section id="disbPanel" class="py-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-building-columns mr-2"></i> Bank
                    Batches</h3>
                <div class="flex items-center gap-2">
                    <select id="bankFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="queued">Queued</option>
                        <option value="sent">Sent</option>
                    </select>
                    <button id="genNeft" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                        <i class="fa-solid fa-file-arrow-down mr-1"></i> Generate File
                    </button>
                    <button id="exportBatches"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="sticky top-0 bg-slate-50 text-slate-500 border-b z-10">
                        <tr>
                            <th class="py-2 px-4">Batch</th>
                            <th class="py-2 px-4">Period</th>
                            <th class="py-2 px-4">Count</th>
                            <th class="py-2 px-4">Amount</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4 w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="batchRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Reports -->
    <section id="reportsPanel" class="py-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-chart-pie mr-2"></i> Cost
                    Breakdown</h3>
                <canvas id="costChart" height="220"></canvas>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-gauge-high mr-2"></i> SLA
                </h3>
                <canvas id="slaChart" height="220"></canvas>
            </div>
        </div>
    </section>
</div>

<!-- Add Employee Modal -->
<div id="empModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Add Employee</h3>
                    <button id="closeEmpModal" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <input id="eName" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                        placeholder="Full name">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="eRole" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Role">
                        <input id="eBase" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Base (Monthly)">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="eAllow" type="number" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="Allowance">
                        <select id="eStatus" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelEmp"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="saveEmp" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ------ Mock Data ------ */
    let EMP = [
        { id: 1, name: 'Aarav Mehta', role: 'SWE I', base: 80000, allow: 10000, ded: 2000, status: 'active' },
        { id: 2, name: 'Riya Patel', role: 'Marketing Analyst', base: 60000, allow: 8000, ded: 1500, status: 'active' },
        { id: 3, name: 'Noah Kim', role: 'Finance Assoc', base: 65000, allow: 7000, ded: 2000, status: 'inactive' }
    ]; // monthly figures

    let RUNS = [
        { id: 'PY-2025-08', period: '2025-08', status: 'posted', gross: 210000, tax: 31500, net: 173500 },
        { id: 'PY-2025-09', period: '2025-09', status: 'draft', gross: 0, tax: 0, net: 0 }
    ];

    let CHECKS = [
        { id: 201, text: 'EPF/401k filings prepared', done: true },
        { id: 202, text: 'ESIC/Health contributions computed', done: false },
        { id: 203, text: 'TDS/Withholding summaries exported', done: false },
        { id: 204, text: 'Payslips generated & distributed', done: true }
    ];

    let TAX_LINES = [
        { name: 'Income Tax (TDS/Withholding)', amount: 31500 },
        { name: 'PF/401k Employer', amount: 8400 },
        { name: 'ESIC/Health Employer', amount: 6300 }
    ];

    let BATCHES = [
        { id: 'B-2301', period: '2025-08', count: 18, amount: 173500, status: 'sent' },
        { id: 'B-2302', period: '2025-09', count: 20, amount: 0, status: 'queued' }
    ];

    /* ------ Elements & Init ------ */
    const $ = (id) => document.getElementById(id);
    const fmt = (n, cur = 'USD', frac = 0) => new Intl.NumberFormat('en-US', { style: 'currency', currency: cur, maximumFractionDigits: frac }).format(Number(n || 0));
    const money = (n) => fmt(n);

    document.addEventListener('DOMContentLoaded', () => {
        // Tabs
        document.querySelectorAll('.py-tab').forEach(b => {
            b.addEventListener('click', (e) => {
                document.querySelectorAll('.py-tab').forEach(x => x.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                document.querySelectorAll('.py-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(name + 'Panel').classList.remove('hidden');
                if (name === 'reports') { ensureCharts(); drawCharts(); }
            });
        });

        // Runs
        $('runPayrollBtn').addEventListener('click', simulateRun);
        $('cycleSelect').addEventListener('change', renderRuns);
        $('periodInput').addEventListener('change', renderRuns);
        $('recalcRuns').addEventListener('click', recalcLastDraft);
        $('postAll').addEventListener('click', postAllDrafts);
        $('exportRuns').addEventListener('click', () => exportCSV('runs.csv', [
            ['Run ID', 'Period', 'Status', 'Gross', 'Taxes', 'Net'],
            ...RUNS.map(r => [r.id, r.period, r.status, r.gross, r.tax, r.net])
        ]));

        // Employees
        $('empFilter').addEventListener('change', renderEmp);
        $('addEmpBtn').addEventListener('click', openEmpModal);
        $('closeEmpModal').addEventListener('click', closeEmpModal);
        $('cancelEmp').addEventListener('click', closeEmpModal);
        $('saveEmp').addEventListener('click', saveEmp);
        $('exportEmp').addEventListener('click', () => exportCSV('employees.csv', [
            ['ID', 'Name', 'Role', 'Base', 'Allowance', 'Deductions', 'Status'],
            ...EMP.map(e => [e.id, e.name, e.role, e.base, e.allow, e.ded || 0, e.status])
        ]));

        // Calc
        $('recalcBtn').addEventListener('click', recalc);
        ['calcBasic', 'calcAllow', 'calcDedPre', 'calcDedPost', 'calcTax', 'calcOtHrs', 'calcOtRate', 'calcLop', 'calcCycle', 'calcProrate', 'calcCur']
            .forEach(id => $(id).addEventListener('input', debounce(recalc, 150)));

        // Compliance
        $('markAllComp').addEventListener('click', () => { CHECKS = CHECKS.map(c => ({ ...c, done: true })); renderCompliance(); });

        // Disbursements
        $('bankFilter').addEventListener('change', renderBatches);
        $('genNeft').addEventListener('click', () => generateBankFile());
        $('exportBatches').addEventListener('click', () => exportCSV('batches.csv', [
            ['Batch', 'Period', 'Count', 'Amount', 'Status'],
            ...BATCHES.map(b => [b.id, b.period, b.count, b.amount, b.status])
        ]));

        // Initial renders
        $('periodInput').value = new Date().toISOString().slice(0, 7);
        renderRuns(); renderEmp(); fillCalcEmployees(); renderCompliance(); renderTax(); renderAudit(); renderBatches();
    });

    /* ------ Runs ------ */
    function renderRuns() {
        $('runRows').innerHTML = RUNS.map(r => {
            const pill = r.status === 'posted' ? 'bg-emerald-50 text-emerald-700' : r.status === 'draft' ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700';
            return `
        <tr class="border-b last:border-0">
          <td class="py-2 px-4 font-medium">${r.id}</td>
          <td class="py-2 px-4">${r.period}</td>
          <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${r.status}</span></td>
          <td class="py-2 px-4">${money(r.gross)}</td>
          <td class="py-2 px-4">${money(r.tax)}</td>
          <td class="py-2 px-4">${money(r.net)}</td>
          <td class="py-2 px-4 text-right">
            <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="postRun('${r.id}')">Post</button>
          </td>
        </tr>`;
        }).join('') || `<tr><td colspan="7" class="py-6 text-center text-slate-500">No runs</td></tr>`;

        // KPIs (latest)
        const latest = RUNS[RUNS.length - 1] || { gross: 0, tax: 0, net: 0 };
        $('kpiNet').textContent = 'Net: ' + money(latest.net);
        $('kpiTax').textContent = 'Taxes: ' + money(latest.tax);
        $('kpiHeadcount').textContent = 'HC: ' + EMP.filter(e => e.status === 'active').length;
    }
    function simulateRun() {
        const period = $('periodInput').value || new Date().toISOString().slice(0, 7);
        const gross = EMP.filter(e => e.status === 'active').reduce((s, e) => s + e.base + e.allow, 0);
        const tax = Math.round(gross * 0.15);
        const net = gross - tax - EMP.reduce((s, e) => s + (e.ded || 0), 0);
        RUNS.push({ id: `PY-${period}`, period, status: 'draft', gross, tax, net });
        renderRuns(); alert('ðŸ§® Draft payroll created');
    }
    function recalcLastDraft() {
        const last = [...RUNS].reverse().find(r => r.status === 'draft');
        if (!last) return alert('No draft run to recalc');
        // simple recalculation: recompute using current EMP + 15% tax
        const gross = EMP.filter(e => e.status === 'active').reduce((s, e) => s + e.base + e.allow, 0);
        last.gross = gross; last.tax = Math.round(gross * 0.15);
        last.net = last.gross - last.tax - EMP.reduce((s, e) => s + (e.ded || 0), 0);
        renderRuns();
    }
    function postRun(id) { const r = RUNS.find(x => x.id === id); if (!r) return; r.status = 'posted'; renderRuns(); }
    function postAllDrafts() { let n = 0; RUNS.forEach(r => { if (r.status === 'draft') { r.status = 'posted'; n++; } }); renderRuns(); alert(n ? `âœ… Posted ${n} draft(s)` : 'No drafts'); }

    /* ------ Employees ------ */
    function renderEmp() {
        const f = $('empFilter').value;
        const data = f === 'all' ? EMP : EMP.filter(e => e.status === f);
        $('empRows').innerHTML = data.map(e => {
            const pill = e.status === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-700';
            return `
        <tr class="border-b last:border-0">
          <td class="py-2 px-4 font-medium">${e.name}</td>
          <td class="py-2 px-4">${e.role}</td>
          <td class="py-2 px-4"><input type="number" class="w-28 rounded border border-slate-300 px-2 py-1 text-sm" value="${e.base}" onchange="editEmpField(${e.id},'base',this.value)"></td>
          <td class="py-2 px-4"><input type="number" class="w-28 rounded border border-slate-300 px-2 py-1 text-sm" value="${e.allow}" onchange="editEmpField(${e.id},'allow',this.value)"></td>
          <td class="py-2 px-4"><input type="number" class="w-28 rounded border border-slate-300 px-2 py-1 text-sm" value="${e.ded || 0}" onchange="editEmpField(${e.id},'ded',this.value)"></td>
          <td class="py-2 px-4">
            <select class="rounded border border-slate-300 px-2 py-1 text-sm" onchange="editEmpField(${e.id},'status',this.value)">
                <option ${e.status === 'active' ? 'selected' : ''}>active</option>
                <option ${e.status === 'inactive' ? 'selected' : ''}>inactive</option>
            </select>
          </td>
          <td class="py-2 px-4 text-right">
            <button class="px-2 py-1 mr-2 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="removeEmp(${e.id})"><i class="fa-solid fa-trash-can mr-1"></i>Delete</button>
          </td>
        </tr>`;
        }).join('') || `<tr><td colspan="7" class="py-6 text-center text-slate-500">No employees</td></tr>`;
    }
    function openEmpModal() { $('empModal').classList.remove('hidden'); }
    function closeEmpModal() { $('empModal').classList.add('hidden'); }
    function saveEmp() {
        const name = val('eName').trim(); if (!name) return alert('Name required');
        EMP.push({ id: Date.now(), name, role: val('eRole') || 'TBD', base: num('eBase'), allow: num('eAllow'), ded: 0, status: val('eStatus') });
        closeEmpModal(); renderEmp();
    }
    function editEmpField(id, field, value) {
        const e = EMP.find(x => x.id === id); if (!e) return;
        if (['base', 'allow', 'ded'].includes(field)) e[field] = Number(value) || 0; else e[field] = value;
    }
    function removeEmp(id) { if (!confirm('Delete this employee?')) return; EMP = EMP.filter(e => e.id !== id); renderEmp(); }

    /* ------ Calculator ------ */
    function fillCalcEmployees() {
        $('calcEmp').innerHTML = EMP.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        if (EMP.length) { $('calcEmp').value = EMP[0].id; seedCalcFromEmp(EMP[0].id); }
        $('calcEmp').addEventListener('change', e => seedCalcFromEmp(Number(e.target.value)));
    }
    function seedCalcFromEmp(id) {
        const e = EMP.find(x => x.id === id); if (!e) return;
        $('calcBasic').value = e.base; $('calcAllow').value = e.allow; $('calcDedPre').value = e.ded || 0;
        $('calcDedPost').value = 0; $('calcTax').value = 15; $('calcOtHrs').value = 0; $('calcOtRate').value = 0; $('calcLop').value = 0;
        recalc();
    }
    function recalc() {
        const cur = val('calcCur') || 'USD';
        const basic = num('calcBasic'), allow = num('calcAllow'), pre = num('calcDedPre'), post = num('calcDedPost');
        const rate = Number(val('calcTax')) || 0, otH = num('calcOtHrs'), otR = num('calcOtRate'), lop = num('calcLop');
        const bonus = $('ruleBonus').checked ? (basic + allow) * 0.10 : 0;
        const cycle = val('calcCycle');
        // period base days
        const baseDays = cycle === 'biweekly' ? 14 : 30;
        const lopAmt = ((basic + allow) / baseDays) * Math.max(0, lop);
        const otAmt = Math.max(0, otH * otR);
        const gross = Math.max(0, basic + allow + bonus + otAmt - pre - lopAmt);
        const taxes = Math.max(0, gross * (rate / 100));
        const erPF = $('rulePF').checked ? (basic * 0.04) : 0;
        const erESIC = $('ruleESIC').checked ? (basic * 0.03) : 0;
        const net = gross - taxes - post;
        const pror = Math.max(0, Math.min(100, Number(val('calcProrate') || 100))) / 100;
        const g2 = gross * pror, t2 = taxes * pror, n2 = net * pror, er2 = (erPF + erESIC) * pror;

        $('outGross').textContent = fmt(g2, cur);
        $('outTax').textContent = fmt(t2, cur);
        $('outNet').textContent = fmt(n2, cur);
        $('outEr').textContent = fmt(er2, cur);
    }

    /* ------ Compliance ------ */
    function renderCompliance() {
        $('compList').innerHTML = CHECKS.map(c => `
        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" ${c.done ? 'checked' : ''} onchange="toggleCheck(${c.id}, this.checked)"> ${c.text}
          </label>
          ${c.done ? '<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-xs">Done</span>' : ''}
        </div>`).join('');
        const done = CHECKS.filter(c => c.done).length;
        $('compCount').textContent = `${done}/${CHECKS.length} complete`;
    }
    function toggleCheck(id, on) { const x = CHECKS.find(c => c.id === id); if (x) { x.done = on; renderCompliance(); } }
    function renderTax() {
        $('taxSummary').innerHTML = TAX_LINES.map(t => `
        <li class="flex items-center justify-between">
          <span>${t.name}</span><span class="font-medium">${money(t.amount)}</span>
        </li>`).join('');
    }
    function renderAudit() {
        const events = [
            '2025-09-12 10:05 â€¢ Payroll policy updated',
            '2025-09-12 11:02 â€¢ Run PY-2025-08 posted by Finance',
            '2025-09-13 09:10 â€¢ Employee base updated (Aarav)'
        ];
        $('auditLog').innerHTML = events.map(e => `<li>${e}</li>`).join('');
    }

    /* ------ Disbursements ------ */
    function renderBatches() {
        const f = $('bankFilter').value;
        const data = f === 'all' ? BATCHES : BATCHES.filter(b => b.status === f);
        $('batchRows').innerHTML = data.map(b => {
            const pill = b.status === 'sent' ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700';
            return `
        <tr class="border-b last:border-0">
          <td class="py-2 px-4 font-medium">${b.id}</td>
          <td class="py-2 px-4">${b.period}</td>
          <td class="py-2 px-4">${b.count}</td>
          <td class="py-2 px-4">${money(b.amount)}</td>
          <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${capitalize(b.status)}</span></td>
          <td class="py-2 px-4 text-right"><button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Batch details coming soon')">Details</button></td>
        </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No batches</td></tr>`;
    }
    function generateBankFile() {
        // very simple NEFT/ACH CSV mock: EmpName,Amount,Period
        const latest = RUNS[RUNS.length - 1];
        const per = latest?.period || $('periodInput').value || '';
        const amtPerEmp = Math.round((latest?.net || 0) / Math.max(1, EMP.filter(e => e.status === 'active').length));
        exportCSV(`bank_${per || 'period'}.csv`, [
            ['Name', 'Amount', 'Period'],
            ...EMP.filter(e => e.status === 'active').map(e => [e.name, amtPerEmp, per])
        ]);
    }

    /* ------ Reports (Charts) ------ */
    let chartsLoaded = false, costC, slaC;
    function ensureCharts() {
        if (typeof Chart !== 'undefined') { chartsLoaded = true; return; }
        if (chartsLoaded) return;
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = () => { chartsLoaded = true; drawCharts(); };
        document.head.appendChild(s);
    }
    function drawCharts() {
        const c1 = document.getElementById('costChart').getContext('2d');
        const c2 = document.getElementById('slaChart').getContext('2d');
        costC && costC.destroy(); slaC && slaC.destroy();
        costC = new Chart(c1, {
            type: 'pie', data: {
                labels: ['Net Pay', 'Taxes', 'Employer Cost'],
                datasets: [{ data: [173500, 31500, 14700], borderWidth: 2, borderColor: '#fff', backgroundColor: ['#10b981', '#ef4444', '#3b82f6'] }]
            }, options: { plugins: { legend: { position: 'bottom' } } }
        });
        slaC = new Chart(c2, {
            type: 'bar', data: { labels: ['Compute', 'Approve', 'Disburse'], datasets: [{ label: 'Hours (median)', data: [2, 8, 4], backgroundColor: '#06b6d4' }] },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    /* ------ Utils ------ */
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function val(id) { return $(id).value; }
    function num(id) { return Number(val(id) || 0); }
    const debounce = (fn, w = 200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), w); }; };
    function exportCSV(filename, rows) {
        const esc = v => { const s = String(v ?? ''); return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s; };
        const csv = rows.map(r => r.map(esc).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }), url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }
</script>

<style>
    .py-tab.active {
        background-color: #1e293b;
        color: white;
    }

    .py-tab:not(.active) {
        color: #64748b;
    }

    .py-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    thead.sticky {
        box-shadow: 0 1px 0 0 rgba(15, 23, 42, .06);
    }
</style>
{% endblock %}