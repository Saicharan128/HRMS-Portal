{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-shield-halved mr-2"></i> Compliance Watchtower
            </h1>
            <p class="text-slate-600 text-sm">Stay compliant with labor laws and regulations.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="newAlertBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-bell mr-1"></i> New Alert
            </button>
            <button id="addPolicyBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-shield mr-1"></i> Add Policy
            </button>
            <button id="exportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab" class="cw-tab active px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-chart-line mr-1"></i> Overview
            </button>
            <button id="rulesTab" class="cw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-gears mr-1"></i> Rules
            </button>
            <button id="auditsTab" class="cw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-clipboard-check mr-1"></i> Audits
            </button>
            <button id="deadlinesTab" class="cw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-calendar-days mr-1"></i> Deadlines
            </button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="cw-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Score & Jurisdictions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-gauge-high mr-2"></i> Compliance Score
                    </h3>
                    <span id="scoreBadge" class="px-2 py-1 text-xs rounded bg-emerald-50 text-emerald-700">Low
                        Risk</span>
                </div>
                <div class="relative h-40">
                    <canvas id="scoreChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Open Issues</div>
                        <div id="openIssuesCount" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Upcoming Deadlines (30d)</div>
                        <div id="deadlineCount" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>
                <div class="mt-5">
                    <div class="text-sm font-medium text-slate-700 mb-2">Active Jurisdictions</div>
                    <div id="jurisdictionChips" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Open Issues -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> Open Issues
                    </h3>
                    <button class="text-sm text-slate-600 hover:text-slate-800" id="ackAllBtn">
                        <i class="fa-solid fa-check-double mr-1"></i> Acknowledge All
                    </button>
                </div>
                <div id="issuesList" class="space-y-3"></div>
            </div>

            <!-- Upcoming Deadlines -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-hourglass-half mr-2"></i> Upcoming Deadlines
                    </h3>
                    <button id="addDeadlineBtn" class="text-sm text-slate-600 hover:text-slate-800">
                        <i class="fa-solid fa-plus mr-1"></i> Add
                    </button>
                </div>
                <div id="deadlinesList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Risk Matrix & Changes -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-table-cells-large mr-2"></i> Risk Matrix
                    </h3>
                    <div class="text-sm text-slate-600" id="riskSummary">0 High ‚Ä¢ 0 Medium ‚Ä¢ 0 Low</div>
                </div>
                <div class="relative h-56">
                    <canvas id="riskChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-arrows-rotate mr-2"></i> Recent Changes
                </h3>
                <div id="changesFeed" class="space-y-3"></div>
            </div>
        </div>
    </section>

    <!-- Rules -->
    <section id="rulesPanel" class="cw-panel hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-gears mr-2"></i> Rules Engine
            </h3>
            <button id="newRuleBtn" class="px-3 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> New Rule
            </button>
        </div>
        <div id="rulesList" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
    </section>

    <!-- Audits -->
    <section id="auditsPanel" class="cw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-clipboard-check mr-2"></i> Audit Log
                </h3>
                <div class="flex items-center gap-2">
                    <select id="auditFilter" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="policy">Policy</option>
                        <option value="employee">Employee</option>
                        <option value="payroll">Payroll</option>
                    </select>
                    <button id="exportAuditBtn"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Time</th>
                            <th class="py-2 pr-4">Actor</th>
                            <th class="py-2 pr-4">Action</th>
                            <th class="py-2 pr-4">Target</th>
                            <th class="py-2 pr-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="auditRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Deadlines -->
    <section id="deadlinesPanel" class="cw-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-calendar-plus mr-2"></i> Add Deadline
                </h3>
                <div class="space-y-3">
                    <input id="dlTitle" type="text" placeholder="Title"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <input id="dlDate" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <select id="dlJurisdiction" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        <option value="US-CA">US-CA</option>
                        <option value="US-NY">US-NY</option>
                        <option value="IN">IN</option>
                        <option value="EU">EU</option>
                        <option value="UK">UK</option>
                    </select>
                    <button id="createDeadline"
                        class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                        <i class="fa-solid fa-plus mr-1"></i> Create
                    </button>
                </div>
            </div>
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-calendar-days mr-2"></i> All Deadlines
                    </h3>
                    <div class="text-sm text-slate-600"><span id="dlCount">0</span> total</div>
                </div>
                <div id="allDeadlines" class="space-y-3"></div>
            </div>
        </div>
    </section>
</div>

<!-- New Rule Modal -->
<div id="ruleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">New Rule</h3>
                    <button id="closeRuleModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Trigger</label>
                        <select id="ruleTrigger" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="new_hire">New Hire</option>
                            <option value="benefit_change">Benefit Change</option>
                            <option value="overtime">Overtime Exceeded</option>
                            <option value="termination">Termination</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Condition</label>
                        <input id="ruleCondition" type="text" placeholder="e.g., location == 'US-CA'"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Action</label>
                        <input id="ruleAction" type="text" placeholder="Create task, notify, block change..."
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelRule"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="saveRule" class="px-3 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> Save Rule
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // ---- Dummy Data (static) ----
    const JURISDICTIONS = ['US-CA', 'US-NY', 'US-TX', 'EU', 'IN', 'UK'];
    const ISSUES = [
        { id: 1, sev: 'high', title: 'Meal break compliance', j: 'US-CA', due: '2025-09-20' },
        { id: 2, sev: 'medium', title: 'Overtime policy mismatch', j: 'US-NY', due: '2025-09-25' },
        { id: 3, sev: 'low', title: 'Missing handbook ack', j: 'IN', due: '2025-10-05' }
    ];
    const DEADLINES = [
        { id: 11, title: 'CA Pay Data Reporting', date: '2025-10-01', j: 'US-CA' },
        { id: 12, title: 'EU Working Time Report', date: '2025-10-15', j: 'EU' },
        { id: 13, title: 'PF Registration Audit', date: '2025-09-30', j: 'IN' }
    ];
    const CHANGES = [
        { ts: '2025-09-12 10:05', text: 'US-CA minimum wage update parsed and applied.' },
        { ts: '2025-09-11 18:22', text: 'EU leave policy clarified for part-time workers.' },
        { ts: '2025-09-10 09:10', text: 'New NY overtime threshold flagged.' }
    ];
    let RULES = [
        { id: 101, name: 'Overtime Alert', enabled: true, trigger: 'overtime', condition: 'hours>40 & location in [US-CA,US-NY]', action: 'Notify HR + block payroll' },
        { id: 102, name: 'New Hire I-9', enabled: true, trigger: 'new_hire', condition: "location=='US-CA'", action: 'Create checklist + due in 3d' },
        { id: 103, name: 'Benefits Change Review', enabled: false, trigger: 'benefit_change', condition: 'any', action: 'Legal review ticket' }
    ];
    let AUDIT = [
        { time: '2025-09-12 12:31', actor: 'Priya S', action: 'Updated policy', target: 'Overtime Rules (US-CA)', status: 'Success', type: 'policy' },
        { time: '2025-09-11 16:02', actor: 'System', action: 'Generated alert', target: 'Meal break compliance', status: 'Info', type: 'employee' },
        { time: '2025-09-09 09:40', actor: 'Alex R', action: 'Exported report', target: 'Pay Data', status: 'Success', type: 'payroll' }
    ];

    // ---- Panels ----
    const panels = {
        overview: document.getElementById('overviewPanel'),
        rules: document.getElementById('rulesPanel'),
        audits: document.getElementById('auditsPanel'),
        deadlines: document.getElementById('deadlinesPanel')
    };

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        wireButtons();
        renderOverview();
        renderRules();
        renderAudits();
        renderDeadlines();
        drawScore();
        drawRisk();
    });

    // ---- Tabs ----
    function setupTabs() {
        document.querySelectorAll('.cw-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.cw-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name].classList.remove('hidden');
            });
        });
    }

    // ---- Buttons / Alerts ----
    function wireButtons() {
        document.getElementById('newAlertBtn').addEventListener('click', () => alert('üîî New alert created (demo)'));
        document.getElementById('addPolicyBtn').addEventListener('click', () => alert('üìÑ Policy added (demo)'));
        document.getElementById('exportBtn').addEventListener('click', () => alert('‚úÖ Export started'));
        document.getElementById('exportAuditBtn').addEventListener('click', () => alert('‚úÖ Audit CSV queued'));
        document.getElementById('ackAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.issue-row').forEach(r => r.classList.add('opacity-60'));
            alert('‚úÖ All issues acknowledged');
        });
        document.getElementById('addDeadlineBtn').addEventListener('click', () => document.getElementById('deadlinesTab').click());
        document.getElementById('createDeadline').addEventListener('click', createDeadline);
        document.getElementById('newRuleBtn').addEventListener('click', openRuleModal);
        document.getElementById('closeRuleModal').addEventListener('click', closeRuleModal);
        document.getElementById('cancelRule').addEventListener('click', closeRuleModal);
        document.getElementById('saveRule').addEventListener('click', saveRule);
    }

    // ---- Overview Rendering ----
    function renderOverview() {
        document.getElementById('openIssuesCount').textContent = ISSUES.length;
        document.getElementById('deadlineCount').textContent = DEADLINES.filter(d => daysFromNow(d.date) <= 30).length;
        document.getElementById('jurisdictionChips').innerHTML = JURISDICTIONS.map(j => chip(j)).join('');
        document.getElementById('issuesList').innerHTML =
            ISSUES.map(i => issueRow(i)).join('') || emptyState('All clear! No open issues.');
        document.getElementById('deadlinesList').innerHTML =
            DEADLINES.slice().sort((a, b) => a.date.localeCompare(b.date)).map(d => deadlineRow(d, true)).join('') ||
            emptyState('No upcoming deadlines.');
        document.getElementById('changesFeed').innerHTML =
            CHANGES.map(c => `<div class="rounded-lg bg-slate-50 p-3">
        <div class="text-xs text-slate-500">${c.ts}</div>
        <div class="text-sm text-slate-800">${c.text}</div>
      </div>`).join('');
        const hi = ISSUES.filter(i => i.sev === 'high').length;
        const md = ISSUES.filter(i => i.sev === 'medium').length;
        const lo = ISSUES.filter(i => i.sev === 'low').length;
        document.getElementById('riskSummary').textContent = `${hi} High ‚Ä¢ ${md} Medium ‚Ä¢ ${lo} Low`;
    }

    // ---- Charts ----
    function drawScore() {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        const pct = Math.max(0, Math.min(100, 92 - ISSUES.length * 6));
        const color = pct >= 85 ? '#10b981' : pct >= 70 ? '#f59e0b' : '#ef4444';
        document.getElementById('scoreBadge').textContent =
            pct >= 85 ? 'Low Risk' : pct >= 70 ? 'Moderate Risk' : 'High Risk';
        new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [pct, 100 - pct], backgroundColor: [color, '#e5e7eb'], borderWidth: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false, resizeDelay: 200,
                cutout: '70%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: false
            }
        });
    }

    function drawRisk() {
        const ctx = document.getElementById('riskChart').getContext('2d');
        const pts = ISSUES.map(i => ({ x: sevX(i.sev), y: daysFromNow(i.due), r: i.sev === 'high' ? 8 : i.sev === 'medium' ? 6 : 5, label: i.title }));
        new Chart(ctx, {
            type: 'scatter',
            data: { datasets: [{ data: pts, pointRadius: pts.map(p => p.r) }] },
            options: {
                responsive: true, maintainAspectRatio: false, resizeDelay: 200,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.raw.label} ‚Ä¢ ${c.raw.y}d` } } },
                scales: {
                    x: { title: { display: true, text: 'Severity (Low ‚Üí High)' }, min: 1, max: 3, ticks: { stepSize: 1, callback: v => ({ 1: 'Low', 2: 'Med', 3: 'High' })[v] } },
                    y: { title: { display: true, text: 'Days until due' }, beginAtZero: true }
                }
            }
        });
    }
    function sevX(s) { return s === 'low' ? 1 : s === 'medium' ? 2 : 3; }

    // ---- Rules ----
    function renderRules() {
        const wrap = document.getElementById('rulesList');
        wrap.innerHTML = RULES.map(r => `
      <div class="rounded-xl border border-slate-200 bg-white p-4 flex items-start justify-between gap-4">
        <div>
          <div class="flex items-center gap-2">
            <span class="font-semibold text-slate-800">${r.name}</span>
            ${badge(r.enabled ? 'Enabled' : 'Disabled', r.enabled ? 'emerald' : 'slate')}
          </div>
          <div class="text-sm text-slate-600 mt-1"><b>Trigger:</b> ${labelTrigger(r.trigger)}</div>
          <div class="text-sm text-slate-600"><b>Condition:</b> ${r.condition}</div>
          <div class="text-sm text-slate-600"><b>Action:</b> ${r.action}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50" onclick="toggleRule(${r.id})">
            <i class="fa-solid ${r.enabled ? 'fa-pause' : 'fa-play'} mr-1"></i> ${r.enabled ? 'Disable' : 'Enable'}
          </button>
          <button class="px-3 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 text-sm" onclick="deleteRule(${r.id})">
            <i class="fa-solid fa-trash mr-1"></i> Delete
          </button>
        </div>
      </div>
    `).join('') || emptyState('No rules yet.');
    }
    function openRuleModal() { document.getElementById('ruleModal').classList.remove('hidden'); }
    function closeRuleModal() { document.getElementById('ruleModal').classList.add('hidden'); }
    function saveRule() {
        const t = document.getElementById('ruleTrigger').value;
        const c = (document.getElementById('ruleCondition').value || 'any').trim();
        const a = (document.getElementById('ruleAction').value || 'Notify').trim();
        const name = `${labelTrigger(t)} Rule`;
        RULES.push({ id: Date.now(), name, enabled: true, trigger: t, condition: c, action: a });
        closeRuleModal(); renderRules(); alert('‚úÖ Rule saved');
    }
    function toggleRule(id) { const r = RULES.find(x => x.id === id); if (r) { r.enabled = !r.enabled; renderRules(); } }
    function deleteRule(id) { RULES = RULES.filter(x => x.id !== id); renderRules(); }
    function labelTrigger(t) { return ({ new_hire: 'New Hire', benefit_change: 'Benefit Change', overtime: 'Overtime Exceeded', termination: 'Termination' })[t] || t; }

    // ---- Audits ----
    function renderAudits() {
        const rows = document.getElementById('auditRows');
        const render = data => rows.innerHTML = data.map(a => `
      <tr class="border-b last:border-0">
        <td class="py-2 pr-4 text-slate-600">${a.time}</td>
        <td class="py-2 pr-4">${a.actor}</td>
        <td class="py-2 pr-4">${a.action}</td>
        <td class="py-2 pr-4">${a.target}</td>
        <td class="py-2 pr-4">${statusBadge(a.status)}</td>
      </tr>`).join('');
        render(AUDIT);
        document.getElementById('auditFilter').addEventListener('change', (e) => {
            const v = e.target.value;
            render(v === 'all' ? AUDIT : AUDIT.filter(x => x.type === v));
        });
    }

    // ---- Deadlines ----
    function renderDeadlines() {
        const list = document.getElementById('allDeadlines');
        list.innerHTML = DEADLINES.slice().sort((a, b) => a.date.localeCompare(b.date))
            .map(d => deadlineRow(d, false)).join('') || emptyState('No deadlines recorded.');
        document.getElementById('dlCount').textContent = DEADLINES.length;
    }
    function createDeadline() {
        const title = (document.getElementById('dlTitle').value || '').trim();
        const date = document.getElementById('dlDate').value;
        const j = document.getElementById('dlJurisdiction').value;
        if (!title || !date) { alert('‚ùå Title and date required'); return; }
        DEADLINES.push({ id: Date.now(), title, date, j });
        document.getElementById('dlTitle').value = ''; document.getElementById('dlDate').value = '';
        renderDeadlines(); renderOverview(); drawRisk(); alert('‚úÖ Deadline added');
    }

    // ---- UI helpers ----
    function chip(txt) { return `<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">${txt}</span>`; }
    function badge(txt, tone) { const m = { emerald: 'bg-emerald-50 text-emerald-700', slate: 'bg-slate-100 text-slate-700', amber: 'bg-amber-50 text-amber-700', red: 'bg-red-50 text-red-700' }; return `<span class="px-2 py-0.5 rounded-full ${m[tone] || m.slate} text-xs">${txt}</span>`; }
    function statusBadge(s) { const c = s === 'Success' ? 'emerald' : s === 'Info' ? 'amber' : 'red'; return badge(s, c); }
    function issueRow(i) {
        const clr = i.sev === 'high' ? 'red' : i.sev === 'medium' ? 'amber' : 'slate';
        return `
      <div class="issue-row flex items-start justify-between p-3 rounded-lg bg-slate-50">
        <div>
          <div class="flex items-center gap-2">
            ${badge(i.sev.toUpperCase(), clr)}
            <span class="font-medium text-slate-800">${i.title}</span>
          </div>
          <div class="text-xs text-slate-600 mt-1">${i.j} ‚Ä¢ Due in ${daysFromNow(i.due)} days</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="snoozeIssue(${i.id})">
            <i class="fa-solid fa-clock mr-1"></i> Snooze
          </button>
          <button class="px-2 py-1 rounded text-white bg-emerald-600 hover:bg-emerald-700 text-xs" onclick="resolveIssue(${i.id})">
            <i class="fa-solid fa-check mr-1"></i> Resolve
          </button>
        </div>
      </div>`;
    }
    function deadlineRow(d, compact) {
        const warn = daysFromNow(d.date) <= 7 ? 'bg-amber-50' : 'bg-slate-50';
        return `
      <div class="flex items-start justify-between p-3 rounded-lg ${warn}">
        <div>
          <div class="font-medium text-slate-800">${d.title}</div>
          <div class="text-xs text-slate-600">${d.j} ‚Ä¢ ${d.date}${compact ? '' : ' ‚Ä¢ Due in ' + daysFromNow(d.date) + ' days'}</div>
        </div>
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="removeDeadline(${d.id})">
          <i class="fa-solid fa-xmark mr-1"></i> Remove
        </button>
      </div>`;
    }
    function emptyState(msg) { return `<div class="text-slate-500 text-center py-6">${msg}</div>`; }
    function daysFromNow(dateStr) { const d = new Date(dateStr), now = new Date(); return Math.max(0, Math.ceil((d - now) / (1000 * 60 * 60 * 24))); }
    function snoozeIssue(id) { alert('‚è∞ Snoozed 7 days (demo)'); }
    function resolveIssue(id) { const i = ISSUES.findIndex(x => x.id === id); if (i > -1) { ISSUES.splice(i, 1); renderOverview(); drawScore(); drawRisk(); } }
    function removeDeadline(id) { const i = DEADLINES.findIndex(x => x.id === id); if (i > -1) { DEADLINES.splice(i, 1); renderDeadlines(); renderOverview(); drawRisk(); } }
</script>

<style>
    .cw-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .cw-tab:not(.active) {
        color: #64748b;
    }

    .cw-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}