{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-6xl">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">Jobs</h1>
            <p class="text-slate-600 text-sm">Post, manage, and track open roles across the organization.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Back</a>
    </div>

    <!-- Create Job -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5">
        <h2 class="text-lg font-semibold text-slate-800 mb-3">Create Job</h2>
        <form id="jobForm" class="grid md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                <input name="title" required
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-800" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                <input name="department" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                <input name="location" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Employment Type</label>
                <select name="employment_type" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">Selectâ€¦</option>
                    <option>Full-time</option>
                    <option>Part-time</option>
                    <option>Contract</option>
                    <option>Intern</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Openings</label>
                <input name="openings" type="number" min="1" value="1"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                <textarea name="description" rows="3"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2 flex items-center justify-between">
                <p class="text-xs text-slate-500">Fields marked * are required.</p>
                <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900"
                    type="submit">Create</button>
            </div>
        </form>
        <div id="formMsg" class="mt-3 text-sm"></div>
    </div>

    <!-- Jobs Table -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-800">My Jobs</h2>
            <button id="refreshBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Refresh</button>
        </div>

        <div class="mt-4 overflow-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">Title</th>
                        <th class="py-2 pr-3">Dept</th>
                        <th class="py-2 pr-3">Location</th>
                        <th class="py-2 pr-3">Type</th>
                        <th class="py-2 pr-3">Openings</th>
                        <th class="py-2 pr-3">Status</th>
                        <th class="py-2 pr-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTbody" class="align-top"></tbody>
            </table>
        </div>
        <div id="listMsg" class="mt-3 text-sm"></div>
    </div>
</div>

<script>
    async function fetchJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(url, data) { const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function putJSON(url, data) { const r = await fetch(url, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function del(url) { const r = await fetch(url, { method: "DELETE" }); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    const jobForm = document.getElementById("jobForm");
    const formMsg = document.getElementById("formMsg");
    const jobsTbody = document.getElementById("jobsTbody");
    const listMsg = document.getElementById("listMsg");
    const refreshBtn = document.getElementById("refreshBtn");

    function input(value, cls = "w-40") { const i = document.createElement("input"); i.value = value || ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function select(options, current) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; options.forEach(o => { const opt = document.createElement("option"); opt.value = o; opt.textContent = o; if (o === current) opt.selected = true; s.appendChild(opt); }); return s; }

    async function loadJobs() {
        try {
            listMsg.textContent = "Loading...";
            const data = await fetchJSON("/api/jobs");
            jobsTbody.innerHTML = "";
            data.forEach(row => {
                const tr = document.createElement("tr");

                const titleI = input(row.title, "w-56");
                const deptI = input(row.department || "", "w-40");
                const locI = input(row.location || "", "w-40");
                const typeS = select(["", "Full-time", "Part-time", "Contract", "Intern"], row.employment_type || "");
                const openI = input(row.openings ?? 1, "w-20"); openI.type = "number"; openI.min = "1";
                const statusS = select(["Open", "Closed"], row.status);

                const tdAct = document.createElement("td"); tdAct.className = "py-2 pr-3";
                const saveBtn = document.createElement("button");
                saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900";
                saveBtn.textContent = "Save";
                const delBtn = document.createElement("button");
                delBtn.className = "px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50";
                delBtn.textContent = "Delete";
                tdAct.append(saveBtn, delBtn);

                tr.append(
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(titleI) || titleI,
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(deptI) || deptI,
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(locI) || locI,
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(typeS) || typeS,
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(openI) || openI,
                    Object.assign(document.createElement("td"), { className: "py-2 pr-3" }).appendChild(statusS) || statusS,
                    tdAct
                );
                jobsTbody.appendChild(tr);

                saveBtn.addEventListener("click", async () => {
                    try {
                        await putJSON(`/api/jobs/${row.id}`, {
                            title: titleI.value.trim(),
                            department: deptI.value.trim(),
                            location: locI.value.trim(),
                            employment_type: typeS.value,
                            openings: openI.value,
                            status: statusS.value
                        });
                        listMsg.className = "mt-3 text-sm text-emerald-700";
                        listMsg.textContent = "Saved.";
                    } catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Save failed."; }
                });

                delBtn.addEventListener("click", async () => {
                    if (!confirm("Delete this job?")) return;
                    try { await del(`/api/jobs/${row.id}`); loadJobs(); }
                    catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Delete failed."; }
                });
            });
            listMsg.textContent = data.length ? "" : "No jobs yet.";
        } catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Failed to load jobs."; }
    }

    jobForm?.addEventListener("submit", async ev => {
        ev.preventDefault();
        formMsg.textContent = "";
        const fd = new FormData(jobForm);
        const payload = Object.fromEntries(fd.entries());
        try { await postJSON("/api/jobs", payload); formMsg.className = "mt-3 text-sm text-emerald-700"; formMsg.textContent = "Job created."; jobForm.reset(); loadJobs(); }
        catch { formMsg.className = "mt-3 text-sm text-rose-700"; formMsg.textContent = "Failed to create job."; }
    });

    refreshBtn?.addEventListener("click", loadJobs);
    loadJobs();
</script>
{% endblock %}