{% extends "layout.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1" />

<div class="mx-auto max-w-7xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 sm:mb-6">
        <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
            <i class="fa-solid fa-magnifying-glass mr-2"></i>Sourcing
        </h1>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm text-center">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Add Candidate -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 mb-6 sm:mb-8">
        <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">Add Candidate</h2>
        <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4" enctype="multipart/form-data">
            <div>
                <label class="block text-sm text-slate-600 mb-1">Name *</label>
                <input name="name" class="w-full rounded-lg border border-slate-300 px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Role of Employment *</label>
                <input name="role_of_employment" class="w-full rounded-lg border border-slate-300 px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Qualification</label>
                <input name="qualification" class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Job *</label>
                <select name="job_id" id="jobSelect" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    required></select>
            </div>

            <div>
                <label class="block text-sm text-slate-600 mb-1">Email</label>
                <input name="email" type="email" class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Phone</label>
                <input name="phone" class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Location</label>
                <input name="location" class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Source</label>
                <input name="source" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="LinkedIn / Referral / ...">
            </div>

            <div>
                <label class="block text-sm text-slate-600 mb-1">Years Experience</label>
                <input name="years_experience" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Current CTC (annual)</label>
                <input name="current_ctc" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Expected CTC (annual)</label>
                <input name="expected_ctc" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Notice Period (days)</label>
                <input name="notice_period_days" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>

            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Resume (PDF/DOC/DOCX)</label>
                <input name="resume" type="file" accept=".pdf,.doc,.docx" class="w-full">
            </div>
            <div class="md:col-span-2 flex flex-col sm:flex-row sm:items-center gap-3">
                <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 w-full sm:w-auto"
                    type="submit">
                    <i class="fa-solid fa-user-plus mr-1"></i> Add Candidate
                </button>
                <span id="addMsg" class="text-sm text-slate-600"></span>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="mb-4 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
        <input id="search" placeholder="Search name / role / recruiter"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <button id="reload" class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-rotate mr-1"></i> Reload
        </button>
    </div>

    <!-- Candidates table -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <!-- Desktop/tablet table -->
        <div class="overflow-x-auto hidden sm:block">
            <table class="min-w-full text-sm text-left text-slate-700">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Role</th>
                        <th class="px-4 py-2">Qualification</th>
                        <th class="px-4 py-2">Stage</th>
                        <th class="px-4 py-2">Job</th>
                        <th class="px-4 py-2">Recruiter</th>
                        <th class="px-4 py-2">Added On</th>
                    </tr>
                </thead>
                <tbody id="candidatesTable" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>

        <!-- Mobile card list -->
        <div id="candidatesCards" class="sm:hidden divide-y divide-slate-200"></div>
    </div>
</div>

<style>
    /* Subtle tap target improvements on mobile */
    @media (max-width: 640px) {

        input,
        select {
            min-height: 42px;
        }
    }

    /* Optional: nicer inertial scrolling for the table on iOS */
    @supports (-webkit-overflow-scrolling: touch) {
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    }
</style>

<script>
    async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
    }
    function includes(hay, needle) {
        return (hay || "").toLowerCase().includes((needle || "").toLowerCase());
    }

    async function loadJobs() {
        const jobs = await fetchJSON("/api/jobs?status=Open");
        const sel = document.getElementById("jobSelect");
        sel.innerHTML = jobs.map(j => `<option value="${j.id}">${j.title} â€” ${j.location || ''}</option>`).join("");
    }

    let allCandidates = [];
    async function loadCandidates() {
        allCandidates = await fetchJSON("/api/candidates");
        renderTable();
    }

    function rowToCardHTML(c) {
        const rec = c.recruiter_name ? c.recruiter_name : (c.recruiter_username || "-");
        const when = c.created_at ? new Date(c.created_at).toLocaleDateString() : "-";
        return `
        <div class="p-4">
            <div class="flex items-start justify-between">
                <div>
                    <div class="font-semibold text-slate-800">${c.name || "-"}</div>
                    <div class="text-sm text-slate-600">${c.role_of_employment || "-"}</div>
                </div>
                <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-700">${c.stage || "-"}</span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                <div class="text-slate-500">Qualification</div><div class="text-slate-800 text-right">${c.qualification || "-"}</div>
                <div class="text-slate-500">Job</div><div class="text-slate-800 text-right">${c.job_title || "-"}</div>
                <div class="text-slate-500">Recruiter</div><div class="text-slate-800 text-right">${rec}</div>
                <div class="text-slate-500">Added</div><div class="text-slate-800 text-right">${when}</div>
            </div>
        </div>`;
    }

    function renderTable() {
        const q = document.getElementById("search").value.trim().toLowerCase();
        const rows = allCandidates.filter(c =>
            !q ||
            includes(c.name, q) ||
            includes(c.role_of_employment, q) ||
            includes(c.recruiter_name, q) ||
            includes(c.recruiter_username, q)
        );

        // Desktop/tablet table
        const tbody = document.getElementById("candidatesTable");
        if (tbody) {
            tbody.innerHTML = rows.map(c => `
                <tr>
                  <td class="px-4 py-2 font-medium">${c.name || "-"}</td>
                  <td class="px-4 py-2">${c.role_of_employment || "-"}</td>
                  <td class="px-4 py-2">${c.qualification || "-"}</td>
                  <td class="px-4 py-2">${c.stage || "-"}</td>
                  <td class="px-4 py-2">${c.job_title || "-"}</td>
                  <td class="px-4 py-2">${c.recruiter_name ? c.recruiter_name : (c.recruiter_username || "-")}</td>
                  <td class="px-4 py-2">${c.created_at ? new Date(c.created_at).toLocaleDateString() : "-"}</td>
                </tr>
            `).join("");
        }

        // Mobile cards
        const cards = document.getElementById("candidatesCards");
        if (cards) {
            cards.innerHTML = rows.map(rowToCardHTML).join("");
        }
    }

    document.getElementById("reload").addEventListener("click", loadCandidates);
    document.getElementById("search").addEventListener("input", renderTable);

    document.getElementById("addForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("addMsg");
        msg.textContent = "Savingâ€¦";
        const fd = new FormData(e.target);
        try {
            const r = await fetch("/api/candidates", { method: "POST", body: fd });
            if (!r.ok) throw new Error(await r.text());
            msg.textContent = "Candidate added âœ“";
            e.target.reset();
            await loadCandidates();
            setTimeout(() => msg.textContent = "", 2000);
        } catch (err) {
            console.error(err);
            msg.textContent = "Failed to add candidate";
            setTimeout(() => msg.textContent = "", 2500);
        }
    });

    Promise.all([loadJobs(), loadCandidates()]).catch(console.error);
</script>
{% endblock %}