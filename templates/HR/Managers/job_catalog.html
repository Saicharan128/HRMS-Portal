{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-layer-group mr-2"></i> Job Catalog
            </h1>
            <p class="text-slate-600 text-sm">Maintain a standardized library of job roles and descriptions.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Create Catalog Entry -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6 mb-8">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-square-plus mr-2"></i> Create Catalog Entry
        </h2>
        <form id="createForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-slate-600 mb-1">Title *</label>
                <input name="title" required class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Family</label>
                <input name="family" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Engineering / HR / Finance" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Level</label>
                <input name="level" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="L2 / Senior / Manager" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Department</label>
                <input name="department" class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Location</label>
                <input name="location" class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Employment Type</label>
                <select name="employment_type" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <option value="">—</option>
                    <option>Full-time</option>
                    <option>Part-time</option>
                    <option>Contract</option>
                    <option>Intern</option>
                </select>
            </div>

            <div>
                <label class="block text-sm text-slate-600 mb-1">Min Experience (yrs)</label>
                <input name="min_experience" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Max Experience (yrs)</label>
                <input name="max_experience" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Salary Min</label>
                <input name="salary_min" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Salary Max</label>
                <input name="salary_max" type="number" min="0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Currency</label>
                <input name="currency" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="INR / USD" />
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Status</label>
                <select name="status" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <option value="Active" selected>Active</option>
                    <option value="Archived">Archived</option>
                </select>
            </div>

            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Description</label>
                <textarea name="description" rows="2"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Responsibilities</label>
                <textarea name="responsibilities" rows="2"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Requirements</label>
                <textarea name="requirements" rows="2"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Skills (comma-separated)</label>
                <input name="skills" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Python, SQL, APIs" />
            </div>

            <div class="md:col-span-2 flex items-center gap-3">
                <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                </button>
                <span id="createMsg" class="text-sm text-slate-600"></span>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-5 gap-2">
        <input id="q" placeholder="Search title, dept, text…"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fDepartment" placeholder="Department"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fLocation" placeholder="Location"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fLevel" placeholder="Level" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fStatus" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">All</option>
            <option value="Active">Active</option>
            <option value="Archived">Archived</option>
        </select>
    </div>

    <!-- Catalog Table -->
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white">
        <table class="min-w-full text-sm text-left text-slate-700">
            <thead class="bg-slate-50 text-slate-600">
                <tr>
                    <th class="px-4 py-2">Title</th>
                    <th class="px-4 py-2">Family</th>
                    <th class="px-4 py-2">Level</th>
                    <th class="px-4 py-2">Dept</th>
                    <th class="px-4 py-2">Location</th>
                    <th class="px-4 py-2">Type</th>
                    <th class="px-4 py-2">Exp</th>
                    <th class="px-4 py-2">Salary</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2 w-56">Actions</th>
                </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-slate-200"></tbody>
        </table>
    </div>
    <div id="listMsg" class="mt-3 text-sm text-slate-600"></div>
</div>

<script>
    async function fetchJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postForm(url, formEl) { const fd = new FormData(formEl); const r = await fetch(url, { method: "POST", body: fd }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function putJSON(url, payload) { const r = await fetch(url, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function del(url) { const r = await fetch(url, { method: "DELETE" }); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    const createForm = document.getElementById("createForm");
    const createMsg = document.getElementById("createMsg");
    const rows = document.getElementById("rows");
    const listMsg = document.getElementById("listMsg");

    const qEl = document.getElementById("q");
    const fDepartment = document.getElementById("fDepartment");
    const fLocation = document.getElementById("fLocation");
    const fLevel = document.getElementById("fLevel");
    const fStatus = document.getElementById("fStatus");

    function tdWrap(el) { const td = document.createElement("td"); td.className = "px-4 py-2"; td.appendChild(el); return td; }
    function input(v, cls = "w-40") { const i = document.createElement("input"); i.value = v ?? ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function textArea(v) { const t = document.createElement("textarea"); t.value = v ?? ""; t.rows = 2; t.className = "w-full rounded-lg border border-slate-300 px-2 py-1 text-sm"; return t; }
    function select(opts, cur) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; opts.forEach(o => { const op = document.createElement("option"); op.value = o; op.textContent = o || "—"; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }

    async function loadList() {
        listMsg.textContent = "Loading…";
        const params = new URLSearchParams();
        if (fStatus.value) params.set("status", fStatus.value);
        // structured filters are supported by backend
        if (fDepartment.value) params.set("department", fDepartment.value.trim());
        if (fLocation.value) params.set("location", fLocation.value.trim());
        if (fLevel.value) params.set("level", fLevel.value.trim());
        if (qEl.value) params.set("q", qEl.value.trim());

        const data = await fetchJSON(`/api/job_catalog${params.toString() ? `?${params.toString()}` : ""}`);
        rows.innerHTML = "";

        data.forEach(r => {
            const tr = document.createElement("tr");

            const titleI = input(r.title, "w-56");
            const familyI = input(r.family, "w-36");
            const levelI = input(r.level, "w-28");
            const deptI = input(r.department, "w-40");
            const locI = input(r.location, "w-36");
            const typeS = select(["", "Full-time", "Part-time", "Contract", "Intern"], r.employment_type || "");
            const expI = input((r.min_experience ?? "") + (r.max_experience ? "–" + r.max_experience : ""), "w-28"); expI.disabled = true; expI.title = "Edit in details below";

            const salI = input((r.salary_min ?? "") + (r.salary_max ? "–" + r.salary_max : ""), "w-32"); salI.disabled = true; salI.title = "Edit in details below";

            const statusS = select(["Active", "Archived"], r.status);

            const actions = document.createElement("div");
            const editBtn = document.createElement("button");
            editBtn.className = "px-2 py-1 mr-2 rounded-md border border-slate-300 text-xs hover:bg-slate-50";
            editBtn.innerHTML = '<i class="fa-solid fa-pen-to-square mr-1"></i>Edit';
            const saveBtn = document.createElement("button");
            saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900";
            saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i>Save';
            const delBtn = document.createElement("button");
            delBtn.className = "px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50";
            delBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Delete';
            actions.append(editBtn, saveBtn, delBtn);

            tr.append(
                tdWrap(titleI), tdWrap(familyI), tdWrap(levelI), tdWrap(deptI), tdWrap(locI),
                tdWrap(typeS), tdWrap(expI), tdWrap(salI), tdWrap(statusS), tdWrap(actions)
            );
            rows.appendChild(tr);

            // Expandable details row
            const tr2 = document.createElement("tr");
            tr2.innerHTML = `
      <td colspan="10" class="px-4 pb-4">
        <details class="rounded-xl border border-slate-200 bg-white p-4">
          <summary class="cursor-pointer text-slate-800 font-medium">Details</summary>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-xs text-slate-500 mb-1">Min Experience (yrs)</label>
              <input id="minExp-${r.id}" type="number" min="0" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.min_experience ?? ""}">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Max Experience (yrs)</label>
              <input id="maxExp-${r.id}" type="number" min="0" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.max_experience ?? ""}">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Salary Min</label>
              <input id="salMin-${r.id}" type="number" min="0" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.salary_min ?? ""}">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Salary Max</label>
              <input id="salMax-${r.id}" type="number" min="0" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.salary_max ?? ""}">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Currency</label>
              <input id="curr-${r.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.currency || ""}">
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Skills (comma)</label>
              <input id="skills-${r.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${r.skills || ""}">
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs text-slate-500 mb-1">Description</label>
              <textarea id="desc-${r.id}" rows="2" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm">${r.description || ""}</textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs text-slate-500 mb-1">Responsibilities</label>
              <textarea id="resp-${r.id}" rows="2" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm">${r.responsibilities || ""}</textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs text-slate-500 mb-1">Requirements</label>
              <textarea id="req-${r.id}" rows="2" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm">${r.requirements || ""}</textarea>
            </div>
          </div>
        </details>
      </td>`;
            rows.appendChild(tr2);

            // Edit simply focuses the details section
            editBtn.addEventListener("click", () => {
                const det = tr2.querySelector("details");
                det.open = true;
                det.scrollIntoView({ behavior: "smooth", block: "center" });
            });

            saveBtn.addEventListener("click", async () => {
                try {
                    await putJSON(`/api/job_catalog/${r.id}`, {
                        title: titleI.value.trim(),
                        family: familyI.value.trim(),
                        level: levelI.value.trim(),
                        department: deptI.value.trim(),
                        location: locI.value.trim(),
                        employment_type: typeS.value,
                        min_experience: document.getElementById(`minExp-${r.id}`).value,
                        max_experience: document.getElementById(`maxExp-${r.id}`).value,
                        salary_min: document.getElementById(`salMin-${r.id}`).value,
                        salary_max: document.getElementById(`salMax-${r.id}`).value,
                        currency: document.getElementById(`curr-${r.id}`).value.trim(),
                        description: document.getElementById(`desc-${r.id}`).value,
                        responsibilities: document.getElementById(`resp-${r.id}`).value,
                        requirements: document.getElementById(`req-${r.id}`).value,
                        skills: document.getElementById(`skills-${r.id}`).value,
                        status: statusS.value
                    });
                    listMsg.className = "mt-3 text-sm text-emerald-700";
                    listMsg.textContent = "Saved.";
                    await loadList();
                } catch (e) {
                    console.error(e);
                    listMsg.className = "mt-3 text-sm text-rose-700";
                    listMsg.textContent = "Save failed.";
                }
            });

            delBtn.addEventListener("click", async () => {
                if (!confirm("Delete this catalog entry?")) return;
                try { await del(`/api/job_catalog/${r.id}`); await loadList(); }
                catch (e) { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Delete failed."; }
            });
        });

        listMsg.textContent = data.length ? "" : "No catalog entries yet.";
    }

    createForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        createMsg.textContent = "Saving…";
        try {
            await postForm("/api/job_catalog", createForm);
            createMsg.className = "text-sm text-emerald-700";
            createMsg.textContent = "Entry created ✓";
            createForm.reset();
            await loadList();
        } catch (e) {
            console.error(e);
            createMsg.className = "text-sm text-rose-700";
            createMsg.textContent = "Failed to create entry";
        }
    });

    // Live filtering
    [qEl, fDepartment, fLocation, fLevel, fStatus].forEach(el => el.addEventListener("input", () => loadList().catch(console.error)));

    loadList().catch(console.error);
</script>
{% endblock %}