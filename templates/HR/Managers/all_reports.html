{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-export mr-1"></i> Export
            </button>
            <label
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm cursor-pointer">
                <i class="fa-solid fa-file-import mr-1"></i> Import
                <input id="importInput" type="file" accept="application/json" class="hidden">
            </label>
            <button id="resetDemo"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-seedling mr-1"></i> Reset
            </button>
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Failed</div>
            <div id="failedReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-hourglass-half mr-1"></i> Avg Gen Time</div>
            <div id="avgGenTime" class="mt-1 text-2xl font-semibold text-slate-800">—</div>
        </div>
    </div>

    <!-- Report Categories -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- HR Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-blue-100 rounded-lg mr-3"><i class="fa-solid fa-users text-blue-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">HR Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('employee_roster')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-user-group mr-2 text-slate-500"></i> Employee Roster</button>
                <button onclick="generateQuickReport('headcount_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-chart-line mr-2 text-slate-500"></i> Headcount Analysis</button>
                <button onclick="generateQuickReport('turnover_report')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-door-open mr-2 text-slate-500"></i> Turnover Report</button>
                <button onclick="generateQuickReport('diversity_metrics')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> Diversity Metrics</button>
                <button onclick="generateQuickReport('recruitment_pipeline')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-funnel-dollar mr-2 text-slate-500"></i> Recruitment Pipeline</button>
            </div>
        </div>

        <!-- Performance Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-green-100 rounded-lg mr-3"><i class="fa-solid fa-chart-line text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Performance Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('performance_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-star mr-2 text-slate-500"></i> Performance Summary</button>
                <button onclick="generateQuickReport('goal_achievement')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-target mr-2 text-slate-500"></i> Goal Achievement</button>
                <button onclick="generateQuickReport('review_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-clipboard-check mr-2 text-slate-500"></i> Review Completion</button>
                <button onclick="generateQuickReport('top_performers')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-trophy mr-2 text-slate-500"></i> Top Performers</button>
                <button onclick="generateQuickReport('training_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-graduation-cap mr-2 text-slate-500"></i> Training Completion</button>
            </div>
        </div>

        <!-- Financial Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-yellow-100 rounded-lg mr-3"><i class="fa-solid fa-dollar-sign text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Financial Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('payroll_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-money-bill mr-2 text-slate-500"></i> Payroll Summary</button>
                <button onclick="generateQuickReport('cost_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-calculator mr-2 text-slate-500"></i> Cost Analysis</button>
                <button onclick="generateQuickReport('expense_reports')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-receipt mr-2 text-slate-500"></i> Expense Reports</button>
                <button onclick="generateQuickReport('budget_variance')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-chart-pie mr-2 text-slate-500"></i> Budget Variance</button>
                <button onclick="generateQuickReport('contractor_payments')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-handshake mr-2 text-slate-500"></i> Contractor Payments</button>
            </div>
        </div>
    </div>

    <!-- Time & Attendance / Compliance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-purple-100 rounded-lg mr-3"><i class="fa-solid fa-clock text-purple-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Time & Attendance</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('attendance_summary')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-calendar-days mr-2 text-slate-500"></i> Attendance Summary</button>
                <button onclick="generateQuickReport('leave_analysis')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-plane-departure mr-2 text-slate-500"></i> Leave Analysis</button>
                <button onclick="generateQuickReport('overtime_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-clock mr-2 text-slate-500"></i> Overtime Report</button>
                <button onclick="generateQuickReport('tardiness_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-exclamation-triangle mr-2 text-slate-500"></i> Tardiness Report</button>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-red-100 rounded-lg mr-3"><i class="fa-solid fa-shield-halved text-red-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Compliance & Legal</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('eeo_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> EEO Report</button>
                <button onclick="generateQuickReport('safety_incidents')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-hard-hat mr-2 text-slate-500"></i> Safety Incidents</button>
                <button onclick="generateQuickReport('policy_compliance')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-file-contract mr-2 text-slate-500"></i> Policy Compliance</button>
                <button onclick="generateQuickReport('audit_trail')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm"><i
                        class="fa-solid fa-search mr-2 text-slate-500"></i> Audit Trail</button>
            </div>
        </div>
    </div>

    <!-- Reports Dashboard -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-list mr-2"></i> Generated Reports
                </h2>
                <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Search:</label>
                        <input id="tableSearch" placeholder="name, user…"
                            class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Type:</label>
                        <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="">All Types</option>
                            <option value="hr">HR Reports</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="attendance">Time & Attendance</option>
                            <option value="compliance">Compliance</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Period:</label>
                        <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Rows:</label>
                        <select id="pageSize" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                    </div>
                    <button id="runSchedules"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-bell mr-1"></i> Run Schedules
                    </button>
                    <button id="exportCSV"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-table mr-1"></i> Export CSV
                    </button>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Generated Yet</h3>
            <p class="text-slate-600 mb-4">Start by generating your first report from the categories above.</p>
        </div>

        <!-- Reports Table -->
        <div id="reportsTable" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Report Name
                                <button class="ml-1 text-xs text-slate-500" onclick="sortBy('name')"><i
                                        class="fa-solid fa-sort"></i></button>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Type
                                <button class="ml-1 text-xs text-slate-500" onclick="sortBy('type')"><i
                                        class="fa-solid fa-sort"></i></button>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Generated
                                <button class="ml-1 text-xs text-slate-500" onclick="sortBy('generated_date')"><i
                                        class="fa-solid fa-sort"></i></button>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Generated By
                                <button class="ml-1 text-xs text-slate-500" onclick="sortBy('generated_by')"><i
                                        class="fa-solid fa-sort"></i></button>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Size</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Status</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="p-6 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">Showing <span id="pageInfo">0-0 of 0</span> reports</div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Previous</button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div id="generateReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-chart-simple mr-2"></i>
                            Generate Custom Report</h3>
                        <button id="closeGenerateModal" class="text-slate-400 hover:text-slate-600"><i
                                class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>

                <form id="generateReportForm" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Type *</label>
                            <select name="report_type" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Report Type</option>
                                <option value="hr">HR Report</option>
                                <option value="performance">Performance Report</option>
                                <option value="financial">Financial Report</option>
                                <option value="attendance">Time & Attendance</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Template *</label>
                            <select name="template_id" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Template</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Date Range *</label>
                            <select name="date_range" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Range</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_quarter">Current Quarter</option>
                                <option value="last_year">Last Year</option>
                                <option value="current_year">Current Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Format *</label>
                            <select name="format" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="pdf">PDF Document</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="csv">CSV File</option>
                                <option value="html">HTML Report</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Date Range -->
                    <div id="customDateRange" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                            <input type="date" name="start_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                            <input type="date" name="end_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Departments</label>
                            <select name="departments[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Departments</option>
                                <option value="engineering">Engineering</option>
                                <option value="sales">Sales</option>
                                <option value="marketing">Marketing</option>
                                <option value="hr">Human Resources</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Employee Types</label>
                            <select name="employee_types[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Types</option>
                                <option value="full_time">Full Time</option>
                                <option value="part_time">Part Time</option>
                                <option value="contractor">Contractor</option>
                                <option value="intern">Intern</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Report Name</label>
                        <input type="text" name="report_name" placeholder="Enter custom name (optional)"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>

                    <div class="flex items-start gap-3">
                        <input type="checkbox" name="schedule_report" id="scheduleReport"
                            class="mt-1 rounded border-slate-300">
                        <div>
                            <label for="scheduleReport" class="block text-sm font-medium text-slate-700">Schedule
                                recurring report</label>
                            <p class="text-xs text-slate-500">Generate this report automatically at regular intervals
                            </p>
                        </div>
                    </div>

                    <div id="scheduleOptions" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Frequency</label>
                            <select name="frequency" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Recipients</label>
                            <input type="text" name="recipients" placeholder="email1@company.com, email2@company.com"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <button type="button" id="cancelGenerate"
                            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900"><i
                                class="fa-solid fa-cog mr-1"></i> Generate Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div id="reportPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-eye mr-2"></i> Report
                            Preview</h3>
                        <div class="flex items-center gap-2">
                            <button id="downloadReportBtn"
                                class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"><i
                                    class="fa-solid fa-download mr-1"></i> Download</button>
                            <button id="closePreviewModal" class="text-slate-400 hover:text-slate-600"><i
                                    class="fa-solid fa-times text-xl"></i></button>
                        </div>
                    </div>
                </div>
                <div id="reportPreviewContent" class="p-6"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toasts -->
<div id="successToast"
    class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-check-circle mr-2"></i><span id="successMessage"></span></div>
</div>
<div id="errorToast"
    class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-exclamation-circle mr-2"></i><span id="errorMessage"></span>
    </div>
</div>
<div id="infoToast"
    class="fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-info-circle mr-2"></i><span id="infoMessage"></span></div>
</div>

<script>
    /* ----------------- Persistence ----------------- */
    const KEY = 'all_reports_store_v1';
    const SEED = {
        reports: [
            { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", format: "pdf", status: "completed", download_count: 15, gen_ms: 900 },
            { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", format: "excel", status: "completed", download_count: 8, gen_ms: 1200 },
            { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", format: "pdf", status: "completed", download_count: 22, gen_ms: 1500 },
            { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", format: "csv", status: "processing", download_count: 0, gen_ms: 0 },
            { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "987 KB", format: "pdf", status: "completed", download_count: 5, gen_ms: 1100 }
        ],
        schedules: [
            { id: 'S-101', type: 'financial', template: 'payroll_summary', frequency: 'monthly', recipients: 'payroll@company.com' },
            { id: 'S-102', type: 'hr', template: 'employee_roster', frequency: 'weekly', recipients: 'hrops@company.com' },
            { id: 'S-103', type: 'attendance', template: 'attendance_summary', frequency: 'weekly', recipients: 'managers@company.com' }
        ],
        idCounter: 6
    };
    let STORE = JSON.parse(localStorage.getItem(KEY) || 'null') || structuredClone(SEED);
    function persist() { localStorage.setItem(KEY, JSON.stringify(STORE)); }

    /* ----------------- State ----------------- */
    let reports = [];
    let filteredReports = [];
    let currentPage = 1;
    let totalPages = 1;
    let sortKey = 'generated_date';
    let sortDir = 'desc';
    let currentPreviewId = null;

    /* ----------------- Init ----------------- */
    document.addEventListener('DOMContentLoaded', initializeReports);

    async function initializeReports() {
        document.getElementById('loadingState').classList.remove('hidden');
        await new Promise(r => setTimeout(r, 400)); // tiny mock delay
        reports = [...STORE.reports];
        filteredReports = [...reports];
        document.getElementById('loadingState').classList.add('hidden');

        setupEventListeners();
        updateSummaryStats();
        renderReports();
    }

    /* ----------------- UI & Events ----------------- */
    function setupEventListeners() {
        // Header actions
        document.getElementById('newReportBtn').addEventListener('click', openGenerateReportModal);
        document.getElementById('exportBtn').addEventListener('click', () => downloadJSON('reports_export.json', STORE));
        document.getElementById('importInput').addEventListener('change', onImportJSON);
        document.getElementById('resetDemo').addEventListener('click', () => { if (!confirm('Reset demo data?')) return; STORE = structuredClone(SEED); persist(); location.reload(); });

        // Modal controls
        document.getElementById('closeGenerateModal').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('cancelGenerate').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('closePreviewModal').addEventListener('click', () => closeModal('reportPreviewModal'));

        // Form
        document.getElementById('generateReportForm').addEventListener('submit', handleGenerateReport);
        document.querySelector('select[name="report_type"]').addEventListener('change', updateTemplateOptions);
        document.querySelector('select[name="date_range"]').addEventListener('change', toggleCustomDateRange);
        document.getElementById('scheduleReport').addEventListener('change', toggleScheduleOptions);

        // Filters / table controls
        document.getElementById('reportTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('tableSearch').addEventListener('input', applyFilters);
        document.getElementById('refreshReports').addEventListener('click', refreshProcessing);
        document.getElementById('pageSize').addEventListener('change', () => { currentPage = 1; renderReports(); });
        document.getElementById('runSchedules').addEventListener('click', runSchedulesNow);
        document.getElementById('exportCSV').addEventListener('click', exportTableCSV);

        // Preview modal download
        document.getElementById('downloadReportBtn').addEventListener('click', downloadPreview);

        // Pagination buttons
        document.getElementById('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderReports(); } });
        document.getElementById('nextPageBtn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderReports(); } });

        // Close modals on backdrop click
        window.addEventListener('click', (e) => {
            ['generateReportModal', 'reportPreviewModal'].forEach(id => {
                const m = document.getElementById(id);
                if (e.target === m) closeModal(id);
            });
        });
    }

    /* ----------------- Stats ----------------- */
    function updateSummaryStats() {
        const today = new Date().toDateString();
        const todayReports = reports.filter(r => new Date(r.generated_date).toDateString() === today).length;
        const totalDownloads = reports.reduce((s, r) => s + (r.download_count || 0), 0);
        const scheduledReports = STORE.schedules.length;
        const failed = reports.filter(r => r.status === 'failed').length;
        const genTimes = reports.map(r => r.gen_ms || 0).filter(Boolean);
        const avg = genTimes.length ? Math.round(genTimes.reduce((a, b) => a + b, 0) / genTimes.length) : 0;

        document.getElementById('totalReports').textContent = reports.length;
        document.getElementById('todayReports').textContent = todayReports;
        document.getElementById('totalDownloads').textContent = totalDownloads;
        document.getElementById('scheduledReports').textContent = scheduledReports;
        document.getElementById('failedReports').textContent = failed;
        document.getElementById('avgGenTime').textContent = avg ? (avg + ' ms') : '—';
    }

    /* ----------------- Filters / Sorting ----------------- */
    function applyFilters() {
        const typeFilter = document.getElementById('reportTypeFilter').value;
        const period = document.getElementById('periodFilter').value;
        const q = (document.getElementById('tableSearch').value || '').toLowerCase().trim();

        filteredReports = reports.filter(r => {
            const matchesType = !typeFilter || r.type === typeFilter;
            let matchesPeriod = true;
            if (period && period !== 'all') {
                const daysAgo = parseInt(period, 10);
                const cutoff = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
                matchesPeriod = new Date(r.generated_date) >= cutoff;
            }
            const matchesQ = !q || (r.name.toLowerCase().includes(q) || (r.generated_by || '').toLowerCase().includes(q));
            return matchesType && matchesPeriod && matchesQ;
        });

        currentPage = 1;
        renderReports();
    }

    function sortBy(key) {
        if (sortKey === key) { sortDir = (sortDir === 'asc' ? 'desc' : 'asc'); } else { sortKey = key; sortDir = 'asc'; }
        filteredReports.sort((a, b) => {
            const va = key === 'generated_date' ? new Date(a[key]) : (a[key] || '').toString().toLowerCase();
            const vb = key === 'generated_date' ? new Date(b[key]) : (b[key] || '').toString().toLowerCase();
            if (va < vb) return sortDir === 'asc' ? -1 : 1;
            if (va > vb) return sortDir === 'asc' ? 1 : -1;
            return 0;
        });
        renderReports();
    }

    /* ----------------- Render Table ----------------- */
    function renderReports() {
        const tbody = document.getElementById('reportsTableBody');
        const itemsPerPage = parseInt(document.getElementById('pageSize').value || '10', 10);

        if (filteredReports.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('reportsTable').classList.add('hidden');
            document.getElementById('pageInfo').textContent = '0-0 of 0';
            return;
        }

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('reportsTable').classList.remove('hidden');

        totalPages = Math.max(1, Math.ceil(filteredReports.length / itemsPerPage));
        currentPage = Math.min(currentPage, totalPages);

        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageReports = filteredReports.slice(startIndex, startIndex + itemsPerPage);

        tbody.innerHTML = pageReports.map(report => `
    <tr class="hover:bg-slate-50">
      <td class="px-6 py-4">
        <div class="flex items-center gap-2">
          <button class="text-slate-400 hover:text-amber-500" title="Pin" onclick="pinReport(${report.id})"><i class="fa-solid fa-thumbtack"></i></button>
          <div>
            <div class="font-medium text-slate-800">${escapeHtml(report.name)}</div>
            <div class="text-sm text-slate-600">ID: #${report.id}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-medium ${typeBadge(report.type)}">${formatType(report.type)}</span></td>
      <td class="px-6 py-4 text-slate-800">${formatDate(report.generated_date)}</td>
      <td class="px-6 py-4 text-slate-800">${escapeHtml(report.generated_by)}</td>
      <td class="px-6 py-4 text-slate-800">${report.file_size}</td>
      <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-medium ${statusBadge(report.status)}">${cap(report.status)}</span></td>
      <td class="px-6 py-4">
        <div class="flex items-center gap-2">
          ${report.status === 'completed' ? `
            <button onclick="previewReport(${report.id})" class="text-blue-600 hover:text-blue-800" title="Preview"><i class="fa-solid fa-eye"></i></button>
            <button onclick="downloadReport(${report.id})" class="text-green-600 hover:text-green-800" title="Download"><i class="fa-solid fa-download"></i></button>
            <button onclick="shareReport(${report.id})" class="text-purple-600 hover:text-purple-800" title="Share"><i class="fa-solid fa-share"></i></button>
          ` : report.status === 'failed' ? `
            <button onclick="retryReport(${report.id})" class="text-amber-600 hover:text-amber-800" title="Retry"><i class="fa-solid fa-rotate-right"></i></button>
          ` : `
            <span class="text-slate-400" title="Processing"><i class="fa-solid fa-clock"></i></span>
          `}
          <button onclick="duplicateReport(${report.id})" class="text-slate-600 hover:text-slate-800" title="Duplicate"><i class="fa-regular fa-copy"></i></button>
          <button onclick="deleteReport(${report.id})" class="text-red-600 hover:text-red-800" title="Delete"><i class="fa-solid fa-trash"></i></button>
        </div>
      </td>
    </tr>
  `).join('');

        // Pagination
        const start = startIndex + 1;
        const end = Math.min(startIndex + itemsPerPage, filteredReports.length);
        document.getElementById('pageInfo').textContent = `${start}-${end} of ${filteredReports.length}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages;

        // Page numbers
        const pn = document.getElementById('pageNumbers');
        pn.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                const b = document.createElement('button');
                b.textContent = i;
                b.className = i === currentPage ? 'px-3 py-1 rounded bg-slate-800 text-white text-sm' : 'px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50';
                b.onclick = () => { currentPage = i; renderReports(); };
                pn.appendChild(b);
            } else if (Math.abs(i - currentPage) === 3) {
                const s = document.createElement('span'); s.textContent = '...'; s.className = 'px-2 text-slate-400'; pn.appendChild(s);
            }
        }
    }

    /* ----------------- Actions ----------------- */
    function openGenerateReportModal() { document.getElementById('generateReportModal').classList.remove('hidden'); }
    function closeModal(id) {
        const m = document.getElementById(id); m.classList.add('hidden');
        if (id === 'generateReportModal') {
            const f = document.getElementById('generateReportForm');
            f.reset(); document.getElementById('customDateRange').classList.add('hidden'); document.getElementById('scheduleOptions').classList.add('hidden');
        }
    }

    function updateTemplateOptions() {
        const reportType = document.querySelector('select[name="report_type"]').value;
        const select = document.querySelector('select[name="template_id"]');
        select.innerHTML = '<option value="">Select Template</option>';
        const map = {
            hr: ['employee_roster', 'headcount_analysis', 'turnover_report', 'diversity_metrics', 'recruitment_pipeline'],
            performance: ['performance_summary', 'goal_achievement', 'review_completion', 'top_performers', 'training_completion'],
            financial: ['payroll_summary', 'cost_analysis', 'expense_reports', 'budget_variance', 'contractor_payments'],
            attendance: ['attendance_summary', 'leave_analysis', 'overtime_report', 'tardiness_report'],
            compliance: ['eeo_report', 'safety_incidents', 'policy_compliance', 'audit_trail']
        };
        (map[reportType] || []).forEach(v => {
            const o = document.createElement('option');
            o.value = v; o.textContent = toTitle(v);
            select.appendChild(o);
        });
    }
    function toggleCustomDateRange() { const dr = document.querySelector('select[name="date_range"]').value; document.getElementById('customDateRange').classList.toggle('hidden', dr !== 'custom'); }
    function toggleScheduleOptions() { const on = document.getElementById('scheduleReport').checked; document.getElementById('scheduleOptions').classList.toggle('hidden', !on); }

    async function handleGenerateReport(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const original = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating...'; btn.disabled = true;
        try {
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            if (data.date_range === 'custom' && (!data.start_date || !data.end_date)) { showError('Select start & end dates'); throw new Error(); }

            await new Promise(r => setTimeout(r, 800 + Math.random() * 800));
            const id = STORE.idCounter++;
            const genMs = 700 + Math.floor(Math.random() * 1200);
            const newReport = {
                id,
                name: data.report_name || `${toTitle(data.template_id)} - ${new Date().toLocaleDateString()}`,
                type: data.report_type,
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.7).toFixed(1)} MB`,
                format: data.format,
                status: "completed",
                download_count: 0,
                gen_ms: genMs
            };
            STORE.reports.unshift(newReport); persist();
            reports.unshift(newReport); filteredReports = [...reports];
            if (fd.get('schedule_report')) {
                const sch = {
                    id: 'S-' + Math.floor(100 + Math.random() * 900),
                    type: data.report_type,
                    template: data.template_id,
                    frequency: data.frequency || 'monthly',
                    recipients: data.recipients || ''
                };
                STORE.schedules.unshift(sch); persist();
                showInfo('Report scheduled ✓');
            }
            showSuccess('Report generated successfully!');
            closeModal('generateReportModal');
            updateSummaryStats();
            applyFilters();
        } catch {
            // noop; toast already shown if validation failed
        } finally {
            btn.innerHTML = original; btn.disabled = false;
        }
    }

    async function generateQuickReport(template) {
        showInfo(`Generating ${toTitle(template)}...`);
        await new Promise(r => setTimeout(r, 600 + Math.random() * 900));
        const id = STORE.idCounter++;
        const newReport = {
            id,
            name: `${toTitle(template)} - ${new Date().toLocaleDateString()}`,
            type: getReportTypeFromTemplate(template),
            generated_date: new Date().toISOString(),
            generated_by: "Current User",
            file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
            format: "pdf",
            status: "completed",
            download_count: 0,
            gen_ms: 600 + Math.floor(Math.random() * 800)
        };
        STORE.reports.unshift(newReport); persist();
        reports.unshift(newReport); filteredReports = [...reports];
        updateSummaryStats(); applyFilters();
        showSuccess(`${toTitle(template)} generated!`);
    }

    function refreshProcessing() {
        // Flip any "processing" to completed/failed randomly
        let changed = false;
        STORE.reports.forEach(r => {
            if (r.status === 'processing') {
                r.status = Math.random() < 0.85 ? 'completed' : 'failed';
                r.gen_ms = 900 + Math.floor(Math.random() * 1000);
                changed = true;
            }
        });
        if (changed) { persist(); reports = [...STORE.reports]; applyFilters(); showSuccess('Refreshed.'); }
        else showInfo('No processing reports.');
    }

    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        currentPreviewId = id;
        const el = document.getElementById('reportPreviewContent');
        el.innerHTML = generateReportPreview(r);
        document.getElementById('reportPreviewModal').classList.remove('hidden');
    }
    function downloadPreview() {
        if (!currentPreviewId) return;
        const r = reports.find(x => x.id === currentPreviewId); if (!r) return;
        const html = `<!doctype html><meta charset="utf-8"><title>${escapeHtml(r.name)}</title>` + generateReportPreview(r);
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (r.name.replace(/\s+/g, '_') + '.html'); a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }

    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}...`);
        setTimeout(() => {
            r.download_count = (r.download_count || 0) + 1;
            STORE.reports = STORE.reports.map(x => x.id === r.id ? r : x); persist();
            updateSummaryStats(); renderReports();
            showSuccess('Report downloaded!');
        }, 600);
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const url = location.href.split('#')[0] + '?report=' + r.id;
        if (navigator.share) { navigator.share({ title: r.name, text: r.name, url }); }
        else {
            navigator.clipboard?.writeText(url).then(() => showSuccess('Link copied!')).catch(() => showInfo('Share unavailable'));
        }
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"?`)) return;
        STORE.reports = STORE.reports.filter(x => x.id !== id); persist();
        reports = reports.filter(x => x.id !== id);
        filteredReports = filteredReports.filter(x => x.id !== id);
        updateSummaryStats(); renderReports(); showSuccess('Deleted.');
    }
    function duplicateReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const clone = { ...r, id: STORE.idCounter++, name: r.name + ' (Copy)', generated_date: new Date().toISOString(), download_count: 0 };
        STORE.reports.unshift(clone); persist();
        reports.unshift(clone); filteredReports = [...reports];
        updateSummaryStats(); applyFilters(); showSuccess('Duplicated.');
    }
    function retryReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        r.status = 'processing'; renderReports();
        setTimeout(() => {
            r.status = Math.random() < 0.9 ? 'completed' : 'failed';
            r.gen_ms = 800 + Math.floor(Math.random() * 1200);
            STORE.reports = STORE.reports.map(x => x.id === r.id ? r : x); persist();
            updateSummaryStats(); renderReports();
            showSuccess(r.status === 'completed' ? 'Report completed.' : 'Retry failed.');
        }, 1000);
    }
    function pinReport(id) {
        const idx = STORE.reports.findIndex(x => x.id === id);
        if (idx > -1) {
            const [item] = STORE.reports.splice(idx, 1);
            STORE.reports.unshift(item); persist();
            reports = [...STORE.reports]; applyFilters();
            showInfo('Pinned to top');
        }
    }

    /* ----------------- Schedules ----------------- */
    function runSchedulesNow() {
        if (!STORE.schedules.length) { showInfo('No schedules'); return; }
        const created = [];
        STORE.schedules.forEach(s => {
            const id = STORE.idCounter++;
            const newReport = {
                id,
                name: `${toTitle(s.template)} - ${new Date().toLocaleDateString()}`,
                type: s.type,
                generated_date: new Date().toISOString(),
                generated_by: "Scheduler",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: "pdf",
                status: "completed",
                download_count: 0,
                gen_ms: 700 + Math.floor(Math.random() * 800)
            };
            STORE.reports.unshift(newReport);
            reports.unshift(newReport);
            created.push(newReport.name);
        });
        persist(); filteredReports = [...reports]; updateSummaryStats(); applyFilters();
        showSuccess(`Ran ${created.length} schedule(s).`);
    }

    /* ----------------- Preview Generators ----------------- */
    function generateReportPreview(report) {
        switch (report.type) {
            case 'hr': return generateHRReportPreview(report);
            case 'performance': return generatePerformanceReportPreview(report);
            case 'financial': return generateFinancialReportPreview(report);
            case 'attendance': return generateAttendanceReportPreview(report);
            case 'compliance': return generateComplianceReportPreview(report);
            default: return '<p class="text-slate-600">Report preview not available.</p>';
        }
    }
    function generateHRReportPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${escapeHtml(r.name)}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${escapeHtml(r.generated_by)}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Employees</h5><p class="text-2xl font-bold text-blue-600">247</p></div>
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">New Hires</h5><p class="text-2xl font-bold text-green-600">15</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Departures</h5><p class="text-2xl font-bold text-red-600">8</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Breakdown</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Engineering</span><span class="font-medium">95 employees</span></div>
        <div class="flex justify-between"><span>Sales</span><span class="font-medium">42 employees</span></div>
        <div class="flex justify-between"><span>Marketing</span><span class="font-medium">28 employees</span></div>
      </div>
    </div>
  </div>`;
    }
    function generatePerformanceReportPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${escapeHtml(r.name)}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${escapeHtml(r.generated_by)}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Rating</h5><p class="text-2xl font-bold text-green-600">4.2/5</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Reviews Completed</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Goals Achieved</h5><p class="text-2xl font-bold text-yellow-600">76%</p></div>
      <div class="bg-purple-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Top Performers</h5><p class="text-2xl font-bold text-purple-600">23</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Performance Distribution</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Exceeds Expectations (4.5-5.0)</span><span class="font-medium">18%</span></div>
        <div class="flex justify-between"><span>Meets Expectations (3.5-4.4)</span><span class="font-medium">67%</span></div>
        <div class="flex justify-between"><span>Below Expectations (2.0-3.4)</span><span class="font-medium">15%</span></div>
      </div>
    </div>
  </div>`;
    }
    function generateFinancialReportPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${escapeHtml(r.name)}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${escapeHtml(r.generated_by)}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Payroll</h5><p class="text-2xl font-bold text-green-600">$1.2M</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Benefits Cost</h5><p class="text-2xl font-bold text-blue-600">$245K</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Expenses</h5><p class="text-2xl font-bold text-yellow-600">$89K</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Costs</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Engineering</span><span class="font-medium">$687,500</span></div>
        <div class="flex justify-between"><span>Sales</span><span class="font-medium">$312,000</span></div>
        <div class="flex justify-between"><span>Marketing</span><span class="font-medium">$156,000</span></div>
      </div>
    </div>
  </div>`;
    }
    function generateAttendanceReportPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${escapeHtml(r.name)}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${escapeHtml(r.generated_by)}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Attendance</h5><p class="text-2xl font-bold text-green-600">94.2%</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">On Time %</h5><p class="text-2xl font-bold text-blue-600">87.5%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Leave Days</h5><p class="text-2xl font-bold text-yellow-600">156</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Sick Days</h5><p class="text-2xl font-bold text-red-600">89</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Attendance Trends</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Perfect Attendance</span><span class="font-medium">42 employees</span></div>
        <div class="flex justify-between"><span>1-2 Absences</span><span class="font-medium">128 employees</span></div>
        <div class="flex justify-between"><span>3+ Absences</span><span class="font-medium">77 employees</span></div>
      </div>
    </div>
  </div>`;
    }
    function generateComplianceReportPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${escapeHtml(r.name)}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${escapeHtml(r.generated_by)}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Compliance Score</h5><p class="text-2xl font-bold text-green-600">96%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Open Issues</h5><p class="text-2xl font-bold text-yellow-600">3</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Training Complete</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Compliance Areas</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Equal Opportunity</span><span class="font-medium text-green-600">✓ Compliant</span></div>
        <div class="flex justify-between"><span>Safety Training</span><span class="font-medium text-green-600">✓ Compliant</span></div>
        <div class="flex justify-between"><span>Data Privacy</span><span class="font-medium text-yellow-600">⚠ Review Required</span></div>
      </div>
    </div>
  </div>`;
    }

    /* ----------------- Utils ----------------- */
    function formatDate(d) { return new Date(d).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    function typeBadge(t) { return ({ hr: 'bg-blue-100 text-blue-700', performance: 'bg-green-100 text-green-700', financial: 'bg-yellow-100 text-yellow-700', attendance: 'bg-purple-100 text-purple-700', compliance: 'bg-red-100 text-red-700' })[t] || 'bg-slate-100 text-slate-700'; }
    function statusBadge(s) { return ({ completed: 'bg-green-100 text-green-700', processing: 'bg-blue-100 text-blue-700', failed: 'bg-red-100 text-red-700', scheduled: 'bg-yellow-100 text-yellow-700' })[s] || 'bg-slate-100 text-slate-700'; }
    function formatType(t) { return ({ hr: 'HR Report', performance: 'Performance', financial: 'Financial', attendance: 'Time & Attendance', compliance: 'Compliance' })[t] || t; }
    function toTitle(k) { return (k || '').split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
    function cap(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function getReportTypeFromTemplate(t) { return ({ employee_roster: 'hr', headcount_analysis: 'hr', turnover_report: 'hr', diversity_metrics: 'hr', recruitment_pipeline: 'hr', performance_summary: 'performance', goal_achievement: 'performance', review_completion: 'performance', top_performers: 'performance', training_completion: 'performance', payroll_summary: 'financial', cost_analysis: 'financial', expense_reports: 'financial', budget_variance: 'financial', contractor_payments: 'financial', attendance_summary: 'attendance', leave_analysis: 'attendance', overtime_report: 'attendance', tardiness_report: 'attendance', eeo_report: 'compliance', safety_incidents: 'compliance', policy_compliance: 'compliance', audit_trail: 'compliance' })[t] || 'hr'; }
    function escapeHtml(str) { return (str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

    /* ----------------- Export / Import ----------------- */
    function downloadJSON(name, obj) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }
    function onImportJSON(e) {
        const f = e.target.files?.[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                if (!data || !Array.isArray(data.reports)) throw new Error('Invalid');
                STORE = data; persist(); showSuccess('Imported ✓'); location.reload();
            } catch { showError('Invalid JSON file'); }
        };
        reader.readAsText(f); e.target.value = '';
    }
    function exportTableCSV() {
        const headers = ['ID', 'Name', 'Type', 'Generated', 'By', 'Size', 'Status', 'Downloads'];
        const rows = filteredReports.map(r => [r.id, r.name, formatType(r.type), new Date(r.generated_date).toISOString(), r.generated_by, r.file_size, r.status, r.download_count || 0]);
        const csv = [headers, ...rows].map(a => a.map(x => `"${String(x).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reports.csv'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }
</script>
{% endblock %}