{% extends "layout.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1" />

<div class="mx-auto max-w-7xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-people-group mr-2"></i> Team overview
            </h1>
            <p class="text-slate-600 text-sm">Get a snapshot of team composition, capacity, and status.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm text-center">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Summary cards -->
    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="text-xs sm:text-sm text-slate-500"><i class="fa-solid fa-user-group mr-1"></i> Total Headcount
            </div>
            <div id="headcount" class="mt-1 text-xl sm:text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="text-xs sm:text-sm text-slate-500"><i class="fa-solid fa-briefcase mr-1"></i> Open Jobs</div>
            <div id="openJobs" class="mt-1 text-xl sm:text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="text-xs sm:text-sm text-slate-500"><i class="fa-solid fa-person-digging mr-1"></i> In Pipeline
            </div>
            <div id="pipeline" class="mt-1 text-xl sm:text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="text-xs sm:text-sm text-slate-500"><i class="fa-solid fa-user-check mr-1"></i> Recent Hires
            </div>
            <div id="recentHires" class="mt-1 text-xl sm:text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Team Composition -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-pie mr-2"></i> By Employee Type
            </h2>
            <div id="typeComposition" class="space-y-2 sm:space-y-3"></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-layer-group mr-2"></i> By Department
            </h2>
            <div id="deptComposition" class="space-y-2 sm:space-y-3"></div>
        </div>
    </div>

    <!-- Team Members -->
    <div class="rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 sm:mb-6">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-users mr-2"></i> Team Members
            </h2>
            <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                <input id="searchInput"
                    class="flex-1 sm:flex-none min-w-0 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"
                    placeholder="Search name, email, or ID...">
                <select id="typeFilter" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                    <option value="">All Types</option>
                    <option value="Employees">Employees</option>
                    <option value="HR">HR</option>
                    <option value="Leaders">Leaders</option>
                    <option value="CXOs">CXOs</option>
                    <option value="Contractors / Remote staff">Contractors</option>
                </select>
                <button id="refreshBtn"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-refresh mr-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <i class="fa-solid fa-spinner fa-spin text-slate-400 text-2xl mb-2"></i>
            <p class="text-slate-600">Loading team data...</p>
        </div>

        <!-- Table (sm and up) -->
        <div id="tableContainer" class="hidden sm:block overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Employee ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Type
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Position</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Designation</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Email</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Joined</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Status</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody" class="bg-white divide-y divide-slate-200"></tbody>
            </table>
        </div>

        <!-- Mobile cards (xs only) -->
        <div id="mobileList" class="sm:hidden space-y-3"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-8">
            <i class="fa-solid fa-users-slash text-slate-300 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No team members found</h3>
            <p class="text-slate-600">Try adjusting your search criteria or filters.</p>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-6 sm:mt-8 rounded-2xl border border-slate-200 bg-white p-5 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-clock-rotate-left mr-2"></i> Recent Activity
        </h2>
        <div id="recentActivity" class="space-y-3 sm:space-y-4"></div>
    </div>
</div>

<style>
    @media (max-width: 640px) {

        input,
        select,
        button {
            min-height: 42px;
        }

        /* nicer tap targets */
    }

    @supports (-webkit-overflow-scrolling: touch) {
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    }
</style>

<script>
    // Global variables
    let teamData = [];
    let jobsData = [];
    let candidatesData = [];

    // Utils
    async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    }
    function formatDate(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function getEmployeeStatus(createdAt) {
        const created = new Date(createdAt);
        const now = new Date();
        const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));
        if (daysDiff <= 30) return { text: 'New', class: 'bg-green-100 text-green-800' };
        if (daysDiff <= 90) return { text: 'Recent', class: 'bg-blue-100 text-blue-800' };
        return { text: 'Active', class: 'bg-slate-100 text-slate-800' };
    }

    // Data loading
    async function loadTeamData() {
        try {
            teamData = await fetchJSON('/api/users');
            updateSummaryCards();
            updateComposition();
            renderTeamTable();
        } catch (e) {
            console.error('Error loading team data:', e);
            showError('Failed to load team data');
        }
    }
    async function loadJobsData() {
        try {
            jobsData = await fetchJSON('/api/jobs');
            document.getElementById('openJobs').textContent = jobsData.filter(j => j.status === 'Open').length;
        } catch {
            document.getElementById('openJobs').textContent = '0';
        }
    }
    async function loadCandidatesData() {
        try {
            candidatesData = await fetchJSON('/api/candidates');
            const inPipeline = candidatesData.filter(c => !['Rejected', 'Onboarding'].includes(c.stage)).length;
            const recentHires = candidatesData.filter(c => c.stage === 'Onboarding' && c.created_at).length;
            document.getElementById('pipeline').textContent = inPipeline;
            document.getElementById('recentHires').textContent = recentHires;
        } catch {
            document.getElementById('pipeline').textContent = '0';
            document.getElementById('recentHires').textContent = '0';
        }
    }

    // UI updates
    function updateSummaryCards() {
        document.getElementById('headcount').textContent = teamData.length;
    }
    function updateComposition() {
        const typeComposition = {};
        const deptComposition = {};
        teamData.forEach(m => {
            const t = m.employee_type || 'Unknown';
            typeComposition[t] = (typeComposition[t] || 0) + 1;
            const d = m.subposition || 'Unassigned';
            deptComposition[d] = (deptComposition[d] || 0) + 1;
        });
        renderComposition('typeComposition', typeComposition);
        renderComposition('deptComposition', deptComposition);
    }
    function renderComposition(elementId, data) {
        const container = document.getElementById(elementId);
        const total = Object.values(data).reduce((s, c) => s + c, 0);
        container.innerHTML = Object.entries(data)
            .sort(([, a], [, b]) => b - a)
            .map(([key, count]) => {
                const pct = total ? Math.round((count / total) * 100) : 0;
                return `
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-slate-400 mr-3"></div>
                        <span class="text-sm font-medium text-slate-700 break-words">${key}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-slate-800">${count}</div>
                        <div class="text-xs text-slate-500">${pct}%</div>
                    </div>
                </div>`;
            }).join('');
    }

    function renderTeamTable() {
        const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const match = m => {
            const s = searchTerm;
            const matchesSearch = !s ||
                (m.name || '').toLowerCase().includes(s) ||
                (m.email || '').toLowerCase().includes(s) ||
                (m.employee_id || '').toLowerCase().includes(s) ||
                (m.username || '').toLowerCase().includes(s);
            const matchesType = !typeFilter || m.employee_type === typeFilter;
            return matchesSearch && matchesType;
        };
        const data = teamData.filter(match);

        const hasRows = data.length > 0;
        document.getElementById('emptyState').classList.toggle('hidden', hasRows);
        document.getElementById('tableContainer').classList.toggle('hidden', !hasRows);
        document.getElementById('mobileList').classList.toggle('hidden', !hasRows);

        if (!hasRows) return;

        // Desktop/tablet table rows
        const tbody = document.getElementById('teamTableBody');
        tbody.innerHTML = data.map(m => {
            const status = getEmployeeStatus(m.created_at);
            return `
            <tr class="hover:bg-slate-50">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center mr-3">
                            <i class="fa-solid fa-user text-slate-500 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-slate-800">${m.name || '-'}</div>
                            <div class="text-sm text-slate-500">@${m.username || '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${m.employee_id || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${m.employee_type || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${m.subposition || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${m.designation || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600 break-all">${m.email || '-'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${formatDate(m.created_at)}</td>
                <td class="px-4 py-3">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${status.class}">${status.text}</span>
                </td>
            </tr>`;
        }).join('');

        // Mobile cards
        const list = document.getElementById('mobileList');
        list.innerHTML = data.map(m => {
            const status = getEmployeeStatus(m.created_at);
            return `
            <div class="rounded-xl border border-slate-200 p-4">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-user text-slate-500"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2">
                            <div class="font-medium text-slate-800 truncate">${m.name || '-'}</div>
                            <span class="shrink-0 inline-flex px-2 py-0.5 text-xs font-semibold rounded-full ${status.class}">${status.text}</span>
                        </div>
                        <div class="text-xs text-slate-500 truncate">@${m.username || '-'}</div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-slate-500">ID:</span> <span class="font-medium">${m.employee_id || '-'}</span></div>
                            <div><span class="text-slate-500">Type:</span> <span class="font-medium">${m.employee_type || '-'}</span></div>
                            <div class="col-span-2"><span class="text-slate-500">Role:</span> <span class="font-medium">${m.subposition || '-'}</span></div>
                            <div class="col-span-2 break-all"><span class="text-slate-500">Email:</span> <span class="font-medium">${m.email || '-'}</span></div>
                            <div><span class="text-slate-500">Joined:</span> <span class="font-medium">${formatDate(m.created_at)}</span></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function loadRecentActivity() {
        const activityContainer = document.getElementById('recentActivity');
        const activities = [];
        const recentHires = teamData
            .filter(m => {
                const created = new Date(m.created_at);
                const daysAgo = Math.floor((new Date() - created) / (1000 * 60 * 60 * 24));
                return daysAgo <= 30;
            })
            .slice(0, 3);

        recentHires.forEach(h => {
            activities.push({
                icon: 'fa-user-plus',
                iconClass: 'text-green-600 bg-green-100',
                title: `${h.name} joined as ${h.subposition || '—'}`,
                time: formatDate(h.created_at),
                description: `New ${h.employee_type || 'employee'}`
            });
        });

        if (!activities.length) {
            activityContainer.innerHTML = `
                <div class="text-center py-6">
                    <i class="fa-solid fa-clock text-slate-300 text-2xl mb-2"></i>
                    <p class="text-slate-500">No recent activity to display</p>
                </div>`;
            return;
        }

        activityContainer.innerHTML = activities.map(a => `
            <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-slate-50">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full ${a.iconClass} flex items-center justify-center">
                        <i class="fa-solid ${a.icon} text-sm"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-slate-800">${a.title}</div>
                    <div class="text-sm text-slate-500">${a.description}</div>
                    <div class="text-xs text-slate-400 mt-1">${a.time}</div>
                </div>
            </div>`).join('');
    }

    function showError(msg) { console.error(msg); }

    async function initializePage() {
        document.getElementById('loadingState').classList.remove('hidden');
        try {
            await Promise.all([loadTeamData(), loadJobsData(), loadCandidatesData()]);
            loadRecentActivity();
            document.getElementById('loadingState').classList.add('hidden');
        } catch (e) {
            console.error('Error initializing page:', e);
            document.getElementById('loadingState').innerHTML = `
                <div class="text-center py-8">
                    <i class="fa-solid fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-600">Failed to load team overview data</p>
                    <button onclick="initializePage()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Try Again</button>
                </div>`;
        }
    }

    // Events
    document.getElementById('searchInput').addEventListener('input', renderTeamTable);
    document.getElementById('typeFilter').addEventListener('change', renderTeamTable);
    document.getElementById('refreshBtn').addEventListener('click', initializePage);

    document.addEventListener('DOMContentLoaded', initializePage);
</script>
{% endblock %}