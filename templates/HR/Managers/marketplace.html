{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-store mr-2"></i> Marketplace
            </h1>
            <p class="text-slate-600 text-sm">Access third-party HR services, tools, and integrations.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="manageInstallsBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-plug mr-1"></i> Manage Installs
            </button>
            <button id="submitVendorBtn"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-paper-plane mr-1"></i> Submit Your App
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
        <div class="relative w-full md:w-96">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input id="searchInput" type="text" placeholder="Search apps, vendors, or keywords"
                class="w-full pl-10 pr-10 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-slate-200">
            <button id="clearSearch"
                class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flex items-center gap-2">
            <div class="hidden md:block text-sm text-slate-600">
                <span id="resultCount">0</span> results
            </div>
            <select id="sortSelect" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="featured">Sort: Featured</option>
                <option value="rating">Sort: Rating</option>
                <option value="installs">Sort: Most Installed</option>
                <option value="new">Sort: Newest</option>
                <option value="price">Sort: Price (Low→High)</option>
            </select>
            <button id="openFilters"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm md:hidden">
                <i class="fa-solid fa-filter mr-1"></i> Filters
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Filters -->
        <aside id="filtersPanel" class="lg:col-span-1 rounded-2xl border border-slate-200 bg-white p-5">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-filter mr-2"></i> Filters
                </h3>
                <button id="resetFilters" class="text-sm text-slate-500 hover:text-slate-700">Reset</button>
            </div>

            <div class="space-y-5">
                <div>
                    <div class="text-sm font-medium text-slate-700 mb-2">Categories</div>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="payroll"> Payroll
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="recruiting"> Recruiting
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="time-tracking"> Time Tracking
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="benefits"> Benefits
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="compliance"> Compliance
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="cat" value="analytics"> Analytics
                        </label>
                    </div>
                </div>

                <div>
                    <div class="text-sm font-medium text-slate-700 mb-2">Pricing</div>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" class="price" value="free">
                            Free</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="price" value="freemium">
                            Freemium</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="price" value="paid">
                            Paid</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="price" value="enterprise">
                            Enterprise</label>
                    </div>
                </div>

                <div>
                    <div class="text-sm font-medium text-slate-700 mb-2">Compliance & Trust</div>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" class="trust" value="soc2"> SOC
                            2</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="trust" value="iso27001">
                            ISO 27001</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="trust" value="gdpr">
                            GDPR</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="trust" value="hipaa">
                            HIPAA</label>
                    </div>
                </div>

                <div>
                    <div class="text-sm font-medium text-slate-700 mb-2">Works With</div>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" class="works" value="slack">
                            Slack</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="works" value="teams">
                            Microsoft Teams</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="works" value="gdrive">
                            Google Drive</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="works" value="okta">
                            Okta/SSO</label>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Results -->
        <section class="lg:col-span-3">
            <!-- Featured strip -->
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-r from-slate-50 to-white p-5 mb-6">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Featured</div>
                        <div class="flex items-center gap-2">
                            <img src="https://dummyimage.com/48x48/0ea5e9/ffffff&text=PF" alt=""
                                class="w-10 h-10 rounded-lg">
                            <div>
                                <div class="font-semibold text-slate-800">PayFlow</div>
                                <div class="text-sm text-slate-600">Global payroll with automated tax filings.</div>
                            </div>
                        </div>
                    </div>
                    <button class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm"
                        onclick="installApp('payflow')">
                        <i class="fa-solid fa-download mr-1"></i> Install
                    </button>
                </div>
            </div>

            <!-- App grid -->
            <div id="appsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Cards injected by JS -->
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-center gap-2 mt-6">
                <button id="prevPage"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm disabled:opacity-40" disabled>
                    <i class="fa-solid fa-chevron-left mr-1"></i> Prev
                </button>
                <div class="text-sm text-slate-600">Page <span id="pageNum">1</span> of <span id="pageTotal">1</span>
                </div>
                <button id="nextPage"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm disabled:opacity-40">
                    Next <i class="fa-solid fa-chevron-right ml-1"></i>
                </button>
            </div>
        </section>
    </div>
</div>

<!-- App Modal -->
<div id="appModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
                <div class="p-6 border-b border-slate-200 flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <img id="modalLogo" src="" class="w-10 h-10 rounded-lg" alt="">
                        <div>
                            <h3 id="modalTitle" class="text-lg font-semibold text-slate-800"></h3>
                            <div id="modalSubtitle" class="text-sm text-slate-600"></div>
                        </div>
                    </div>
                    <button id="closeAppModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div id="modalBadges" class="flex flex-wrap gap-2"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="rounded-lg bg-slate-50 p-3">
                            <div class="text-xs text-slate-500 mb-1">Pricing</div>
                            <div id="modalPrice" class="font-semibold text-slate-800"></div>
                        </div>
                        <div class="rounded-lg bg-slate-50 p-3">
                            <div class="text-xs text-slate-500 mb-1">Rating</div>
                            <div id="modalRating" class="font-semibold text-slate-800"></div>
                        </div>
                        <div class="rounded-lg bg-slate-50 p-3">
                            <div class="text-xs text-slate-500 mb-1">Installs</div>
                            <div id="modalInstalls" class="font-semibold text-slate-800"></div>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-slate-700 mb-1">Overview</div>
                        <p id="modalDesc" class="text-sm text-slate-600"></p>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-slate-700 mb-1">Works With</div>
                        <div id="modalWorks" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="modalDocs"
                            class="px-3 py-2 rounded-lg border border-slate-300 text-sm bg-white hover:bg-slate-50">
                            <i class="fa-solid fa-file-lines mr-1"></i> Docs
                        </button>
                        <button id="modalInstall" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                            <i class="fa-solid fa-download mr-1"></i> Install
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------- Data (mock) ---------- */
    const ALL_APPS = [
        {
            id: 'payflow', name: 'PayFlow', category: 'payroll',
            desc: 'Global payroll, automated filings, localized compliance.',
            price: 'Paid • from $4/emp/mo', pricingKey: 'paid',
            rating: 4.8, installs: 12840,
            badges: ['SOC 2', 'GDPR'],
            works: ['slack', 'okta'],
            logo: 'https://dummyimage.com/64x64/0ea5e9/ffffff&text=PF'
        },
        {
            id: 'hirely', name: 'Hirely ATS', category: 'recruiting',
            desc: 'Modern applicant tracking with AI screening.',
            price: 'Freemium', pricingKey: 'freemium',
            rating: 4.6, installs: 8930,
            badges: ['ISO 27001'],
            works: ['slack', 'gdrive'],
            logo: 'https://dummyimage.com/64x64/8b5cf6/ffffff&text=HA'
        },
        {
            id: 'chronos', name: 'Chronos Time', category: 'time-tracking',
            desc: 'Time, attendance, geofencing, and overtime rules.',
            price: 'Paid • from $2/user/mo', pricingKey: 'paid',
            rating: 4.5, installs: 15210,
            badges: ['SOC 2'],
            works: ['teams'],
            logo: 'https://dummyimage.com/64x64/10b981/ffffff&text=CT'
        },
        {
            id: 'beneplus', name: 'BenePlus', category: 'benefits',
            desc: 'Benefits enrollment, carrier sync, self-service.',
            price: 'Enterprise', pricingKey: 'enterprise',
            rating: 4.4, installs: 3740,
            badges: ['HIPAA', 'GDPR'],
            works: ['okta'],
            logo: 'https://dummyimage.com/64x64/f59e0b/ffffff&text=BP'
        },
        {
            id: 'guardrail', name: 'GuardRail', category: 'compliance',
            desc: 'Policy, audits, and automated risk alerts.',
            price: 'Paid', pricingKey: 'paid',
            rating: 4.7, installs: 6420,
            badges: ['SOC 2', 'ISO 27001'],
            works: ['gdrive', 'slack'],
            logo: 'https://dummyimage.com/64x64/ef4444/ffffff&text=GR'
        },
        {
            id: 'insightHR', name: 'InsightHR', category: 'analytics',
            desc: 'People analytics, retention risk, and headcount planning.',
            price: 'Free', pricingKey: 'free',
            rating: 4.3, installs: 2210,
            badges: [],
            works: ['gdrive', 'teams'],
            logo: 'https://dummyimage.com/64x64/06b6d4/ffffff&text=IH'
        }
    ];

    /* ---------- State ---------- */
    let activePage = 1;
    const perPage = 6;
    let installed = new Set();
    let filters = { categories: new Set(), pricing: new Set(), trust: new Set(), works: new Set(), sort: 'featured', q: '' };

    /* ---------- Elements ---------- */
    const appsGrid = document.getElementById('appsGrid');
    const resultCount = document.getElementById('resultCount');
    const pageNum = document.getElementById('pageNum');
    const pageTotal = document.getElementById('pageTotal');

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Filters
        document.querySelectorAll('.cat').forEach(c => c.addEventListener('change', () => toggleSet(filters.categories, c.value, c.checked)));
        document.querySelectorAll('.price').forEach(p => p.addEventListener('change', () => toggleSet(filters.pricing, p.value, p.checked)));
        document.querySelectorAll('.trust').forEach(t => t.addEventListener('change', () => toggleSet(filters.trust, t.value, t.checked)));
        document.querySelectorAll('.works').forEach(w => w.addEventListener('change', () => toggleSet(filters.works, w.value, w.checked)));
        document.getElementById('sortSelect').addEventListener('change', (e) => { filters.sort = e.target.value; render(); });
        document.getElementById('resetFilters').addEventListener('click', resetFilters);

        // Search
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        searchInput.addEventListener('input', debounce(() => { filters.q = searchInput.value.trim().toLowerCase(); clearSearch.classList.toggle('hidden', !filters.q); render(); }, 300));
        clearSearch.addEventListener('click', () => { searchInput.value = ''; filters.q = ''; clearSearch.classList.add('hidden'); render(); });

        // Pagination
        document.getElementById('prevPage').addEventListener('click', () => { if (activePage > 1) { activePage--; render(); } });
        document.getElementById('nextPage').addEventListener('click', () => { const total = getTotalPages(); if (activePage < total) { activePage++; render(); } });

        // Modal
        document.getElementById('closeAppModal').addEventListener('click', closeModal);
        window.addEventListener('click', (e) => { if (e.target === document.getElementById('appModal')) closeModal(); });

        render();
    });

    /* ---------- Render ---------- */
    function render() {
        const filtered = applyFilters(ALL_APPS);
        resultCount.textContent = filtered.length;
        const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
        activePage = Math.min(activePage, totalPages);
        pageNum.textContent = activePage;
        pageTotal.textContent = totalPages;
        document.getElementById('prevPage').disabled = activePage === 1;
        document.getElementById('nextPage').disabled = activePage === totalPages;

        const start = (activePage - 1) * perPage;
        const pageItems = filtered.slice(start, start + perPage);

        appsGrid.innerHTML = pageItems.map(appCardHTML).join('');
    }

    /* ---------- Helpers ---------- */
    function appCardHTML(a) {
        const isInstalled = installed.has(a.id);
        const trustTags = a.badges.map(b => `<span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 text-xs">${b}</span>`).join(' ');
        const worksTags = a.works.map(w => `<span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs">${labelWorks(w)}</span>`).join(' ');
        return `
    <div class="rounded-2xl border border-slate-200 bg-white p-4 flex flex-col">
      <div class="flex items-start gap-3">
        <img src="${a.logo}" alt="${a.name}" class="w-12 h-12 rounded-lg">
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-slate-800">${a.name}</h4>
            <div class="text-sm text-amber-600"><i class="fa-solid fa-star mr-1"></i>${a.rating.toFixed(1)}</div>
          </div>
          <div class="text-sm text-slate-600">${a.desc}</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-3">${trustTags} ${worksTags}</div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-slate-600"><i class="fa-solid fa-tags mr-1"></i>${a.price}</div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50" onclick="openModal('${a.id}')">
            <i class="fa-solid fa-circle-info mr-1"></i> Details
          </button>
          <button class="px-3 py-2 rounded-lg ${isInstalled ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white text-sm"
                  onclick="installApp('${a.id}')">
            <i class="fa-solid ${isInstalled ? 'fa-check' : 'fa-download'} mr-1"></i> ${isInstalled ? 'Installed' : 'Install'}
          </button>
        </div>
      </div>
    </div>
  `;
    }

    function labelWorks(key) {
        return ({ slack: 'Slack', teams: 'Microsoft Teams', gdrive: 'Google Drive', okta: 'Okta/SSO' })[key] || key;
    }

    function toggleSet(set, val, checked) { checked ? set.add(val) : set.delete(val); activePage = 1; render(); }

    function applyFilters(apps) {
        let out = apps.slice();

        if (filters.categories.size) out = out.filter(a => filters.categories.has(a.category));
        if (filters.pricing.size) out = out.filter(a => filters.pricing.has(a.pricingKey));
        if (filters.trust.size) out = out.filter(a => a.badges.some(b => Array.from(filters.trust).includes(b.toLowerCase())));
        if (filters.works.size) out = out.filter(a => a.works.some(w => filters.works.has(w)));

        if (filters.q) {
            const q = filters.q;
            out = out.filter(a =>
                a.name.toLowerCase().includes(q) ||
                a.desc.toLowerCase().includes(q) ||
                a.category.toLowerCase().includes(q) ||
                a.price.toLowerCase().includes(q)
            );
        }

        switch (filters.sort) {
            case 'rating': out.sort((a, b) => b.rating - a.rating); break;
            case 'installs': out.sort((a, b) => b.installs - a.installs); break;
            case 'new': out.sort((a, b) => a.id.localeCompare(b.id)); break; // placeholder
            case 'price': out.sort((a, b) => priceKey(a.pricingKey) - priceKey(b.pricingKey)); break;
            default: /* featured */ out.sort((a, b) => b.installs * 0.5 + b.rating * 100 - (a.installs * 0.5 + a.rating * 100));
        }

        return out;
    }

    function priceKey(k) { return ({ free: 0, freemium: 1, paid: 2, enterprise: 3 })[k] ?? 9; }
    function getTotalPages() { return Math.max(1, Math.ceil(applyFilters(ALL_APPS).length / perPage)); }

    function resetFilters() {
        filters = { categories: new Set(), pricing: new Set(), trust: new Set(), works: new Set(), sort: 'featured', q: '' };
        document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
        document.getElementById('sortSelect').value = 'featured';
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearch').classList.add('hidden');
        activePage = 1; render();
    }

    /* ---------- Modal ---------- */
    function openModal(id) {
        const a = ALL_APPS.find(x => x.id === id);
        if (!a) return;
        document.getElementById('modalLogo').src = a.logo;
        document.getElementById('modalTitle').textContent = a.name;
        document.getElementById('modalSubtitle').textContent = capitalize(a.category);
        document.getElementById('modalPrice').textContent = a.price;
        document.getElementById('modalRating').textContent = `${a.rating.toFixed(1)} / 5`;
        document.getElementById('modalInstalls').textContent = Intl.NumberFormat().format(a.installs);
        document.getElementById('modalDesc').textContent = a.desc;
        document.getElementById('modalBadges').innerHTML = a.badges.map(b => `<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-xs">${b}</span>`).join('') || '<span class="text-xs text-slate-500">No compliance tags</span>';
        document.getElementById('modalWorks').innerHTML = a.works.map(w => `<span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs">${labelWorks(w)}</span>`).join('');
        document.getElementById('modalInstall').onclick = () => installApp(id, true);
        document.getElementById('modalDocs').onclick = () => window.open('#', '_blank');
        document.getElementById('appModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('appModal').classList.add('hidden'); }

    /* ---------- Actions ---------- */
    function installApp(id, fromModal = false) {
        if (installed.has(id)) {
            toast('Already installed');
            return;
        }
        installed.add(id);
        toast('App installed');
        render();
        if (fromModal) closeModal();
    }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    /* ---------- Utilities ---------- */
    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
    function toast(msg) {
        const n = document.createElement('div');
        n.className = 'fixed bottom-4 right-4 z-50 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm';
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => { n.remove(); }, 1800);
    }

    // Mobile filters toggle
    document.getElementById('openFilters')?.addEventListener('click', () => {
        const p = document.getElementById('filtersPanel');
        p.classList.toggle('hidden');
    });
</script>

<style>
    /* Optional: tighter mobile spacing */
    @media (max-width: 640px) {
        #appsGrid .rounded-2xl {
            padding: 1rem;
        }
    }
</style>
{% endblock %}