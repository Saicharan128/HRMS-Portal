{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-people-group mr-2"></i> Team
            </h1>
            <p class="text-slate-600 text-sm">View and manage employee details, roles, and responsibilities.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="addEmployeeBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-user-plus mr-1"></i> Add Employee
            </button>
            <button id="bulkActionBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-layer-group mr-1"></i> Bulk Actions
            </button>
            <button id="exportBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-export mr-1"></i> Export
            </button>
            <button id="copyLinkBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-link mr-1"></i> Copy View
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Controls -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
        <div class="relative w-full md:w-[28rem]">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input id="searchInput" type="text" placeholder="Search by name, role, or email"
                class="w-full pl-10 pr-10 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-slate-200">
            <button id="clearSearch"
                class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flex items-center gap-2">
            <select id="deptFilter" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="all">All Depts</option>
                <option value="engineering">Engineering</option>
                <option value="sales">Sales</option>
                <option value="marketing">Marketing</option>
                <option value="hr">HR</option>
                <option value="finance">Finance</option>
                <option value="operations">Operations</option>
            </select>
            <select id="statusFilter" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="on_leave">On Leave</option>
                <option value="inactive">Inactive</option>
            </select>
            <select id="sortSelect" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="name">Sort: Name</option>
                <option value="role">Sort: Role</option>
                <option value="dept">Sort: Dept</option>
                <option value="joined">Sort: Join Date</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Summary -->
        <aside class="rounded-2xl border border-slate-200 bg-white p-5">
            <h3 class="text-lg font-semibold text-slate-800 mb-3">
                <i class="fa-solid fa-chart-pie mr-2"></i> Headcount Snapshot
            </h3>
            <div class="grid grid-cols-3 gap-3">
                <div class="rounded-lg bg-slate-50 p-3">
                    <div class="text-xs text-slate-500">Total</div>
                    <div id="hcTotal" class="text-xl font-semibold text-slate-800">0</div>
                </div>
                <div class="rounded-lg bg-slate-50 p-3">
                    <div class="text-xs text-slate-500">Active</div>
                    <div id="hcActive" class="text-xl font-semibold text-slate-800">0</div>
                </div>
                <div class="rounded-lg bg-slate-50 p-3">
                    <div class="text-xs text-slate-500">Open Roles</div>
                    <div id="hcOpen" class="text-xl font-semibold text-slate-800">0</div>
                </div>
            </div>
            <div class="mt-5">
                <div class="text-sm font-medium text-slate-700 mb-2">Departments</div>
                <div id="deptChips" class="flex flex-wrap gap-2"></div>
            </div>
        </aside>

        <!-- Right: Table -->
        <section class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between p-4 border-b border-slate-200">
                <div class="text-sm text-slate-600">
                    <span id="resultCount">0</span> employees
                </div>
                <div class="flex items-center gap-2">
                    <button id="inviteBtn"
                        class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">
                        <i class="fa-solid fa-paper-plane mr-1"></i> Invite
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4 w-10"><input id="selectAll" type="checkbox"></th>
                            <th class="py-2 px-4">Employee</th>
                            <th class="py-2 px-4">Role</th>
                            <th class="py-2 px-4">Department</th>
                            <th class="py-2 px-4">Manager</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4">Joined</th>
                            <th class="py-2 px-4 w-36"></th>
                        </tr>
                    </thead>
                    <tbody id="rows" class="text-slate-800"><!-- injected --></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-center gap-2 p-4 border-t border-slate-200">
                <button id="prevPage"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm disabled:opacity-40" disabled>
                    <i class="fa-solid fa-chevron-left mr-1"></i> Prev
                </button>
                <div class="text-sm text-slate-600">Page <span id="pageNum">1</span> of <span id="pageTotal">1</span>
                </div>
                <button id="nextPage"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm disabled:opacity-40">
                    Next <i class="fa-solid fa-chevron-right ml-1"></i>
                </button>
            </div>
        </section>
    </div>
</div>

<!-- Add/Edit Employee Modal -->
<div id="empModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 id="empModalTitle" class="text-lg font-semibold text-slate-800">Add Employee</h3>
                    <button id="closeEmpModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
                            <input id="empFirst" type="text"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
                            <input id="empLast" type="text" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input id="empEmail" type="email" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Role</label>
                            <input id="empRole" type="text" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                                placeholder="e.g., Software Engineer">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                            <select id="empDept" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="engineering">Engineering</option>
                                <option value="sales">Sales</option>
                                <option value="marketing">Marketing</option>
                                <option value="hr">HR</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Manager</label>
                            <input id="empManager" type="text"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="e.g., Priya S">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                            <select id="empStatus" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="active">Active</option>
                                <option value="on_leave">On Leave</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Join Date</label>
                        <input id="empJoined" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div class="flex items-center justify-between pt-2">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                            <input id="empInvite" type="checkbox" class="rounded border-slate-300" checked>
                            Send invite
                        </label>
                        <div class="flex items-center gap-2">
                            <button id="empCancel"
                                class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                            <button id="empSave" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                                <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden"></div>

<script>
    /* ---- Persistence ---- */
    const LS_KEY = 'team_employees_v1';
    const LS_STATE = 'team_view_v1';

    /* ---- Mock Data (seeded if none in localStorage) ---- */
    let EMPLOYEES = JSON.parse(localStorage.getItem(LS_KEY) || 'null') || [
        { id: 1, first: 'Aarav', last: 'Mehta', email: 'aarav@company.com', role: 'Software Engineer', dept: 'engineering', manager: 'Priya S', status: 'active', joined: '2024-06-10' },
        { id: 2, first: 'Sara', last: 'Lopez', email: 'sara@company.com', role: 'HR Generalist', dept: 'hr', manager: 'David K', status: 'active', joined: '2023-11-01' },
        { id: 3, first: 'Kai', last: 'Ng', email: 'kai@company.com', role: 'Sales Manager', dept: 'sales', manager: 'Meera J', status: 'on_leave', joined: '2022-09-15' },
        { id: 4, first: 'Riya', last: 'Patel', email: 'riya@company.com', role: 'Marketing Analyst', dept: 'marketing', manager: 'Alex R', status: 'active', joined: '2025-01-08' },
        { id: 5, first: 'Noah', last: 'Kim', email: 'noah@company.com', role: 'Finance Associate', dept: 'finance', manager: 'Sana M', status: 'inactive', joined: '2021-04-21' }
    ];
    persist();

    /* ---- Quick metric ---- */
    const OPEN_ROLES = 3;

    /* ---- State ---- */
    let activePage = 1;
    const perPage = 10;
    let selected = new Set();
    let filters = { q: '', dept: 'all', status: 'all', sort: 'name' };

    /* ---- Elements ---- */
    const rows = document.getElementById('rows');
    const resultCount = document.getElementById('resultCount');
    const pageNum = document.getElementById('pageNum');
    const pageTotal = document.getElementById('pageTotal');

    /* ---- Init ---- */
    document.addEventListener('DOMContentLoaded', () => {
        hydrateFromURL();
        hydrateFromLocal();

        // Controls
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        searchInput.addEventListener('input', debounce(() => {
            filters.q = searchInput.value.trim().toLowerCase();
            clearSearch.classList.toggle('hidden', !filters.q);
            activePage = 1; render(); persistView();
        }, 250));
        clearSearch.addEventListener('click', () => {
            searchInput.value = ''; filters.q = ''; clearSearch.classList.add('hidden');
            activePage = 1; render(); persistView();
        });

        document.getElementById('deptFilter').addEventListener('change', e => { filters.dept = e.target.value; activePage = 1; render(); persistView(); });
        document.getElementById('statusFilter').addEventListener('change', e => { filters.status = e.target.value; activePage = 1; render(); persistView(); });
        document.getElementById('sortSelect').addEventListener('change', e => { filters.sort = e.target.value; activePage = 1; render(); persistView(); });

        document.getElementById('prevPage').addEventListener('click', () => { if (activePage > 1) { activePage--; render(); } });
        document.getElementById('nextPage').addEventListener('click', () => { const total = totalPages(); if (activePage < total) { activePage++; render(); } });

        document.getElementById('selectAll').addEventListener('change', (e) => {
            const idsOnPage = currentPageItems().map(x => x.id);
            if (e.target.checked) { idsOnPage.forEach(id => selected.add(id)); } else { idsOnPage.forEach(id => selected.delete(id)); }
            render();
        });

        // Buttons
        document.getElementById('inviteBtn').addEventListener('click', inviteSelected);
        document.getElementById('bulkActionBtn').addEventListener('click', bulkActions);
        document.getElementById('addEmployeeBtn').addEventListener('click', () => openEmpModal());
        document.getElementById('closeEmpModal').addEventListener('click', closeEmpModal);
        document.getElementById('empCancel').addEventListener('click', closeEmpModal);
        document.getElementById('empSave').addEventListener('click', saveEmployee);
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        document.getElementById('copyLinkBtn').addEventListener('click', copyViewLink);

        // Outside-click close for modal
        window.addEventListener('click', (e) => { if (e.target === document.getElementById('empModal')) closeEmpModal(); });

        // Summary
        document.getElementById('hcOpen').textContent = OPEN_ROLES;
        render();
    });

    /* ---- Render ---- */
    function render() {
        persist();
        const data = applyFilters(EMPLOYEES);
        resultCount.textContent = data.length;
        document.getElementById('hcTotal').textContent = EMPLOYEES.length;
        document.getElementById('hcActive').textContent = EMPLOYEES.filter(e => e.status === 'active').length;
        renderDeptChips();

        const pages = Math.max(1, Math.ceil(data.length / perPage));
        activePage = Math.min(activePage, pages);
        pageNum.textContent = activePage;
        pageTotal.textContent = pages;
        document.getElementById('prevPage').disabled = activePage === 1;
        document.getElementById('nextPage').disabled = activePage === pages;

        const start = (activePage - 1) * perPage;
        const pageItems = data.slice(start, start + perPage);
        rows.innerHTML = pageItems.map(rowHTML).join('') ||
            `<tr><td colspan="8" class="py-6 text-center text-slate-500">No employees found</td></tr>`;

        // update select-all
        const idsOnPage = pageItems.map(x => x.id);
        document.getElementById('selectAll').checked = idsOnPage.length > 0 && idsOnPage.every(id => selected.has(id));
    }

    function rowHTML(e) {
        const checked = selected.has(e.id) ? 'checked' : '';
        return `
  <tr class="border-b last:border-0">
    <td class="py-2 px-4"><input type="checkbox" ${checked} onchange="toggleSelect(${e.id}, this.checked)"></td>
    <td class="py-2 px-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center text-slate-600">${avatar(e)}</div>
        <div>
          <div class="font-medium text-slate-800">${escapeHTML(e.first)} ${escapeHTML(e.last)}</div>
          <div class="text-xs text-slate-500">${escapeHTML(e.email)}</div>
        </div>
      </div>
    </td>
    <td class="py-2 px-4">${badge(e.role, 'blue')}</td>
    <td class="py-2 px-4">${capitalize(e.dept)}</td>
    <td class="py-2 px-4">${escapeHTML(e.manager || '—')}</td>
    <td class="py-2 px-4">${statusPill(e.status)}</td>
    <td class="py-2 px-4">${e.joined}</td>
    <td class="py-2 px-4 text-right">
      <div class="flex items-center gap-2">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="openEmpModal(${e.id})">
          <i class="fa-solid fa-pen mr-1"></i> Edit
        </button>
        <button class="px-2 py-1 rounded text-white ${e.status === 'inactive' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-700 hover:bg-slate-800'} text-xs" onclick="toggleActive(${e.id})">
          ${e.status === 'inactive' ? 'Activate' : 'Deactivate'}
        </button>
        <button class="px-2 py-1 rounded text-white bg-red-600 hover:bg-red-700 text-xs" onclick="deleteEmployee(${e.id})">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    </td>
  </tr>`;
    }

    /* ---- Actions ---- */
    function toggleSelect(id, on) { on ? selected.add(id) : selected.delete(id); }
    function bulkActions() {
        if (selected.size === 0) { toast('Select at least one employee'); return; }
        if (!confirm('Mark selected employees as Active?')) return;
        EMPLOYEES = EMPLOYEES.map(e => selected.has(e.id) ? { ...e, status: 'active' } : e);
        selected.clear(); render(); toast('Updated selected employees');
    }
    function inviteSelected() {
        if (selected.size === 0) { toast('Select at least one employee'); return; }
        toast('Invitations sent to selected employees');
    }
    function toggleActive(id) {
        EMPLOYEES = EMPLOYEES.map(e => e.id === id ? { ...e, status: e.status === 'inactive' ? 'active' : 'inactive' } : e);
        render();
    }
    function deleteEmployee(id) {
        const e = EMPLOYEES.find(x => x.id === id);
        if (!e) return;
        if (!confirm(`Delete ${e.first} ${e.last}? This cannot be undone.`)) return;
        EMPLOYEES = EMPLOYEES.filter(x => x.id !== id);
        selected.delete(id);
        // adjust pagination if last item on last page removed
        if ((activePage - 1) * perPage >= applyFilters(EMPLOYEES).length) activePage = Math.max(1, activePage - 1);
        render(); toast('Employee deleted');
    }

    /* ---- Filters/Sort ---- */
    function applyFilters(list) {
        let out = list.slice();
        if (filters.q) {
            const q = filters.q;
            out = out.filter(e =>
                `${e.first} ${e.last}`.toLowerCase().includes(q) ||
                e.role.toLowerCase().includes(q) ||
                e.email.toLowerCase().includes(q)
            );
        }
        if (filters.dept !== 'all') out = out.filter(e => e.dept === filters.dept);
        if (filters.status !== 'all') out = out.filter(e => e.status === filters.status);

        switch (filters.sort) {
            case 'role': out.sort((a, b) => a.role.localeCompare(b.role)); break;
            case 'dept': out.sort((a, b) => a.dept.localeCompare(b.dept)); break;
            case 'joined': out.sort((a, b) => new Date(a.joined) - new Date(b.joined)); break;
            default: out.sort((a, b) => `${a.first} ${a.last}`.localeCompare(`${b.first} ${b.last}`));
        }
        return out;
    }
    function currentPageItems() { return applyFilters(EMPLOYEES).slice((activePage - 1) * perPage, (activePage - 1) * perPage + perPage); }
    function totalPages() { return Math.max(1, Math.ceil(applyFilters(EMPLOYEES).length / perPage)); }

    /* ---- Modal: Add/Edit ---- */
    function openEmpModal(id) {
        const isEdit = !!id;
        const modal = document.getElementById('empModal');
        const title = document.getElementById('empModalTitle');
        title.textContent = isEdit ? 'Edit Employee' : 'Add Employee';
        modal.classList.remove('hidden');

        // reset
        const emp = isEdit ? EMPLOYEES.find(x => x.id === id) : {
            first: '', last: '', email: '', role: '', dept: 'engineering', manager: '', status: 'active', joined: today()
        };
        document.getElementById('empFirst').value = emp.first;
        document.getElementById('empLast').value = emp.last;
        document.getElementById('empEmail').value = emp.email;
        document.getElementById('empRole').value = emp.role;
        document.getElementById('empDept').value = emp.dept;
        document.getElementById('empManager').value = emp.manager;
        document.getElementById('empStatus').value = emp.status;
        document.getElementById('empJoined').value = emp.joined;
        document.getElementById('empInvite').checked = true;
        document.getElementById('empSave').dataset.editId = isEdit ? id : '';
    }
    function closeEmpModal() { document.getElementById('empModal').classList.add('hidden'); }
    function saveEmployee() {
        const id = document.getElementById('empSave').dataset.editId;
        const payload = {
            first: val('empFirst').trim(), last: val('empLast').trim(), email: val('empEmail').trim().toLowerCase(),
            role: val('empRole').trim(), dept: val('empDept'), manager: val('empManager').trim(),
            status: val('empStatus'), joined: val('empJoined') || today()
        };
        if (!payload.first || !payload.last || !payload.email) { toast('First, Last, and Email are required'); return; }
        if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(payload.email)) { toast('Invalid email'); return; }
        const emailTaken = EMPLOYEES.some(e => e.email.toLowerCase() === payload.email && String(e.id) !== String(id || ''));
        if (emailTaken) { toast('Email already exists'); return; }

        if (id) {
            EMPLOYEES = EMPLOYEES.map(e => e.id == id ? { ...e, ...payload } : e);
            toast('Employee updated');
        } else {
            EMPLOYEES.unshift({ id: Date.now(), ...payload });
            toast('Employee added' + (document.getElementById('empInvite').checked ? ' & invite sent' : ''));
        }
        closeEmpModal(); render();
    }

    /* ---- Summary & Chips ---- */
    function renderDeptChips() {
        const counts = EMPLOYEES.reduce((m, e) => (m[e.dept] = (m[e.dept] || 0) + 1, m), {});
        const chips = Object.entries(counts).sort().map(([d, c]) => `
    <button class="px-2 py-1 rounded-full ${filters.dept === d ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'} text-xs"
            onclick="setDept('${d}')">${capitalize(d)} • ${c}</button>`).join(' ');
        document.getElementById('deptChips').innerHTML = chips || '<span class="text-xs text-slate-500">No data</span>';
    }
    function setDept(d) { filters.dept = d; document.getElementById('deptFilter').value = d; activePage = 1; render(); persistView(); }

    /* ---- Export / Link ---- */
    function exportCSV() {
        const list = applyFilters(EMPLOYEES);
        const cols = ['First Name', 'Last Name', 'Email', 'Role', 'Department', 'Manager', 'Status', 'Joined'];
        const rows = list.map(e => [e.first, e.last, e.email, e.role, capitalize(e.dept), e.manager || '', labelStatus(e.status), e.joined]
            .map(csvCell).join(',')).join('\n');
        const blob = new Blob([cols.join(',') + '\n' + rows], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `team-${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 300);
        toast('Export generated');
    }
    function copyViewLink() {
        const url = new URL(window.location.href);
        url.searchParams.set('q', filters.q || '');
        url.searchParams.set('dept', filters.dept);
        url.searchParams.set('status', filters.status);
        url.searchParams.set('sort', filters.sort);
        navigator.clipboard.writeText(url.toString()).then(() => toast('View link copied')).catch(() => toast('Copy failed'));
    }

    /* ---- Helpers ---- */
    function persist() { localStorage.setItem(LS_KEY, JSON.stringify(EMPLOYEES)); }
    function persistView() { localStorage.setItem(LS_STATE, JSON.stringify(filters)); history.replaceState(null, '', buildURLFromFilters()); }
    function hydrateFromLocal() {
        const saved = JSON.parse(localStorage.getItem(LS_STATE) || 'null');
        if (!saved) return;
        filters = { ...filters, ...saved };
        document.getElementById('deptFilter').value = filters.dept;
        document.getElementById('statusFilter').value = filters.status;
        document.getElementById('sortSelect').value = filters.sort;
        if (filters.q) { document.getElementById('searchInput').value = filters.q; document.getElementById('clearSearch').classList.remove('hidden'); }
    }
    function hydrateFromURL() {
        const url = new URL(window.location.href);
        const q = url.searchParams.get('q'); const dept = url.searchParams.get('dept');
        const status = url.searchParams.get('status'); const sort = url.searchParams.get('sort');
        if (q) { filters.q = q; }
        if (dept) { filters.dept = dept; }
        if (status) { filters.status = status; }
        if (sort) { filters.sort = sort; }
    }
    function buildURLFromFilters() {
        const url = new URL(window.location.href);
        url.searchParams.set('q', filters.q || '');
        url.searchParams.set('dept', filters.dept);
        url.searchParams.set('status', filters.status);
        url.searchParams.set('sort', filters.sort);
        return url.toString();
    }

    function badge(text, tone) {
        const cls = tone === 'blue' ? 'bg-blue-50 text-blue-700' : 'bg-slate-100 text-slate-700';
        return `<span class="px-2 py-0.5 rounded-full ${cls}">${escapeHTML(text || '—')}</span>`;
    }
    function statusPill(s) {
        const map = { active: 'bg-emerald-50 text-emerald-700', on_leave: 'bg-amber-50 text-amber-700', inactive: 'bg-slate-100 text-slate-700' };
        return `<span class="px-2 py-0.5 rounded-full ${map[s] || map.inactive} text-xs">${labelStatus(s)}</span>`;
    }
    function labelStatus(s) { return ({ active: 'Active', on_leave: 'On Leave', inactive: 'Inactive' })[s] || s; }
    function avatar(e) { return (e.first?.[0] || '?').toUpperCase(); }
    function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function val(id) { return document.getElementById(id).value; }
    function today() { const d = new Date(); const m = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${d.getFullYear()}-${m}-${day}`; }
    function escapeHTML(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])); }
    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
    function csvCell(v) { return `"${String(v ?? '').replace(/"/g, '""')}"`; }
    function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('hidden'); t.style.opacity = 1; setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.classList.add('hidden'), 300); }, 1800); }

    window.toggleSelect = toggleSelect; // expose for inline onchange
    window.openEmpModal = openEmpModal;
    window.deleteEmployee = deleteEmployee;
    window.toggleActive = toggleActive;
</script>

<style>
    /* tighter mobile spacing */
    @media (max-width: 640px) {

        table th,
        table td {
            padding-left: .75rem;
            padding-right: .75rem;
        }
    }
</style>
{% endblock %}