{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-users-gear mr-2"></i> Team Overview
            </h1>
            <p class="text-slate-600 text-sm">Get a snapshot of team composition, capacity, and status.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export
            </button>
            <button id="copyLinkBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-link mr-1"></i> Copy View
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Controls -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
        <div class="flex items-center gap-2">
            <select id="periodSelect" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="this_q">This Quarter</option>
                <option value="next_q">Next Quarter</option>
                <option value="this_m">This Month</option>
            </select>
            <select id="deptSelect" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="all">All Depts</option>
                <option value="engineering">Engineering</option>
                <option value="sales">Sales</option>
                <option value="marketing">Marketing</option>
                <option value="hr">HR</option>
                <option value="finance">Finance</option>
                <option value="operations">Operations</option>
            </select>
            <label class="inline-flex items-center gap-2 text-sm text-slate-700 ml-1">
                <input id="includePTO" type="checkbox" class="rounded border-slate-300" checked>
                Include PTO in planned hours
            </label>
        </div>
        <div class="relative w-full md:w-96">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input id="searchInput" type="text" placeholder="Find squad, manager, or keyword"
                class="w-full pl-10 pr-10 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-slate-200">
            <button id="clearSearch"
                class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

    <!-- KPI tiles -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Headcount</div>
            <div class="mt-1 flex items-end justify-between">
                <div class="text-2xl font-semibold text-slate-800" id="kpiHeadcount">0</div>
                <span id="kpiHCTrend" class="text-xs px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">+0%</span>
            </div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Utilization (avg)</div>
            <div class="mt-1 flex items-end justify-between">
                <div class="text-2xl font-semibold text-slate-800" id="kpiUtil">0%</div>
                <span class="text-xs text-slate-500">Target: 75–85%</span>
            </div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Capacity Buffer</div>
            <div class="mt-1 flex items-end justify-between">
                <div class="text-2xl font-semibold text-slate-800" id="kpiBuffer">0%</div>
                <span id="kpiBufferBadge"
                    class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">Balanced</span>
            </div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Open Roles</div>
            <div class="mt-1 flex items-end justify-between">
                <div class="text-2xl font-semibold text-slate-800" id="kpiOpen">0</div>
                <span class="text-xs text-slate-500">Time-to-fill: <span id="kpiTTF">—</span></span>
            </div>
        </div>
    </div>

    <!-- Charts row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Composition -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-circle-nodes mr-2"></i>
                    Composition by Department</h3>
                <span class="text-sm text-slate-600" id="compTotal">0 total</span>
            </div>
            <canvas id="compChart" height="210"></canvas>
            <div id="compLegend" class="mt-4 flex flex-wrap gap-2 text-xs"></div>
        </div>

        <!-- Seniority -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-stairs mr-2"></i> Seniority Mix
                </h3>
                <span class="text-sm text-slate-600">Entry • Mid • Senior • Lead</span>
            </div>
            <canvas id="seniorityChart" height="210"></canvas>
        </div>

        <!-- Utilization -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-gauge-high mr-2"></i> Capacity &
                    Utilization</h3>
                <span class="text-sm text-slate-600" id="utilLabel">—</span>
            </div>
            <canvas id="utilChart" height="210"></canvas>
            <div class="mt-3 text-xs text-slate-600">Shows planned vs. available hours for the selected period.</div>
        </div>
    </div>

    <!-- Squads table -->
    <div class="rounded-2xl border border-slate-200 bg-white mt-6">
        <div class="flex items-center justify-between p-4 border-b border-slate-200">
            <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-people-group mr-2"></i> Squads</h3>
            <div class="flex items-center gap-3 text-sm">
                <span class="text-slate-600">Color key:</span>
                <span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">Under</span>
                <span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700">Balanced</span>
                <span class="px-2 py-0.5 rounded-full bg-red-50 text-red-700">Over</span>
                <div class="hidden md:flex items-center gap-2 ml-4">
                    <label class="text-slate-600">Sort:</label>
                    <select id="sortSelect" class="rounded-lg border border-slate-300 px-2 py-1 text-sm">
                        <option value="name.asc">Name ↑</option>
                        <option value="name.desc">Name ↓</option>
                        <option value="util.desc" selected>Utilization ↓</option>
                        <option value="util.asc">Utilization ↑</option>
                        <option value="capacity.desc">Capacity ↓</option>
                        <option value="capacity.asc">Capacity ↑</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-500 border-b">
                    <tr>
                        <th class="py-2 px-4">Squad</th>
                        <th class="py-2 px-4">Manager</th>
                        <th class="py-2 px-4">Dept</th>
                        <th class="py-2 px-4">Headcount</th>
                        <th class="py-2 px-4">Capacity (hrs)</th>
                        <th class="py-2 px-4">Planned (hrs)</th>
                        <th class="py-2 px-4">Utilization</th>
                        <th class="py-2 px-4 w-28"></th>
                    </tr>
                </thead>
                <tbody id="squadRows" class="text-slate-800"><!-- injected --></tbody>
            </table>
        </div>
    </div>

    <!-- PTO / Status -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-plane-departure mr-2"></i>
                Upcoming PTO</h3>
            <div id="ptoList" class="space-y-3"></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-user-check mr-2"></i> Status
                Breakdown</h3>
            <div id="statusBreakdown" class="space-y-2 text-sm"></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-bullhorn mr-2"></i> Notes</h3>
            <ul id="notesFeed" class="list-disc list-inside text-sm text-slate-700 space-y-2"></ul>
        </div>
    </div>
</div>

<!-- Squad details modal -->
<div id="squadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
                <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-circle-info mr-2"></i> Squad
                        Details</h3>
                    <button id="closeSquadModal" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="squadModalBody" class="p-4"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toasts -->
<div id="toast" class="fixed top-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden"></div>

<!-- Charts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ----- Mock data ----- */
    const PEOPLE = [
        { id: 1, name: 'Aarav Mehta', dept: 'engineering', level: 'mid', status: 'active' },
        { id: 2, name: 'Sara Lopez', dept: 'hr', level: 'senior', status: 'active' },
        { id: 3, name: 'Kai Ng', dept: 'sales', level: 'lead', status: 'on_leave' },
        { id: 4, name: 'Riya Patel', dept: 'marketing', level: 'entry', status: 'active' },
        { id: 5, name: 'Noah Kim', dept: 'finance', level: 'mid', status: 'inactive' },
        { id: 6, name: 'Isha Verma', dept: 'engineering', level: 'senior', status: 'active' },
        { id: 7, name: 'Jon Park', dept: 'operations', level: 'mid', status: 'active' },
        { id: 8, name: 'Maya Singh', dept: 'engineering', level: 'entry', status: 'active' },
        { id: 9, name: 'Omar Ali', dept: 'sales', level: 'mid', status: 'active' },
        { id: 10, name: 'Ana Souza', dept: 'marketing', level: 'senior', status: 'active' },
    ];
    const SQUADS = [
        { id: 201, name: 'Platform Core', manager: 'Priya S', dept: 'engineering', hc: 5, capacity: 800, planned: 660 },
        { id: 202, name: 'Growth GTM', manager: 'Alex R', dept: 'marketing', hc: 3, capacity: 480, planned: 420 },
        { id: 203, name: 'RevOps', manager: 'Meera J', dept: 'sales', hc: 3, capacity: 480, planned: 520 },
        { id: 204, name: 'People Ops', manager: 'David K', dept: 'hr', hc: 2, capacity: 320, planned: 210 },
        { id: 205, name: 'FinOps', manager: 'Sana M', dept: 'finance', hc: 2, capacity: 320, planned: 300 },
    ];
    const PTO = [
        { who: 'Kai Ng', from: '2025-09-18', to: '2025-09-22', hours: 24 },
        { who: 'Maya Singh', from: '2025-09-25', to: '2025-09-27', hours: 16 },
        { who: 'Noah Kim', from: '2025-10-02', to: '2025-10-05', hours: 24 },
    ];
    const OPEN_ROLES = 4;
    const TTF_DAYS = 26;
    const NOTES = [
        'Hiring freeze lifted for Engineering (2 roles unlocked).',
        'Quarterly rotations starting Oct 1: check manager assignments.',
        'PTO spike during last week of September—re-balance sprint capacity.',
    ];

    /* ----- State/Elements ----- */
    let filters = { period: 'this_q', dept: 'all', q: '' };
    let sortPref = 'util.desc';
    const $ = (id) => document.getElementById(id);

    /* ----- Init ----- */
    document.addEventListener('DOMContentLoaded', () => {
        // Controls
        $('periodSelect').addEventListener('change', e => { filters.period = e.target.value; renderAll(); persistView(); });
        $('deptSelect').addEventListener('change', e => { filters.dept = e.target.value; renderAll(); persistView(); });
        $('includePTO').addEventListener('change', () => { renderKPIs(); drawUtil(); renderSquads(); });
        $('sortSelect').addEventListener('change', e => { sortPref = e.target.value; renderSquads(); });

        // Search
        const search = $('searchInput'), clearBtn = $('clearSearch');
        search.addEventListener('input', debounce(() => {
            filters.q = search.value.trim().toLowerCase();
            clearBtn.classList.toggle('hidden', !filters.q);
            renderSquads();
            persistView();
        }, 250));
        clearBtn.addEventListener('click', () => {
            search.value = ''; filters.q = ''; clearBtn.classList.add('hidden'); renderSquads(); persistView();
        });

        // Export & copy link
        $('exportBtn').addEventListener('click', exportCSV);
        $('copyLinkBtn').addEventListener('click', copyViewLink);

        // Modal close
        $('closeSquadModal').addEventListener('click', closeSquadModal);
        window.addEventListener('click', (e) => { const m = $('squadModal'); if (e.target === m) closeSquadModal(); });

        // Render
        hydrateFromURL();
        renderKPIs();
        renderCharts();
        renderSquads();
        renderSidePanels();

        if (typeof Chart === 'undefined') {
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
            s.onload = () => { drawComp(); drawSeniority(); drawUtil(); };
            document.head.appendChild(s);
        } else { drawComp(); drawSeniority(); drawUtil(); }
    });

    function renderAll() { renderKPIs(); drawComp(); drawSeniority(); drawUtil(); renderSquads(); renderSidePanels(); }

    /* ----- KPIs ----- */
    function renderKPIs() {
        const pool = applyDept(PEOPLE);
        const hc = pool.length;
        const utilAvg = avgUtil();
        const buffer = Math.max(0, 100 - utilAvg);
        $('kpiHeadcount').textContent = hc;
        $('kpiHCTrend').textContent = '+0%';
        $('kpiUtil').textContent = utilAvg.toFixed(0) + '%';
        $('kpiBuffer').textContent = buffer.toFixed(0) + '%';
        const tight = utilAvg > 90, under = utilAvg < 70;
        $('kpiBufferBadge').textContent = tight ? 'Tight' : under ? 'Under' : 'Balanced';
        $('kpiBufferBadge').className = 'text-xs px-2 py-0.5 rounded-full ' + (tight ? 'bg-red-50 text-red-700' : under ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700');
        $('kpiOpen').textContent = OPEN_ROLES;
        $('kpiTTF').textContent = TTF_DAYS + 'd';
    }

    /* ----- Charts ----- */
    let compChart, seniorityChart, utilChart;
    function renderCharts() {
        $('compTotal').textContent = applyDept(PEOPLE).length + ' total';
        $('utilLabel').textContent = labelPeriod(filters.period);
    }
    function drawComp() {
        const ctx = $('compChart').getContext('2d');
        const data = countBy(applyDept(PEOPLE), 'dept');
        const labels = Object.keys(data).map(capitalize);
        const values = Object.values(data);
        compChart && compChart.destroy();
        compChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels, datasets: [{
                    data: values, borderWidth: 2, borderColor: '#fff',
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
        $('compLegend').innerHTML = labels.map((l, i) => `<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700">${l} • ${values[i]}</span>`).join(' ');
    }
    function drawSeniority() {
        const ctx = $('seniorityChart').getContext('2d');
        const levels = ['entry', 'mid', 'senior', 'lead'];
        const byDept = groupBy(applyDept(PEOPLE), 'dept');
        const depts = Object.keys(byDept).map(capitalize);
        const colors = ['#c7d2fe', '#93c5fd', '#86efac', '#fbcfe8'];
        const datasets = levels.map((lvl, i) => ({
            label: capitalize(lvl),
            data: Object.values(byDept).map(list => list.filter(p => p.level === lvl).length),
            backgroundColor: colors[i]
        }));
        seniorityChart && seniorityChart.destroy();
        seniorityChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: depts, datasets },
            options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
        });
    }
    function drawUtil() {
        const ctx = $('utilChart').getContext('2d');
        const items = applyDeptSquads(SQUADS).slice().sort((a, b) => a.name.localeCompare(b.name));
        const labels = items.map(s => s.name);
        const ptoAdj = $('includePTO').checked ? PTOHoursByDept(filters.dept) : 0;
        const planned = items.map(s => s.planned + Math.round(ptoAdj * (s.capacity / totalCapacity(items))));
        const capacity = items.map(s => s.capacity);
        utilChart && utilChart.destroy();
        utilChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels, datasets: [
                    { label: 'Planned', data: planned, backgroundColor: '#f59e0b' },
                    { label: 'Capacity', data: capacity, backgroundColor: '#10b981' }
                ]
            },
            options: { plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
        });
    }

    /* ----- Squads table ----- */
    function renderSquads() {
        const q = (filters.q || '').toLowerCase();
        let list = applyDeptSquads(SQUADS)
            .filter(s => !q || s.name.toLowerCase().includes(q) || s.manager.toLowerCase().includes(q))
            .map(s => {
                const pct = Math.round((s.planned / Math.max(1, s.capacity)) * 100);
                return { ...s, util: pct };
            });

        // sort
        const [key, dir] = sortPref.split('.');
        list.sort((a, b) => {
            const av = key === 'util' ? a.util : key === 'capacity' ? a.capacity : a.name.toLowerCase();
            const bv = key === 'util' ? b.util : key === 'capacity' ? b.capacity : b.name.toLowerCase();
            if (av < bv) return dir === 'asc' ? -1 : 1;
            if (av > bv) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        const rows = list.map(s => {
            const pill = s.util > 90 ? 'bg-red-50 text-red-700' : s.util < 70 ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700';
            return `
      <tr class="border-b last:border-0">
        <td class="py-2 px-4 font-medium">${s.name}</td>
        <td class="py-2 px-4">${s.manager}</td>
        <td class="py-2 px-4">${capitalize(s.dept)}</td>
        <td class="py-2 px-4">${s.hc}</td>
        <td class="py-2 px-4">${s.capacity}</td>
        <td class="py-2 px-4">${s.planned}</td>
        <td class="py-2 px-4">
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 rounded-full text-xs ${pill}">${s.util}%</span>
            <span class="h-2 w-24 bg-slate-200 rounded overflow-hidden">
              <span class="h-2 block ${s.util > 90 ? 'bg-red-500' : s.util < 70 ? 'bg-emerald-500' : 'bg-amber-500'}" style="width:${Math.min(100, s.util)}%"></span>
            </span>
          </div>
        </td>
        <td class="py-2 px-4 text-right">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="openSquadModal(${s.id})">
            <i class="fa-solid fa-circle-info mr-1"></i> Details
          </button>
        </td>
      </tr>`;
        }).join('');

        $('squadRows').innerHTML = rows || `<tr><td colspan="8" class="py-6 text-center text-slate-500">No squads match your filters</td></tr>`;
    }

    /* ----- Side panels ----- */
    function renderSidePanels() {
        // PTO
        $('ptoList').innerHTML = PTO.map(p => `
    <div class="flex items-center justify-between p-3 rounded-lg ${daysFromNow(p.from) <= 7 ? 'bg-amber-50' : 'bg-slate-50'}">
      <div>
        <div class="font-medium text-slate-800">${p.who}</div>
        <div class="text-xs text-slate-600">${p.from} → ${p.to} • starts in ${daysFromNow(p.from)}d</div>
      </div>
      <span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 text-xs">PTO</span>
    </div>`).join('');

        // Status Breakdown
        const pool = applyDept(PEOPLE);
        const byStatus = countBy(pool, 'status');
        $('statusBreakdown').innerHTML = Object.entries(byStatus)
            .map(([k, v]) => `<div class="flex items-center justify-between">
      <span class="text-slate-600">${labelStatus(k)}</span>
      <span class="font-medium text-slate-800">${v}</span>
    </div>`).join('') || '<div class="text-slate-500">No data</div>';

        // Notes
        $('notesFeed').innerHTML = NOTES.map(n => `<li>${n}</li>`).join('');
    }

    /* ----- Modal ----- */
    function openSquadModal(id) {
        const s = SQUADS.find(x => x.id === id); if (!s) return;
        const members = sampleMembersForDept(s.dept, s.hc);
        const body = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="rounded-lg bg-slate-50 p-3">
        <div class="text-sm text-slate-600">Squad</div>
        <div class="font-semibold text-slate-800">${s.name}</div>
      </div>
      <div class="rounded-lg bg-slate-50 p-3">
        <div class="text-sm text-slate-600">Manager</div>
        <div class="font-semibold text-slate-800">${s.manager}</div>
      </div>
      <div class="rounded-lg bg-slate-50 p-3">
        <div class="text-sm text-slate-600">Capacity</div>
        <div class="font-semibold text-slate-800">${s.capacity} hrs</div>
      </div>
      <div class="rounded-lg bg-slate-50 p-3">
        <div class="text-sm text-slate-600">Planned</div>
        <div class="font-semibold text-slate-800">${s.planned} hrs</div>
      </div>
    </div>
    <div class="mt-4">
      <div class="mb-2 font-medium text-slate-800">Members (${members.length})</div>
      <ul class="space-y-2">
        ${members.map(m => `<li class="flex items-center justify-between rounded border border-slate-200 p-2">
          <span>${m.name} • <span class="text-slate-500 text-xs">${capitalize(m.level)}</span></span>
          <span class="text-xs ${statusTone(m.status)} px-2 py-0.5 rounded-full">${labelStatus(m.status)}</span>
        </li>`).join('')}
      </ul>
    </div>`;
        $('squadModalBody').innerHTML = body;
        $('squadModal').classList.remove('hidden');
    }
    function closeSquadModal() { $('squadModal').classList.add('hidden'); }

    /* ----- Export / Link ----- */
    function exportCSV() {
        // Export visible squad rows + KPI summary at top
        const list = Array.from(document.querySelectorAll('#squadRows tr')).length ? applyFiltersToSquads() : [];
        const kpi = [
            ['Headcount', $('kpiHeadcount').textContent],
            ['Utilization Avg', $('kpiUtil').textContent],
            ['Capacity Buffer', $('kpiBuffer').textContent],
            ['Open Roles', $('kpiOpen').textContent]
        ];
        const header = 'Metric,Value\n' + kpi.map(r => r.map(csvCell).join(',')).join('\n') + '\n\n';
        const cols = ['Squad', 'Manager', 'Dept', 'Headcount', 'Capacity', 'Planned', 'Utilization'];
        const rows = list.map(s => [s.name, s.manager, capitalize(s.dept), s.hc, s.capacity, s.planned, s.util + '%'].map(csvCell).join(',')).join('\n');
        const blob = new Blob([header + cols.join(',') + '\n' + rows], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `team-overview-${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 300);
        toast('Export generated');
    }
    function copyViewLink() {
        const url = new URL(window.location.href);
        url.searchParams.set('dept', filters.dept);
        url.searchParams.set('period', filters.period);
        url.searchParams.set('q', filters.q || '');
        url.searchParams.set('sort', sortPref);
        navigator.clipboard.writeText(url.toString()).then(() => toast('View link copied')).catch(() => toast('Copy failed'));
    }

    /* ----- Helpers ----- */
    function applyDept(list) { return filters.dept === 'all' ? list.slice() : list.filter(x => x.dept === filters.dept); }
    function applyDeptSquads(list) { return filters.dept === 'all' ? list.slice() : list.filter(x => x.dept === filters.dept); }
    function countBy(list, key) { return list.reduce((m, x) => (m[x[key]] = (m[x[key]] || 0) + 1, m), {}); }
    function groupBy(list, key) { return list.reduce((m, x) => ((m[x[key]] = m[x[key]] || []).push(x), m), {}); }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function labelPeriod(p) { return ({ this_q: 'This Quarter', next_q: 'Next Quarter', this_m: 'This Month' })[p] || 'This Quarter'; }
    function labelStatus(s) { return ({ active: 'Active', on_leave: 'On Leave', inactive: 'Inactive' })[s] || s; }
    function statusTone(s) { return ({ active: 'bg-emerald-50 text-emerald-700', on_leave: 'bg-amber-50 text-amber-700', inactive: 'bg-slate-100 text-slate-700' })[s] || 'bg-slate-100 text-slate-700'; }
    function daysFromNow(dateStr) { const d = new Date(dateStr), now = new Date(); return Math.max(0, Math.ceil((d - now) / 86400000)); }
    function avgUtil() {
        const items = applyDeptSquads(SQUADS);
        if (!items.length) return 0;
        const arr = items.map(s => (s.planned / Math.max(1, s.capacity)) * 100);
        return arr.reduce((a, b) => a + b, 0) / arr.length;
    }
    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
    function PTOHoursByDept(dept) {
        const total = PTO.reduce((a, p) => a + (p.hours || 8), 0);
        if (dept === 'all') return total;
        // crude split: assume dept gets proportional PTO by headcount share
        const hcAll = PEOPLE.length;
        const hcDept = PEOPLE.filter(p => p.dept === dept).length || 1;
        return Math.round(total * (hcDept / hcAll));
    }
    function totalCapacity(items) { return items.reduce((a, s) => a + s.capacity, 0) || 1; }
    function sampleMembersForDept(dept, n) {
        const pool = PEOPLE.filter(p => dept === 'all' ? true : p.dept === dept);
        const out = [];
        for (let i = 0; i < Math.min(n, pool.length); i++) out.push(pool[i]);
        return out;
    }
    function csvCell(v) { return `"${String(v).replace(/"/g, '""')}"`; }
    function toast(msg) {
        const t = $('toast'); t.textContent = msg; t.classList.remove('hidden'); t.style.opacity = 1;
        setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.classList.add('hidden'), 300); }, 1800);
    }
    function applyFiltersToSquads() {
        const q = (filters.q || '').toLowerCase();
        let list = applyDeptSquads(SQUADS)
            .filter(s => !q || s.name.toLowerCase().includes(q) || s.manager.toLowerCase().includes(q))
            .map(s => ({ ...s, util: Math.round((s.planned / Math.max(1, s.capacity)) * 100) }));
        return list;
    }

    /* ----- Persist / hydrate view via URL ----- */
    function persistView() {
        const url = new URL(window.location.href);
        url.searchParams.set('dept', filters.dept);
        url.searchParams.set('period', filters.period);
        url.searchParams.set('q', filters.q || '');
        url.searchParams.set('sort', sortPref);
        history.replaceState(null, '', url.toString());
    }
    function hydrateFromURL() {
        const url = new URL(window.location.href);
        const dept = url.searchParams.get('dept');
        const period = url.searchParams.get('period');
        const q = url.searchParams.get('q');
        const sort = url.searchParams.get('sort');
        if (dept) { filters.dept = dept; $('deptSelect').value = dept; }
        if (period) { filters.period = period; $('periodSelect').value = period; }
        if (q) { filters.q = q; $('searchInput').value = q; $('clearSearch').classList.toggle('hidden', !q); }
        if (sort) { sortPref = sort; $('sortSelect').value = sort; }
    }
</script>
{% endblock %}