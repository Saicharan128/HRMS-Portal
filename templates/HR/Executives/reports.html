{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500 flex items-center justify-between">
                <span><i class="fa-solid fa-filter mr-2"></i> Saved View</span>
                <button id="saveViewBtn"
                    class="text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">Save</button>
            </div>
            <select id="savedViews" class="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                <option value="">(none)</option>
            </select>
        </div>
    </div>

    <!-- Report Categories (Quick generate) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- HR -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-blue-100 rounded-lg mr-3"><i class="fa-solid fa-users text-blue-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">HR Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('employee_roster')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-user-group mr-2 text-slate-500"></i> Employee Roster
                </button>
                <button onclick="generateQuickReport('headcount_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-chart-line mr-2 text-slate-500"></i> Headcount Analysis
                </button>
                <button onclick="generateQuickReport('turnover_report')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-door-open mr-2 text-slate-500"></i> Turnover Report
                </button>
                <button onclick="generateQuickReport('diversity_metrics')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> Diversity Metrics
                </button>
                <button onclick="generateQuickReport('recruitment_pipeline')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-funnel-dollar mr-2 text-slate-500"></i> Recruitment Pipeline
                </button>
            </div>
        </div>
        <!-- Performance -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-green-100 rounded-lg mr-3"><i class="fa-solid fa-chart-line text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Performance Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('performance_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-star mr-2 text-slate-500"></i> Performance Summary
                </button>
                <button onclick="generateQuickReport('goal_achievement')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-target mr-2 text-slate-500"></i> Goal Achievement
                </button>
                <button onclick="generateQuickReport('review_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-clipboard-check mr-2 text-slate-500"></i> Review Completion
                </button>
                <button onclick="generateQuickReport('top_performers')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-trophy mr-2 text-slate-500"></i> Top Performers
                </button>
                <button onclick="generateQuickReport('training_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-graduation-cap mr-2 text-slate-500"></i> Training Completion
                </button>
            </div>
        </div>
        <!-- Financial -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-yellow-100 rounded-lg mr-3"><i class="fa-solid fa-dollar-sign text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Financial Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('payroll_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-money-bill mr-2 text-slate-500"></i> Payroll Summary
                </button>
                <button onclick="generateQuickReport('cost_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-calculator mr-2 text-slate-500"></i> Cost Analysis
                </button>
                <button onclick="generateQuickReport('expense_reports')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-receipt mr-2 text-slate-500"></i> Expense Reports
                </button>
                <button onclick="generateQuickReport('budget_variance')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-chart-pie mr-2 text-slate-500"></i> Budget Variance
                </button>
                <button onclick="generateQuickReport('contractor_payments')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-handshake mr-2 text-slate-500"></i> Contractor Payments
                </button>
            </div>
        </div>
    </div>

    <!-- Time & Attendance + Compliance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-purple-100 rounded-lg mr-3"><i class="fa-solid fa-clock text-purple-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Time & Attendance</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('attendance_summary')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-calendar-days mr-2 text-slate-500"></i> Attendance Summary
                </button>
                <button onclick="generateQuickReport('leave_analysis')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-plane-departure mr-2 text-slate-500"></i> Leave Analysis
                </button>
                <button onclick="generateQuickReport('overtime_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-clock mr-2 text-slate-500"></i> Overtime Report
                </button>
                <button onclick="generateQuickReport('tardiness_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-exclamation-triangle mr-2 text-slate-500"></i> Tardiness Report
                </button>
            </div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-red-100 rounded-lg mr-3"><i class="fa-solid fa-shield-halved text-red-600"></i></div>
                <h3 class="text-lg font-semibold text-slate-800">Compliance & Legal</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('eeo_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> EEO Report
                </button>
                <button onclick="generateQuickReport('safety_incidents')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-hard-hat mr-2 text-slate-500"></i> Safety Incidents
                </button>
                <button onclick="generateQuickReport('policy_compliance')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-file-contract mr-2 text-slate-500"></i> Policy Compliance
                </button>
                <button onclick="generateQuickReport('audit_trail')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-search mr-2 text-slate-500"></i> Audit Trail
                </button>
            </div>
        </div>
    </div>

    <!-- Reports Dashboard -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-list mr-2"></i> Generated Reports
                </h2>
                <div class="flex items-center gap-2">
                    <div class="hidden md:flex items-center gap-2">
                        <label class="text-sm text-slate-600">Search:</label>
                        <input id="searchBox" placeholder="name, owner, type…"
                            class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Type:</label>
                        <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="">All</option>
                            <option value="hr">HR</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="attendance">Attendance</option>
                            <option value="compliance">Compliance</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Period:</label>
                        <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="7">Last 7d</option>
                            <option value="30">Last 30d</option>
                            <option value="90">Last 90d</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <!-- Empty -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Generated Yet</h3>
            <p class="text-slate-600 mb-4">Start by generating your first report above.</p>
        </div>

        <!-- Table -->
        <div id="reportsTable" class="hidden">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <input id="selectAll" type="checkbox" class="rounded border-slate-300">
                    <span class="text-sm text-slate-600">Select all</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="bulkDownload"
                        class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-50" disabled>
                        <i class="fa-solid fa-download mr-1"></i> Download
                    </button>
                    <button id="bulkDelete"
                        class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-50" disabled>
                        <i class="fa-solid fa-trash mr-1"></i> Delete
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 w-8"></th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700 cursor-pointer" data-sort="name">
                                Report Name <i class="fa-solid fa-sort text-slate-400"></i>
                            </th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700 cursor-pointer" data-sort="type">
                                Type <i class="fa-solid fa-sort text-slate-400"></i>
                            </th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700 cursor-pointer"
                                data-sort="generated_date">
                                Generated <i class="fa-solid fa-sort text-slate-400"></i>
                            </th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700 cursor-pointer"
                                data-sort="generated_by">
                                Generated By <i class="fa-solid fa-sort text-slate-400"></i>
                            </th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700">Size</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700">Status</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="p-6 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">
                    Showing <span id="pageInfo">0-0 of 0</span> reports
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Previous</button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Trends -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-3"><i class="fa-solid fa-chart-column mr-2"></i> Reports
                by Type</h3>
            <canvas id="typeChart" height="140"></canvas>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-3"><i class="fa-solid fa-chart-area mr-2"></i> Last 30d
                Volume</h3>
            <canvas id="volumeChart" height="140"></canvas>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-3"><i class="fa-solid fa-bolt mr-2"></i> Quick Actions
            </h3>
            <div class="grid grid-cols-2 gap-2">
                <button id="markProcessingBtn"
                    class="px-3 py-2 rounded border border-slate-300 hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-hourglass-half mr-1"></i> Simulate Processing
                </button>
                <button id="markCompleteBtn"
                    class="px-3 py-2 rounded border border-slate-300 hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-check mr-1"></i> Simulate Complete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div id="generateReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800">
                            <i class="fa-solid fa-chart-simple mr-2"></i> Generate Custom Report
                        </h3>
                        <button id="closeGenerateModal" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <form id="generateReportForm" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Type *</label>
                            <select name="report_type" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Report Type</option>
                                <option value="hr">HR Report</option>
                                <option value="performance">Performance Report</option>
                                <option value="financial">Financial Report</option>
                                <option value="attendance">Time & Attendance</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Template *</label>
                            <select name="template_id" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Template</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Date Range *</label>
                            <select name="date_range" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Range</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_quarter">Current Quarter</option>
                                <option value="last_year">Last Year</option>
                                <option value="current_year">Current Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Format *</label>
                            <select name="format" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="pdf">PDF Document</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="csv">CSV File</option>
                                <option value="html">HTML Report</option>
                            </select>
                        </div>
                    </div>

                    <div id="customDateRange" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                            <input type="date" name="start_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                            <input type="date" name="end_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Departments</label>
                            <select name="departments[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Departments</option>
                                <option value="engineering">Engineering</option>
                                <option value="sales">Sales</option>
                                <option value="marketing">Marketing</option>
                                <option value="hr">Human Resources</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Employee Types</label>
                            <select name="employee_types[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Types</option>
                                <option value="full_time">Full Time</option>
                                <option value="part_time">Part Time</option>
                                <option value="contractor">Contractor</option>
                                <option value="intern">Intern</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Report Name</label>
                        <input type="text" name="report_name" placeholder="Enter custom name (optional)"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>

                    <div class="flex items-start gap-3">
                        <input type="checkbox" name="schedule_report" id="scheduleReport"
                            class="mt-1 rounded border-slate-300">
                        <div>
                            <label for="scheduleReport" class="block text-sm font-medium text-slate-700">Schedule
                                recurring report</label>
                            <p class="text-xs text-slate-500">Generate this report automatically at regular intervals
                            </p>
                        </div>
                    </div>

                    <div id="scheduleOptions" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Frequency</label>
                            <select name="frequency" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Recipients</label>
                            <input type="email" name="recipients" placeholder="email1@company.com, email2@company.com"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <button type="button" id="cancelGenerate"
                            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
                            <i class="fa-solid fa-cog mr-1"></i> Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div id="reportPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-eye mr-2"></i> Report
                            Preview</h3>
                        <div class="flex items-center gap-2">
                            <button id="downloadReportBtn"
                                class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                                <i class="fa-solid fa-download mr-1"></i> Download
                            </button>
                            <button id="closePreviewModal" class="text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="reportPreviewContent" class="p-6"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toasts -->
<div id="successToast"
    class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-check-circle mr-2"></i><span id="successMessage"></span></div>
</div>
<div id="errorToast"
    class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-exclamation-circle mr-2"></i><span id="errorMessage"></span>
    </div>
</div>
<div id="infoToast"
    class="fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-info-circle mr-2"></i><span id="infoMessage"></span></div>
</div>

<!-- Charts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ---------- State ---------- */
    let reports = [];
    let filteredReports = [];
    let currentPage = 1;
    let totalPages = 1;
    let reportIdCounter = 6;
    let sortState = { key: 'generated_date', dir: 'desc' };
    const LS_KEY = 'reports_saved_views_v1';

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        initializeReports();
    });

    async function initializeReports() {
        await loadReportsData();
        setupEventListeners();
        renderReports();
        renderCharts();
        hydrateSavedViews();
    }

    /* ---------- Mock Load ---------- */
    async function loadReportsData() {
        document.getElementById('loadingState').classList.remove('hidden');
        await new Promise(r => setTimeout(r, 600));
        reports = [
            { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", format: "pdf", status: "completed", download_count: 15 },
            { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", format: "excel", status: "completed", download_count: 8 },
            { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", format: "pdf", status: "completed", download_count: 22 },
            { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", format: "csv", status: "processing", download_count: 0 },
            { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "987 KB", format: "pdf", status: "completed", download_count: 5 }
        ];
        filteredReports = [...reports];
        updateSummaryStats();
        document.getElementById('loadingState').classList.add('hidden');
    }

    /* ---------- Summary ---------- */
    function updateSummaryStats() {
        const today = new Date().toDateString();
        const todayCount = reports.filter(r => new Date(r.generated_date).toDateString() === today).length;
        const totalDownloads = reports.reduce((a, r) => a + r.download_count, 0);
        const scheduledReports = 3; // mock

        document.getElementById('totalReports').textContent = reports.length;
        document.getElementById('todayReports').textContent = todayCount;
        document.getElementById('totalDownloads').textContent = totalDownloads;
        document.getElementById('scheduledReports').textContent = scheduledReports;
    }

    /* ---------- Events ---------- */
    function setupEventListeners() {
        // Modals
        document.getElementById('newReportBtn').addEventListener('click', openGenerateReportModal);
        document.getElementById('closeGenerateModal').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('cancelGenerate').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('closePreviewModal').addEventListener('click', () => closeModal('reportPreviewModal'));
        // Form
        document.getElementById('generateReportForm').addEventListener('submit', handleGenerateReport);
        document.querySelector('select[name="report_type"]').addEventListener('change', updateTemplateOptions);
        document.querySelector('select[name="date_range"]').addEventListener('change', toggleCustomDateRange);
        document.getElementById('scheduleReport').addEventListener('change', toggleScheduleOptions);

        // Filters
        document.getElementById('reportTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('searchBox').addEventListener('input', debounce(applyFilters, 200));
        document.getElementById('refreshReports').addEventListener('click', async () => { await loadReportsData(); applyFilters(); });

        // Select all / bulk
        document.getElementById('selectAll').addEventListener('change', (e) => toggleSelectAll(e.target.checked));
        document.getElementById('bulkDownload').addEventListener('click', bulkDownload);
        document.getElementById('bulkDelete').addEventListener('click', bulkDelete);

        // Sorting
        document.querySelectorAll('thead th[data-sort]').forEach(th => th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            sortState.dir = (sortState.key === key && sortState.dir === 'asc') ? 'desc' : 'asc';
            sortState.key = key;
            renderReports();
        }));

        // Quick actions
        document.getElementById('markProcessingBtn').addEventListener('click', () => simulateStatus('processing'));
        document.getElementById('markCompleteBtn').addEventListener('click', () => simulateStatus('completed'));

        // Export
        document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);

        // Saved views
        document.getElementById('saveViewBtn').addEventListener('click', saveCurrentView);
        document.getElementById('savedViews').addEventListener('change', applySavedView);

        // Preview download button
        document.getElementById('downloadReportBtn').addEventListener('click', () => showInfo('Download would start here'));

        // Click outside modals to close
        window.addEventListener('click', (e) => {
            ['generateReportModal', 'reportPreviewModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (e.target === modal) modal.classList.add('hidden');
            });
        });
    }

    /* ---------- Saved Views ---------- */
    function hydrateSavedViews() {
        const saved = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        const sel = document.getElementById('savedViews');
        sel.innerHTML = '<option value="">(none)</option>';
        saved.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = v.name;
            sel.appendChild(opt);
        });
    }
    function saveCurrentView() {
        const name = prompt('Name this view');
        if (!name) return;
        const view = {
            id: Date.now().toString(),
            name,
            type: document.getElementById('reportTypeFilter').value,
            period: document.getElementById('periodFilter').value,
            search: document.getElementById('searchBox').value
        };
        const saved = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        saved.push(view);
        localStorage.setItem(LS_KEY, JSON.stringify(saved));
        hydrateSavedViews();
        showSuccess('View saved');
    }
    function applySavedView() {
        const id = document.getElementById('savedViews').value;
        if (!id) return;
        const saved = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        const v = saved.find(x => x.id === id);
        if (!v) return;
        document.getElementById('reportTypeFilter').value = v.type;
        document.getElementById('periodFilter').value = v.period;
        document.getElementById('searchBox').value = v.search;
        applyFilters();
    }

    /* ---------- Filters / Search ---------- */
    function applyFilters() {
        const typeFilter = document.getElementById('reportTypeFilter').value;
        const periodFilter = document.getElementById('periodFilter').value;
        const q = (document.getElementById('searchBox').value || '').toLowerCase().trim();

        filteredReports = reports.filter(report => {
            const matchesType = !typeFilter || report.type === typeFilter;
            let matchesPeriod = true;
            if (periodFilter && periodFilter !== 'all') {
                const d = new Date(report.generated_date);
                const cutoff = new Date(Date.now() - parseInt(periodFilter) * 86400000);
                matchesPeriod = d >= cutoff;
            }
            const matchesText = !q || `${report.name} ${report.generated_by} ${report.type}`.toLowerCase().includes(q);
            return matchesType && matchesPeriod && matchesText;
        });

        currentPage = 1;
        renderReports();
    }

    /* ---------- Render Table & Pagination ---------- */
    function renderReports() {
        if (filteredReports.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('reportsTable').classList.add('hidden');
            return;
        }
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('reportsTable').classList.remove('hidden');

        // sort
        filteredReports.sort((a, b) => {
            const k = sortState.key;
            let av = a[k], bv = b[k];
            if (k === 'generated_date') { av = new Date(av).getTime(); bv = new Date(bv).getTime(); }
            if (typeof av === 'string' && typeof bv === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
            if (av < bv) return sortState.dir === 'asc' ? -1 : 1;
            if (av > bv) return sortState.dir === 'asc' ? 1 : -1;
            return 0;
        });

        renderReportsTable();
        updatePagination();
        updateBulkButtons();
    }

    function renderReportsTable() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '';
        const itemsPerPage = 10;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageReports = filteredReports.slice(startIndex, startIndex + itemsPerPage);

        pageReports.forEach(report => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50';
            tr.innerHTML = `
      <td class="px-4 py-3 align-top">
        <input type="checkbox" class="rowSel rounded border-slate-300" data-id="${report.id}">
      </td>
      <td class="px-4 py-3">
        <div class="font-medium text-slate-800">${report.name}</div>
        <div class="text-xs text-slate-500">#${report.id} • ${report.format.toUpperCase()}</div>
      </td>
      <td class="px-4 py-3">
        <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(report.type)}">${formatType(report.type)}</span>
      </td>
      <td class="px-4 py-3 text-slate-800">${formatDate(report.generated_date)}</td>
      <td class="px-4 py-3 text-slate-800">${report.generated_by}</td>
      <td class="px-4 py-3 text-slate-800">${report.file_size}</td>
      <td class="px-4 py-3">
        <span class="px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(report.status)}">${formatStatus(report.status)}</span>
      </td>
      <td class="px-4 py-3">
        <div class="flex items-center gap-2">
          ${report.status === 'completed' ? `
            <button class="text-blue-600 hover:text-blue-800" title="Preview" onclick="previewReport(${report.id})"><i class="fa-solid fa-eye"></i></button>
            <button class="text-green-600 hover:text-green-800" title="Download" onclick="downloadReport(${report.id})"><i class="fa-solid fa-download"></i></button>
            <button class="text-purple-600 hover:text-purple-800" title="Share" onclick="shareReport(${report.id})"><i class="fa-solid fa-share"></i></button>
          ` : `
            <button class="text-blue-600 hover:text-blue-800" title="Retry" onclick="retryReport(${report.id})"><i class="fa-solid fa-rotate-right"></i></button>
          `}
          <button class="text-red-600 hover:text-red-800" title="Delete" onclick="deleteReport(${report.id})"><i class="fa-solid fa-trash"></i></button>
        </div>
      </td>
    `;
            tbody.appendChild(tr);
        });

        // wire row checkboxes
        document.querySelectorAll('.rowSel').forEach(cb => cb.addEventListener('change', updateBulkButtons));
    }

    function updatePagination() {
        const itemsPerPage = 10;
        totalPages = Math.ceil(filteredReports.length / itemsPerPage) || 1;
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredReports.length);
        document.getElementById('pageInfo').textContent = `${start}-${end} of ${filteredReports.length}`;

        const prev = document.getElementById('prevPageBtn');
        const next = document.getElementById('nextPageBtn');
        prev.disabled = currentPage === 1;
        next.disabled = currentPage === totalPages;
        prev.onclick = () => { if (currentPage > 1) { currentPage--; renderReports(); } };
        next.onclick = () => { if (currentPage < totalPages) { currentPage++; renderReports(); } };

        const pages = document.getElementById('pageNumbers');
        pages.innerHTML = '';
        const windowSize = 2;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= windowSize) {
                const b = document.createElement('button');
                b.textContent = i;
                b.className = i === currentPage ? 'px-3 py-1 rounded bg-slate-800 text-white text-sm'
                    : 'px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50';
                b.onclick = () => { currentPage = i; renderReports(); };
                pages.appendChild(b);
            } else if (Math.abs(i - currentPage) === windowSize + 1) {
                const dots = document.createElement('span');
                dots.textContent = '…';
                dots.className = 'px-2 text-slate-400';
                pages.appendChild(dots);
            }
        }
    }

    /* ---------- Bulk ops ---------- */
    function selectedIds() {
        return Array.from(document.querySelectorAll('.rowSel:checked')).map(x => parseInt(x.dataset.id, 10));
    }
    function updateBulkButtons() {
        const any = selectedIds().length > 0;
        document.getElementById('bulkDownload').disabled = !any;
        document.getElementById('bulkDelete').disabled = !any;
        const all = document.querySelectorAll('.rowSel').length;
        const checked = document.querySelectorAll('.rowSel:checked').length;
        const selAll = document.getElementById('selectAll');
        selAll.checked = all > 0 && checked === all;
        selAll.indeterminate = checked > 0 && checked < all;
    }
    function toggleSelectAll(on) {
        document.querySelectorAll('.rowSel').forEach(cb => cb.checked = on);
        updateBulkButtons();
    }
    function bulkDownload() {
        const ids = selectedIds();
        if (!ids.length) return;
        showInfo(`Downloading ${ids.length} report(s)…`);
        setTimeout(() => { ids.forEach(downloadReport); }, 300);
    }
    function bulkDelete() {
        const ids = selectedIds();
        if (!ids.length) return;
        if (!confirm(`Delete ${ids.length} report(s)?`)) return;
        reports = reports.filter(r => !ids.includes(r.id));
        filteredReports = filteredReports.filter(r => !ids.includes(r.id));
        updateSummaryStats();
        renderReports();
        showSuccess('Selected reports deleted');
    }

    /* ---------- Quick generate ---------- */
    async function generateQuickReport(reportType) {
        try {
            showInfo(`Generating ${formatReportName(reportType)}…`);
            await new Promise(r => setTimeout(r, 1000));
            const newReport = {
                id: reportIdCounter++,
                name: `${formatReportName(reportType)} - ${new Date().toLocaleDateString()}`,
                type: getReportTypeFromTemplate(reportType),
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: "pdf",
                status: "completed",
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            updateSummaryStats();
            renderReports();
            renderCharts();
            showSuccess('Report generated');
        } catch (e) {
            showError('Failed to generate report');
        }
    }

    function getReportTypeFromTemplate(tpl) {
        const map = {
            employee_roster: 'hr', headcount_analysis: 'hr', turnover_report: 'hr', diversity_metrics: 'hr', recruitment_pipeline: 'hr',
            performance_summary: 'performance', goal_achievement: 'performance', review_completion: 'performance', top_performers: 'performance', training_completion: 'performance',
            payroll_summary: 'financial', cost_analysis: 'financial', expense_reports: 'financial', budget_variance: 'financial', contractor_payments: 'financial',
            attendance_summary: 'attendance', leave_analysis: 'attendance', overtime_report: 'attendance', tardiness_report: 'attendance',
            eeo_report: 'compliance', safety_incidents: 'compliance', policy_compliance: 'compliance', audit_trail: 'compliance'
        };
        return map[tpl] || 'hr';
    }
    function formatReportName(type) {
        return type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    /* ---------- Generate modal handlers ---------- */
    function openGenerateReportModal() { document.getElementById('generateReportModal').classList.remove('hidden'); }
    function closeModal(id) {
        const el = document.getElementById(id);
        el.classList.add('hidden');
        if (id === 'generateReportModal') {
            const f = document.getElementById('generateReportForm');
            f.reset();
            document.getElementById('customDateRange').classList.add('hidden');
            document.getElementById('scheduleOptions').classList.add('hidden');
        }
    }
    function updateTemplateOptions() {
        const type = document.querySelector('select[name="report_type"]').value;
        const sel = document.querySelector('select[name="template_id"]');
        sel.innerHTML = '<option value="">Select Template</option>';
        const templates = {
            hr: ['employee_roster', 'headcount_analysis', 'turnover_report', 'diversity_metrics', 'recruitment_pipeline'],
            performance: ['performance_summary', 'goal_achievement', 'review_completion', 'top_performers', 'training_completion'],
            financial: ['payroll_summary', 'cost_analysis', 'expense_reports', 'budget_variance', 'contractor_payments'],
            attendance: ['attendance_summary', 'leave_analysis', 'overtime_report', 'tardiness_report'],
            compliance: ['eeo_report', 'safety_incidents', 'policy_compliance', 'audit_trail']
        }[type] || [];
        templates.forEach(v => {
            const o = document.createElement('option');
            o.value = v; o.textContent = formatReportName(v);
            sel.appendChild(o);
        });
    }
    function toggleCustomDateRange() {
        const val = document.querySelector('select[name="date_range"]').value;
        document.getElementById('customDateRange').classList.toggle('hidden', val !== 'custom');
    }
    function toggleScheduleOptions() {
        document.getElementById('scheduleOptions').classList.toggle('hidden', !document.getElementById('scheduleReport').checked);
    }

    async function handleGenerateReport(e) {
        e.preventDefault();
        const form = e.target;
        const btn = form.querySelector('button[type="submit"]');
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating...';
        btn.disabled = true;
        try {
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());
            await new Promise(r => setTimeout(r, 1200));
            const newReport = {
                id: reportIdCounter++,
                name: data.report_name || `${formatReportName(data.template_id || data.report_type)} - ${new Date().toLocaleDateString()}`,
                type: data.report_type,
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: data.format,
                status: "completed",
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            updateSummaryStats();
            renderReports();
            renderCharts();
            closeModal('generateReportModal');
            showSuccess('Report generated successfully!');
        } catch (err) {
            showError('Failed to generate report');
        } finally {
            btn.innerHTML = orig; btn.disabled = false;
        }
    }

    /* ---------- Preview generators ---------- */
    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const content = document.getElementById('reportPreviewContent');
        content.innerHTML = generateReportPreview(r) + sampleTable();
        document.getElementById('reportPreviewModal').classList.remove('hidden');
    }
    function generateReportPreview(report) {
        const header = `
    <div class="border-b border-slate-200 pb-4 mb-4">
      <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
      <p class="text-slate-600">Generated ${formatDate(report.generated_date)} by ${report.generated_by} • ${report.format.toUpperCase()}</p>
    </div>`;
        const cards = {
            hr: [
                card('Total Employees', '247', 'blue'),
                card('New Hires', '15', 'emerald'),
                card('Departures', '8', 'rose')
            ],
            performance: [
                card('Avg Rating', '4.2/5', 'emerald'),
                card('Reviews Completed', '89%', 'blue'),
                card('Goals Achieved', '76%', 'amber')
            ],
            financial: [
                card('Total Payroll', '$1.2M', 'emerald'),
                card('Benefits', '$245K', 'blue'),
                card('Expenses', '$89K', 'amber')
            ],
            attendance: [
                card('Avg Attendance', '94.2%', 'emerald'),
                card('On Time %', '87.5%', 'blue'),
                card('Leave Days', '156', 'amber')
            ],
            compliance: [
                card('Compliance Score', '96%', 'emerald'),
                card('Open Issues', '3', 'amber'),
                card('Training Complete', '89%', 'blue')
            ]
        }[report.type] || [];
        return header + `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">${cards.join('')}</div>`;
    }
    function card(label, value, tone) {
        const colors = { blue: 'bg-blue-50 text-blue-600', emerald: 'bg-emerald-50 text-emerald-600', amber: 'bg-amber-50 text-amber-600', rose: 'bg-rose-50 text-rose-600' };
        return `<div class="${colors[tone] || 'bg-slate-50 text-slate-700'} p-4 rounded-lg">
    <div class="text-sm font-medium text-slate-700">${label}</div>
    <div class="text-2xl font-bold">${value}</div>
  </div>`;
    }
    function sampleTable() {
        const rows = Array.from({ length: 6 }, (_, i) => `
    <tr class="${i % 2 ? 'bg-slate-50' : ''}">
      <td class="px-3 py-2">EMP-${1000 + i}</td>
      <td class="px-3 py-2">Alex ${String.fromCharCode(65 + i)}</td>
      <td class="px-3 py-2">Engineering</td>
      <td class="px-3 py-2 text-right">${(Math.random() * 100000).toFixed(0)}</td>
    </tr>`).join('');
        return `
    <div class="rounded-xl border border-slate-200">
      <div class="p-3 border-b border-slate-200 font-medium text-slate-800">Sample Data</div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr><th class="px-3 py-2 text-left">Employee ID</th><th class="px-3 py-2 text-left">Name</th><th class="px-3 py-2 text-left">Dept</th><th class="px-3 py-2 text-right">Comp</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
    }

    /* ---------- Actions ---------- */
    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}…`);
        setTimeout(() => { r.download_count++; updateSummaryStats(); renderReports(); showSuccess('Report downloaded'); }, 600);
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const url = window.location.href + `?report=${r.id}`;
        if (navigator.share) navigator.share({ title: r.name, text: r.name, url });
        else navigator.clipboard.writeText(url).then(() => showSuccess('Link copied')).catch(() => showInfo('Share not available'));
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"?`)) return;
        reports = reports.filter(x => x.id !== id);
        filteredReports = filteredReports.filter(x => x.id !== id);
        updateSummaryStats(); renderReports(); renderCharts();
        showSuccess('Report deleted');
    }
    function retryReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        r.status = 'processing'; renderReports();
        setTimeout(() => { r.status = 'completed'; renderReports(); showSuccess('Report re-generated'); }, 1200);
    }

    /* ---------- Charts ---------- */
    let typeChart, volumeChart;
    function renderCharts() {
        const typeCounts = ['hr', 'performance', 'financial', 'attendance', 'compliance'].map(t => reports.filter(r => r.type === t).length);
        const ctx1 = document.getElementById('typeChart').getContext('2d');
        typeChart && typeChart.destroy();
        typeChart = new Chart(ctx1, {
            type: 'doughnut',
            data: { labels: ['HR', 'Perf', 'Fin', 'Attend', 'Comp'], datasets: [{ data: typeCounts }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        // last 30 days mock sparkline
        const days = Array.from({ length: 30 }, (_, i) => i + 1);
        const vals = days.map(() => Math.floor(Math.random() * 4));
        const ctx2 = document.getElementById('volumeChart').getContext('2d');
        volumeChart && volumeChart.destroy();
        volumeChart = new Chart(ctx2, {
            type: 'line',
            data: { labels: days, datasets: [{ data: vals, fill: false, tension: .3 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    /* ---------- Utils ---------- */
    function getTypeBadgeClass(type) {
        const c = { hr: 'bg-blue-100 text-blue-700', performance: 'bg-green-100 text-green-700', financial: 'bg-yellow-100 text-yellow-700', attendance: 'bg-purple-100 text-purple-700', compliance: 'bg-red-100 text-red-700' };
        return c[type] || 'bg-slate-100 text-slate-700';
    }
    function formatType(t) { return ({ hr: 'HR', performance: 'Performance', financial: 'Financial', attendance: 'Attendance', compliance: 'Compliance' })[t] || t; }
    function getStatusBadgeClass(s) { const c = { completed: 'bg-green-100 text-green-700', processing: 'bg-blue-100 text-blue-700', failed: 'bg-red-100 text-red-700', scheduled: 'bg-yellow-100 text-yellow-700' }; return c[s] || 'bg-slate-100 text-slate-700'; }
    function formatStatus(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    function formatDate(ds) {
        return new Date(ds).toLocaleString('en-US', { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }
    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }

    /* ---------- Quick simulate status ---------- */
    function simulateStatus(status) {
        const first = reports.find(r => r.status !== status);
        if (!first) return;
        first.status = status;
        renderReports();
        showInfo(`Set "${first.name}" → ${status}`);
    }

    /* ---------- Export CSV ---------- */
    function exportCsv() {
        if (!filteredReports.length) { showInfo('Nothing to export'); return; }
        const cols = ['id', 'name', 'type', 'generated_date', 'generated_by', 'file_size', 'format', 'status', 'download_count'];
        const rows = [cols.join(',')].concat(filteredReports.map(r => cols.map(c => `"${String(r[c]).replace(/"/g, '""')}"`).join(',')));
        const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `reports-${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }

    /* ---------- Toasts ---------- */
    function showToast(kind, msg) {
        const el = document.getElementById(`${kind}Toast`);
        document.getElementById(`${kind}Message`).textContent = msg;
        el.classList.remove('translate-x-full');
        setTimeout(() => el.classList.add('translate-x-full'), 2500);
    }
    function showSuccess(m) { showToast('success', m); }
    function showError(m) { showToast('error', m); }
    function showInfo(m) { showToast('info', m); }
</script>
{% endblock %}