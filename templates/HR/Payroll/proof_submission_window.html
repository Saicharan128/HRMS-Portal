{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div class="min-w-0">
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-calendar-check"></i>
                <span class="truncate">Proof Submission Window</span>
            </h1>
            <p class="text-slate-600 text-xs sm:text-sm">Configure declaration/proof windows with reminders.</p>
        </div>
        <div class="grid grid-cols-2 sm:flex sm:flex-wrap items-center gap-2 w-full sm:w-auto">
            <button id="btnNewWindow"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-plus mr-1"></i> New Window
            </button>
            <button id="btnNewReminder"
                class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-bell mr-1"></i> New Reminder
            </button>
            <button id="btnExport"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-file-arrow-down mr-1"></i> Export
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto text-center">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 sm:mb-6">
        <div class="flex overflow-x-auto no-scrollbar space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab"
                class="psw-tab active px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-gauge-high mr-1"></i> Overview
            </button>
            <button id="windowsTab" class="psw-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-calendar-days mr-1"></i> Windows
            </button>
            <button id="remindersTab"
                class="psw-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-bell mr-1"></i> Reminders
            </button>
            <button id="historyTab" class="psw-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-clock-rotate-left mr-1"></i> History
            </button>
            <button id="settingsTab" class="psw-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-gear mr-1"></i> Settings
            </button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="psw-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- KPIs -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-clipboard-list mr-2"></i> Current FY
                    </h3>
                    <span id="fyBadge" class="px-2 py-1 text-xs rounded bg-amber-50 text-amber-700">Draft</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Windows</div>
                        <div id="kpiWindows" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Active Now</div>
                        <div id="kpiActive" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Upcoming</div>
                        <div id="kpiUpcoming" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Reminders</div>
                        <div id="kpiRem" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>
                <div class="relative h-40 mt-4"><canvas id="kpiChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-2">
                    <select id="fyPicker" class="px-2 py-1 rounded-lg border border-slate-300 text-sm w-full sm:w-auto">
                        <option>FY 2025â€“26</option>
                        <option>FY 2024â€“25</option>
                        <option>FY 2023â€“24</option>
                    </select>
                    <button id="btnValidate"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50 w-full sm:w-auto">
                        <i class="fa-solid fa-spell-check mr-1"></i> Validate
                    </button>
                </div>
            </div>

            <!-- Mix -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Status Mix
                    </h3>
                </div>
                <div class="relative h-40"><canvas id="mixChart" class="absolute inset-0 w-full h-full"></canvas></div>
                <div id="mixLegend" class="mt-3 text-sm text-slate-700"></div>
            </div>

            <!-- Quick Actions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">
                    <i class="fa-solid fa-bolt mr-2"></i> Quick Actions
                </h3>
                <div class="space-y-3">
                    <button id="btnPreview"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-eye mr-2"></i> Preview employee timeline
                    </button>
                    <button id="btnNudge"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-bell mr-2"></i> Send test reminder
                    </button>
                    <button id="btnRollback"
                        class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 text-left">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Rollback last change
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Windows -->
    <section id="windowsPanel" class="psw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-calendar-days mr-2"></i> Declaration & Proof Windows
                </h3>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                    <input id="winSearch" type="text" placeholder="Search type or FY..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-64">
                    <select id="winStatus"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="closed">Closed</option>
                        <option value="upcoming">Upcoming</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4 pl-4">Type</th>
                            <th class="py-2 pr-4">FY</th>
                            <th class="py-2 pr-4">Open</th>
                            <th class="py-2 pr-4">Close</th>
                            <th class="py-2 pr-4">Grace (days)</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4 w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="winRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Reminders -->
    <section id="remindersPanel" class="psw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-bell mr-2"></i> Reminders
                </h3>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                    <input id="remSearch" type="text" placeholder="Search window or channel..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-64">
                    <select id="remScope"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="declaration">Declaration</option>
                        <option value="proof">Proof</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4 pl-4">Window</th>
                            <th class="py-2 pr-4">When</th>
                            <th class="py-2 pr-4">Channel</th>
                            <th class="py-2 pr-4">Audience</th>
                            <th class="py-2 pr-4">Template</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4 w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="remRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- History -->
    <section id="historyPanel" class="psw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-table mr-2"></i> Change History
                </h3>
                <div class="text-xs sm:text-sm text-slate-600">Last 10 edits</div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4 pl-4">Time</th>
                            <th class="py-2 pr-4">Entity</th>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4">Action</th>
                            <th class="py-2 pr-4">By</th>
                        </tr>
                    </thead>
                    <tbody id="histRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Settings -->
    <section id="settingsPanel" class="psw-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-clock mr-2"></i> Defaults
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="block">Default grace days
                        <input id="stGrace" type="number" min="0" value="3"
                            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
                    </label>
                    <label class="flex items-center gap-2"><input id="stLock" type="checkbox" class="h-4 w-4"> Lock
                        claims after close</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-bell mr-2"></i> Reminder Rules
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center gap-2"><input id="stDigest" type="checkbox" checked class="h-4 w-4">
                        Daily digest during last 3 days</label>
                    <label class="flex items-center gap-2"><input id="stSkipWKND" type="checkbox" checked
                            class="h-4 w-4"> Skip weekends</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> Save
                </h3>
                <button id="stSave"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                </button>
            </div>
        </div>
    </section>
</div>

<!-- Modal -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full sm:max-w-lg max-w-none">
                <div class="p-4 sm:p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 id="modalTitle" class="text-base sm:text-lg font-semibold text-slate-800">New</h3>
                    <button id="closeModal" class="text-slate-400 hover:text-slate-600 p-2 -mr-2 sm:mr-0">
                        <i class="fa-solid fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>
                <div id="modalBody" class="p-4 sm:p-6 space-y-4 text-sm"></div>
                <div
                    class="px-4 sm:px-6 pb-4 sm:pb-6 flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-2">
                    <button id="cancelEdit"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 w-full sm:w-auto">Cancel</button>
                    <button id="saveEdit"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 w-full sm:w-auto">
                        <i class="fa-solid fa-check mr-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // ----  Data ----
    const WINDOWS = [
        { id: 1, type: 'Declaration', fy: 'FY 2025â€“26', open: '2025-04-01', close: '2025-05-15', grace: 3, status: 'closed' },
        { id: 2, type: 'Proof', fy: 'FY 2024â€“25', open: '2025-01-10', close: '2025-02-10', grace: 5, status: 'closed' },
        { id: 3, type: 'Proof', fy: 'FY 2025â€“26', open: '2025-12-05', close: '2026-01-10', grace: 3, status: 'upcoming' },
        { id: 4, type: 'Declaration', fy: 'FY 2026â€“27', open: '2026-04-01', close: '2026-05-10', grace: 2, status: 'upcoming' }
    ];
    const REMINDERS = [
        { id: 11, window: 'Declaration â€” FY 2025â€“26', when: 'Open+1d', channel: 'Email', audience: 'All', tmpl: 'DEC_OPEN', status: 'active' },
        { id: 12, window: 'Proof â€” FY 2024â€“25', when: '7d before close', channel: 'Slack', audience: 'Pending', tmpl: 'PRF_NUDGE', status: 'active' },
        { id: 13, window: 'Proof â€” FY 2025â€“26', when: '1d before close', channel: 'SMS', audience: 'Pending', tmpl: 'PRF_LAST', status: 'inactive' }
    ];
    const HISTORY = [
        { ts: '2025-09-10 18:30', ent: 'Window', name: 'Proof FY25â€“26', action: 'Created', by: 'Payroll' },
        { ts: '2025-08-22 09:10', ent: 'Reminder', name: 'PRF_NUDGE', action: 'Enabled', by: 'System' },
        { ts: '2025-05-16 19:00', ent: 'Window', name: 'Decl FY25â€“26', action: 'Auto-closed', by: 'System' }
    ];

    // ---- Panels/Tabs ----
    const panels = {
        overview: document.getElementById('overviewPanel'),
        windows: document.getElementById('windowsPanel'),
        reminders: document.getElementById('remindersPanel'),
        history: document.getElementById('historyPanel'),
        settings: document.getElementById('settingsPanel')
    };
    let _kpiChart, _mixChart;

    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        wireButtons();
        safe(renderKPIs);
        safe(drawCharts);
        safe(renderWindows);
        safe(renderReminders);
        safe(renderHistory);
    });

    /* ------ Tabs ------ */
    function setupTabs() {
        document.querySelectorAll('.psw-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.psw-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name]?.classList.remove('hidden');
            });
        });
    }

    /* ------ Buttons / Inputs ------ */
    function wireButtons() {
        on('btnNewWindow', 'click', () => openModal('New Window', windowForm()));
        on('btnNewReminder', 'click', () => openModal('New Reminder', reminderForm()));
        on('btnExport', 'click', () => alert('âœ… Exported ()'));
        on('btnValidate', 'click', () => alert('âœ… Validation passed ()'));
        on('btnPreview', 'click', () => alert('ðŸ‘€ Timeline previewed ()'));
        on('btnNudge', 'click', () => alert('ðŸ”” Test reminder sent ()'));
        on('btnRollback', 'click', () => alert('â†©ï¸ Rolled back ()'));
        on('stSave', 'click', () => alert('âœ… Settings saved'));

        on('winSearch', 'input', renderWindows);
        on('winStatus', 'change', renderWindows);
        on('remSearch', 'input', renderReminders);
        on('remScope', 'change', renderReminders);

        on('closeModal', 'click', closeModal);
        on('cancelEdit', 'click', closeModal);
        on('saveEdit', 'click', () => { closeModal(); alert('ðŸ’¾ Saved ()'); });
    }

    /* ------ Overview / KPIs & Charts ------ */
    function now() { return new Date(); } // single source of truth

    function inferStatus(w) {
        const t = now();
        const open = new Date(w.open);
        const close = new Date(w.close);
        if (close < t) return 'closed';
        if (open > t) return 'upcoming';
        return 'active';
    }

    function renderKPIs() {
        const active = WINDOWS.filter(w => inferStatus(w) === 'active').length;
        const upcoming = WINDOWS.filter(w => inferStatus(w) === 'upcoming').length;

        text('kpiWindows', WINDOWS.length);
        text('kpiActive', active);
        text('kpiUpcoming', upcoming);
        text('kpiRem', REMINDERS.length);

        const badge = id('fyBadge');
        if (badge) {
            const ready = WINDOWS.length > 0 && REMINDERS.length > 0;
            badge.textContent = ready ? 'Ready' : (WINDOWS.length > 0 ? 'In Progress' : 'Draft');
            badge.className = 'px-2 py-1 text-xs rounded ' + (ready ? 'bg-emerald-50 text-emerald-700' : (WINDOWS.length > 0 ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700'));
        }
    }

    function drawCharts() {
        // KPI Bar
        const el1 = id('kpiChart');
        if (el1 && window.Chart) {
            const ctx1 = el1.getContext('2d');
            _kpiChart && _kpiChart.destroy();
            _kpiChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Windows', 'Active', 'Upcoming', 'Reminders'],
                    datasets: [{
                        label: 'Count',
                        data: [
                            WINDOWS.length,
                            WINDOWS.filter(w => inferStatus(w) === 'active').length,
                            WINDOWS.filter(w => inferStatus(w) === 'upcoming').length,
                            REMINDERS.length
                        ]
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        // Mix Doughnut
        const counts = {
            active: WINDOWS.filter(w => inferStatus(w) === 'active').length,
            upcoming: WINDOWS.filter(w => inferStatus(w) === 'upcoming').length,
            closed: WINDOWS.filter(w => inferStatus(w) === 'closed').length
        };
        const el2 = id('mixChart');
        if (el2 && window.Chart) {
            const ctx2 = el2.getContext('2d');
            _mixChart && _mixChart.destroy();
            _mixChart = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } }, animation: false }
            });
        }
        const legend = id('mixLegend');
        if (legend) {
            legend.innerHTML = Object.entries(counts)
                .map(([k, v]) => `<div class="flex items-center justify-between text-sm"><span class="capitalize">${k}</span><span>${v}</span></div>`)
                .join('');
        }
    }

    /* ------ Windows ------ */
    function renderWindows() {
        const q = (id('winSearch')?.value || '').toLowerCase();
        const st = id('winStatus')?.value || 'all';
        const rows = WINDOWS
            .map(w => ({ ...w, status: inferStatus(w) }))
            .filter(r => st === 'all' ? true : r.status === st)
            .filter(r => r.type.toLowerCase().includes(q) || r.fy.toLowerCase().includes(q))
            .sort((a, b) => new Date(a.open) - new Date(b.open));
        const tbody = id('winRows'); if (!tbody) return;
        tbody.innerHTML = rows.map(rowWindow).join('') || emptyRow(7);
    }
    function rowWindow(r) {
        return `<tr class="border-b last:border-0">
      <td class="py-2 pr-4 pl-4">${r.type}</td>
      <td class="py-2 pr-4">${r.fy}</td>
      <td class="py-2 pr-4">${r.open}</td>
      <td class="py-2 pr-4">${r.close}</td>
      <td class="py-2 pr-4">${r.grace}</td>
      <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
      <td class="py-2 pr-4">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('âœï¸ Edit ${r.type} ${r.fy} ()')">
          <i class="fa-solid fa-pen mr-1"></i> Edit
        </button>
      </td>
    </tr>`;
    }

    /* ------ Reminders ------ */
    function renderReminders() {
        const q = (id('remSearch')?.value || '').toLowerCase();
        const scope = id('remScope')?.value || 'all';
        const rows = REMINDERS
            .filter(r => scope === 'all' ? true : r.window.toLowerCase().startsWith(scope))
            .filter(r => r.window.toLowerCase().includes(q) || r.channel.toLowerCase().includes(q))
            .sort((a, b) => a.window.localeCompare(b.window));
        const tbody = id('remRows'); if (!tbody) return;
        tbody.innerHTML = rows.map(rowReminder).join('') || emptyRow(7);
    }
    function rowReminder(r) {
        return `<tr class="border-b last:border-0">
      <td class="py-2 pr-4 pl-4">${r.window}</td>
      <td class="py-2 pr-4">${r.when}</td>
      <td class="py-2 pr-4">${r.channel}</td>
      <td class="py-2 pr-4">${r.audience}</td>
      <td class="py-2 pr-4"><span class="px-2 py-0.5 rounded bg-slate-50 text-slate-700 text-xs">${r.tmpl}</span></td>
      <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
      <td class="py-2 pr-4">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('âœï¸ Edit ${r.tmpl} ()')">
          <i class="fa-solid fa-pen mr-1"></i> Edit
        </button>
      </td>
    </tr>`;
    }

    /* ------ History ------ */
    function renderHistory() {
        const tbody = id('histRows'); if (!tbody) return;
        tbody.innerHTML = HISTORY.map(h => `
      <tr class="border-b last:border-0">
        <td class="py-2 pr-4 pl-4 text-slate-600">${h.ts}</td>
        <td class="py-2 pr-4">${h.ent}</td>
        <td class="py-2 pr-4">${h.name}</td>
        <td class="py-2 pr-4">${h.action}</td>
        <td class="py-2 pr-4">${h.by}</td>
      </tr>`).join('');
    }

    /* ------ Modal helpers ------ */
    function openModal(title, bodyHTML) {
        text('modalTitle', title);
        const body = id('modalBody'); if (body) body.innerHTML = bodyHTML;
        id('editModal')?.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    function closeModal() {
        id('editModal')?.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function windowForm() {
        return `
      <label class="block">Type
        <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
          <option>Declaration</option><option>Proof</option>
        </select>
      </label>
      <label class="block mt-2">FY
        <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="FY 2025â€“26">
      </label>
      <div class="grid grid-cols-2 gap-3 mt-2">
        <label class="block">Open<input type="date" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2"></label>
        <label class="block">Close<input type="date" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2"></label>
      </div>
      <label class="block mt-2">Grace days<input type="number" min="0" value="3" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2"></label>
      <div class="mt-2"><label class="flex items-center gap-2"><input type="checkbox" checked class="h-4 w-4"> Active</label></div>`;
    }
    function reminderForm() {
        return `
      <label class="block">Window
        <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Declaration â€” FY 2025â€“26">
      </label>
      <label class="block mt-2">When
        <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
          <option>Open+1d</option><option>7d before close</option><option>1d before close</option>
        </select>
      </label>
      <div class="grid grid-cols-2 gap-3 mt-2">
        <label class="block">Channel
          <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
            <option>Email</option><option>Slack</option><option>SMS</option>
          </select>
        </label>
        <label class="block">Audience
          <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
            <option>All</option><option>Pending</option>
          </select>
        </label>
      </div>
      <label class="block mt-2">Template code
        <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="DEC_OPEN">
      </label>
      <div class="mt-2"><label class="flex items-center gap-2"><input type="checkbox" checked class="h-4 w-4"> Active</label></div>`;
    }

    /* ------ Utils ------ */
    function id(x) { return document.getElementById(x); }
    function text(x, v) { const el = id(x); if (el) el.textContent = v; }
    function on(x, ev, fn) { const el = id(x); if (el) el.addEventListener(ev, fn); }
    function safe(fn) { try { fn(); } catch (e) {/* keep UI stable */ } }
    function badgeStatus(s) {
        const map = { active: 'bg-emerald-50 text-emerald-700', upcoming: 'bg-blue-50 text-blue-700', closed: 'bg-slate-100 text-slate-700', inactive: 'bg-slate-100 text-slate-700' };
        const k = (s || 'inactive'); const label = k.charAt(0).toUpperCase() + k.slice(1);
        return `<span class="px-2 py-0.5 rounded-full ${map[k] || map['inactive']} text-xs">${label}</span>`;
    }
    function emptyRow(colspan) { return `<tr><td colspan="${colspan}" class="py-6 text-center text-slate-500">No records.</td></tr>`; }
</script>

<style>
    .psw-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .psw-tab:not(.active) {
        color: #64748b;
    }

    .psw-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
{% endblock %}