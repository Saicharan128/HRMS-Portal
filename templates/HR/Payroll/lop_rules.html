{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div class="min-w-0">
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-user-minus"></i> <span class="truncate">LOP Rules</span>
            </h1>
            <p class="text-slate-600 text-xs sm:text-sm">Configure proration and import LOP from attendance.</p>
        </div>
        <div class="grid grid-cols-2 sm:flex sm:flex-wrap items-center gap-2 w-full sm:w-auto">
            <button id="btnNewRule"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-plus mr-1"></i> New Rule
            </button>
            <button id="btnImport"
                class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-file-import mr-1"></i> Import LOP
            </button>
            <button id="btnMap"
                class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm w-full sm:w-auto">
                <i class="fa-solid fa-diagram-project mr-1"></i> Map Attendance
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto text-center">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 sm:mb-6">
        <div class="flex overflow-x-auto no-scrollbar space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab"
                class="lop-tab active px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-gauge-high mr-1"></i> Overview
            </button>
            <button id="rulesTab" class="lop-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-sliders mr-1"></i> Rules
            </button>
            <button id="importsTab" class="lop-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-file-arrow-up mr-1"></i> Imports
            </button>
            <button id="historyTab" class="lop-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-clock-rotate-left mr-1"></i> History
            </button>
            <button id="settingsTab" class="lop-tab px-3 sm:px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                <i class="fa-solid fa-gear mr-1"></i> Settings
            </button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="lop-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- KPIs -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-calendar-day mr-2"></i> Current Cycle
                    </h3>
                    <span id="cycleBadge" class="px-2 py-1 text-xs rounded bg-amber-50 text-amber-700">Draft</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Rules</div>
                        <div id="kpiRules" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Mappings</div>
                        <div id="kpiMaps" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Imports</div>
                        <div id="kpiImports" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Errors</div>
                        <div id="kpiErrors" class="text-lg sm:text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>
                <div class="relative h-40 sm:h-48 mt-4">
                    <canvas id="kpiChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-2">
                    <select id="cyclePicker" class="px-2 py-2 rounded-lg border border-slate-300 text-sm">
                        <option>Sep 2025</option>
                        <option>Aug 2025</option>
                        <option>Jul 2025</option>
                    </select>
                    <button id="btnValidate"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-spell-check mr-1"></i> Validate
                    </button>
                </div>
            </div>

            <!-- Mix -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Status Mix
                    </h3>
                </div>
                <div class="relative h-40 sm:h-48">
                    <canvas id="mixChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 text-sm text-slate-700 grid grid-cols-2 gap-1 sm:block"></div>
            </div>

            <!-- Quick Actions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">
                    <i class="fa-solid fa-bolt mr-2"></i> Quick Actions
                </h3>
                <div class="space-y-2 sm:space-y-3">
                    <button id="btnSimulate"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-calculator mr-2"></i> Simulate employee LOP
                    </button>
                    <button id="btnRecalc"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-rotate mr-2"></i> Recompute payroll with LOP
                    </button>
                    <button id="btnRollback"
                        class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 text-left">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Rollback last import
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Rules -->
    <section id="rulesPanel" class="lop-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-3 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-sliders mr-2"></i> Proration Rules
                </h3>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <input id="ruleSearch" type="text" placeholder="Search name or scope..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-64">
                    <select id="ruleStatus"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4 hidden md:table-cell">Scope</th>
                            <th class="py-2 pr-4">Method</th>
                            <th class="py-2 pr-4 hidden sm:table-cell">Denominator</th>
                            <th class="py-2 pr-4 hidden lg:table-cell">Half-day</th>
                            <th class="py-2 pr-4 hidden lg:table-cell">Round</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ruleRows" class="text-slate-800"></tbody>
                </table>
            </div>
            <p class="mt-3 text-xs text-slate-500 md:hidden">Tip: Scope/Denominator/flags are hidden on small screens.
            </p>
        </div>
    </section>

    <!-- Imports -->
    <section id="importsPanel" class="lop-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-3 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-file-arrow-up mr-2"></i> LOP Imports
                </h3>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <input id="impSearch" type="text" placeholder="Search batch or status..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-64">
                    <select id="impStatus"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="draft">Draft</option>
                        <option value="applied">Applied</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4">Batch</th>
                            <th class="py-2 pr-4">Cycle</th>
                            <th class="py-2 pr-4 hidden sm:table-cell">Rows</th>
                            <th class="py-2 pr-4 hidden sm:table-cell">Applied</th>
                            <th class="py-2 pr-4 hidden md:table-cell">Errors</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="impRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- History -->
    <section id="historyPanel" class="lop-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-3 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-table mr-2"></i> Change History
                </h3>
                <div class="text-xs sm:text-sm text-slate-600">Last 10 events</div>
            </div>
            <div class="overflow-x-auto -mx-3 sm:mx-0">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b sticky top-0 bg-white">
                        <tr>
                            <th class="py-2 pr-4">Time</th>
                            <th class="py-2 pr-4">Entity</th>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4">Action</th>
                            <th class="py-2 pr-4 hidden sm:table-cell">By</th>
                        </tr>
                    </thead>
                    <tbody id="histRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Settings -->
    <section id="settingsPanel" class="lop-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-lock mr-2"></i> Defaults
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="block">Default denominator
                        <select id="stDen" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option>Calendar Days (30)</option>
                            <option>Working Days</option>
                            <option>Actual Days in Month</option>
                        </select>
                    </label>
                    <label class="flex items-center gap-2"><input id="stHalf" type="checkbox" checked class="h-4 w-4">
                        Support half-day as 0.5</label>
                    <label class="flex items-center gap-2"><input id="stRound" type="checkbox" checked class="h-4 w-4">
                        Round to 2 decimals</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-shield-halved mr-2"></i> Validation
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center gap-2"><input id="stNoNeg" type="checkbox" checked class="h-4 w-4">
                        Disallow negative LOP</label>
                    <label class="flex items-center gap-2"><input id="stMax" type="checkbox" checked class="h-4 w-4">
                        Cap LOP ≤ denominator</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> Save
                </h3>
                <button id="stSave"
                    class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                </button>
            </div>
        </div>
    </section>
</div>

<!-- Modal -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full sm:max-w-lg max-w-none">
                <div class="p-4 sm:p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 id="modalTitle" class="text-base sm:text-lg font-semibold text-slate-800">New</h3>
                    <button id="closeModal" class="text-slate-400 hover:text-slate-600 p-2 -mr-2 sm:mr-0">
                        <i class="fa-solid fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>
                <div id="modalBody" class="p-4 sm:p-6 space-y-3 sm:space-y-4 text-sm"></div>
                <div class="px-4 sm:px-6 pb-4 sm:pb-6 flex flex-col sm:flex-row sm:items-center justify-end gap-2">
                    <button id="cancelEdit"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 w-full sm:w-auto">Cancel</button>
                    <button id="saveEdit"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 w-full sm:w-auto">
                        <i class="fa-solid fa-check mr-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // ----  Data ----
    const RULES = [
        { id: 1, name: 'Org Default', scope: 'Org-wide', method: 'Daily Proration', denom: 'Actual Days in Month', half: true, round: '2 decimals', status: 'active' },
        { id: 2, name: 'Sales Floor', scope: 'Dept: Sales', method: 'Hourly (8h/day)', denom: 'Working Days', half: true, round: '2 decimals', status: 'active' },
        { id: 3, name: 'Contractor', scope: 'Grade: C3', method: 'Flat per day', denom: 'Calendar Days (30)', half: false, round: 'Nearest ₹1', status: 'inactive' }
    ];
    const IMPORTS = [
        { id: 11, batch: 'LOP-SEP-25-A', cycle: 'Sep 2025', rows: 120, applied: 118, errors: 2, status: 'applied' },
        { id: 12, batch: 'LOP-AUG-25-B', cycle: 'Aug 2025', rows: 115, applied: 115, errors: 0, status: 'applied' },
        { id: 13, batch: 'LOP-SEP-25-DRAFT', cycle: 'Sep 2025', rows: 6, applied: 0, errors: 0, status: 'draft' }
    ];
    const HISTORY = [
        { ts: '2025-09-14 11:40', ent: 'Import', name: 'LOP-SEP-25-A', action: 'Applied 118/120', by: 'Payroll' },
        { ts: '2025-09-10 09:05', ent: 'Rule', name: 'Sales Floor', action: 'Activated', by: 'HR Admin' },
        { ts: '2025-08-31 18:10', ent: 'Import', name: 'LOP-AUG-25-B', action: 'Applied 115/115', by: 'System' }
    ];

    // ---- Panels/Tabs ----
    const panels = {
        overview: document.getElementById('overviewPanel'),
        rules: document.getElementById('rulesPanel'),
        imports: document.getElementById('importsPanel'),
        history: document.getElementById('historyPanel'),
        settings: document.getElementById('settingsPanel')
    };
    let _kpiChart, _mixChart;

    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        wireButtons();
        renderKPIs();
        drawCharts();
        renderRules();
        renderImports();
        renderHistory();
    });

    function setupTabs() {
        document.querySelectorAll('.lop-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.lop-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name].classList.remove('hidden');
            });
        });
    }

    function wireButtons() {
        document.getElementById('btnNewRule').addEventListener('click', () => openModal('New LOP Rule', ruleForm()));
        document.getElementById('btnImport').addEventListener('click', () => openModal('Import LOP', importForm()));
        document.getElementById('btnMap').addEventListener('click', () => openModal('Map Attendance Fields', mapForm()));
        document.getElementById('btnValidate').addEventListener('click', () => alert('✅ Validation passed ()'));
        document.getElementById('btnSimulate').addEventListener('click', () => alert('🧮 Simulated for EMP001: 1.5 days LOP ()'));
        document.getElementById('btnRecalc').addEventListener('click', () => alert('🔁 Payroll recomputed with LOP ()'));
        document.getElementById('btnRollback').addEventListener('click', () => alert('↩️ Last import rolled back ()'));
        document.getElementById('cyclePicker').addEventListener('change', () => alert('🔁 Switched cycle ()'));
        document.getElementById('stSave').addEventListener('click', () => alert('✅ Settings saved ()'));

        document.getElementById('ruleSearch').addEventListener('input', renderRules);
        document.getElementById('ruleStatus').addEventListener('change', renderRules);
        document.getElementById('impSearch').addEventListener('input', renderImports);
        document.getElementById('impStatus').addEventListener('change', renderImports);

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelEdit').addEventListener('click', closeModal);
        document.getElementById('saveEdit').addEventListener('click', () => { closeModal(); alert('💾 Saved ()'); });
    }

    // ---- Overview/KPIs ----
    function renderKPIs() {
        const maps = 2; // mapping count
        const errors = IMPORTS.reduce((a, b) => a + b.errors, 0);
        document.getElementById('kpiRules').textContent = RULES.length;
        document.getElementById('kpiMaps').textContent = maps;
        document.getElementById('kpiImports').textContent = IMPORTS.length;
        document.getElementById('kpiErrors').textContent = errors;
        const ready = RULES.some(r => r.status === 'active') && IMPORTS.length > 0;
        const badge = document.getElementById('cycleBadge');
        badge.textContent = ready ? 'Ready' : (RULES.length > 0 ? 'In Progress' : 'Draft');
        badge.className = 'px-2 py-1 text-xs rounded ' + (ready ? 'bg-emerald-50 text-emerald-700' : (RULES.length > 0 ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700'));
    }

    function drawCharts() {
        const ctx1 = document.getElementById('kpiChart').getContext('2d');
        if (_kpiChart) _kpiChart.destroy();
        _kpiChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Rules', 'Mappings', 'Imports', 'Errors'],
                datasets: [{ label: 'Count', data: [RULES.length, 2, IMPORTS.length, IMPORTS.reduce((a, b) => a + b.errors, 0)] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        const counts = {
            active: RULES.filter(r => r.status === 'active').length,
            inactive: RULES.filter(r => r.status === 'inactive').length,
            applied: IMPORTS.filter(i => i.status === 'applied').length,
            draft: IMPORTS.filter(i => i.status === 'draft').length,
            failed: IMPORTS.filter(i => i.status === 'failed').length
        };
        const ctx2 = document.getElementById('mixChart').getContext('2d');
        if (_mixChart) _mixChart.destroy();
        _mixChart = new Chart(ctx2, {
            type: 'doughnut',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } }, animation: false }
        });
        document.getElementById('mixLegend').innerHTML =
            Object.entries(counts).map(([k, v]) => `<div class="flex items-center justify-between text-sm"><span class="capitalize">${k}</span><span>${v}</span></div>`).join('');
    }

    // ---- Rules ----
    function renderRules() {
        const q = (document.getElementById('ruleSearch').value || '').toLowerCase();
        const st = document.getElementById('ruleStatus').value;
        const rows = RULES
            .filter(r => st === 'all' ? true : r.status === st)
            .filter(r => r.name.toLowerCase().includes(q) || (r.scope || '').toLowerCase().includes(q))
            .slice().sort((a, b) => a.name.localeCompare(b.name));
        document.getElementById('ruleRows').innerHTML = rows.map(rowRule).join('') || emptyRow(8);
    }
    function rowRule(r) {
        return `<tr class="border-b last:border-0">
    <td class="py-2 pr-4">
      <div class="font-medium">${r.name}</div>
      <div class="text-xs text-slate-500 md:hidden">${r.scope} • ${r.denom}</div>
    </td>
    <td class="py-2 pr-4 hidden md:table-cell">${r.scope}</td>
    <td class="py-2 pr-4">${r.method}</td>
    <td class="py-2 pr-4 hidden sm:table-cell">${r.denom}</td>
    <td class="py-2 pr-4 hidden lg:table-cell">${badgeLite(r.half ? 'Yes' : 'No')}</td>
    <td class="py-2 pr-4 hidden lg:table-cell">${r.round}</td>
    <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
    <td class="py-2 pr-4">
      <div class="flex flex-wrap gap-2">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('✏️ Edit ${r.name} ()')">
          <i class="fa-solid fa-pen mr-1"></i> Edit
        </button>
      </div>
    </td>
  </tr>`;
    }

    // ---- Imports ----
    function renderImports() {
        const q = (document.getElementById('impSearch').value || '').toLowerCase();
        const st = document.getElementById('impStatus').value;
        const rows = IMPORTS
            .filter(i => st === 'all' ? true : i.status === st)
            .filter(i => i.batch.toLowerCase().includes(q) || i.cycle.toLowerCase().includes(q))
            .slice().sort((a, b) => a.batch.localeCompare(b.batch));
        document.getElementById('impRows').innerHTML = rows.map(rowImport).join('') || emptyRow(7);
    }
    function rowImport(r) {
        return `<tr class="border-b last:border-0">
    <td class="py-2 pr-4">
      <div class="font-medium">${r.batch}</div>
      <div class="text-xs text-slate-500 sm:hidden">${r.cycle} • ${r.applied}/${r.rows} • Err ${r.errors}</div>
    </td>
    <td class="py-2 pr-4">${r.cycle}</td>
    <td class="py-2 pr-4 hidden sm:table-cell">${r.rows}</td>
    <td class="py-2 pr-4 hidden sm:table-cell">${r.applied}</td>
    <td class="py-2 pr-4 hidden md:table-cell">${r.errors}</td>
    <td class="py-2 pr-4">${badgeImport(r.status)}</td>
    <td class="py-2 pr-4">
      <div class="flex flex-wrap gap-2">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('🔍 Review ${r.batch} ()')">
          <i class="fa-solid fa-eye mr-1"></i> Review
        </button>
      </div>
    </td>
  </tr>`;
    }

    // ---- History ----
    function renderHistory() {
        document.getElementById('histRows').innerHTML = HISTORY.map(h => `
    <tr class="border-b last:border-0">
      <td class="py-2 pr-4 text-slate-600">${h.ts}</td>
      <td class="py-2 pr-4">${h.ent}</td>
      <td class="py-2 pr-4">${h.name}</td>
      <td class="py-2 pr-4">${h.action}</td>
      <td class="py-2 pr-4 hidden sm:table-cell">${h.by}</td>
    </tr>`).join('');
    }

    // ---- Modal helpers ----
    function openModal(title, bodyHTML) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = bodyHTML;
        document.getElementById('editModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function ruleForm() {
        return `
    <label class="block">Name<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="e.g., Org Default"></label>
    <label class="block mt-2">Scope<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Org-wide / Dept / Grade"></label>
    <label class="block mt-2">Method
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Daily Proration</option>
        <option>Hourly (8h/day)</option>
        <option>Flat per day</option>
      </select>
    </label>
    <label class="block mt-2">Denominator
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Calendar Days (30)</option>
        <option>Working Days</option>
        <option>Actual Days in Month</option>
      </select>
    </label>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
      <label class="flex items-center gap-2"><input type="checkbox" checked class="h-4 w-4"> Support half-day (0.5)</label>
      <label class="block">Rounding
        <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
          <option>2 decimals</option><option>Nearest ₹1</option><option>No rounding</option>
        </select>
      </label>
    </div>
    <div class="mt-2"><label class="flex items-center gap-2"><input type="checkbox" checked class="h-4 w-4"> Active</label></div>`;
    }
    function importForm() {
        return `
    <div class="space-y-2">
      <label class="block">Cycle
        <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Sep 2025">
      </label>
      <label class="block">CSV Columns (preview)
        <div class="mt-1 rounded-lg border border-slate-200 px-3 py-2 text-slate-600 text-xs">
          emp_code,date,lop_units,remark
        </div>
      </label>
      <div class="text-xs text-slate-500">Tip: half-day = 0.5; multiple rows per employee allowed.</div>
    </div>`;
    }
    function mapForm() {
        return `
    <label class="block">Source System
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Biometrics</option><option>HRMS</option><option>CSV Upload</option>
      </select>
    </label>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
      <label class="block">Emp Identifier → <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="emp_code"></label>
      <label class="block">Date Field → <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="date"></label>
      <label class="block">Units Field → <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="lop_units"></label>
      <label class="block">Note Field → <input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="remark"></label>
    </div>`;
    }

    // ---- Utils ----
    function badgeStatus(s) {
        const map = { active: 'bg-emerald-50 text-emerald-700', inactive: 'bg-slate-100 text-slate-700' };
        const label = s.charAt(0).toUpperCase() + s.slice(1);
        return `<span class="px-2 py-0.5 rounded-full ${map[s] || map['inactive']} text-xs">${label}</span>`;
    }
    function badgeImport(s) {
        const map = { applied: 'bg-emerald-50 text-emerald-700', draft: 'bg-amber-50 text-amber-700', failed: 'bg-red-50 text-red-700' };
        const label = s.charAt(0).toUpperCase() + s.slice(1);
        return `<span class="px-2 py-0.5 rounded-full ${map[s] || map['draft']} text-xs">${label}</span>`;
    }
    function badgeLite(s) { return `<span class="px-2 py-0.5 rounded-full bg-slate-50 text-slate-700 text-xs">${s}</span>`; }
    function emptyRow(colspan) { return `<tr><td colspan="${colspan}" class="py-6 text-center text-slate-500">No records.</td></tr>`; }
</script>

<style>
    .lop-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .lop-tab:not(.active) {
        color: #64748b;
    }

    .lop-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
{% endblock %}