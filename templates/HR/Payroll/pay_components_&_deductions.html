{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-layer-group mr-2"></i> Pay Components & Deductions
            </h1>
            <p class="text-slate-600 text-sm">Define earnings, deduction heads, and policies.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="btnNewEarn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> New Earning
            </button>
            <button id="btnNewDed" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
                <i class="fa-solid fa-minus mr-1"></i> New Deduction
            </button>
            <button id="btnNewPol" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                <i class="fa-solid fa-scale-balanced mr-1"></i> New Policy
            </button>
            <button id="btnExport"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-arrow-down mr-1"></i> Export
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab" class="pcd-tab active px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-gauge-high mr-1"></i> Overview
            </button>
            <button id="earningsTab" class="pcd-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-arrow-trend-up mr-1"></i> Earnings
            </button>
            <button id="deductionsTab" class="pcd-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-arrow-trend-down mr-1"></i> Deductions
            </button>
            <button id="policiesTab" class="pcd-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-scale-balanced mr-1"></i> Policies
            </button>
            <button id="historyTab" class="pcd-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-clock-rotate-left mr-1"></i> History
            </button>
            <button id="settingsTab" class="pcd-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-gear mr-1"></i> Settings
            </button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="pcd-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- KPIs -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-clipboard-list mr-2"></i> Catalog
                    </h3>
                    <span id="catalogBadge" class="px-2 py-1 text-xs rounded bg-amber-50 text-amber-700">Draft</span>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Earnings</div>
                        <div id="kpiEarn" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Deductions</div>
                        <div id="kpiDed" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Policies</div>
                        <div id="kpiPol" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Inactive</div>
                        <div id="kpiInactive" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>
                <div class="relative h-40 mt-4">
                    <canvas id="overviewChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <button id="btnValidate"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-spell-check mr-1"></i> Validate Catalog
                    </button>
                    <button id="btnImport"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-file-import mr-1"></i> Import CSV
                    </button>
                </div>
            </div>

            <!-- Mix -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Status Mix
                    </h3>
                </div>
                <div class="relative h-40">
                    <canvas id="mixChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 text-sm text-slate-700"></div>
            </div>

            <!-- Quick Actions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-3">
                    <i class="fa-solid fa-bolt mr-2"></i> Quick Actions
                </h3>
                <div class="space-y-3">
                    <button id="btnPreviewSlip"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-eye mr-2"></i> Preview sample payslip impact
                    </button>
                    <button id="btnSyncPolicies"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-rotate mr-2"></i> Recompute with policies
                    </button>
                    <button id="btnRollback"
                        class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 text-left">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Rollback last change
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Earnings -->
    <section id="earningsPanel" class="pcd-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-arrow-trend-up mr-2"></i> Earnings Heads
                </h3>
                <div class="flex items-center gap-2">
                    <input id="earnSearch" type="text" placeholder="Search name or code..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <select id="earnStatus" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4">Code</th>
                            <th class="py-2 pr-4">Calc</th>
                            <th class="py-2 pr-4">Taxable</th>
                            <th class="py-2 pr-4">PF</th>
                            <th class="py-2 pr-4">ESI</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="earnRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Deductions -->
    <section id="deductionsPanel" class="pcd-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-arrow-trend-down mr-2"></i> Deduction Heads
                </h3>
                <div class="flex items-center gap-2">
                    <input id="dedSearch" type="text" placeholder="Search name or code..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <select id="dedStatus" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4">Code</th>
                            <th class="py-2 pr-4">Calc</th>
                            <th class="py-2 pr-4">Pre/Post Tax</th>
                            <th class="py-2 pr-4">Cap/Limit</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dedRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Policies -->
    <section id="policiesPanel" class="pcd-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-scale-balanced mr-2"></i> Policies
                </h3>
                <div class="flex items-center gap-2">
                    <input id="polSearch" type="text" placeholder="Search policy..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <select id="polStatus" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Policy</th>
                            <th class="py-2 pr-4">Scope</th>
                            <th class="py-2 pr-4">Rule</th>
                            <th class="py-2 pr-4">Effective</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="polRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- History -->
    <section id="historyPanel" class="pcd-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-table mr-2"></i> Change History
                </h3>
                <div class="text-sm text-slate-600">Last 10 edits</div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Time</th>
                            <th class="py-2 pr-4">Type</th>
                            <th class="py-2 pr-4">Name</th>
                            <th class="py-2 pr-4">Action</th>
                            <th class="py-2 pr-4">By</th>
                        </tr>
                    </thead>
                    <tbody id="histRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Settings -->
    <section id="settingsPanel" class="pcd-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-lock mr-2"></i> Defaults
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center gap-2"><input id="stRound" type="checkbox" checked> Round to nearest
                        ₹1</label>
                    <label class="flex items-center gap-2"><input id="stProrate" type="checkbox" checked> Prorate by
                        DOJ/DOL</label>
                    <label class="flex items-center gap-2"><input id="stBackpay" type="checkbox"> Allow backpay
                        adjustments</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-shield-halved mr-2"></i> Compliance
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center gap-2"><input id="stPF" type="checkbox" checked> Enforce PF
                        statutory limits</label>
                    <label class="flex items-center gap-2"><input id="stESI" type="checkbox" checked> Enforce ESI
                        thresholds</label>
                    <label class="flex items-center gap-2"><input id="stPT" type="checkbox"> Enable Professional
                        Tax</label>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-clock mr-2"></i> Versioning
                </h3>
                <div class="space-y-2 text-sm">
                    <label class="block">Effective from:
                        <input id="stEff" type="date" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
                    </label>
                    <button id="stSave"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm mt-2">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Modal (New Head/Policy) - Demo -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 id="modalTitle" class="text-lg font-semibold text-slate-800">New</h3>
                    <button id="closeModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4 text-sm" id="modalBody">
                    <!-- dynamic form content -->
                </div>
                <div class="px-6 pb-6 flex items-center justify-end gap-2">
                    <button id="cancelEdit"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                    <button id="saveEdit" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
                        <i class="fa-solid fa-check mr-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ---- Demo Data ---- */
    const EARNINGS = [
        { id: 1, name: 'Basic Pay', code: 'BASIC', calc: 'Fixed', taxable: true, pf: true, esi: false, status: 'active' },
        { id: 2, name: 'HRA', code: 'HRA', calc: 'Percentage of BASIC (40%)', taxable: true, pf: false, esi: false, status: 'active' },
        { id: 3, name: 'Special Allowance', code: 'SA', calc: 'Remainder', taxable: true, pf: true, esi: false, status: 'active' },
        { id: 4, name: 'Meal Card', code: 'MEAL', calc: 'Fixed', taxable: false, pf: false, esi: false, status: 'inactive' }
    ];
    const DEDUCTIONS = [
        { id: 11, name: 'PF Employee', code: 'PFEE', calc: '12% of PF Wages', pretax: 'Pre-tax', cap: '₹15,000 base', status: 'active' },
        { id: 12, name: 'ESI Employee', code: 'ESIE', calc: '0.75% of Gross (ESI)', pretax: 'Pre-tax', cap: 'As per threshold', status: 'active' },
        { id: 13, name: 'Professional Tax', code: 'PT', calc: 'Slab (State)', pretax: 'Pre-tax', cap: '₹200/mo (example)', status: 'inactive' }
    ];
    const POLICIES = [
        { id: 21, policy: 'CTC Structure v2', scope: 'Org-wide', rule: 'BASIC 50% of CTC; HRA 40% of BASIC', eff: '2025-04-01', status: 'active' },
        { id: 22, policy: 'ESI Eligibility', scope: 'Salary ≤ ₹30,000', rule: 'Auto-enroll ESI heads', eff: '2025-04-01', status: 'active' },
        { id: 23, policy: 'PT City Slab', scope: 'BLR/MUM', rule: 'Apply state-specific PT slabs', eff: '2025-04-01', status: 'inactive' }
    ];
    const HISTORY = [
        { ts: '2025-09-12 10:05', type: 'Earning', name: 'HRA', action: 'Updated calc to 40%', by: 'System' },
        { ts: '2025-08-30 16:20', type: 'Policy', name: 'CTC Structure v2', action: 'Activated', by: 'HR Admin' },
        { ts: '2025-08-05 11:10', type: 'Deduction', name: 'PT', action: 'Deactivated', by: 'Payroll' }
    ];

    /* ---- Panels/Tabs ---- */
    const panels = {
        overview: document.getElementById('overviewPanel'),
        earnings: document.getElementById('earningsPanel'),
        deductions: document.getElementById('deductionsPanel'),
        policies: document.getElementById('policiesPanel'),
        history: document.getElementById('historyPanel'),
        settings: document.getElementById('settingsPanel')
    };
    let _overviewChart, _mixChart;

    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        wireButtons();
        renderOverview();
        drawCharts();
        renderEarnings();
        renderDeductions();
        renderPolicies();
        renderHistory();
    });

    function setupTabs() {
        document.querySelectorAll('.pcd-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.pcd-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name].classList.remove('hidden');
            });
        });
    }

    function wireButtons() {
        document.getElementById('btnNewEarn').addEventListener('click', () => openModal('New Earning', earningForm()));
        document.getElementById('btnNewDed').addEventListener('click', () => openModal('New Deduction', deductionForm()));
        document.getElementById('btnNewPol').addEventListener('click', () => openModal('New Policy', policyForm()));
        document.getElementById('btnExport').addEventListener('click', () => alert('✅ Exported (demo)'));
        document.getElementById('btnPreviewSlip').addEventListener('click', () => alert('👀 Sample impact previewed (demo)'));
        document.getElementById('btnSyncPolicies').addEventListener('click', () => alert('🔁 Recomputed with policies (demo)'));
        document.getElementById('btnRollback').addEventListener('click', () => alert('↩️ Rolled back (demo)'));
        document.getElementById('btnValidate').addEventListener('click', () => alert('✅ Validation passed (demo)'));
        document.getElementById('btnImport').addEventListener('click', () => alert('📥 Import dialog (demo)'));

        document.getElementById('earnSearch').addEventListener('input', renderEarnings);
        document.getElementById('earnStatus').addEventListener('change', renderEarnings);
        document.getElementById('dedSearch').addEventListener('input', renderDeductions);
        document.getElementById('dedStatus').addEventListener('change', renderDeductions);
        document.getElementById('polSearch').addEventListener('input', renderPolicies);
        document.getElementById('polStatus').addEventListener('change', renderPolicies);

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelEdit').addEventListener('click', closeModal);
        document.getElementById('saveEdit').addEventListener('click', () => { closeModal(); alert('💾 Saved (demo)'); });

        document.getElementById('stSave').addEventListener('click', () => alert('✅ Settings saved'));
    }

    /* ---- Overview ---- */
    function renderOverview() {
        const earn = EARNINGS.length;
        const ded = DEDUCTIONS.length;
        const pol = POLICIES.length;
        const inactive = EARNINGS.filter(x => x.status === 'inactive').length + DEDUCTIONS.filter(x => x.status === 'inactive').length + POLICIES.filter(x => x.status === 'inactive').length;
        document.getElementById('kpiEarn').textContent = earn;
        document.getElementById('kpiDed').textContent = ded;
        document.getElementById('kpiPol').textContent = pol;
        document.getElementById('kpiInactive').textContent = inactive;
        const badge = document.getElementById('catalogBadge');
        const allActive = inactive === 0 && (earn + ded + pol) > 0;
        badge.textContent = allActive ? 'Ready' : (earn + ded + pol > 0 ? 'In Progress' : 'Draft');
        badge.className = 'px-2 py-1 text-xs rounded ' + (allActive ? 'bg-emerald-50 text-emerald-700' : (earn + ded + pol > 0 ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-700'));
    }

    function drawCharts() {
        const ctx1 = document.getElementById('overviewChart').getContext('2d');
        if (_overviewChart) _overviewChart.destroy();
        _overviewChart = new Chart(ctx1, {
            type: 'bar',
            data: { labels: ['Earnings', 'Deductions', 'Policies', 'Inactive'], datasets: [{ label: 'Count', data: [EARNINGS.length, DEDUCTIONS.length, POLICIES.length, document.getElementById('kpiInactive').textContent | 0] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        const counts = {
            active: EARNINGS.filter(x => x.status === 'active').length + DEDUCTIONS.filter(x => x.status === 'active').length + POLICIES.filter(x => x.status === 'active').length,
            inactive: EARNINGS.filter(x => x.status === 'inactive').length + DEDUCTIONS.filter(x => x.status === 'inactive').length + POLICIES.filter(x => x.status === 'inactive').length
        };
        const ctx2 = document.getElementById('mixChart').getContext('2d');
        if (_mixChart) _mixChart.destroy();
        _mixChart = new Chart(ctx2, {
            type: 'doughnut',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } }, animation: false }
        });
        document.getElementById('mixLegend').innerHTML =
            Object.entries(counts).map(([k, v]) => `<div class="flex items-center justify-between text-sm"><span class="capitalize">${k}</span><span>${v}</span></div>`).join('');
    }

    /* ---- Earnings ---- */
    function renderEarnings() {
        const q = (document.getElementById('earnSearch').value || '').toLowerCase();
        const st = document.getElementById('earnStatus').value;
        const rows = EARNINGS
            .filter(r => (st === 'all' ? true : r.status === st))
            .filter(r => r.name.toLowerCase().includes(q) || r.code.toLowerCase().includes(q) || (r.calc || '').toLowerCase().includes(q))
            .slice().sort((a, b) => a.name.localeCompare(b.name));
        document.getElementById('earnRows').innerHTML = rows.map(rowEarn).join('') || emptyRow(8);
    }
    function rowEarn(r) {
        return `<tr class="border-b last:border-0">
    <td class="py-2 pr-4">${r.name}</td>
    <td class="py-2 pr-4">${r.code}</td>
    <td class="py-2 pr-4">${r.calc}</td>
    <td class="py-2 pr-4">${badgePlain(r.taxable ? 'Yes' : 'No')}</td>
    <td class="py-2 pr-4">${badgePlain(r.pf ? 'Yes' : 'No')}</td>
    <td class="py-2 pr-4">${badgePlain(r.esi ? 'Yes' : 'No')}</td>
    <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
    <td class="py-2 pr-4">
      <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('✏️ Edit ${r.name} (demo)')">
        <i class="fa-solid fa-pen mr-1"></i> Edit
      </button>
    </td>
  </tr>`;
    }

    /* ---- Deductions ---- */
    function renderDeductions() {
        const q = (document.getElementById('dedSearch').value || '').toLowerCase();
        const st = document.getElementById('dedStatus').value;
        const rows = DEDUCTIONS
            .filter(r => (st === 'all' ? true : r.status === st))
            .filter(r => r.name.toLowerCase().includes(q) || r.code.toLowerCase().includes(q) || (r.calc || '').toLowerCase().includes(q))
            .slice().sort((a, b) => a.name.localeCompare(b.name));
        document.getElementById('dedRows').innerHTML = rows.map(rowDed).join('') || emptyRow(7);
    }
    function rowDed(r) {
        return `<tr class="border-b last:border-0">
    <td class="py-2 pr-4">${r.name}</td>
    <td class="py-2 pr-4">${r.code}</td>
    <td class="py-2 pr-4">${r.calc}</td>
    <td class="py-2 pr-4">${r.pretax}</td>
    <td class="py-2 pr-4">${r.cap}</td>
    <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
    <td class="py-2 pr-4">
      <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('✏️ Edit ${r.name} (demo)')">
        <i class="fa-solid fa-pen mr-1"></i> Edit
      </button>
    </td>
  </tr>`;
    }

    /* ---- Policies ---- */
    function renderPolicies() {
        const q = (document.getElementById('polSearch').value || '').toLowerCase();
        const st = document.getElementById('polStatus').value;
        const rows = POLICIES
            .filter(r => (st === 'all' ? true : r.status === st))
            .filter(r => r.policy.toLowerCase().includes(q) || r.rule.toLowerCase().includes(q) || (r.scope || '').toLowerCase().includes(q))
            .slice().sort((a, b) => a.policy.localeCompare(b.policy));
        document.getElementById('polRows').innerHTML = rows.map(rowPol).join('') || emptyRow(6);
    }
    function rowPol(r) {
        return `<tr class="border-b last:border-0">
    <td class="py-2 pr-4">${r.policy}</td>
    <td class="py-2 pr-4">${r.scope}</td>
    <td class="py-2 pr-4">${r.rule}</td>
    <td class="py-2 pr-4">${r.eff}</td>
    <td class="py-2 pr-4">${badgeStatus(r.status)}</td>
    <td class="py-2 pr-4">
      <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('✏️ Edit ${r.policy} (demo)')">
        <i class="fa-solid fa-pen mr-1"></i> Edit
      </button>
    </td>
  </tr>`;
    }

    /* ---- History ---- */
    function renderHistory() {
        document.getElementById('histRows').innerHTML = HISTORY.map(h => `
    <tr class="border-b last:border-0">
      <td class="py-2 pr-4 text-slate-600">${h.ts}</td>
      <td class="py-2 pr-4">${h.type}</td>
      <td class="py-2 pr-4">${h.name}</td>
      <td class="py-2 pr-4">${h.action}</td>
      <td class="py-2 pr-4">${h.by}</td>
    </tr>`).join('');
    }

    /* ---- Modal helpers (demo only) ---- */
    function openModal(title, bodyHTML) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = bodyHTML;
        document.getElementById('editModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('editModal').classList.add('hidden'); }

    function earningForm() {
        return `
    <label class="block">Name<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="e.g., Basic Pay"></label>
    <label class="block mt-2">Code<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="BASIC"></label>
    <label class="block mt-2">Calculation
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Fixed</option><option>Percentage of head</option><option>Remainder</option>
      </select>
    </label>
    <div class="mt-2 space-y-2">
      <label class="flex items-center gap-2"><input type="checkbox" checked> Taxable</label>
      <label class="flex items-center gap-2"><input type="checkbox" checked> Include in PF</label>
      <label class="flex items-center gap-2"><input type="checkbox"> Include in ESI</label>
    </div>`;
    }
    function deductionForm() {
        return `
    <label class="block">Name<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="e.g., PF Employee"></label>
    <label class="block mt-2">Code<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="PFEE"></label>
    <label class="block mt-2">Calculation
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Fixed</option><option>Percentage</option><option>Slab</option>
      </select>
    </label>
    <label class="block mt-2">Pre/Post Tax
      <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2">
        <option>Pre-tax</option><option>Post-tax</option>
      </select>
    </label>
    <label class="block mt-2">Cap/Limit<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Optional"></label>`;
    }
    function policyForm() {
        return `
    <label class="block">Policy Name<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="CTC Structure v3"></label>
    <label class="block mt-2">Scope<input class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Org-wide / Dept / Grade"></label>
    <label class="block mt-2">Rule<textarea class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" rows="3" placeholder="DSL or description"></textarea></label>
    <label class="block mt-2">Effective<input type="date" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2"></label>
    <div class="mt-2"><label class="flex items-center gap-2"><input type="checkbox" checked> Active</label></div>`;
    }

    /* ---- Utils ---- */
    function badgeStatus(s) {
        return `<span class="px-2 py-0.5 rounded-full ${s === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-700'} text-xs">${s.charAt(0).toUpperCase() + s.slice(1)}</span>`;
    }
    function badgePlain(s) { return `<span class="px-2 py-0.5 rounded-full bg-slate-50 text-slate-700 text-xs">${s}</span>`; }
    function emptyRow(colspan) {
        return `<tr><td colspan="${colspan}" class="py-6 text-center text-slate-500">No records.</td></tr>`;
    }
</script>

<style>
    .pcd-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .pcd-tab:not(.active) {
        color: #64748b;
    }

    .pcd-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}