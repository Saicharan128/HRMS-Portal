{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-arrow-down mr-1"></i> Export CSV
            </button>
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Report Categories -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- HR Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-blue-100 rounded-lg mr-3">
                    <i class="fa-solid fa-users text-blue-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">HR Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('employee_roster')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-user-group mr-2 text-slate-500"></i> Employee Roster
                </button>
                <button onclick="generateQuickReport('headcount_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-chart-line mr-2 text-slate-500"></i> Headcount Analysis
                </button>
                <button onclick="generateQuickReport('turnover_report')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-door-open mr-2 text-slate-500"></i> Turnover Report
                </button>
                <button onclick="generateQuickReport('diversity_metrics')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> Diversity Metrics
                </button>
                <button onclick="generateQuickReport('recruitment_pipeline')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-funnel-dollar mr-2 text-slate-500"></i> Recruitment Pipeline
                </button>
            </div>
        </div>

        <!-- Performance Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-green-100 rounded-lg mr-3">
                    <i class="fa-solid fa-chart-line text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Performance Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('performance_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-star mr-2 text-slate-500"></i> Performance Summary
                </button>
                <button onclick="generateQuickReport('goal_achievement')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-target mr-2 text-slate-500"></i> Goal Achievement
                </button>
                <button onclick="generateQuickReport('review_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-clipboard-check mr-2 text-slate-500"></i> Review Completion
                </button>
                <button onclick="generateQuickReport('top_performers')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-trophy mr-2 text-slate-500"></i> Top Performers
                </button>
                <button onclick="generateQuickReport('training_completion')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-graduation-cap mr-2 text-slate-500"></i> Training Completion
                </button>
            </div>
        </div>

        <!-- Financial Reports -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                    <i class="fa-solid fa-dollar-sign text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Financial Reports</h3>
            </div>
            <div class="space-y-2">
                <button onclick="generateQuickReport('payroll_summary')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-money-bill mr-2 text-slate-500"></i> Payroll Summary
                </button>
                <button onclick="generateQuickReport('cost_analysis')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-calculator mr-2 text-slate-500"></i> Cost Analysis
                </button>
                <button onclick="generateQuickReport('expense_reports')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-receipt mr-2 text-slate-500"></i> Expense Reports
                </button>
                <button onclick="generateQuickReport('budget_variance')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-chart-pie mr-2 text-slate-500"></i> Budget Variance
                </button>
                <button onclick="generateQuickReport('contractor_payments')"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-handshake mr-2 text-slate-500"></i> Contractor Payments
                </button>
            </div>
        </div>
    </div>

    <!-- Time & Attendance + Compliance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-purple-100 rounded-lg mr-3">
                    <i class="fa-solid fa-clock text-purple-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Time & Attendance</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('attendance_summary')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-calendar-days mr-2 text-slate-500"></i> Attendance Summary
                </button>
                <button onclick="generateQuickReport('leave_analysis')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-plane-departure mr-2 text-slate-500"></i> Leave Analysis
                </button>
                <button onclick="generateQuickReport('overtime_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-clock mr-2 text-slate-500"></i> Overtime Report
                </button>
                <button onclick="generateQuickReport('tardiness_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-exclamation-triangle mr-2 text-slate-500"></i> Tardiness Report
                </button>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-red-100 rounded-lg mr-3">
                    <i class="fa-solid fa-shield-halved text-red-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Compliance & Legal</h3>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generateQuickReport('eeo_report')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-balance-scale mr-2 text-slate-500"></i> EEO Report
                </button>
                <button onclick="generateQuickReport('safety_incidents')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-hard-hat mr-2 text-slate-500"></i> Safety Incidents
                </button>
                <button onclick="generateQuickReport('policy_compliance')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-file-contract mr-2 text-slate-500"></i> Policy Compliance
                </button>
                <button onclick="generateQuickReport('audit_trail')"
                    class="text-left px-3 py-2 rounded-lg hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-search mr-2 text-slate-500"></i> Audit Trail
                </button>
            </div>
        </div>
    </div>

    <!-- Reports Dashboard -->
    <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <h2 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-list mr-2"></i> Generated Reports
                </h2>
                <div class="flex items-center gap-3 flex-wrap">
                    <input id="searchInput" placeholder="Search reportsâ€¦"
                        class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Type:</label>
                        <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="">All Types</option>
                            <option value="hr">HR Reports</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="attendance">Time & Attendance</option>
                            <option value="compliance">Compliance</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-600">Period:</label>
                        <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Generated Yet</h3>
            <p class="text-slate-600 mb-4">Start by generating your first report from the categories above.</p>
        </div>

        <!-- Reports Table -->
        <div id="reportsTable" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Report Name</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Type</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Generated</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Generated By</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Size</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Status</th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="p-6 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">
                    Showing <span id="pageInfo">0-0 of 0</span> reports
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>
                        Previous
                    </button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div id="generateReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800">
                            <i class="fa-solid fa-chart-simple mr-2"></i> Generate Custom Report
                        </h3>
                        <button id="closeGenerateModal" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <form id="generateReportForm" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Type *</label>
                            <select name="report_type" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Report Type</option>
                                <option value="hr">HR Report</option>
                                <option value="performance">Performance Report</option>
                                <option value="financial">Financial Report</option>
                                <option value="attendance">Time & Attendance</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Report Template *</label>
                            <select name="template_id" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Template</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Date Range *</label>
                            <select name="date_range" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Range</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_quarter">Current Quarter</option>
                                <option value="last_year">Last Year</option>
                                <option value="current_year">Current Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Format *</label>
                            <select name="format" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="pdf">PDF Document</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="csv">CSV File</option>
                                <option value="html">HTML Report</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Date Range -->
                    <div id="customDateRange" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                            <input type="date" name="start_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                            <input type="date" name="end_date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Departments</label>
                            <select name="departments[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Departments</option>
                                <option value="engineering">Engineering</option>
                                <option value="sales">Sales</option>
                                <option value="marketing">Marketing</option>
                                <option value="hr">Human Resources</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Employee Types</label>
                            <select name="employee_types[]" multiple
                                class="w-full rounded-lg border border-slate-300 px-3 py-2" size="4">
                                <option value="all" selected>All Types</option>
                                <option value="full_time">Full Time</option>
                                <option value="part_time">Part Time</option>
                                <option value="contractor">Contractor</option>
                                <option value="intern">Intern</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Report Name</label>
                        <input type="text" name="report_name" placeholder="Enter custom name (optional)"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>

                    <div class="flex items-start gap-3">
                        <input type="checkbox" name="schedule_report" id="scheduleReport"
                            class="mt-1 rounded border-slate-300">
                        <div>
                            <label for="scheduleReport" class="block text-sm font-medium text-slate-700">Schedule
                                recurring report</label>
                            <p class="text-xs text-slate-500">Generate this report automatically at regular intervals
                            </p>
                        </div>
                    </div>

                    <div id="scheduleOptions" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Frequency</label>
                            <select name="frequency" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Recipients</label>
                            <input type="email" name="recipients" placeholder="email1@company.com, email2@company.com"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <button type="button" id="cancelGenerate"
                            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
                            <i class="fa-solid fa-cog mr-1"></i> Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div id="reportPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800">
                            <i class="fa-solid fa-eye mr-2"></i> Report Preview
                        </h3>
                        <div class="flex items-center gap-2">
                            <button id="downloadReportBtn"
                                class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
                                <i class="fa-solid fa-download mr-1"></i> Download
                            </button>
                            <button id="closePreviewModal" class="text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="reportPreviewContent" class="p-6"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toasts -->
<div id="successToast"
    class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-check-circle mr-2"></i><span id="successMessage"></span></div>
</div>
<div id="errorToast"
    class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-exclamation-circle mr-2"></i><span id="errorMessage"></span>
    </div>
</div>
<div id="infoToast"
    class="fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full">
    <div class="flex items-center"><i class="fa-solid fa-info-circle mr-2"></i><span id="infoMessage"></span></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', initializeReports);

    /* ===== State ===== */
    let reports = [];
    let filteredReports = [];
    let currentPage = 1;
    let totalPages = 1;
    let reportIdCounter = 6;

    /* ===== Init ===== */
    async function initializeReports() {
        await loadReportsData();
        setupEventListeners();
        renderReports();
    }

    /* ===== Data (mock) ===== */
    async function loadReportsData() {
        try {
            document.getElementById('loadingState').classList.remove('hidden');
            await new Promise(r => setTimeout(r, 600)); // simulate API

            const mockReports = [
                { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", format: "pdf", status: "completed", download_count: 15 },
                { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", format: "excel", status: "completed", download_count: 8 },
                { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", format: "pdf", status: "completed", download_count: 22 },
                { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", format: "csv", status: "processing", download_count: 0 },
                { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "987 KB", format: "pdf", status: "completed", download_count: 5 }
            ];

            reports = mockReports;
            filteredReports = [...reports];
            updateSummaryStats();
        } catch (e) {
            console.error(e);
            showError('Failed to load reports data');
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
        }
    }

    /* ===== Stats ===== */
    function updateSummaryStats() {
        const todayStr = new Date().toDateString();
        const today = reports.filter(r => new Date(r.generated_date).toDateString() === todayStr).length;
        const downloads = reports.reduce((a, r) => a + (r.download_count || 0), 0);
        const scheduled = 3; // mock

        document.getElementById('totalReports').textContent = reports.length;
        document.getElementById('todayReports').textContent = today;
        document.getElementById('totalDownloads').textContent = downloads;
        document.getElementById('scheduledReports').textContent = scheduled;
    }

    /* ===== Events ===== */
    function setupEventListeners() {
        // Modals
        document.getElementById('newReportBtn').addEventListener('click', openGenerateReportModal);
        document.getElementById('closeGenerateModal').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('cancelGenerate').addEventListener('click', () => closeModal('generateReportModal'));
        document.getElementById('closePreviewModal').addEventListener('click', () => closeModal('reportPreviewModal'));

        // Form
        document.getElementById('generateReportForm').addEventListener('submit', handleGenerateReport);
        document.querySelector('select[name="report_type"]').addEventListener('change', updateTemplateOptions);
        document.querySelector('select[name="date_range"]').addEventListener('change', toggleCustomDateRange);
        document.getElementById('scheduleReport').addEventListener('change', toggleScheduleOptions);

        // Filters
        document.getElementById('reportTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 250));
        document.getElementById('refreshReports').addEventListener('click', loadReportsData);

        // Pagination
        document.getElementById('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderReports(); } });
        document.getElementById('nextPageBtn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderReports(); } });

        // Preview download
        document.getElementById('downloadReportBtn').addEventListener('click', () => showInfo('Download functionality would be implemented here'));

        // Outside click closes modals
        window.addEventListener('click', (e) => {
            ['generateReportModal', 'reportPreviewModal'].forEach(id => {
                const m = document.getElementById(id);
                if (e.target === m) { closeModal(id); }
            });
        });

        // Export CSV
        document.getElementById('exportCsvBtn').addEventListener('click', exportFilteredCsv);
    }

    /* ===== Modal helpers ===== */
    function openGenerateReportModal() { document.getElementById('generateReportModal').classList.remove('hidden'); }
    function closeModal(id) {
        const el = document.getElementById(id);
        el.classList.add('hidden');
        if (id === 'generateReportModal') {
            document.getElementById('generateReportForm').reset();
            document.getElementById('customDateRange').classList.add('hidden');
            document.getElementById('scheduleOptions').classList.add('hidden');
            updateTemplateOptions(); // reset templates
        }
    }
    function updateTemplateOptions() {
        const reportType = document.querySelector('select[name="report_type"]').value;
        const sel = document.querySelector('select[name="template_id"]');
        sel.innerHTML = '<option value="">Select Template</option>';
        const templates = {
            hr: [
                { value: 'employee_roster', text: 'Employee Roster' },
                { value: 'headcount_analysis', text: 'Headcount Analysis' },
                { value: 'turnover_report', text: 'Turnover Report' },
                { value: 'diversity_metrics', text: 'Diversity Metrics' }
            ],
            performance: [
                { value: 'performance_summary', text: 'Performance Summary' },
                { value: 'goal_achievement', text: 'Goal Achievement' },
                { value: 'review_completion', text: 'Review Completion' },
                { value: 'top_performers', text: 'Top Performers' }
            ],
            financial: [
                { value: 'payroll_summary', text: 'Payroll Summary' },
                { value: 'cost_analysis', text: 'Cost Analysis' },
                { value: 'expense_reports', text: 'Expense Reports' },
                { value: 'budget_variance', text: 'Budget Variance' }
            ],
            attendance: [
                { value: 'attendance_summary', text: 'Attendance Summary' },
                { value: 'leave_analysis', text: 'Leave Analysis' },
                { value: 'overtime_report', text: 'Overtime Report' },
                { value: 'tardiness_report', text: 'Tardiness Report' }
            ],
            compliance: [
                { value: 'eeo_report', text: 'EEO Report' },
                { value: 'safety_incidents', text: 'Safety Incidents' },
                { value: 'policy_compliance', text: 'Policy Compliance' },
                { value: 'audit_trail', text: 'Audit Trail' }
            ]
        };
        (templates[reportType] || []).forEach(t => {
            const op = document.createElement('option'); op.value = t.value; op.textContent = t.text; sel.appendChild(op);
        });
    }
    function toggleCustomDateRange() {
        const v = document.querySelector('select[name="date_range"]').value;
        document.getElementById('customDateRange').classList.toggle('hidden', v !== 'custom');
    }
    function toggleScheduleOptions() {
        const checked = document.getElementById('scheduleReport').checked;
        document.getElementById('scheduleOptions').classList.toggle('hidden', !checked);
    }

    /* ===== Create / Quick Create ===== */
    async function handleGenerateReport(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const orig = btn.innerHTML;
        try {
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating...';
            btn.disabled = true;
            await new Promise(r => setTimeout(r, 1200));

            const newReport = {
                id: reportIdCounter++,
                name: data.report_name || `${formatReportName(data.template_id)} - ${new Date().toLocaleDateString()}`,
                type: data.report_type,
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: data.format,
                status: "completed",
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            showSuccess('Report generated successfully!');
            closeModal('generateReportModal');
            updateSummaryStats();
            renderReports();
        } catch (e) {
            console.error(e);
            showError('Failed to generate report');
        } finally {
            btn.innerHTML = orig;
            btn.disabled = false;
        }
    }

    async function generateQuickReport(template) {
        try {
            showInfo(`Generating ${formatReportName(template)} report...`);
            await new Promise(r => setTimeout(r, 900));
            const newReport = {
                id: reportIdCounter++,
                name: `${formatReportName(template)} - ${new Date().toLocaleDateString()}`,
                type: getReportTypeFromTemplate(template),
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${(Math.random() * 3 + 0.5).toFixed(1)} MB`,
                format: "pdf",
                status: "completed",
                download_count: 0
            };
            reports.unshift(newReport);
            filteredReports = [...reports];
            showSuccess(`${formatReportName(template)} report generated successfully!`);
            updateSummaryStats(); renderReports();
        } catch (e) {
            console.error(e);
            showError('Failed to generate report');
        }
    }
    function getReportTypeFromTemplate(t) {
        const m = {
            employee_roster: 'hr', headcount_analysis: 'hr', turnover_report: 'hr', diversity_metrics: 'hr', recruitment_pipeline: 'hr',
            performance_summary: 'performance', goal_achievement: 'performance', review_completion: 'performance', top_performers: 'performance', training_completion: 'performance',
            payroll_summary: 'financial', cost_analysis: 'financial', expense_reports: 'financial', budget_variance: 'financial', contractor_payments: 'financial',
            attendance_summary: 'attendance', leave_analysis: 'attendance', overtime_report: 'attendance', tardiness_report: 'attendance',
            eeo_report: 'compliance', safety_incidents: 'compliance', policy_compliance: 'compliance', audit_trail: 'compliance'
        };
        return m[t] || 'hr';
    }
    function formatReportName(rt) { return (rt || '').split('_').map(w => w ? w[0].toUpperCase() + w.slice(1) : '').join(' '); }

    /* ===== Filtering / Search ===== */
    function applyFilters() {
        const type = document.getElementById('reportTypeFilter').value;
        const period = document.getElementById('periodFilter').value;
        const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();

        filteredReports = reports.filter(r => {
            const matchType = !type || r.type === type;
            let matchPeriod = true;
            if (period && period !== 'all') {
                const days = parseInt(period, 10);
                const cut = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                matchPeriod = new Date(r.generated_date) >= cut;
            }
            const hay = `${r.name} ${r.generated_by} ${r.type} ${r.format}`.toLowerCase();
            const matchQ = !q || hay.includes(q);
            return matchType && matchPeriod && matchQ;
        });

        currentPage = 1;
        renderReports();
    }

    /* ===== Render ===== */
    function renderReports() {
        const empty = filteredReports.length === 0;
        document.getElementById('emptyState').classList.toggle('hidden', !empty);
        document.getElementById('reportsTable').classList.toggle('hidden', empty);
        if (!empty) { renderReportsTable(); updatePagination(); }
    }
    function renderReportsTable() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '';

        const itemsPerPage = 10;
        const start = (currentPage - 1) * itemsPerPage;
        const pageReports = filteredReports.slice(start, start + itemsPerPage);

        pageReports.forEach(r => {
            const tr = document.createElement('tr'); tr.className = 'hover:bg-slate-50';
            tr.innerHTML = `
      <td class="px-6 py-4">
        <div>
          <div class="font-medium text-slate-800">${iconForFormat(r.format)} ${r.name}</div>
          <div class="text-sm text-slate-600">ID: #${r.id}</div>
        </div>
      </td>
      <td class="px-6 py-4">
        <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(r.type)}">${formatType(r.type)}</span>
      </td>
      <td class="px-6 py-4 text-slate-800">${formatDate(r.generated_date)}</td>
      <td class="px-6 py-4 text-slate-800">${r.generated_by}</td>
      <td class="px-6 py-4 text-slate-800">${r.file_size}</td>
      <td class="px-6 py-4">
        <span class="px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(r.status)}">${formatStatus(r.status)}</span>
      </td>
      <td class="px-6 py-4">
        <div class="flex items-center gap-2">
          ${r.status === 'completed' ? `
            <button onclick="previewReport(${r.id})" class="text-blue-600 hover:text-blue-800" title="Preview"><i class="fa-solid fa-eye"></i></button>
            <button onclick="downloadReport(${r.id})" class="text-green-600 hover:text-green-800" title="Download"><i class="fa-solid fa-download"></i></button>
            <button onclick="shareReport(${r.id})" class="text-purple-600 hover:text-purple-800" title="Share"><i class="fa-solid fa-share"></i></button>
          ` : `
            <span class="text-slate-400"><i class="fa-solid fa-clock" title="Processing"></i></span>
          `}
          <button onclick="deleteReport(${r.id})" class="text-red-600 hover:text-red-800" title="Delete"><i class="fa-solid fa-trash"></i></button>
        </div>
      </td>
    `;
            tbody.appendChild(tr);
        });
    }
    function updatePagination() {
        const itemsPerPage = 10;
        totalPages = Math.max(1, Math.ceil(filteredReports.length / itemsPerPage));
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredReports.length);
        document.getElementById('pageInfo').textContent = filteredReports.length ? `${start}-${end} of ${filteredReports.length}` : '0-0 of 0';

        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages;

        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                const b = document.createElement('button');
                b.textContent = i;
                b.className = i === currentPage ? 'px-3 py-1 rounded bg-slate-800 text-white text-sm'
                    : 'px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50';
                b.onclick = () => goToPage(i);
                pageNumbers.appendChild(b);
            } else if (Math.abs(i - currentPage) === 3) {
                const dots = document.createElement('span'); dots.textContent = '...'; dots.className = 'px-2 text-slate-400';
                pageNumbers.appendChild(dots);
            }
        }
    }
    function goToPage(p) { currentPage = p; renderReports(); }

    /* ===== UI helpers ===== */
    function getTypeBadgeClass(type) {
        const c = {
            hr: 'bg-blue-100 text-blue-700', performance: 'bg-green-100 text-green-700',
            financial: 'bg-yellow-100 text-yellow-700', attendance: 'bg-purple-100 text-purple-700',
            compliance: 'bg-red-100 text-red-700'
        };
        return c[type] || 'bg-slate-100 text-slate-700';
    }
    function formatType(t) {
        const m = { hr: 'HR Report', performance: 'Performance', financial: 'Financial', attendance: 'Time & Attendance', compliance: 'Compliance' };
        return m[t] || t;
    }
    function getStatusBadgeClass(s) {
        const c = { completed: 'bg-green-100 text-green-700', processing: 'bg-blue-100 text-blue-700', failed: 'bg-red-100 text-red-700', scheduled: 'bg-yellow-100 text-yellow-700' };
        return c[s] || 'bg-slate-100 text-slate-700';
    }
    function formatStatus(s) { return s ? s[0].toUpperCase() + s.slice(1) : ''; }
    function formatDate(d) {
        return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function iconForFormat(fmt) {
        const map = { pdf: 'fa-file-pdf text-rose-600', excel: 'fa-file-excel text-emerald-600', csv: 'fa-file-csv text-slate-600', html: 'fa-file-code text-indigo-600' };
        const cls = map[fmt] || 'fa-file text-slate-500';
        return `<i class="fa-solid ${cls} mr-2"></i>`;
    }

    /* ===== Preview / Download / Share / Delete ===== */
    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        document.getElementById('reportPreviewContent').innerHTML = generateReportPreview(r);
        document.getElementById('reportPreviewModal').classList.remove('hidden');
    }
    function generateReportPreview(r) {
        switch (r.type) {
            case 'hr': return hrPreview(r);
            case 'performance': return perfPreview(r);
            case 'financial': return finPreview(r);
            case 'attendance': return attPreview(r);
            case 'compliance': return compPreview(r);
            default: return '<p class="text-slate-600">Report preview not available.</p>';
        }
    }
    function hrPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4">
      <h4 class="text-xl font-semibold text-slate-800">${r.name}</h4>
      <p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${r.generated_by}</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Employees</h5><p class="text-2xl font-bold text-blue-600">247</p></div>
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">New Hires</h5><p class="text-2xl font-bold text-green-600">15</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Departures</h5><p class="text-2xl font-bold text-red-600">8</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Breakdown</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Engineering</span><span class="font-medium">95 employees</span></div>
        <div class="flex justify-between"><span>Sales</span><span class="font-medium">42 employees</span></div>
        <div class="flex justify-between"><span>Marketing</span><span class="font-medium">28 employees</span></div>
      </div>
    </div>
  </div>`;
    }
    function perfPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${r.name}</h4><p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${r.generated_by}</p></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Rating</h5><p class="text-2xl font-bold text-green-600">4.2/5</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Reviews Completed</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Goals Achieved</h5><p class="text-2xl font-bold text-yellow-600">76%</p></div>
      <div class="bg-purple-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Top Performers</h5><p class="text-2xl font-bold text-purple-600">23</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Performance Distribution</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Exceeds (4.5â€“5.0)</span><span class="font-medium">18%</span></div>
        <div class="flex justify-between"><span>Meets (3.5â€“4.4)</span><span class="font-medium">67%</span></div>
        <div class="flex justify-between"><span>Below (2.0â€“3.4)</span><span class="font-medium">15%</span></div>
      </div>
    </div>
  </div>`;
    }
    function finPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${r.name}</h4><p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${r.generated_by}</p></div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Total Payroll</h5><p class="text-2xl font-bold text-green-600">$1.2M</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Benefits Cost</h5><p class="text-2xl font-bold text-blue-600">$245K</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Expenses</h5><p class="text-2xl font-bold text-yellow-600">$89K</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Department Costs</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Engineering</span><span class="font-medium">$687,500</span></div>
        <div class="flex justify-between"><span>Sales</span><span class="font-medium">$312,000</span></div>
        <div class="flex justify-between"><span>Marketing</span><span class="font-medium">$156,000</span></div>
      </div>
    </div>
  </div>`;
    }
    function attPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${r.name}</h4><p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${r.generated_by}</p></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Avg Attendance</h5><p class="text-2xl font-bold text-green-600">94.2%</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">On Time %</h5><p class="text-2xl font-bold text-blue-600">87.5%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Leave Days</h5><p class="text-2xl font-bold text-yellow-600">156</p></div>
      <div class="bg-red-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Sick Days</h5><p class="text-2xl font-bold text-red-600">89</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Attendance Trends</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Perfect Attendance</span><span class="font-medium">42 employees</span></div>
        <div class="flex justify-between"><span>1â€“2 Absences</span><span class="font-medium">128 employees</span></div>
        <div class="flex justify-between"><span>3+ Absences</span><span class="font-medium">77 employees</span></div>
      </div>
    </div>
  </div>`;
    }
    function compPreview(r) {
        return `
  <div class="space-y-6">
    <div class="border-b border-slate-200 pb-4"><h4 class="text-xl font-semibold text-slate-800">${r.name}</h4><p class="text-slate-600">Generated on ${formatDate(r.generated_date)} by ${r.generated_by}</p></div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Compliance Score</h5><p class="text-2xl font-bold text-green-600">96%</p></div>
      <div class="bg-yellow-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Open Issues</h5><p class="text-2xl font-bold text-yellow-600">3</p></div>
      <div class="bg-blue-50 p-4 rounded-lg"><h5 class="font-medium text-slate-800">Training Complete</h5><p class="text-2xl font-bold text-blue-600">89%</p></div>
    </div>
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-medium text-slate-800 mb-3">Compliance Areas</h5>
      <div class="space-y-2">
        <div class="flex justify-between"><span>Equal Opportunity</span><span class="font-medium text-green-600">âœ“ Compliant</span></div>
        <div class="flex justify-between"><span>Safety Training</span><span class="font-medium text-green-600">âœ“ Compliant</span></div>
        <div class="flex justify-between"><span>Data Privacy</span><span class="font-medium text-yellow-600">âš  Review Required</span></div>
      </div>
    </div>
  </div>`;
    }

    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}...`);
        setTimeout(() => {
            r.download_count = (r.download_count || 0) + 1;
            updateSummaryStats(); renderReports();
            showSuccess('Report downloaded successfully!');
        }, 800);
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const data = { title: r.name, text: `Check out this report: ${r.name}`, url: window.location.href + `?report=${r.id}` };
        if (navigator.share) { navigator.share(data); } else {
            navigator.clipboard.writeText(data.url).then(() => showSuccess('Report link copied to clipboard!'))
                .catch(() => showInfo('Share functionality not available'));
        }
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"? This cannot be undone.`)) return;
        reports = reports.filter(x => x.id !== id);
        filteredReports = filteredReports.filter(x => x.id !== id);
        updateSummaryStats(); renderReports(); showSuccess('Report deleted successfully');
    }

    /* ===== CSV Export ===== */
    function exportFilteredCsv() {
        const cols = ['id', 'name', 'type', 'generated_date', 'generated_by', 'file_size', 'format', 'status', 'download_count'];
        const safe = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
        const rows = [cols.join(',')].concat(filteredReports.map(r => cols.map(k => safe(r[k])).join(',')));
        const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'reports_filtered.csv'; document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    /* ===== Toasts & Utils ===== */
    function showToast(type, message) {
        const toast = document.getElementById(`${type}Toast`), msg = document.getElementById(`${type}Message`);
        msg.textContent = message; toast.classList.remove('translate-x-full'); setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }
    function showSuccess(m) { showToast('success', m); }
    function showError(m) { showToast('error', m); }
    function showInfo(m) { showToast('info', m); }
    function debounce(fn, wait) {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }
</script>
{% endblock %}