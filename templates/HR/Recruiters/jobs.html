{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-6xl">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">Jobs</h1>
            <p class="text-slate-600 text-sm">Create and manage your job postings. Sourcing will pull from these.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Back</a>
    </div>

    <!-- Create Job -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5">
        <h2 class="text-lg font-semibold text-slate-800 mb-3">Create Job</h2>
        <form id="jobForm" class="grid md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                <input name="title" required
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-800" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                <input name="department" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                <input name="location" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Employment Type</label>
                <select name="employment_type" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">Select…</option>
                    <option>Full-time</option>
                    <option>Part-time</option>
                    <option>Contract</option>
                    <option>Intern</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Openings</label>
                <input name="openings" type="number" min="1" value="1"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                <textarea name="description" rows="3"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2 flex items-center justify-between">
                <p class="text-xs text-slate-500">Fields marked * are required.</p>
                <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900"
                    type="submit">Create</button>
            </div>
        </form>
        <div id="formMsg" class="mt-3 text-sm"></div>
    </div>

    <!-- Filters -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <label class="block text-sm font-medium text-slate-700 mb-2">Status</label>
            <select id="statusFilter" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                <option value="">All</option>
                <option>Open</option>
                <option>Closed</option>
            </select>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5 lg:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-2">Search</label>
            <input id="searchInput" placeholder="Search title/department/location/description…"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" />
        </div>
    </div>

    <!-- Jobs Table -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-800">My Jobs</h2>
            <button id="refreshBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Refresh</button>
        </div>

        <div class="mt-4 overflow-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">Title</th>
                        <th class="py-2 pr-3">Dept</th>
                        <th class="py-2 pr-3">Location</th>
                        <th class="py-2 pr-3">Type</th>
                        <th class="py-2 pr-3">Openings</th>
                        <th class="py-2 pr-3">Status</th>
                        <th class="py-2 pr-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTbody" class="align-top"></tbody>
            </table>
        </div>
        <div id="listMsg" class="mt-3 text-sm"></div>
    </div>
</div>

<script>
    async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
    }
    async function postJSON(url, data) {
        const r = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
    }
    async function putJSON(url, data) {
        const r = await fetch(url, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
    }
    async function del(url) {
        const r = await fetch(url, { method: "DELETE" });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
    }

    const jobForm = document.getElementById("jobForm");
    const formMsg = document.getElementById("formMsg");
    const statusFilter = document.getElementById("statusFilter");
    const searchInput = document.getElementById("searchInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const jobsTbody = document.getElementById("jobsTbody");
    const listMsg = document.getElementById("listMsg");

    function td(text) {
        const c = document.createElement("td");
        c.className = "py-2 pr-3";
        c.textContent = text;
        return c;
    }
    function input(value, cls = "w-40") {
        const i = document.createElement("input");
        i.value = value || "";
        i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`;
        return i;
    }
    function select(options, current) {
        const s = document.createElement("select");
        s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm";
        options.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o; opt.textContent = o;
            if (o === current) opt.selected = true;
            s.appendChild(opt);
        });
        return s;
    }

    async function loadJobs() {
        try {
            listMsg.textContent = "Loading...";
            const params = new URLSearchParams();
            if (statusFilter.value) params.set("status", statusFilter.value);
            if (searchInput.value.trim()) params.set("q", searchInput.value.trim());
            const data = await fetchJSON("/api/jobs?" + params.toString());
            jobsTbody.innerHTML = "";
            data.forEach(row => {
                const tr = document.createElement("tr");

                // Title (editable)
                const titleInput = input(row.title, "w-56");
                const tdTitle = document.createElement("td"); tdTitle.className = "py-2 pr-3"; tdTitle.appendChild(titleInput);

                // Dept (editable)
                const deptInput = input(row.department || "", "w-40");
                const tdDept = document.createElement("td"); tdDept.className = "py-2 pr-3"; tdDept.appendChild(deptInput);

                // Location (editable)
                const locInput = input(row.location || "", "w-40");
                const tdLoc = document.createElement("td"); tdLoc.className = "py-2 pr-3"; tdLoc.appendChild(locInput);

                // Type (editable)
                const typeSel = select(["", "Full-time", "Part-time", "Contract", "Intern"], row.employment_type || "");
                const tdType = document.createElement("td"); tdType.className = "py-2 pr-3"; tdType.appendChild(typeSel);

                // Openings (editable)
                const openInput = input(row.openings ?? 1, "w-20"); openInput.type = "number"; openInput.min = "1";
                const tdOpen = document.createElement("td"); tdOpen.className = "py-2 pr-3"; tdOpen.appendChild(openInput);

                // Status (editable)
                const statusSel = select(["Open", "Closed"], row.status);
                const tdStatus = document.createElement("td"); tdStatus.className = "py-2 pr-3"; tdStatus.appendChild(statusSel);

                // Actions
                const tdAct = document.createElement("td"); tdAct.className = "py-2 pr-3";
                const saveBtn = document.createElement("button");
                saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900";
                saveBtn.textContent = "Save";
                const delBtn = document.createElement("button");
                delBtn.className = "px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50";
                delBtn.textContent = "Delete";
                tdAct.append(saveBtn, delBtn);

                tr.append(tdTitle, tdDept, tdLoc, tdType, tdOpen, tdStatus, tdAct);
                jobsTbody.appendChild(tr);

                saveBtn.addEventListener("click", async () => {
                    try {
                        await putJSON(`/api/jobs/${row.id}`, {
                            title: titleInput.value.trim(),
                            department: deptInput.value.trim(),
                            location: locInput.value.trim(),
                            employment_type: typeSel.value,
                            openings: openInput.value,
                            status: statusSel.value
                        });
                        listMsg.className = "mt-3 text-sm text-emerald-700";
                        listMsg.textContent = "Saved.";
                        setTimeout(() => listMsg.textContent = "", 1200);
                    } catch (e) {
                        listMsg.className = "mt-3 text-sm text-rose-700";
                        listMsg.textContent = "Failed to save.";
                        console.error(e);
                    }
                });

                delBtn.addEventListener("click", async () => {
                    if (!confirm("Delete this job?")) return;
                    try {
                        await del(`/api/jobs/${row.id}`);
                        await loadJobs();
                    } catch (e) {
                        listMsg.className = "mt-3 text-sm text-rose-700";
                        listMsg.textContent = "Failed to delete.";
                        console.error(e);
                    }
                });
            });
            listMsg.textContent = data.length ? "" : "No jobs yet.";
        } catch (e) {
            listMsg.className = "mt-3 text-sm text-rose-700";
            listMsg.textContent = "Failed to load jobs.";
            console.error(e);
        }
    }

    jobForm?.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        formMsg.textContent = "";
        const fd = new FormData(jobForm);
        const payload = Object.fromEntries(fd.entries());
        try {
            await postJSON("/api/jobs", payload);
            formMsg.className = "mt-3 text-sm text-emerald-700";
            formMsg.textContent = "Job created.";
            jobForm.reset();
            await loadJobs();
        } catch (e) {
            formMsg.className = "mt-3 text-sm text-rose-700";
            formMsg.textContent = "Failed to create job.";
            console.error(e);
        }
    });

    statusFilter?.addEventListener("change", loadJobs);
    searchInput?.addEventListener("input", () => { clearTimeout(window.__t); window.__t = setTimeout(loadJobs, 300); });
    refreshBtn?.addEventListener("click", loadJobs);

    loadJobs();
</script>
{% endblock %}