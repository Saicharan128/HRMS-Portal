{% extends "layout.html" %}
{% block content %}
<!-- Add in <head> of base layout if missing -->
<meta name="viewport" content="width=device-width, initial-scale=1" />

<div class="mx-auto max-w-6xl px-3 sm:px-4">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">Jobs</h1>
            <p class="text-slate-600 text-xs sm:text-sm">Post, manage, and track open roles across the organization.</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm w-full sm:w-auto text-center">Back</a>
    </div>

    <!-- Create Job -->
    <div class="mt-4 sm:mt-6 rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
        <h2 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">Create Job</h2>
        <form id="jobForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                <input name="title" required
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-800" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                <input name="department" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                <input name="location" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Employment Type</label>
                <select name="employment_type" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">Select…</option>
                    <option>Full-time</option>
                    <option>Part-time</option>
                    <option>Contract</option>
                    <option>Intern</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Openings</label>
                <input name="openings" type="number" min="1" value="1"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                <textarea name="description" rows="3"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2"></textarea>
            </div>
            <div class="md:col-span-2 flex flex-wrap items-center justify-between gap-2">
                <p class="text-xs text-slate-500">Fields marked * are required.</p>
                <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900"
                    type="submit">Create</button>
            </div>
        </form>
        <div id="formMsg" class="mt-3 text-sm"></div>
    </div>

    <!-- Jobs -->
    <div class="mt-4 sm:mt-6 rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <h2 class="text-base sm:text-lg font-semibold text-slate-800">My Jobs</h2>
            <button id="refreshBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm w-full sm:w-auto">Refresh</button>
        </div>

        <!-- Table (≥sm) -->
        <div class="mt-4 overflow-auto hidden sm:block">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">Title</th>
                        <th class="py-2 pr-3">Dept</th>
                        <th class="py-2 pr-3">Location</th>
                        <th class="py-2 pr-3">Type</th>
                        <th class="py-2 pr-3">Openings</th>
                        <th class="py-2 pr-3">Status</th>
                        <th class="py-2 pr-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTbody" class="align-top"></tbody>
            </table>
        </div>

        <!-- Cards (mobile) -->
        <div id="jobsCards" class="sm:hidden mt-4 space-y-3"></div>

        <div id="listMsg" class="mt-3 text-sm"></div>
    </div>
</div>

<script>
    async function fetchJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(url, data) { const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function putJSON(url, data) { const r = await fetch(url, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function delReq(url) { const r = await fetch(url, { method: "DELETE" }); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    const jobForm = document.getElementById("jobForm");
    const formMsg = document.getElementById("formMsg");
    const jobsTbody = document.getElementById("jobsTbody");
    const jobsCards = document.getElementById("jobsCards");
    const listMsg = document.getElementById("listMsg");
    const refreshBtn = document.getElementById("refreshBtn");

    function tdWrap(el) { const td = document.createElement("td"); td.className = "py-2 pr-3"; td.appendChild(el); return td; }
    function input(v, cls = "w-40") { const i = document.createElement("input"); i.value = v || ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function select(opts, cur) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; opts.forEach(o => { const op = document.createElement("option"); op.value = o; op.textContent = o; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }

    async function loadJobs() {
        try {
            listMsg.textContent = "Loading...";
            const data = await fetchJSON("/api/jobs");
            // TABLE
            jobsTbody.innerHTML = "";
            data.forEach(row => {
                const tr = document.createElement("tr");
                const titleI = input(row.title, "w-56");
                const deptI = input(row.department || "", "w-40");
                const locI = input(row.location || "", "w-40");
                const typeS = select(["", "Full-time", "Part-time", "Contract", "Intern"], row.employment_type || "");
                const openI = input(row.openings ?? 1, "w-20"); openI.type = "number"; openI.min = "1";
                const statusS = select(["Open", "Closed"], row.status || "Open");

                const actions = document.createElement("div");
                const saveBtn = document.createElement("button");
                saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900";
                saveBtn.textContent = "Save";
                const delBtn = document.createElement("button");
                delBtn.className = "px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50";
                delBtn.textContent = "Delete";
                actions.append(saveBtn, delBtn);

                tr.append(tdWrap(titleI), tdWrap(deptI), tdWrap(locI), tdWrap(typeS), tdWrap(openI), tdWrap(statusS), tdWrap(actions));
                jobsTbody.appendChild(tr);

                saveBtn.addEventListener("click", async () => {
                    try {
                        await putJSON(`/api/jobs/${row.id}`, {
                            title: titleI.value.trim(),
                            department: deptI.value.trim(),
                            location: locI.value.trim(),
                            employment_type: typeS.value,
                            openings: openI.value,
                            status: statusS.value
                        });
                        listMsg.className = "mt-3 text-sm text-emerald-700"; listMsg.textContent = "Saved.";
                    } catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Save failed."; }
                });
                delBtn.addEventListener("click", async () => {
                    if (!confirm("Delete this job?")) return;
                    try { await delReq(`/api/jobs/${row.id}`); loadJobs(); }
                    catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Delete failed."; }
                });
            });

            // CARDS (mobile)
            jobsCards.innerHTML = "";
            data.forEach(row => {
                const card = document.createElement("div");
                card.className = "rounded-xl border border-slate-200 p-3";
                card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0 flex-1">
            <div class="text-sm text-slate-500 mb-1">Title</div>
            <input id="c-title-${row.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${row.title || ""}">
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <div class="text-[11px] text-slate-500 mb-1">Dept</div>
                <input id="c-dept-${row.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${row.department || ""}">
              </div>
              <div>
                <div class="text-[11px] text-slate-500 mb-1">Location</div>
                <input id="c-loc-${row.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${row.location || ""}">
              </div>
              <div>
                <div class="text-[11px] text-slate-500 mb-1">Type</div>
                <select id="c-type-${row.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm">
                  ${["", "Full-time", "Part-time", "Contract", "Intern"].map(o => `<option value="${o}" ${o === (row.employment_type || "") ? "selected" : ""}>${o || "—"}</option>`).join("")}
                </select>
              </div>
              <div>
                <div class="text-[11px] text-slate-500 mb-1">Openings</div>
                <input id="c-open-${row.id}" type="number" min="1" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm" value="${row.openings ?? 1}">
              </div>
              <div>
                <div class="text-[11px] text-slate-500 mb-1">Status</div>
                <select id="c-status-${row.id}" class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm">
                  ${["Open", "Closed"].map(o => `<option value="${o}" ${o === (row.status || "Open") ? "selected" : ""}>${o}</option>`).join("")}
                </select>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-1">
            <button class="text-xs px-2 py-1 rounded bg-slate-800 text-white hover:bg-slate-900" data-act="save">Save</button>
            <button class="text-xs px-2 py-1 rounded border border-rose-300 text-rose-700 hover:bg-rose-50" data-act="del">Delete</button>
          </div>
        </div>`;
                jobsCards.appendChild(card);

                card.querySelector('[data-act="save"]').addEventListener("click", async () => {
                    const payload = {
                        title: card.querySelector(`#c-title-${row.id}`).value.trim(),
                        department: card.querySelector(`#c-dept-${row.id}`).value.trim(),
                        location: card.querySelector(`#c-loc-${row.id}`).value.trim(),
                        employment_type: card.querySelector(`#c-type-${row.id}`).value,
                        openings: card.querySelector(`#c-open-${row.id}`).value,
                        status: card.querySelector(`#c-status-${row.id}`).value
                    };
                    try { await putJSON(`/api/jobs/${row.id}`, payload); listMsg.className = "mt-3 text-sm text-emerald-700"; listMsg.textContent = "Saved."; }
                    catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Save failed."; }
                });
                card.querySelector('[data-act="del"]').addEventListener("click", async () => {
                    if (!confirm("Delete this job?")) return;
                    try { await delReq(`/api/jobs/${row.id}`); loadJobs(); }
                    catch { listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Delete failed."; }
                });
            });

            listMsg.textContent = data.length ? "" : "No jobs yet.";
        } catch {
            listMsg.className = "mt-3 text-sm text-rose-700"; listMsg.textContent = "Failed to load jobs.";
        }
    }

    jobForm?.addEventListener("submit", async ev => {
        ev.preventDefault();
        formMsg.textContent = "";
        const fd = new FormData(jobForm);
        const payload = Object.fromEntries(fd.entries());
        try { await postJSON("/api/jobs", payload); formMsg.className = "mt-3 text-sm text-emerald-700"; formMsg.textContent = "Job created."; jobForm.reset(); loadJobs(); }
        catch { formMsg.className = "mt-3 text-sm text-rose-700"; formMsg.textContent = "Failed to create job."; }
    });

    refreshBtn?.addEventListener("click", loadJobs);
    loadJobs();
</script>
{% endblock %}