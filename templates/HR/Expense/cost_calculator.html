{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-calculator mr-2"></i> Cost Calculator
            </h1>
            <p class="text-slate-600 text-sm">Estimate workforce costs with advanced budgeting tools.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="saveScenarioBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-save mr-1"></i> Save Scenario
            </button>
            <button id="exportBudgetBtn"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export Budget
            </button>
            <label
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm cursor-pointer">
                <i class="fa-solid fa-file-import mr-1"></i> Import (JSON)
                <input id="importJSON" type="file" accept="application/json" class="hidden">
            </label>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="positionTab"
                class="calculator-tab active px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fa-solid fa-user mr-1"></i> Position Calculator
            </button>
            <button id="teamTab" class="calculator-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fa-solid fa-users mr-1"></i> Team Calculator
            </button>
            <button id="budgetTab" class="calculator-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fa-solid fa-chart-pie mr-1"></i> Budget Planner
            </button>
            <button id="scenarioTab" class="calculator-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fa-solid fa-flask mr-1"></i> Scenario Analysis
            </button>
        </div>
    </div>

    <!-- Position Calculator -->
    <div id="positionCalculator" class="calculator-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Inputs -->
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-user-plus mr-2"></i> Position Details
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="resetPosition"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                            <i class="fa-solid fa-rotate mr-1"></i> Reset
                        </button>
                        <button id="exportPosition"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm hover:bg-slate-50">
                            <i class="fa-solid fa-file-export mr-1"></i> Export CSV
                        </button>
                    </div>
                </div>

                <form id="positionForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Job Title *</label>
                            <input type="text" id="positionTitle" required
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                            <select id="positionDepartment" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Department</option>
                                <option value="engineering">Engineering</option>
                                <option value="sales">Sales</option>
                                <option value="marketing">Marketing</option>
                                <option value="hr">Human Resources</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Level</label>
                            <select id="positionLevel" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Level</option>
                                <option value="entry">Entry</option>
                                <option value="mid">Mid</option>
                                <option value="senior">Senior</option>
                                <option value="lead">Lead/Manager</option>
                                <option value="director">Director</option>
                                <option value="executive">Executive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                            <select id="positionLocation" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="">Select Location</option>
                                <option value="san-francisco">San Francisco</option>
                                <option value="new-york">New York</option>
                                <option value="austin">Austin</option>
                                <option value="remote">Remote</option>
                            </select>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <h4 class="font-medium text-slate-800 mb-3">Compensation Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Base Salary *</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="baseSalary" required min="0" step="1000"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Bonus Target (%)</label>
                                <input type="number" id="bonusPercent" min="0" max="100" step="1"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Equity Value
                                    (Annual)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="equityValue" min="0" step="1000"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Employment Type</label>
                                <select id="employmentType" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                    <option value="full-time" selected>Full-Time</option>
                                    <option value="part-time">Part-Time</option>
                                    <option value="contractor">Contractor</option>
                                    <option value="intern">Intern</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">FTE % (proration)</label>
                                <input type="number" id="ftePercent" min="10" max="100" step="5" value="100"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <p class="text-xs text-slate-500 mt-1">Used for part-time & interns (100 = full-time)
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <h4 class="font-medium text-slate-800 mb-3">Benefits & Additional Costs</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Health Insurance
                                    (Monthly)</label>
                                <div class="relative"><span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="healthInsurance" min="0" step="50"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Retirement (401k Match
                                    %)</label>
                                <input type="number" id="retirement401k" min="0" max="10" step="0.5"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Equipment & Setup
                                    (One-time)</label>
                                <div class="relative"><span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="equipment" min="0" step="100"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Training & Development
                                    (Annual)</label>
                                <div class="relative"><span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="training" min="0" step="100"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Office Space
                                    (Monthly)</label>
                                <div class="relative"><span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="officeSpace" min="0" step="50"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Other Benefits
                                    (Monthly)</label>
                                <div class="relative"><span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="otherBenefits" min="0" step="50"
                                        class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <h4 class="font-medium text-slate-800 mb-3">Taxes & Overhead</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Payroll Tax Rate
                                    (%)</label>
                                <input type="number" id="payrollTax" min="0" max="20" step="0.1" value="7.65"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Workers' Comp (%)</label>
                                <input type="number" id="workersComp" min="0" max="5" step="0.1" value="0.5"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Unemployment (%)</label>
                                <input type="number" id="unemployment" min="0" max="10" step="0.1" value="2.5"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2">
                        <label class="flex items-center gap-2 text-sm text-slate-700">
                            <input id="includeEquityInTaxes" type="checkbox" class="rounded border-slate-300" checked>
                            Include equity in tax base
                        </label>
                        <button type="button" id="calculatePosition"
                            class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">
                            <i class="fa-solid fa-calculator mr-2"></i> Calculate Total Cost
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-chart-line mr-2"></i> Cost Breakdown
                </h3>

                <div id="positionResults" class="hidden space-y-4">
                    <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="text-sm text-blue-600 mb-1">Total Annual Cost</div>
                        <div id="totalAnnualCost" class="text-2xl font-bold text-blue-800">$0</div>
                        <div class="text-xs text-blue-600 mt-1">Including all benefits and taxes</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-lg bg-slate-50 flex items-center justify-between">
                            <span class="text-sm text-slate-600">Monthly Cost</span>
                            <span id="monthlyCost" class="font-medium text-slate-800">$0</span>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-50 flex items-center justify-between">
                            <span class="text-sm text-slate-600">Effective Hourly Rate</span>
                            <span id="hourlyRate" class="font-medium text-slate-800">$0</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h4 class="text-sm font-medium text-slate-800">Breakdown</h4>
                        <div id="costBreakdown" class="space-y-1 text-sm"></div>
                    </div>

                    <div class="p-3 rounded-lg bg-purple-50 flex items-center justify-between">
                        <span class="text-sm text-purple-600">Benefits Ratio</span>
                        <span id="benefitsRatio" class="font-medium text-purple-800">0%</span>
                    </div>
                </div>

                <div id="positionEmptyState" class="text-center py-8 text-slate-500">
                    <i class="fa-solid fa-calculator text-4xl mb-4"></i>
                    <p>Enter position details and click "Calculate Total Cost" to see the breakdown.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Calculator -->
    <div id="teamCalculator" class="calculator-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Builder -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-users mr-2"></i> Team Builder
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="addTeamMember"
                            class="px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm">
                            <i class="fa-solid fa-plus mr-1"></i> Add Member
                        </button>
                        <button id="exportTeam"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                            <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
                        </button>
                    </div>
                </div>

                <div id="teamMembers" class="space-y-3"></div>

                <div class="mt-6 pt-4 border-t border-slate-200">
                    <button id="calculateTeam"
                        class="w-full px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">
                        <i class="fa-solid fa-calculator mr-2"></i> Calculate Team Cost
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-chart-pie mr-2"></i> Team
                    Cost Analysis</h3>
                <div id="teamResults" class="hidden space-y-4"></div>
                <div id="teamEmptyState" class="text-center py-8 text-slate-500">
                    <i class="fa-solid fa-users text-4xl mb-4"></i>
                    <p>Add team members to see cost analysis.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Planner -->
    <div id="budgetPlanner" class="calculator-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-cog mr-2"></i> Budget
                    Parameters</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Budget Period</label>
                        <select id="budgetPeriod" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="annual">Annual Budget</option>
                            <option value="quarterly">Quarterly Budget</option>
                            <option value="monthly">Monthly Budget</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Total Budget</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                            <input type="number" id="totalBudget" min="0" step="10000"
                                class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Growth Rate (%)</label>
                        <input type="number" id="growthRate" min="0" max="50" step="1"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Department Focus</label>
                        <select id="budgetDepartment" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="all">All Departments</option>
                            <option value="engineering">Engineering</option>
                            <option value="sales">Sales</option>
                            <option value="marketing">Marketing</option>
                            <option value="hr">Human Resources</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                    <button id="generateBudget"
                        class="w-full px-4 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 font-medium">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Generate Budget Plan
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-pie-chart mr-2"></i> Budget
                        Allocation</h3>
                    <div class="text-sm text-slate-600">
                        <span id="budgetUtilization">0%</span> of budget allocated
                    </div>
                </div>
                <div id="budgetChart" class="mb-6"><canvas id="budgetPieChart" height="300"></canvas></div>
                <div id="budgetBreakdown" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Scenario Analysis -->
    <div id="scenarioAnalysis" class="calculator-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-flask mr-2"></i> Scenario
                    Comparison</h3>
                <div class="flex items-center gap-2">
                    <button id="addScenario"
                        class="px-3 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-sm">
                        <i class="fa-solid fa-plus mr-1"></i> Add Scenario
                    </button>
                    <button id="exportScenarios"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-file-export mr-1"></i> Export JSON
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="scenarioGrid"></div>

            <div class="mt-6">
                <div class="rounded-lg border border-slate-200 p-4">
                    <h4 class="font-medium text-slate-800 mb-3">Scenario Comparison Chart</h4>
                    <canvas id="scenarioChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Team Member Modal -->
<div id="addMemberModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-slate-800">Add Team Member</h3>
                        <button id="closeAddMemberModal" class="text-slate-400 hover:text-slate-600"><i
                                class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Role Title</label>
                        <input type="text" id="memberRole" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Level</label>
                            <select id="memberLevel" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                                <option value="entry">Entry</option>
                                <option value="mid">Mid</option>
                                <option value="senior">Senior</option>
                                <option value="lead">Lead</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Count</label>
                            <input type="number" id="memberCount" min="1" value="1"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>
                    <div class="">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Annual Salary</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                            <input type="number" id="memberSalary" min="0" step="1000"
                                class="w-full pl-8 rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <button id="cancelAddMember"
                            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50">Cancel</button>
                        <button id="confirmAddMember"
                            class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">
                            <i class="fa-solid fa-plus mr-1"></i> Add Member
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast"
    class="fixed top-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity">
</div>

<script>
    /* -------------------- State & Persistence -------------------- */
    const LS_KEY = 'cost_calc_state_v1';
    let currentTab = 'position';
    let teamMembers = [];
    let scenarios = [];

    /* -------------------- Init -------------------- */
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        setupEventListeners();
        initializeDefaults();
        switchTab('position');
        renderTeamMembers();
        renderScenarios();
    });

    /* -------------------- Event Listeners -------------------- */
    function setupEventListeners() {
        document.querySelectorAll('.calculator-tab').forEach(t => {
            t.addEventListener('click', (e) => switchTab(e.currentTarget.id.replace('Tab', '')));
        });
        // Position
        $('calculatePosition').addEventListener('click', calculatePositionCost);
        $('exportPosition').addEventListener('click', exportPositionCSV);
        $('resetPosition').addEventListener('click', () => { $('positionForm').reset(); initializeDefaults(); toggleResults(false); });
        $('employmentType').addEventListener('change', onEmploymentTypeChange);
        // Live auto-calc
        ['baseSalary', 'bonusPercent', 'equityValue', 'healthInsurance', 'retirement401k', 'equipment', 'training', 'officeSpace', 'otherBenefits', 'payrollTax', 'workersComp', 'unemployment', 'ftePercent', 'includeEquityInTaxes'].forEach(id => {
            const el = $(id); if (el) el.addEventListener('input', debounce(() => { if ($('baseSalary').value) calculatePositionCost(); }, 400));
        });

        // Team
        $('addTeamMember').addEventListener('click', openAddMemberModal);
        $('calculateTeam').addEventListener('click', calculateTeamCost);
        $('exportTeam').addEventListener('click', exportTeamCSV);
        $('closeAddMemberModal').addEventListener('click', closeAddMemberModal);
        $('cancelAddMember').addEventListener('click', closeAddMemberModal);
        $('confirmAddMember').addEventListener('click', confirmAddMember);
        window.addEventListener('click', (e) => { if (e.target === $('addMemberModal')) closeAddMemberModal(); });

        // Budget
        $('generateBudget').addEventListener('click', generateBudgetPlan);
        $('exportBudgetBtn').addEventListener('click', exportBudgetJSON);

        // Scenarios
        $('addScenario').addEventListener('click', addScenario);
        $('saveScenarioBtn').addEventListener('click', saveStateToast);
        $('exportScenarios').addEventListener('click', exportScenariosJSON);

        // Import
        $('importJSON').addEventListener('change', importJSON);
    }

    /* -------------------- Tabs -------------------- */
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.calculator-tab').forEach(b => b.classList.remove('active'));
        $(tab + 'Tab').classList.add('active');
        document.querySelectorAll('.calculator-panel').forEach(p => p.classList.add('hidden'));
        const map = { position: 'positionCalculator', team: 'teamCalculator', budget: 'budgetPlanner', scenario: 'scenarioAnalysis' };
        $(map[tab]).classList.remove('hidden');
    }

    /* -------------------- Defaults -------------------- */
    function initializeDefaults() {
        $('payrollTax').value = '7.65';
        $('workersComp').value = '0.5';
        $('unemployment').value = '2.5';
        $('healthInsurance').value = '800';
        $('retirement401k').value = '4';
        $('equipment').value = '2000';
        $('training').value = '1500';
        $('officeSpace').value = '500';
        $('ftePercent').value = '100';
        $('includeEquityInTaxes').checked = true;
    }

    /* -------------------- Position Calculator -------------------- */
    function onEmploymentTypeChange() {
        const type = $('employmentType').value;
        // Sensible defaults per type
        if (type === 'contractor') {
            $('payrollTax').value = '0'; $('workersComp').value = '0'; $('unemployment').value = '0';
            $('healthInsurance').value = '0'; $('retirement401k').value = '0';
            $('ftePercent').value = $('ftePercent').value || '100';
        } else if (type === 'intern') {
            $('ftePercent').value = '50';
        } else if (type === 'part-time') {
            $('ftePercent').value = '60';
        } else {
            initializeDefaults();
        }
        calculatePositionCost();
    }

    function calculatePositionCost() {
        const baseSalary = num('baseSalary');
        if (!baseSalary) { toast('Please enter a base salary', 'error'); return; }

        const fte = clamp(num('ftePercent', 100) / 100, 0.1, 1);
        const type = $('employmentType').value;

        const bonusPct = num('bonusPercent');
        const equity = num('equityValue');
        const healthMonthly = num('healthInsurance');
        const k401 = num('retirement401k');
        const equip = num('equipment');
        const training = num('training');
        const officeMonthly = num('officeSpace');
        const otherMonthly = num('otherBenefits');
        const taxPayroll = num('payrollTax');
        const taxWC = num('workersComp');
        const taxUnemp = num('unemployment');
        const includeEquity = $('includeEquityInTaxes').checked;

        // Prorate salary/bonus/equity for FTE% (contractors typically use base as hourly annualized; still allow FTE)
        const proratedBase = baseSalary * fte;
        const bonusAmt = proratedBase * (bonusPct / 100);
        const equityProrated = equity * fte;

        // Benefits (monthly → annual) and proration for FTE (optional: scale partially – here we scale)
        const annualHealth = healthMonthly * 12 * fte;
        const annualOffice = officeMonthly * 12 * fte;
        const annualOther = otherMonthly * 12 * fte;
        const k401Amt = proratedBase * (k401 / 100);

        // Compensation for tax base
        const compForTax = proratedBase + bonusAmt + (includeEquity ? equityProrated : 0);

        // Contractor taxes/benefits often zeroed already by type switch
        const taxes = compForTax * (taxPayroll / 100) + compForTax * (taxWC / 100) + compForTax * (taxUnemp / 100);

        const totalComp = proratedBase + bonusAmt + equityProrated;
        const totalBenefits = annualHealth + k401Amt + training + annualOther;
        const totalAnnual = totalComp + totalBenefits + taxes + equip + annualOffice;

        const monthly = totalAnnual / 12;
        const hours = 40 * 52 * fte; // FTE-adjusted hours
        const hourly = hours > 0 ? totalAnnual / hours : 0;
        const benefitsRatio = baseSalary ? (totalBenefits / (proratedBase || 1)) * 100 : 0;

        html('totalAnnualCost', money(totalAnnual));
        html('monthlyCost', money(monthly));
        html('hourlyRate', money(hourly, false));
        html('benefitsRatio', benefitsRatio.toFixed(1) + '%');

        const breakdown = [
            ['Base Salary', proratedBase],
            ['Bonus', bonusAmt],
            ['Equity', equityProrated],
            ['Health Insurance', annualHealth],
            ['401k Match', k401Amt],
            ['Training', training],
            ['Office Space', annualOffice],
            ['Other Benefits', annualOther],
            ['Equipment', equip],
            ['Taxes (Payroll + WC + Unemp)', taxes]
        ].filter(([, v]) => v > 0);

        $('costBreakdown').innerHTML = breakdown.map(([k, v]) =>
            `<div class="flex justify-between">
      <span class="text-slate-600">${k}:</span>
      <span class="text-slate-800">${money(v)}</span>
    </div>`).join('');

        toggleResults(true);
        saveState();
    }

    function toggleResults(show) {
        $('positionResults').classList.toggle('hidden', !show);
        $('positionEmptyState').classList.toggle('hidden', show);
    }

    /* -------------------- Team Calculator -------------------- */
    function openAddMemberModal() { $('addMemberModal').classList.remove('hidden'); }
    function closeAddMemberModal() { $('addMemberModal').classList.add('hidden'); clearAddMemberForm(); }
    function clearAddMemberForm() { $('memberRole').value = ''; $('memberLevel').value = 'entry'; $('memberCount').value = '1'; $('memberSalary').value = ''; }

    function confirmAddMember() {
        const role = $('memberRole').value.trim();
        const level = $('memberLevel').value;
        const count = parseInt($('memberCount').value || '1', 10);
        const salary = parseFloat($('memberSalary').value || '0');
        if (!role || !salary || salary < 0 || count < 1) { toast('Please fill all fields', 'error'); return; }
        // Assume ~40% loaded cost factor; could make configurable
        const totalCost = salary * 1.4 * count;
        teamMembers.push({ id: Date.now(), role, level, count, salary, totalCost });
        saveState(); renderTeamMembers(); closeAddMemberModal();
    }

    function renderTeamMembers() {
        const c = $('teamMembers');
        if (!teamMembers.length) { c.innerHTML = '<p class="text-slate-500 text-center py-4">No team members added yet</p>'; return; }
        c.innerHTML = teamMembers.map(m => `
    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <div>
        <div class="font-medium text-slate-800">${escapeHtml(m.role)}</div>
        <div class="text-sm text-slate-600">${m.level} level • ${m.count} person(s)</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="font-medium text-slate-800">${money(m.salary)}</div>
          <div class="text-xs text-slate-600">per person</div>
        </div>
        <button onclick="removeTeamMember(${m.id})" class="text-red-600 hover:text-red-800 p-1">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    </div>`).join('');
    }

    function removeTeamMember(id) {
        teamMembers = teamMembers.filter(x => x.id !== id);
        saveState(); renderTeamMembers(); calculateTeamCost();
    }

    function calculateTeamCost() {
        if (!teamMembers.length) {
            $('teamResults').classList.add('hidden'); $('teamEmptyState').classList.remove('hidden'); return;
        }
        const totalSalaries = teamMembers.reduce((s, m) => s + (m.salary * m.count), 0);
        const totalCost = teamMembers.reduce((s, m) => s + m.totalCost, 0);
        const totalCount = teamMembers.reduce((s, m) => s + m.count, 0);
        const avgSalary = totalSalaries / Math.max(1, totalCount);

        $('teamResults').innerHTML = `
    <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
      <div class="text-sm text-blue-600 mb-1">Total Team Cost</div>
      <div class="text-2xl font-bold text-blue-800">${money(totalCost)}</div>
      <div class="text-xs text-blue-600 mt-1">Annual including benefits & taxes</div>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div class="p-3 rounded-lg bg-slate-50">
        <div class="text-sm text-slate-600">Team Size</div>
        <div class="text-lg font-bold text-slate-800">${totalCount}</div>
      </div>
      <div class="p-3 rounded-lg bg-slate-50">
        <div class="text-sm text-slate-600">Avg Salary</div>
        <div class="text-lg font-bold text-slate-800">${money(avgSalary)}</div>
      </div>
    </div>
    <div class="space-y-2">
      <h4 class="text-sm font-medium text-slate-800">Cost by Role</h4>
      ${teamMembers.map(m => `
        <div class="flex justify-between text-sm">
          <span class="text-slate-600">${escapeHtml(m.role)} (${m.count}x):</span>
          <span class="font-medium text-slate-800">${money(m.totalCost)}</span>
        </div>`).join('')}
    </div>`;
        $('teamResults').classList.remove('hidden');
        $('teamEmptyState').classList.add('hidden');
    }

    /* -------------------- Budget Planner -------------------- */
    function withChart(fn) {
        if (typeof Chart !== 'undefined') return fn();
        const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = fn; document.head.appendChild(s);
    }

    function generateBudgetPlan() {
        const total = num('totalBudget');
        if (!total) { toast('Please enter a total budget amount', 'error'); return; }
        const allocation = { 'Salaries': 0.65, 'Benefits': 0.20, 'Equipment': 0.05, 'Training': 0.03, 'Office': 0.04, 'Other': 0.03 };
        const data = Object.entries(allocation).map(([k, p]) => ({ category: k, amount: total * p, pct: p * 100 }));
        withChart(() => renderBudgetChart(data));
        renderBudgetBreakdown(data);
        $('budgetUtilization').textContent = data.reduce((s, x) => s + x.pct, 0).toFixed(1) + '%';
        saveState();
    }

    let budgetChart;
    function renderBudgetChart(data) {
        const ctx = $('budgetPieChart').getContext('2d');
        if (budgetChart) budgetChart.destroy();
        budgetChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(x => x.category), datasets: [{
                    data: data.map(x => x.amount),
                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'],
                    borderWidth: 2, borderColor: '#fff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: { label: (c) => `${c.label}: ${money(c.raw)} (${(c.raw / c.dataset.data.reduce((a, b) => a + b, 0) * 100).toFixed(1)}%)` } }
                }
            }
        });
    }

    function renderBudgetBreakdown(data) {
        const colors = ['bg-blue-500', 'bg-red-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-cyan-500'];
        $('budgetBreakdown').innerHTML = data.map((x, i) => `
    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <div class="flex items-center gap-3">
        <div class="w-4 h-4 rounded ${colors[i % colors.length]}"></div>
        <span class="font-medium text-slate-800">${x.category}</span>
      </div>
      <div class="text-right">
        <div class="font-bold text-slate-800">${money(x.amount)}</div>
        <div class="text-sm text-slate-600">${x.pct.toFixed(1)}%</div>
      </div>
    </div>`).join('');
    }

    /* -------------------- Scenarios -------------------- */
    function addScenario() {
        const s = { id: Date.now(), name: `Scenario ${scenarios.length + 1}`, headcount: 50, avgSalary: 75000, benefits: 0.25, growth: 0.10 };
        scenarios.push(s); saveState(); renderScenarios();
    }

    function renderScenarios() {
        const c = $('scenarioGrid');
        if (!scenarios.length) { c.innerHTML = '<p class="col-span-3 text-slate-500 text-center py-8">No scenarios created yet</p>'; withChart(() => renderScenarioChart()); return; }
        c.innerHTML = scenarios.map(s => `
    <div class="rounded-lg border border-slate-200 p-4">
      <div class="flex items-center justify-between mb-3">
        <input type="text" value="${escapeHtml(s.name)}" onchange="updateScenarioName(${s.id}, this.value)"
               class="font-medium text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-4/5">
        <button onclick="removeScenario(${s.id})" class="text-red-600 hover:text-red-800"><i class="fa-solid fa-trash"></i></button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">Headcount</label>
          <input type="number" value="${s.headcount}" onchange="updateScenario(${s.id}, 'headcount', this.value)"
                 class="w-full text-sm rounded border border-slate-300 px-2 py-1">
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">Avg Salary</label>
          <input type="number" value="${s.avgSalary}" onchange="updateScenario(${s.id}, 'avgSalary', this.value)"
                 class="w-full text-sm rounded border border-slate-300 px-2 py-1">
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">Benefits Rate</label>
          <input type="number" value="${s.benefits}" step="0.05" onchange="updateScenario(${s.id}, 'benefits', this.value)"
                 class="w-full text-sm rounded border border-slate-300 px-2 py-1">
        </div>
        <div class="pt-2 border-t border-slate-200">
          <div class="text-sm text-slate-600">Total Cost</div>
          <div class="text-lg font-bold text-slate-800">${money(calcScenarioCost(s))}</div>
        </div>
      </div>
    </div>`).join('');
        withChart(() => renderScenarioChart());
    }

    function calcScenarioCost(s) {
        const base = s.headcount * s.avgSalary;
        const benefits = base * s.benefits;
        const taxes = base * 0.10;
        return (base + benefits + taxes) * (1 + s.growth);
    }

    function updateScenarioName(id, name) { const s = scenarios.find(x => x.id === id); if (s) { s.name = name; saveState(); } }
    function updateScenario(id, field, value) { const s = scenarios.find(x => x.id === id); if (s) { s[field] = parseFloat(value) || 0; saveState(); renderScenarios(); } }
    function removeScenario(id) { scenarios = scenarios.filter(x => x.id !== id); saveState(); renderScenarios(); }

    let scenarioChart;
    function renderScenarioChart() {
        const ctx = $('scenarioChart').getContext('2d');
        if (scenarioChart) scenarioChart.destroy();
        if (!scenarios.length) return;
        scenarioChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: scenarios.map(s => s.name),
                datasets: [{
                    label: 'Total Cost', data: scenarios.map(s => calcScenarioCost(s)),
                    backgroundColor: 'rgba(139,92,246,0.6)', borderColor: 'rgba(139,92,246,1)', borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + (v / 1e6).toFixed(1) + 'M' } } }
            }
        });
    }

    /* -------------------- Export / Import -------------------- */
    function exportPositionCSV() {
        const fields = ['Title', 'Dept', 'Level', 'Location', 'Employment Type', 'FTE %', 'Base Salary', 'Bonus %', 'Equity', 'Health (mo)', '401k %', 'Equip', 'Training', 'Office (mo)', 'Other (mo)', 'PayrollTax %', 'WC %', 'Unemp %', 'Include Equity', 'Total Annual'];
        const vals = [
            $('positionTitle').value, $('positionDepartment').value, $('positionLevel').value, $('positionLocation').value,
            $('employmentType').value, $('ftePercent').value, $('baseSalary').value, $('bonusPercent').value, $('equityValue').value,
            $('healthInsurance').value, $('retirement401k').value, $('equipment').value, $('training').value, $('officeSpace').value, $('otherBenefits').value,
            $('payrollTax').value, $('workersComp').value, $('unemployment').value, $('includeEquityInTaxes').checked,
            textContent('totalAnnualCost')
        ];
        downloadCSV([fields, vals], 'position_cost.csv');
    }

    function exportTeamCSV() {
        const rows = [['Role', 'Level', 'Count', 'Salary', 'TotalCost']];
        teamMembers.forEach(m => rows.push([m.role, m.level, m.count, m.salary, m.totalCost]));
        downloadCSV(rows, 'team_costs.csv');
    }

    function exportBudgetJSON() {
        const out = { period: $('budgetPeriod').value, totalBudget: num('totalBudget'), growthRate: num('growthRate'), breakdown: $('budgetBreakdown').innerText };
        downloadJSON(out, 'budget_plan.json');
    }

    function exportScenariosJSON() {
        downloadJSON({ scenarios }, 'scenarios.json');
    }

    function importJSON(e) {
        const f = e.target.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
            try {
                const obj = JSON.parse(r.result);
                if (obj.scenarios) scenarios = obj.scenarios;
                if (obj.teamMembers) teamMembers = obj.teamMembers;
                if (obj.position) restorePosition(obj.position);
                saveState(); renderScenarios(); renderTeamMembers(); toast('Imported', 'success');
            } catch { toast('Invalid JSON', 'error'); }
        };
        r.readAsText(f); e.target.value = '';
    }

    /* -------------------- Save / Load -------------------- */
    function saveState() {
        const state = {
            position: serializePosition(),
            teamMembers,
            scenarios
        };
        localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadState() {
        try {
            const raw = localStorage.getItem(LS_KEY); if (!raw) return;
            const state = JSON.parse(raw);
            if (state.position) restorePosition(state.position);
            teamMembers = Array.isArray(state.teamMembers) ? state.teamMembers : [];
            scenarios = Array.isArray(state.scenarios) ? state.scenarios : [];
        } catch { }
    }
    function saveStateToast() { saveState(); toast('Scenario saved', 'success'); }

    function serializePosition() {
        const ids = ['positionTitle', 'positionDepartment', 'positionLevel', 'positionLocation', 'employmentType', 'ftePercent', 'baseSalary', 'bonusPercent', 'equityValue', 'healthInsurance', 'retirement401k', 'equipment', 'training', 'officeSpace', 'otherBenefits', 'payrollTax', 'workersComp', 'unemployment', 'includeEquityInTaxes'];
        const o = {}; ids.forEach(id => o[id] = (id === 'includeEquityInTaxes') ? $(id).checked : $(id).value);
        return o;
    }
    function restorePosition(o) { Object.entries(o).forEach(([k, v]) => { if ($(k)) { if (k === 'includeEquityInTaxes') $(k).checked = !!v; else $(k).value = v; } }); }

    /* -------------------- Utils -------------------- */
    const $ = (id) => document.getElementById(id);
    const num = (id) => parseFloat($(id).value || '0');
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const money = (n, cents = true) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: cents ? 2 : 0, maximumFractionDigits: cents ? 2 : 0 }).format(n || 0);
    const html = (id, val) => { $(id).textContent = val; };
    const textContent = (id) => $(id).textContent || '';
    const escapeHtml = (s = '') => String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));
    const debounce = (fn, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };
    function toast(msg, tone = 'info') { const el = $('toast'); el.textContent = msg; el.style.backgroundColor = tone === 'success' ? '#16a34a' : tone === 'error' ? '#dc2626' : '#334155'; el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0', 2200); }
    function downloadCSV(rows, filename) {
        const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = filename; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }
    function downloadJSON(obj, filename) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = filename; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }
</script>

<style>
    .calculator-tab.active {
        background-color: #1e293b;
        color: white;
    }

    .calculator-tab:not(.active) {
        color: #64748b;
    }

    .calculator-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}