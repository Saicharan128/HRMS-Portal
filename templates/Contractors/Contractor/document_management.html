{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-6xl">
    <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-semibold text-slate-800">Document management</h1>
                <p class="mt-1 text-slate-600">Securely store, share, and manage HR documents (offer letters, resumes,
                    payslips, personal docs).</p>
            </div>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Back</a>
        </div>

        <!-- Filters -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="rounded-2xl border border-slate-200 bg-white p-5">
                <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                <input id="searchInput" placeholder="Search title/category/periodâ€¦"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" />
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-5">
                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                <select id="categoryFilter" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All</option>
                    <option>Offer</option>
                    <option>Resume</option>
                    <option>Payslip</option>
                    <option>Personal</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-5">
                <label class="block text-sm font-medium text-slate-700 mb-1">Period</label>
                <input id="periodFilter" placeholder="YYYY-MM"
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" />
            </div>
        </div>

        <!-- Self upload (Personal/Resume) -->
        <form id="selfUploadForm" class="mt-6 rounded-2xl border border-slate-200 p-5" enctype="multipart/form-data">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">Upload (you)</h2>
                <p class="text-sm text-slate-600">You can upload <span class="font-medium">Personal</span> docs or
                    updated <span class="font-medium">Resume</span>.</p>
            </div>
            <div class="grid md:grid-cols-3 gap-4 mt-3">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Category *</label>
                    <select name="category" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm"
                        required>
                        <option>Personal</option>
                        <option>Resume</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                    <input name="title" placeholder="e.g., Address Proof"
                        class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Period</label>
                    <input name="period" placeholder="YYYY-MM"
                        class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">File *</label>
                    <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required
                        class="w-full rounded-xl border px-3 py-2" />
                </div>
                <div class="md:col-span-1 flex items-end justify-end">
                    <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900"
                        type="submit">Upload</button>
                </div>
            </div>
            <div id="selfUploadMsg" class="mt-2 text-sm"></div>
        </form>

        <!-- Table -->
        <div class="mt-6 rounded-2xl border border-slate-200 p-5">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">Your documents</h2>
                <button id="refreshBtn"
                    class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Refresh</button>
            </div>

            <div class="mt-4 overflow-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-600 border-b">
                        <tr>
                            <th class="py-2 pr-3">Title</th>
                            <th class="py-2 pr-3">Category</th>
                            <th class="py-2 pr-3">Period</th>
                            <th class="py-2 pr-3">Uploaded</th>
                            <th class="py-2 pr-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody" class="align-top"></tbody>
                </table>
                <div id="listMsg" class="mt-3 text-sm"></div>
            </div>
        </div>
    </div>
</div>

<script>
    async function getJSON(u) { const r = await fetch(u); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    const tbody = document.getElementById("tbody");
    const listMsg = document.getElementById("listMsg");
    const refreshBtn = document.getElementById("refreshBtn");
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const periodFilter = document.getElementById("periodFilter");
    const selfUploadForm = document.getElementById("selfUploadForm");
    const selfUploadMsg = document.getElementById("selfUploadMsg");

    function render(rows) {
        const q = (searchInput.value || "").toLowerCase().trim();
        const cat = categoryFilter.value;
        const per = periodFilter.value;
        const filtered = rows.filter(r => {
            const hay = [r.title, r.category, r.period].map(x => (x || "").toLowerCase()).join(" ");
            const okQ = !q || hay.includes(q);
            const okC = !cat || r.category === cat;
            const okP = !per || (r.period || "").startsWith(per);
            return okQ && okC && okP;
        });

        tbody.innerHTML = "";
        filtered.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td class="py-2 pr-3 font-medium text-slate-800">${r.title}</td>
      <td class="py-2 pr-3">${r.category || "-"}</td>
      <td class="py-2 pr-3">${r.period || "-"}</td>
      <td class="py-2 pr-3">${new Date(r.uploaded_at).toLocaleString()}</td>
      <td class="py-2 pr-3 space-x-2">
        <a class="px-2 py-1 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900" href="${r.url}" target="_blank">Open</a>
        <button class="delBtn px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50" data-id="${r.id}">Delete</button>
      </td>
    `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll(".delBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
                if (!confirm("Delete this document?")) return;
                try {
                    const r = await fetch("/api/docs/" + btn.dataset.id, { method: "DELETE" });
                    if (!r.ok) {
                        const t = await r.text();
                        try { const j = JSON.parse(t); alert(j.error || "Delete failed."); }
                        catch { alert("Delete failed."); }
                        return;
                    }
                    loadList();
                } catch (e) { alert("Delete failed."); console.error(e); }
            });
        });
    }

    async function loadList() {
        try {
            listMsg.textContent = "Loading...";
            const rows = await getJSON("/api/docs");
            render(rows);
            listMsg.textContent = rows.length ? "" : "No documents yet.";
        } catch (e) {
            listMsg.className = "mt-3 text-sm text-rose-700";
            listMsg.textContent = "Failed to load.";
            console.error(e);
        }
    }
    refreshBtn.addEventListener("click", loadList);
    searchInput.addEventListener("input", () => { clearTimeout(window.__d); window.__d = setTimeout(loadList, 200); });
    categoryFilter.addEventListener("change", loadList);
    periodFilter.addEventListener("input", () => { clearTimeout(window.__p); window.__p = setTimeout(loadList, 200); });

    selfUploadForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        selfUploadMsg.textContent = ""; selfUploadMsg.className = "mt-2 text-sm";
        try {
            const fd = new FormData(selfUploadForm);
            const r = await fetch("/api/docs/upload", { method: "POST", body: fd });
            const t = await r.text();
            if (!r.ok) {
                try { const j = JSON.parse(t); selfUploadMsg.className = "mt-2 text-sm text-rose-700"; selfUploadMsg.textContent = j.error || "Upload failed."; }
                catch { selfUploadMsg.className = "mt-2 text-sm text-rose-700"; selfUploadMsg.textContent = "Upload failed."; }
                return;
            }
            selfUploadMsg.className = "mt-2 text-sm text-emerald-700";
            selfUploadMsg.textContent = "Uploaded.";
            selfUploadForm.reset();
            loadList();
        } catch (e) {
            selfUploadMsg.className = "mt-2 text-sm text-rose-700";
            selfUploadMsg.textContent = "Upload failed.";
            console.error(e);
        }
    });

    loadList();
</script>
{% endblock %}