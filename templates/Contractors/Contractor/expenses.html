{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 py-4 sm:py-6 gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-receipt mr-2"></i> Expenses
            </h1>
            <p class="text-slate-600 text-sm mt-1">Submit, approve, and reimburse employee expenses easily.</p>
        </div>
        <div class="flex items-center gap-2 w-full sm:w-auto">
            <button id="newExpenseBtn"
                class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm flex-1 sm:flex-none">
                <i class="fa-solid fa-circle-plus mr-1"></i> New Expense
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm flex-1 sm:flex-none">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex flex-wrap sm:flex-nowrap space-x-1 bg-slate-100 p-1 rounded-xl gap-y-2">
            <button id="mineTab"
                class="ex-tab active px-3 py-2 rounded-lg text-sm font-medium flex-1 sm:flex-none text-center"><i
                    class="fa-solid fa-user mr-1"></i> My Expenses</button>
            <button id="approvalsTab"
                class="ex-tab px-3 py-2 rounded-lg text-sm font-medium flex-1 sm:flex-none text-center"><i
                    class="fa-solid fa-check-to-slot mr-1"></i> Approvals</button>
            <button id="reimburseTab"
                class="ex-tab px-3 py-2 rounded-lg text-sm font-medium flex-1 sm:flex-none text-center"><i
                    class="fa-solid fa-building-columns mr-1"></i> Reimbursements</button>
            <button id="policiesTab"
                class="ex-tab px-3 py-2 rounded-lg text-sm font-medium flex-1 sm:flex-none text-center"><i
                    class="fa-solid fa-scale-balanced mr-1"></i> Policies</button>
            <button id="reportsTab"
                class="ex-tab px-3 py-2 rounded-lg text-sm font-medium flex-1 sm:flex-none text-center"><i
                    class="fa-solid fa-chart-line mr-1"></i> Reports</button>
        </div>
    </div>

    <!-- My Expenses -->
    <section id="minePanel" class="ex-panel">
        <div class="rounded-2xl border border-slate-200 bg-white">
            <div
                class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border-b border-slate-200 gap-4">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto">
                    <div class="relative w-full sm:w-64 md:w-80">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input id="mySearch" placeholder="Search category, merchant, or note"
                            class="w-full pl-10 pr-10 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-slate-200 text-sm">
                        <button id="myClear"
                            class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <select id="myStatus"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="draft">Draft</option>
                        <option value="submitted">Submitted</option>
                        <option value="approved">Approved</option>
                        <option value="reimbursed">Reimbursed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <input id="myPeriod" type="month"
                        class="px-3 py-2 rounded-lg border border-slate-300 text-sm w-full sm:w-auto">
                </div>
                <div class="text-sm text-slate-600">
                    <span id="kpiPending">Pending: â€”</span> â€¢ <span id="kpiApproved">Approved: â€”</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4">Date</th>
                            <th class="py-2 px-4 hidden sm:table-cell">Category</th>
                            <th class="py-2 px-4 hidden sm:table-cell">Merchant</th>
                            <th class="py-2 px-4">Amount</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4 w-28"></th>
                        </tr>
                    </thead>
                    <tbody id="myRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Approvals -->
    <section id="approvalsPanel" class="ex-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-check-to-slot mr-2"></i> Pending
                    Approvals</h3>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <select id="apFilter"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm w-full sm:w-auto">
                        <option value="all">All</option>
                        <option value="submitted">Submitted</option>
                        <option value="flagged">Flagged</option>
                    </select>
                    <button id="approveAll"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm w-full sm:w-auto"><i
                            class="fa-solid fa-check mr-1"></i> Approve All</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 px-4">Employee</th>
                            <th class="py-2 px-4 hidden sm:table-cell">Category</th>
                            <th class="py-2 px-4">Amount</th>
                            <th class="py-2 px-4 hidden sm:table-cell">Policy</th>
                            <th class="py-2 px-4">Status</th>
                            <th class="py-2 px-4 w-28"></th>
                        </tr>
                    </thead>
                    <tbody id="apRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Reimbursements -->
    <section id="reimbursePanel" class="ex-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-building-columns mr-2"></i>
                        Batches</h3>
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <select id="rbFilter"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-sm w-full sm:w-auto">
                            <option value="all">All</option>
                            <option value="queued">Queued</option>
                            <option value="sent">Sent</option>
                        </select>
                        <button id="genRbFile"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm w-full sm:w-auto"><i
                                class="fa-solid fa-file-arrow-down mr-1"></i> Generate File</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 px-4">Batch</th>
                                <th class="py-2 px-4">Count</th>
                                <th class="py-2 px-4">Amount</th>
                                <th class="py-2 px-4">Status</th>
                                <th class="py-2 px-4 w-24"></th>
                            </tr>
                        </thead>
                        <tbody id="rbRows" class="text-slate-800"></tbody>
                    </table>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-wallet mr-2"></i> Next
                    Payout</h3>
                <ul id="nextPayout" class="space-y-2 text-sm"></ul>
            </div>
        </div>
    </section>

    <!-- Policies -->
    <section id="policiesPanel" class="ex-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                <h3 class="text-lg font-semibold text-slate-800"><i class="fa-solid fa-scale-balanced mr-2"></i> Expense
                    Policies</h3>
                <button id="newPolicy"
                    class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm w-full sm:w-auto"><i
                        class="fa-solid fa-plus mr-1"></i> New</button>
            </div>
            <ul id="policyList" class="space-y-3 text-sm"></ul>
        </div>
    </section>

    <!-- Reports -->
    <section id="reportsPanel" class="ex-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-chart-pie mr-2"></i> Spend
                    by Category</h3>
                <canvas id="catChart" height="220"></canvas>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-plane-departure mr-2"></i>
                    Travel vs. Non-Travel</h3>
                <canvas id="travelChart" height="220"></canvas>
            </div>
        </div>
    </section>
</div>

<!-- New Expense Modal -->
<div id="expModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg sm:max-w-xl">
                <div class="p-4 sm:p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">New Expense</h3>
                    <button id="closeExpModal" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-4 sm:p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input id="eDate" type="date"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <select id="eCategory" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                            <option>Meals</option>
                            <option>Travel</option>
                            <option>Lodging</option>
                            <option>Supplies</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input id="eMerchant" placeholder="Merchant"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <input id="eAmount" type="number" placeholder="Amount"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    <input id="eNote" placeholder="Notes (optional)"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-sm"><input id="ePolicy" type="checkbox" checked>
                            Within policy</label>
                        <button id="uploadReceipt"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm"><i
                                class="fa-solid fa-upload mr-1"></i> Receipt</button>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="saveDraft"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm w-full sm:w-auto">Save
                            Draft</button>
                        <button id="submitExpense"
                            class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm w-full sm:w-auto"><i
                                class="fa-solid fa-paper-plane mr-1"></i> Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .ex-tab.active {
        background-color: #1e293b;
        color: white;
    }

    .ex-tab:not(.active) {
        color: #64748b;
    }

    .ex-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    @media (max-width: 640px) {
        .max-w-7xl {
            max-width: 100%;
        }

        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }

        table {
            font-size: 0.75rem;
        }

        th,
        td {
            padding: 0.5rem;
        }

        input,
        select,
        button {
            font-size: 0.875rem;
        }

        canvas {
            max-height: 200px;
        }
    }
</style>

<script>
    /* -------- Mock Data -------- */
    let MY = [
        { id: 1, date: '2025-09-10', cat: 'Meals', merch: 'Cafe Deli', amt: 18, st: 'submitted' },
        { id: 2, date: '2025-09-11', cat: 'Travel', merch: 'Uber', amt: 22, st: 'approved' },
        { id: 3, date: '2025-09-12', cat: 'Supplies', merch: 'OfficeMart', amt: 45, st: 'draft' },
        { id: 4, date: '2025-09-08', cat: 'Lodging', merch: 'Hotel Z', amt: 180, st: 'reimbursed' },
        { id: 5, date: '2025-09-09', cat: 'Travel', merch: 'IndiGo', amt: 120, st: 'rejected' }
    ];
    let AP = [
        { id: 'R-101', emp: 'Aarav Mehta', cat: 'Travel', amt: 120, policy: 'OK', st: 'submitted' },
        { id: 'R-102', emp: 'Riya Patel', cat: 'Meals', amt: 38, policy: 'Flag', st: 'flagged' },
        { id: 'R-103', emp: 'Noah Kim', cat: 'Supplies', amt: 65, policy: 'OK', st: 'submitted' }
    ];
    let RB = [
        { id: 'RB-2301', count: 7, amount: 563, st: 'sent' },
        { id: 'RB-2302', count: 4, amount: 241, st: 'queued' }
    ];
    let POL = [
        { name: 'Meals â€” â‚¹800/day or $10/day cap', ver: 'v2.0', eff: '2025-07-01' },
        { name: 'Travel â€” economy, >300km needs approval', ver: 'v1.8', eff: '2025-06-15' }
    ];

    /* -------- Helpers -------- */
    const $ = (id) => document.getElementById(id);
    function money(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(n || 0)); }
    function badge(s) { return s === 'approved' ? 'bg-emerald-50 text-emerald-700' : s === 'submitted' ? 'bg-amber-50 text-amber-700' : s === 'reimbursed' ? 'bg-blue-50 text-blue-700' : s === 'rejected' ? 'bg-red-50 text-red-700' : 'bg-slate-100 text-slate-700'; }

    /* -------- Init -------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Tabs
        document.querySelectorAll('.ex-tab').forEach(b => {
            b.addEventListener('click', e => {
                document.querySelectorAll('.ex-tab').forEach(x => x.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                document.querySelectorAll('.ex-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(name + 'Panel').classList.remove('hidden');
                if (name === 'reports') { ensureCharts(); drawCharts(); }
            });
        });

        // My expenses filters
        $('myPeriod').value = new Date().toISOString().slice(0, 7);
        $('myStatus').addEventListener('change', renderMine);
        const s = $('mySearch'), c = $('myClear');
        s.addEventListener('input', () => { c.classList.toggle('hidden', !s.value.trim()); renderMine(); });
        c.addEventListener('click', () => { s.value = ''; c.classList.add('hidden'); renderMine(); });
        $('myPeriod').addEventListener('change', renderMine);

        // Approvals
        $('apFilter').addEventListener('change', renderApprovals);
        $('approveAll').addEventListener('click', () => { AP = AP.map(x => ({ ...x, st: 'approved' })); renderApprovals(); });

        // Reimbursements
        $('rbFilter').addEventListener('change', renderBatches);
        $('genRbFile').addEventListener('click', () => alert('âœ… Reimbursement file generated'));

        // Policies
        $('newPolicy').addEventListener('click', () => alert('ðŸ“ New policy form would open'));

        // Modal
        $('newExpenseBtn').addEventListener('click', openExpModal);
        $('closeExpModal').addEventListener('click', closeExpModal);
        $('saveDraft').addEventListener('click', saveDraft);
        $('submitExpense').addEventListener('click', submitExpense);
        $('uploadReceipt').addEventListener('click', () => alert('ðŸ“Ž Upload receipt (mock)'));

        // Paint
        renderMine(); renderApprovals(); renderBatches(); renderNextPayout(); renderPolicies();
    });

    /* -------- My Expenses -------- */
    function renderMine() {
        const q = ($('mySearch').value || '').toLowerCase();
        const st = $('myStatus').value;
        const period = $('myPeriod').value;
        const data = MY.filter(x => (st === 'all' || x.st === st) && (!q || [x.cat, x.merch].some(v => v.toLowerCase().includes(q))) && (!period || x.date.startsWith(period)));
        $('myRows').innerHTML = data.map(x => `
    <tr class="border-b last:border-0">
      <td class="py-2 px-4">${x.date}<br class="sm:hidden"><span class="sm:hidden text-xs text-slate-600">${x.cat} â€¢ ${x.merch}</span></td>
      <td class="py-2 px-4 hidden sm:table-cell">${x.cat}</td>
      <td class="py-2 px-4 hidden sm:table-cell">${x.merch}</td>
      <td class="py-2 px-4">${money(x.amt)}</td>
      <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${badge(x.st)} capitalize">${x.st}</span></td>
      <td class="py-2 px-4 text-right">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="editExp(${x.id})">Edit</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No expenses</td></tr>`;
        const pSum = MY.filter(x => x.st === 'submitted').reduce((s, i) => s + i.amt, 0);
        const aSum = MY.filter(x => x.st === 'approved' || x.st === 'reimbursed').reduce((s, i) => s + i.amt, 0);
        $('kpiPending').textContent = 'Pending: ' + money(pSum);
        $('kpiApproved').textContent = 'Approved: ' + money(aSum);
    }
    function editExp(id) {
        const e = MY.find(x => x.id === id); if (!e) return;
        $('eDate').value = e.date; $('eCategory').value = e.cat; $('eMerchant').value = e.merch; $('eAmount').value = e.amt; $('eNote').value = '';
        openExpModal();
    }

    /* -------- Approvals -------- */
    function renderApprovals() {
        const f = $('apFilter').value;
        const data = f === 'all' ? AP : AP.filter(x => x.st === f);
        $('apRows').innerHTML = data.map(x => {
            const tone = x.st === 'flagged' ? 'bg-red-50 text-red-700' : 'bg-amber-50 text-amber-700';
            return `
    <tr class="border-b last:border-0">
      <td class="py-2 px-4 font-medium">${x.emp}<br class="sm:hidden"><span class="sm:hidden text-xs text-slate-600">${x.cat} â€¢ ${x.policy}</span></td>
      <td class="py-2 px-4 hidden sm:table-cell">${x.cat}</td>
      <td class="py-2 px-4">${money(x.amt)}</td>
      <td class="py-2 px-4 hidden sm:table-cell"><span class="px-2 py-0.5 rounded-full text-xs ${x.policy === 'OK' ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700'}">${x.policy}</span></td>
      <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${tone} capitalize">${x.st}</span></td>
      <td class="py-2 px-4 text-right">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="approve('${x.id}')">Approve</button>
      </td>
    </tr>`;
        }).join('') || `<tr><td colspan="6" class="py-6 text-center text-slate-500">No items</td></tr>`;
    }
    function approve(id) { const t = AP.find(x => x.id === id); if (!t) return; t.st = 'approved'; renderApprovals(); }

    /* -------- Reimbursements -------- */
    function renderBatches() {
        const f = $('rbFilter').value;
        const data = f === 'all' ? RB : RB.filter(b => b.st === f);
        $('rbRows').innerHTML = data.map(b => {
            const pill = b.st === 'sent' ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700';
            return `
    <tr class="border-b last:border-0">
      <td class="py-2 px-4 font-medium">${b.id}</td>
      <td class="py-2 px-4">${b.count}</td>
      <td class="py-2 px-4">${money(b.amount)}</td>
      <td class="py-2 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${pill}">${b.st}</span></td>
      <td class="py-2 px-4 text-right"><button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Batch details coming soon')">Details</button></td>
    </tr>`;
        }).join('') || `<tr><td colspan="5" class="py-6 text-center text-slate-500">No batches</td></tr>`;
    }
    function renderNextPayout() {
        const due = MY.filter(x => x.st === 'approved').slice(0, 3);
        $('nextPayout').innerHTML = due.map(x => `
    <li class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <div><div class="font-medium text-slate-800">${x.cat} â€¢ ${x.merch}</div><div class="text-xs text-slate-600">${x.date}</div></div>
      <div class="text-sm font-semibold">${money(x.amt)}</div>
    </li>`).join('') || `<li class="text-slate-500">No approved items</li>`;
    }

    /* -------- Policies -------- */
    function renderPolicies() {
        $('policyList').innerHTML = POL.map(p => `
    <li class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
      <div><div class="font-medium text-slate-800">${p.name}</div><div class="text-xs text-slate-600">${p.ver} â€¢ Effective ${p.eff}</div></div>
      <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('Open policy')">Open</button>
    </li>`).join('');
    }

    /* -------- Modal -------- */
    function openExpModal() { $('expModal').classList.remove('hidden'); }
    function closeExpModal() { $('expModal').classList.add('hidden'); }
    function saveDraft() {
        const item = readModal(); if (!item) return;
        item.st = 'draft'; MY.push(item); closeExpModal(); renderMine();
    }
    function submitExpense() {
        const item = readModal(); if (!item) return;
        item.st = 'submitted'; MY.push(item); closeExpModal(); renderMine();
    }
    function readModal() {
        const date = $('eDate').value || new Date().toISOString().slice(0, 10);
        const cat = $('eCategory').value || 'Other';
        const merch = $('eMerchant').value.trim() || 'â€”';
        const amt = Number($('eAmount').value || 0); if (!amt) { alert('Amount required'); return null; }
        return { id: Date.now(), date, cat, merch, amt, st: 'draft' };
    }

    /* -------- Reports -------- */
    let chartsReady = false, catC, travelC;
    function ensureCharts() {
        if (typeof Chart !== 'undefined') { chartsReady = true; return; }
        if (chartsReady) return;
        const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        s.onload = () => { chartsReady = true; drawCharts(); };
        document.head.appendChild(s);
    }
    function drawCharts() {
        const c1 = document.getElementById('catChart'); const c2 = document.getElementById('travelChart');
        if (!chartsReady || !c1 || !c2) return;
        catC && catC.destroy(); travelC && travelC.destroy();

        const byCat = aggregateByCategory(MY);
        catC = new Chart(c1, {
            type: 'pie',
            data: { labels: Object.keys(byCat), datasets: [{ data: Object.values(byCat), borderWidth: 2, borderColor: '#fff', backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        const travel = MY.filter(x => x.cat === 'Travel' || x.cat === 'Lodging').reduce((s, i) => s + i.amt, 0);
        const non = MY.reduce((s, i) => s + i.amt, 0) - travel;
        travelC = new Chart(c2, {
            type: 'bar',
            data: { labels: ['Travel', 'Non-Travel'], datasets: [{ data: [travel, non], backgroundColor: '#06b6d4' }] },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }
    function aggregateByCategory(items) {
        return items.reduce((m, i) => { m[i.cat] = (m[i.cat] || 0) + i.amt; return m; }, {});
    }
</script>
{% endblock %}