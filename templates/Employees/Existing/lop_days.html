{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-user-minus mr-2"></i> LOP Days
            </h1>
            <p class="text-slate-600 text-sm">View loss-of-pay days and proration impact.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export CSV
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab" class="lop-tab active px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-chart-line mr-1"></i> Overview</button>
            <button id="calendarTab" class="lop-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-calendar-days mr-1"></i> Calendar</button>
            <button id="adjustTab" class="lop-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-scale-balanced mr-1"></i> Adjustments</button>
            <button id="historyTab" class="lop-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-clock-rotate-left mr-1"></i> History</button>
            <button id="policyTab" class="lop-tab px-4 py-2 rounded-lg text-sm font-medium"><i
                    class="fa-solid fa-book mr-1"></i> Policy</button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="lop-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Current month summary -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-calendar-day mr-2"></i> Current Cycle (<span id="cycleLabel">—</span>)
                    </h3>
                    <span id="riskBadge" class="px-2 py-1 text-xs rounded bg-emerald-50 text-emerald-700">Low</span>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">LOP Days</div>
                        <div id="tileDays" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Proration %</div>
                        <div id="tilePror" class="text-xl font-semibold text-slate-800">0%</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Pay Impact (₹)</div>
                        <div id="tileImpact" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Leave Bal.</div>
                        <div id="tileBal" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>

                <div class="relative h-40 mt-4">
                    <canvas id="impactChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>

                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                    <select id="monthPicker" class="px-2 py-1 rounded-lg border border-slate-300 text-sm"></select>
                    <select id="salaryBasis" class="px-2 py-1 rounded-lg border border-slate-300 text-sm">
                        <option value="monthly">Monthly (₹)</option>
                        <option value="daily">Per-day (₹)</option>
                    </select>
                    <button id="applyBalance"
                        class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-leaf mr-1"></i> Apply leave balance
                    </button>
                </div>

                <!-- What-if -->
                <div class="mt-4 rounded-xl bg-slate-50 p-3">
                    <div class="flex items-center justify-between text-xs text-slate-600 mb-2">
                        <span><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> What-if: convert LOP back to paid
                            day(s)</span>
                        <span id="whatIfLabel">0 day(s)</span>
                    </div>
                    <input id="whatIf" type="range" min="0" max="0" value="0" class="w-full">
                </div>
            </div>

            <!-- Reasons mix -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Reasons Mix
                    </h3>
                </div>
                <div class="relative h-40">
                    <canvas id="mixChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 text-sm text-slate-700"></div>
            </div>

            <!-- Quick Actions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-3">
                    <i class="fa-solid fa-bolt mr-2"></i> Quick Actions
                </h3>
                <div class="space-y-3">
                    <button id="reqRegBtn"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-file-pen mr-2"></i> Request regularization
                    </button>
                    <button id="downloadMemoBtn"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-file-arrow-down mr-2"></i> Download LOP memo
                    </button>
                    <button id="raiseQueryBtn"
                        class="w-full px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-left">
                        <i class="fa-solid fa-circle-question mr-2"></i> Raise payroll query
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar -->
    <section id="calendarPanel" class="lop-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-calendar-days mr-2"></i> Attendance Calendar — <span id="calLabel">—</span>
                </h3>
                <div class="text-sm text-slate-600">Legend:
                    <span class="px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-xs">LOP</span>
                    <span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 text-xs">Half</span>
                    <span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-xs">Present</span>
                </div>
            </div>
            <div class="grid grid-cols-7 text-xs text-slate-500 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
        </div>
    </section>

    <!-- Adjustments -->
    <section id="adjustPanel" class="lop-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-scale-balanced mr-2"></i> Regularization Requests
                    </h3>
                    <button id="newReqBtn"
                        class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                        <i class="fa-solid fa-plus mr-1"></i> New
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500 border-b">
                            <tr>
                                <th class="py-2 pr-4">Date</th>
                                <th class="py-2 pr-4">Type</th>
                                <th class="py-2 pr-4">Reason</th>
                                <th class="py-2 pr-4">Status</th>
                                <th class="py-2 pr-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reqRows" class="text-slate-800"></tbody>
                    </table>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-circle-info mr-2"></i> Notes
                </h3>
                <ul class="list-disc pl-5 text-sm text-slate-700 space-y-2">
                    <li>Half-day LOP counts as 0.5.</li>
                    <li>Approved regularizations restore pay in the next cycle.</li>
                    <li>Cut-off: 3 business days before payroll lock.</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- History -->
    <section id="historyPanel" class="lop-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-table mr-2"></i> Last 12 Months
                </h3>
                <div class="flex items-center gap-2">
                    <input id="searchHist" type="text" placeholder="Search month or remark..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <select id="statusHist" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="lop">With LOP</option>
                        <option value="clean">No LOP</option>
                    </select>
                    <input id="impactMin" type="number" placeholder="Min ₹"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-28">
                    <input id="impactMax" type="number" placeholder="Max ₹"
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm w-28">
                </div>
            </div>
            <div class="relative h-48 mb-4">
                <canvas id="trendChart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Month</th>
                            <th class="py-2 pr-4">LOP Days</th>
                            <th class="py-2 pr-4">Proration %</th>
                            <th class="py-2 pr-4">Impact (₹)</th>
                            <th class="py-2 pr-4">Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="histRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Policy -->
    <section id="policyPanel" class="lop-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-book-open mr-2"></i> LOP &
                    Proration Policy (Summary)</h3>
                <div class="space-y-3 text-sm text-slate-700">
                    <div class="rounded-lg bg-slate-50 p-3">Payroll proration = LOP Days / Working Days. (Pay Impact =
                        Base Salary × Proration)</div>
                    <div class="rounded-lg bg-slate-50 p-3">Leaves applied post cut-off may convert to LOP.</div>
                    <div class="rounded-lg bg-slate-50 p-3">Sandwich rule not applied on weekends ().</div>
                </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-headset mr-2"></i> Support
                </h3>
                <div class="space-y-2 text-sm">
                    <div><b>Email:</b> payroll@example.com</div>
                    <div><b>SLA:</b> 2 business days</div>
                    <button id="contactBtn"
                        class="mt-2 px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-paper-plane mr-1"></i> Contact Payroll
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- New Request Modal -->
<div id="reqModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">New Regularization</h3>
                    <button id="closeReqModal" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                        <input id="rqDate" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                        <select id="rqType" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option value="full">Full-day LOP</option>
                            <option value="half">Half-day LOP</option>
                            <option value="miss">Missing punch</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Reason</label>
                        <input id="rqReason" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="e.g., Doctor visit">
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelReq"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="saveReq"
                            class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ---- Data ---- */
    const MONTHLY = {
        'Sep 2025': {
            workingDays: 21, baseSalary: 100000,
            lop: [
                { day: 3, type: 'full', reason: 'Unplanned leave' },
                { day: 9, type: 'half', reason: 'Late login' },
                { day: 18, type: 'full', reason: 'No show' }
            ],
            leaveBalance: 2.5
        },
        'Aug 2025': { workingDays: 22, baseSalary: 98000, lop: [{ day: 27, type: 'half', reason: 'Early exit' }], leaveBalance: 3.0 },
        'Jul 2025': { workingDays: 23, baseSalary: 98000, lop: [], leaveBalance: 2.0 }
    };

    let REQS = [
        { ts: '2025-09-12 10:05', date: '2025-09-09', type: 'half', reason: 'Team offsite travel', status: 'Approved' },
        { ts: '2025-09-19 16:40', date: '2025-09-18', type: 'full', reason: 'System outage', status: 'Pending' }
    ];

    const HISTORY = [
        { month: '2025-09', lop: 2.5, pror: 11.9, impact: 11900, remark: '3 LOP entries' },
        { month: '2025-08', lop: 0.5, pror: 2.2, impact: 2156, remark: 'Half-day' },
        { month: '2025-07', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2025-06', lop: 1, pror: 4.5, impact: 4410, remark: 'Sick leave lapse' },
        { month: '2025-05', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2025-04', lop: 1, pror: 4.3, impact: 4200, remark: 'Missed swipe' },
        { month: '2025-03', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2025-02', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2025-01', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2024-12', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2024-11', lop: 0, pror: 0, impact: 0, remark: 'Clean' },
        { month: '2024-10', lop: 0.5, pror: 2.3, impact: 2100, remark: 'Half-day' }
    ];

    /* ---- Panels & Charts ---- */
    const panels = {
        overview: document.getElementById('overviewPanel'),
        calendar: document.getElementById('calendarPanel'),
        adjust: document.getElementById('adjustPanel'),
        history: document.getElementById('historyPanel'),
        policy: document.getElementById('policyPanel')
    };
    let _impactChart, _mixChart, _trendChart;
    let whatIfDays = 0; // simulated converted lop -> paid

    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        hydrateMonthPicker();
        wireButtons();
        renderOverview();
        renderCalendar();
        renderReqs();
        renderHistory();
        drawImpact();
        drawMix();
        drawTrend();
    });

    function setupTabs() {
        document.querySelectorAll('.lop-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.lop-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name].classList.remove('hidden');
                if (name === 'calendar') document.getElementById('calLabel').textContent = document.getElementById('monthPicker').value;
            });
        });
    }

    function hydrateMonthPicker() {
        const sel = document.getElementById('monthPicker');
        sel.innerHTML = '';
        Object.keys(MONTHLY).forEach(m => {
            const o = document.createElement('option'); o.textContent = m; sel.appendChild(o);
        });
        sel.value = Object.keys(MONTHLY)[0];
        document.getElementById('cycleLabel').textContent = sel.value;
        document.getElementById('calLabel').textContent = sel.value;
    }

    function wireButtons() {
        document.getElementById('monthPicker').addEventListener('change', onMonthChange);
        document.getElementById('salaryBasis').addEventListener('change', renderOverview);
        document.getElementById('exportBtn').addEventListener('click', exportCsv);
        document.getElementById('reqRegBtn').addEventListener('click', openReqModal);
        document.getElementById('newReqBtn').addEventListener('click', openReqModal);
        document.getElementById('closeReqModal').addEventListener('click', closeReqModal);
        document.getElementById('cancelReq').addEventListener('click', closeReqModal);
        document.getElementById('saveReq').addEventListener('click', saveReq);
        document.getElementById('downloadMemoBtn').addEventListener('click', () => alert('📄 LOP memo downloaded (demo)'));
        document.getElementById('raiseQueryBtn').addEventListener('click', () => alert('📩 Query form opened (demo)'));
        document.getElementById('contactBtn').addEventListener('click', () => alert('📬 Opening support ticket (demo)'));
        document.getElementById('searchHist').addEventListener('input', renderHistory);
        document.getElementById('statusHist').addEventListener('change', renderHistory);
        document.getElementById('impactMin').addEventListener('input', renderHistory);
        document.getElementById('impactMax').addEventListener('input', renderHistory);
        document.getElementById('applyBalance').addEventListener('click', applyLeaveBalance);

        const slider = document.getElementById('whatIf');
        slider.addEventListener('input', () => {
            whatIfDays = Number(slider.value);
            document.getElementById('whatIfLabel').textContent = `${whatIfDays} day(s)`;
            renderOverview(); drawImpact();
        });
    }

    /* ---- Overview / Metrics ---- */
    function onMonthChange() {
        document.getElementById('cycleLabel').textContent = document.getElementById('monthPicker').value;
        document.getElementById('calLabel').textContent = document.getElementById('monthPicker').value;
        whatIfDays = 0; document.getElementById('whatIf').value = 0; document.getElementById('whatIfLabel').textContent = '0 day(s)';
        renderOverview(); renderCalendar(); drawImpact(); drawMix();
    }

    function getMonthData() {
        const m = document.getElementById('monthPicker').value;
        const data = JSON.parse(JSON.stringify(MONTHLY[m] || { workingDays: 0, baseSalary: 0, lop: [], leaveBalance: 0 }));
        // apply what-if conversion (turn LOP back to paid days)
        let toConvert = Math.min(whatIfDays, totalLopDays(data.lop));
        if (toConvert > 0) {
            for (const e of data.lop) {
                const val = (e.type === 'half') ? 0.5 : 1;
                if (toConvert <= 0) break;
                if (val <= toConvert) { e.type = 'conv'; toConvert -= val; } // mark converted (ignored in tally)
                else if (e.type === 'full' && toConvert === 0.5) { e.type = 'half'; toConvert = 0; } // partial convert
            }
        }
        return data;
    }
    function totalLopDays(list) { return list.reduce((a, x) => a + (x.type === 'half' ? 0.5 : (x.type === 'full' ? 1 : 0)), 0); }

    function renderOverview() {
        const data = getMonthData();
        const lopDays = totalLopDays(data.lop);
        const pror = data.workingDays ? (lopDays / data.workingDays) : 0;
        const impact = Math.round(data.baseSalary * pror);
        const perDay = data.workingDays ? Math.round(data.baseSalary / data.workingDays) : 0;

        document.getElementById('tileDays').textContent = lopDays.toFixed(1).replace('.0', '');
        document.getElementById('tilePror').textContent = (pror * 100).toFixed(1).replace('.0', '') + '%';
        document.getElementById('tileImpact').textContent = fmt(impact);
        document.getElementById('tileBal').textContent = Number(data.leaveBalance).toFixed(1);

        // set slider max
        const maxConvertible = totalLopDays(MONTHLY[document.getElementById('monthPicker').value]?.lop || []);
        const slider = document.getElementById('whatIf');
        slider.max = Math.floor(maxConvertible * 2) / 2; // allow 0.5 steps
        slider.step = 0.5;

        // risk badge
        const badge = document.getElementById('riskBadge');
        const tone = lopDays >= 3 ? { txt: 'High', cls: 'bg-red-50 text-red-700' } :
            lopDays >= 1 ? { txt: 'Moderate', cls: 'bg-amber-50 text-amber-700' } :
                { txt: 'Low', cls: 'bg-emerald-50 text-emerald-700' };
        badge.textContent = tone.txt; badge.className = 'px-2 py-1 text-xs rounded ' + tone.cls;

        // salary basis
        if (document.getElementById('salaryBasis').value === 'daily') {
            document.getElementById('tileImpact').textContent = fmt(perDay);
        }
    }

    /* ---- Calendar ---- */
    function renderCalendar() {
        const label = document.getElementById('monthPicker').value; // e.g., "Sep 2025"
        const [monthIdx, year] = parseMonthLabel(label); // monthIdx 0-11
        const first = new Date(year, monthIdx, 1);
        const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
        const offset = first.getDay(); // 0 Sun - 6 Sat
        const d = getMonthData();
        const grid = [];

        // leading blanks
        for (let i = 0; i < offset; i++) grid.push(blankCell());

        for (let day = 1; day <= daysInMonth; day++) {
            const mark = d.lop.find(x => x.day === day);
            const type = mark?.type || 'ok';
            grid.push(cell(day, type, mark?.reason || '', new Date(year, monthIdx, day)));
        }
        document.getElementById('calGrid').innerHTML = grid.join('');
    }
    function blankCell() { return `<div class="rounded-lg border border-slate-200 p-3 text-center text-sm opacity-40"> </div>`; }
    function cell(day, type, title, dt) {
        const isWeekend = [0, 6].includes(dt.getDay());
        const baseTone = isWeekend ? 'bg-slate-50' : 'bg-white';
        const tone = type === 'full' ? 'bg-red-50 text-red-700 border-red-200'
            : type === 'half' ? 'bg-amber-50 text-amber-700 border-amber-200'
                : type === 'conv' ? 'bg-sky-50 text-sky-700 border-sky-200'
                    : `border-slate-200 ${baseTone} text-emerald-700`;
        const label = type === 'full' ? 'LOP' : type === 'half' ? 'Half' : type === 'conv' ? 'Converted' : 'Present';
        return `<button class="rounded-lg border ${tone} p-3 text-center text-sm hover:ring-1 hover:ring-slate-200"
           title="${title || ''}" onclick="peekDay('${dt.toISOString().slice(0, 10)}','${label}','${title || ''}')">
            <div class="font-medium">${String(day).padStart(2, '0')}</div>
            <div class="text-xs">${label}</div>
          </button>`;
    }
    function parseMonthLabel(lbl) {
        const [mon, yr] = lbl.split(' ');
        const map = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };
        return [map[mon], Number(yr)];
    }
    window.peekDay = (iso, state, note) => {
        alert(`${iso}\nStatus: ${state}${note ? `\nNote: ${note}` : ''}\n\n(Quick regularization coming soon)`);
    }

    /* ---- Adjustments ---- */
    function renderReqs() {
        document.getElementById('reqRows').innerHTML = REQS.map(r => `
    <tr class="border-b last:border-0">
      <td class="py-2 pr-4 text-slate-600">${r.date}</td>
      <td class="py-2 pr-4 capitalize">${r.type}</td>
      <td class="py-2 pr-4">${r.reason}</td>
      <td class="py-2 pr-4">${badgePlain(r.status.toLowerCase())}</td>
      <td class="py-2 pr-4">
        <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="alert('👀 View request (demo)')">
          <i class="fa-solid fa-eye mr-1"></i> View
        </button>
      </td>
    </tr>`).join('');
    }
    function openReqModal() { document.getElementById('reqModal').classList.remove('hidden'); }
    function closeReqModal() { document.getElementById('reqModal').classList.add('hidden'); }
    function saveReq() {
        const date = document.getElementById('rqDate').value;
        const type = document.getElementById('rqType').value;
        const reason = (document.getElementById('rqReason').value || '').trim();
        if (!date || !reason) { alert('❌ Date & reason required'); return; }
        REQS.unshift({ ts: new Date().toISOString().slice(0, 16).replace('T', ' '), date, type, reason, status: 'Pending' });
        closeReqModal(); renderReqs(); alert('✅ Request submitted (demo)');
    }
    function applyLeaveBalance() {
        const m = document.getElementById('monthPicker').value;
        const d = MONTHLY[m];
        if (!d) return;
        const maxConv = Math.min(d.leaveBalance, totalLopDays(d.lop));
        if (maxConv <= 0) { alert('Nothing to apply.'); return; }
        d.leaveBalance = Math.max(0, d.leaveBalance - maxConv);
        whatIfDays = 0; document.getElementById('whatIf').value = 0;
        // mutate lop: consume entries from end
        let toUse = maxConv;
        for (const e of d.lop) {
            if (toUse <= 0) break;
            const val = (e.type === 'half') ? 0.5 : 1;
            if (val <= toUse) { e.type = 'conv'; toUse -= val; }
            else if (e.type === 'full' && toUse === 0.5) { e.type = 'half'; toUse = 0; }
        }
        renderOverview(); renderCalendar(); drawImpact(); drawMix();
    }

    /* ---- History ---- */
    function renderHistory() {
        const q = (document.getElementById('searchHist').value || '').toLowerCase();
        const st = document.getElementById('statusHist').value;
        const min = Number(document.getElementById('impactMin').value || NaN);
        const max = Number(document.getElementById('impactMax').value || NaN);

        const rows = HISTORY
            .filter(h => (st === 'all' ? true : (st === 'lop' ? h.lop > 0 : h.lop === 0)))
            .filter(h => labelMonth(h.month).toLowerCase().includes(q) || (h.remark || '').toLowerCase().includes(q))
            .filter(h => (isNaN(min) || h.impact >= min) && (isNaN(max) || h.impact <= max))
            .slice().sort((a, b) => b.month.localeCompare(a.month));

        document.getElementById('histRows').innerHTML = rows.map(h => `
    <tr class="border-b last:border-0">
      <td class="py-2 pr-4">${labelMonth(h.month)}</td>
      <td class="py-2 pr-4">${h.lop}</td>
      <td class="py-2 pr-4">${h.pror}%</td>
      <td class="py-2 pr-4">₹${fmt(h.impact)}</td>
      <td class="py-2 pr-4">${h.remark || ''}</td>
    </tr>`).join('');
    }

    /* ---- Charts ---- */
    function drawImpact() {
        const d = getMonthData();
        const lopDays = totalLopDays(d.lop);
        const impact = Math.round(d.baseSalary * (d.workingDays ? lopDays / d.workingDays : 0));
        const ctx = document.getElementById('impactChart').getContext('2d');
        _impactChart && _impactChart.destroy();
        _impactChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Base', 'Impact'], datasets: [{ label: 'Amount (₹)', data: [d.baseSalary, impact] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true } } }
        });
    }
    function drawMix() {
        const m = document.getElementById('monthPicker').value;
        const d = getMonthData();
        const byReason = d.lop.reduce((m, x) => { const val = x.type === 'half' ? 0.5 : (x.type === 'full' ? 1 : 0); m[x.reason] = (m[x.reason] || 0) + val; return m; }, {});
        const ctx = document.getElementById('mixChart').getContext('2d');
        _mixChart && _mixChart.destroy();
        _mixChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(byReason), datasets: [{ data: Object.values(byReason) }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } }, animation: false }
        });
        document.getElementById('mixLegend').innerHTML =
            Object.entries(byReason).map(([k, v]) => `<div class="flex items-center justify-between text-sm"><span>${k}</span><span>${v} day(s)</span></div>`).join('') ||
            '<div class="text-sm text-slate-600">No LOP this month.</div>';
    }
    function drawTrend() {
        const labels = HISTORY.slice().sort((a, b) => a.month.localeCompare(b.month)).map(h => labelMonth(h.month));
        const vals = HISTORY.slice().sort((a, b) => a.month.localeCompare(b.month)).map(h => h.lop);
        const ctx = document.getElementById('trendChart').getContext('2d');
        _trendChart && _trendChart.destroy();
        _trendChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'LOP Days', data: vals }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, animation: false, scales: { y: { beginAtZero: true } } }
        });
    }

    /* ---- Export ---- */
    function exportCsv() {
        const m = document.getElementById('monthPicker').value;
        const d = MONTHLY[m];
        const rows1 = [['month', 'working_days', 'base_salary', 'leave_balance', 'lop_day', 'lop_type', 'reason']];
        (d.lop || []).forEach(e => rows1.push([m, d.workingDays, d.baseSalary, d.leaveBalance, e.day, e.type, e.reason]));
        const rows2 = [['history_month', 'lop_days', 'proration_pct', 'impact', 'remark']];
        HISTORY.forEach(h => rows2.push([h.month, h.lop, h.pror, h.impact, h.remark || '']));

        const csv = toCsv(rows1) + '\n\n' + toCsv(rows2);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'lop_export.csv'; a.click();
        URL.revokeObjectURL(url);
    }
    function toCsv(rows) { return rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n'); }

    /* ---- Helpers ---- */
    function fmt(n) { return (n || 0).toLocaleString('en-IN'); }
    function labelMonth(ym) { const [y, m] = ym.split('-'); return new Date(Number(y), Number(m) - 1, 1).toLocaleString('en-IN', { month: 'short', year: 'numeric' }); }
    function badgePlain(s) {
        const m = { approved: 'bg-emerald-50 text-emerald-700', pending: 'bg-amber-50 text-amber-700', rejected: 'bg-red-50 text-red-700' };
        const label = s.charAt(0).toUpperCase() + s.slice(1);
        return `<span class="px-2 py-0.5 rounded-full ${m[s] || 'bg-slate-100 text-slate-700'} text-xs">${label}</span>`;
    }
</script>

<style>
    .lop-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .lop-tab:not(.active) {
        color: #64748b;
    }

    .lop-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}