{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-calendar-check mr-2"></i> Proof Submission Window
            </h1>
            <p class="text-slate-600 text-sm">Submit deductible proofs within the window.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="uploadBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-upload mr-1"></i> Upload Proof
            </button>
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
            </button>
            <button id="downloadChecklistBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-list-check mr-1"></i> Download Checklist
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl">
            <button id="overviewTab" class="psw-tab active px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-gauge-high mr-1"></i> Overview
            </button>
            <button id="uploadsTab" class="psw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-file-circle-check mr-1"></i> Uploads
            </button>
            <button id="guidelinesTab" class="psw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-book-open mr-1"></i> Guidelines
            </button>
            <button id="timelineTab" class="psw-tab px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-timeline mr-1"></i> Timeline
            </button>
        </div>
    </div>

    <!-- Overview -->
    <section id="overviewPanel" class="psw-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Window & countdown -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-window-restore mr-2"></i> Window
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="editWindowBtn"
                            class="px-2 py-1 text-xs rounded border border-slate-300 bg-white hover:bg-slate-50">
                            <i class="fa-solid fa-screwdriver-wrench"></i> Settings
                        </button>
                        <span id="winBadge" class="px-2 py-1 text-xs rounded bg-emerald-50 text-emerald-700">Open</span>
                    </div>
                </div>
                <div class="mt-3 text-sm text-slate-700">
                    <div><b>Opens:</b> <span id="openDate">Dec 01, 2025</span></div>
                    <div><b>Closes:</b> <span id="closeDate">Jan 15, 2026</span></div>
                    <div class="mt-2"><b>Time left:</b> <span id="countdown">--</span></div>
                </div>
                <div class="mt-4">
                    <div class="w-full bg-slate-100 rounded-full h-2">
                        <div id="progressBar" class="h-2 rounded-full bg-emerald-500" style="width:0%"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1">
                        <span id="progressText">0% of window elapsed</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-5">
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Submitted</div>
                        <div id="sumSubmitted" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Pending</div>
                        <div id="sumPending" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                    <div class="rounded-lg bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Rejected</div>
                        <div id="sumRejected" class="text-xl font-semibold text-slate-800">0</div>
                    </div>
                </div>
            </div>

            <!-- Section coverage -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Section Coverage
                    </h3>
                </div>
                <div class="relative h-40">
                    <canvas id="coverageChart" class="absolute inset-0 w-full h-full"></canvas>
                </div>
                <div id="coverageLegend" class="mt-3 text-sm text-slate-700"></div>
            </div>

            <!-- Quick actions -->
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-bolt mr-2"></i> Quick Actions
                    </h3>
                </div>
                <div class="space-y-3">
                    <button id="uploadActionBtn"
                        class="w-full px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-left">
                        <i class="fa-solid fa-upload mr-2"></i> Upload a proof
                    </button>
                    <button id="bulkZipBtn"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-box-archive mr-2"></i> Download all receipts
                    </button>
                    <button id="contactBtn"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-left">
                        <i class="fa-solid fa-headset mr-2"></i> Contact payroll
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Uploads -->
    <section id="uploadsPanel" class="psw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-file-circle-check mr-2"></i> Proofs
                </h3>
                <div class="flex items-center gap-2">
                    <input id="searchInput" type="text" placeholder="Search section or file..."
                        class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <select id="statusFilter" class="px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button id="addRowBtn"
                        class="px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 text-sm">
                        <i class="fa-solid fa-plus mr-1"></i> Add Row
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                        <tr>
                            <th class="py-2 pr-4">Section</th>
                            <th class="py-2 pr-4">Declared (â‚¹)</th>
                            <th class="py-2 pr-4">Proof</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2 pr-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="proofRows" class="text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Guidelines -->
    <section id="guidelinesPanel" class="psw-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-book-open mr-2"></i> What to submit
                </h3>
                <ul class="list-disc pl-5 text-sm text-slate-700 space-y-2">
                    <li>80C: PPF/ELSS/LIC receipts; EPF auto-considered.</li>
                    <li>80D: Health insurance premium receipt with policy no.</li>
                    <li>HRA: Rent receipts, landlord PAN (if applicable), agreement.</li>
                    <li>LTA: Tickets + boarding passes for eligible travel.</li>
                    <li>NPS 80CCD(1B): Contribution receipt.</li>
                </ul>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">
                    <i class="fa-solid fa-circle-info mr-2"></i> Tips
                </h3>
                <ul class="list-disc pl-5 text-sm text-slate-700 space-y-2">
                    <li>Combine multiple pages into a single PDF per section.</li>
                    <li>Ensure name, amount, dates are clearly visible.</li>
                    <li>Only PNG/JPG/PDF up to 5 MB each.</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Timeline -->
    <section id="timelinePanel" class="psw-panel hidden">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">
                    <i class="fa-solid fa-timeline mr-2"></i> Timeline & Status
                </h3>
                <select id="fyPicker" class="px-2 py-1 rounded-lg border border-slate-300 text-sm">
                    <option>FY 2025-26</option>
                    <option>FY 2024-25</option>
                </select>
            </div>
            <div class="relative h-48 mb-4">
                <canvas id="statusChart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
            <div id="timelineList" class="space-y-3 text-sm"></div>
        </div>
    </section>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Upload Proof</h3>
                    <button id="closeUploadModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-3 text-sm">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Section</label>
                        <select id="upSection" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                            <option>80C</option>
                            <option>80D</option>
                            <option>80CCD(1B)</option>
                            <option>HRA</option>
                            <option>LTA</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">File</label>
                        <input id="upFile" type="file" accept=".pdf,.png,.jpg,.jpeg"
                            class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        <div class="text-xs text-slate-500 mt-1">Accepted: PDF/PNG/JPG â€¢ Max 5 MB</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                        <input id="upNotes" class="w-full rounded-lg border border-slate-300 px-3 py-2"
                            placeholder="optional">
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelUpload"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="saveUpload"
                            class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Window Settings Modal -->
<div id="winModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Window Settings</h3>
                    <button id="closeWinModal" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-3 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Opens</label>
                            <input id="winOpen" type="date" class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Closes</label>
                            <input id="winClose" type="date"
                                class="w-full rounded-lg border border-slate-300 px-3 py-2">
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="cancelWin"
                            class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
                        <button id="saveWin" class="px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ---------- LocalStorage ---------- */
    const LS = { get: k => JSON.parse(localStorage.getItem(k) || 'null'), set: (k, v) => localStorage.setItem(k, JSON.stringify(v)) };
    const K_PROOFS = 'psw_proofs', K_TIMELINE = 'psw_timeline', K_WINDOW = 'psw_window';

    /* ---------- Seed Data ---------- */
    let WINDOW = LS.get(K_WINDOW) || { open: '2025-12-01', close: '2026-01-15' };
    let PROOFS = LS.get(K_PROOFS) || [
        { id: 1, sec: '80C', declared: 90000, file: 'ppf_receipt.pdf', status: 'approved' },
        { id: 2, sec: '80D', declared: 24000, file: 'health_premium.pdf', status: 'pending' },
        { id: 3, sec: '80CCD(1B)', declared: 50000, file: 'nps_receipt.pdf', status: 'pending' },
        { id: 4, sec: 'HRA', declared: 180000, file: 'rent_bundle.pdf', status: 'rejected' },
        { id: 5, sec: 'LTA', declared: 30000, file: 'tickets.pdf', status: 'pending' }
    ];
    let TIMELINE = LS.get(K_TIMELINE) || [
        { ts: '2025-12-01 09:00', text: 'Window opened' },
        { ts: '2025-12-05 18:10', text: 'Uploaded 80C proof' },
        { ts: '2025-12-22 11:40', text: 'Uploaded HRA bundle' },
        { ts: '2025-12-30 16:25', text: 'Uploaded 80D receipt' }
    ];
    function persist() { LS.set(K_PROOFS, PROOFS); LS.set(K_TIMELINE, TIMELINE); LS.set(K_WINDOW, WINDOW); }

    /* ---------- Panels/Tabs ---------- */
    const panels = {
        overview: document.getElementById('overviewPanel'),
        uploads: document.getElementById('uploadsPanel'),
        guidelines: document.getElementById('guidelinesPanel'),
        timeline: document.getElementById('timelinePanel')
    };
    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        wireButtons();
        renderOverview();
        renderProofs();
        drawCoverage();
        renderTimeline();
        drawStatus();
        startTick();
    });

    /* ---------- Tabs ---------- */
    function setupTabs() {
        document.querySelectorAll('.psw-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.psw-tab').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const name = e.currentTarget.id.replace('Tab', '');
                Object.values(panels).forEach(p => p.classList.add('hidden'));
                panels[name].classList.remove('hidden');
            });
        });
    }

    /* ---------- Buttons & Events ---------- */
    function wireButtons() {
        // Upload
        document.getElementById('uploadBtn').addEventListener('click', openUpload);
        document.getElementById('uploadActionBtn').addEventListener('click', openUpload);
        document.getElementById('closeUploadModal').addEventListener('click', closeUpload);
        document.getElementById('cancelUpload').addEventListener('click', closeUpload);
        document.getElementById('saveUpload').addEventListener('click', saveUpload);

        // Upload table controls
        document.getElementById('searchInput').addEventListener('input', renderProofs);
        document.getElementById('statusFilter').addEventListener('change', renderProofs);
        document.getElementById('addRowBtn').addEventListener('click', addRow);

        // Window settings
        document.getElementById('editWindowBtn').addEventListener('click', openWinModal);
        document.getElementById('closeWinModal').addEventListener('click', closeWinModal);
        document.getElementById('cancelWin').addEventListener('click', closeWinModal);
        document.getElementById('saveWin').addEventListener('click', saveWindow);

        // Utilities
        document.getElementById('fyPicker').addEventListener('change', drawStatus);
        document.getElementById('bulkZipBtn').addEventListener('click', makeZip);
        document.getElementById('downloadChecklistBtn').addEventListener('click', downloadChecklist);
        document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
        document.getElementById('contactBtn').addEventListener('click', () => alert('ðŸ“¬ Opening support ticket'));
    }

    /* ---------- Overview ---------- */
    let _coverageChart, _statusChart, _countTick;
    function renderOverview() {
        const submitted = PROOFS.filter(p => p.status !== 'pending').length;
        const rejected = PROOFS.filter(p => p.status === 'rejected').length;
        const pending = PROOFS.filter(p => p.status === 'pending').length;
        _id('sumSubmitted').textContent = submitted;
        _id('sumPending').textContent = pending;
        _id('sumRejected').textContent = rejected;

        const open = new Date(WINDOW.open + 'T00:00:00');
        const close = new Date(WINDOW.close + 'T23:59:59');
        const now = new Date();
        const total = Math.max(0, close - open);
        const elapsed = Math.min(Math.max(0, now - open), total);
        const pct = total ? Math.round((elapsed / total) * 100) : 0;

        const badge = _id('winBadge');
        if (now < open) { setBadge(badge, 'Upcoming', 'amber'); }
        else if (now > close) { setBadge(badge, 'Closed', 'red'); }
        else { setBadge(badge, 'Open', 'emerald'); }

        _id('progressBar').style.width = pct + '%';
        _id('progressText').textContent = `${pct}% of window elapsed`;
        _id('openDate').textContent = fmtDate(open);
        _id('closeDate').textContent = fmtDate(close);

        // Coverage legend
        const bySec = groupSum(PROOFS, 'sec', 'declared');
        _id('coverageLegend').innerHTML = Object.entries(bySec).map(([k, v]) => `
    <div class="flex items-center justify-between text-sm"><span>${k}</span><span>â‚¹${fmtIN(v)}</span></div>
  `).join('') || '<div class="text-slate-500 text-sm">No declarations yet.</div>';
    }

    /* ---------- Countdown ---------- */
    function startTick() { updateCountdown(); clearInterval(_countTick); _countTick = setInterval(updateCountdown, 1000); }
    function updateCountdown() {
        const now = new Date(), open = new Date(WINDOW.open + 'T00:00:00'), close = new Date(WINDOW.close + 'T23:59:59');
        let out = 'Window closed';
        if (now < open) { out = 'Opens soon'; }
        else if (now <= close) {
            const diff = close - now;
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            out = `${pad(d)}d : ${pad(h)}h : ${pad(m)}m : ${pad(s)}s`;
        }
        _id('countdown').textContent = out;
    }

    /* ---------- Uploads Table ---------- */
    function renderProofs() {
        const q = (_id('searchInput').value || '').toLowerCase();
        const st = _id('statusFilter').value;
        const rows = PROOFS
            .filter(p => st === 'all' ? true : p.status === st)
            .filter(p => p.sec.toLowerCase().includes(q) || (p.file || '').toLowerCase().includes(q))
            .slice().sort((a, b) => a.sec.localeCompare(b.sec));

        _id('proofRows').innerHTML = rows.map(r => `
    <tr class="border-b last:border-0">
      <td class="py-2 pr-4">
        <select class="rounded border border-slate-300 px-2 py-1 text-sm" onchange="updateField(${r.id},'sec',this.value)">
          ${['80C', '80D', '80CCD(1B)', 'HRA', 'LTA'].map(s => `<option ${s === r.sec ? 'selected' : ''}>${s}</option>`).join('')}
        </select>
      </td>
      <td class="py-2 pr-4">
        <input type="number" class="w-32 rounded border border-slate-300 px-2 py-1 text-sm"
               value="${r.declared || 0}" onchange="updateNumber(${r.id},'declared',this.value)">
      </td>
      <td class="py-2 pr-4">${r.file ? `<i class="fa-solid fa-paperclip mr-1"></i>${escapeHtml(r.file)}` : '-'}</td>
      <td class="py-2 pr-4">${badgePlain(r.status)}</td>
      <td class="py-2 pr-4">
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="openUpload('${r.sec}')">
            <i class="fa-solid fa-upload mr-1"></i> Upload
          </button>
          <button class="px-2 py-1 rounded text-white ${r.file ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-400 cursor-not-allowed'} text-xs" ${r.file ? '' : 'disabled'} onclick="alert('Preview: ${escapeHtml(r.file || 'N/A')}')">
            <i class="fa-solid fa-eye mr-1"></i> Preview
          </button>
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="markStatus(${r.id},'approved')">
            <i class="fa-solid fa-check mr-1"></i> Approve
          </button>
          <button class="px-2 py-1 rounded border border-slate-300 bg-white text-xs hover:bg-slate-50" onclick="markStatus(${r.id},'rejected')">
            <i class="fa-solid fa-xmark mr-1"></i> Reject
          </button>
          <button class="px-2 py-1 rounded border border-rose-200 bg-white text-xs hover:bg-rose-50 text-rose-700" onclick="removeRow(${r.id})">
            <i class="fa-solid fa-trash mr-1"></i> Delete
          </button>
        </div>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="py-6 text-center text-slate-500">No records.</td></tr>`;

        // refresh analytics
        renderOverview(); drawCoverage(); drawStatus();
    }
    function addRow() {
        const id = Date.now();
        PROOFS.unshift({ id, sec: '80C', declared: 0, file: '', status: 'pending' });
        persist(); renderProofs();
    }
    function updateField(id, key, val) { const r = PROOFS.find(x => x.id === id); if (!r) return; r[key] = val; persist(); renderOverview(); drawCoverage(); }
    function updateNumber(id, key, val) { const n = Number(val) || 0; updateField(id, key, n); }
    function removeRow(id) { if (!confirm('Delete this row?')) return; PROOFS = PROOFS.filter(x => x.id !== id); persist(); renderProofs(); }
    function markStatus(id, st) { const r = PROOFS.find(x => x.id === id); if (!r) return; r.status = st; persist(); renderProofs(); addTimeline(`${st === 'approved' ? 'Approved' : 'Rejected'} ${r.sec} proof`); }

    /* ---------- Timeline ---------- */
    function renderTimeline() {
        _id('timelineList').innerHTML = TIMELINE.map(t => `
    <div class="rounded-lg bg-slate-50 p-3">
      <div class="text-xs text-slate-500">${t.ts}</div>
      <div class="text-sm text-slate-800">${escapeHtml(t.text)}</div>
    </div>`).join('');
    }
    function addTimeline(text) {
        const ts = new Date().toISOString().replace('T', ' ').slice(0, 16);
        TIMELINE.unshift({ ts, text }); persist(); renderTimeline();
    }

    /* ---------- Charts ---------- */
    function drawCoverage() {
        const ctx = _id('coverageChart').getContext('2d');
        const bySec = groupSum(PROOFS, 'sec', 'declared');
        _coverageChart && _coverageChart.destroy();
        _coverageChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(bySec), datasets: [{ data: Object.values(bySec) }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } }, animation: false }
        });
    }
    function drawStatus() {
        const ctx = _id('statusChart').getContext('2d');
        const buckets = ['Approved', 'Pending', 'Rejected'];
        const counts = [
            PROOFS.filter(p => p.status === 'approved').length,
            PROOFS.filter(p => p.status === 'pending').length,
            PROOFS.filter(p => p.status === 'rejected').length
        ];
        _statusChart && _statusChart.destroy();
        _statusChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: buckets, datasets: [{ label: 'Count', data: counts }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true } } }
        });
    }

    /* ---------- Upload Modal ---------- */
    function openUpload(sec) { _id('uploadModal').classList.remove('hidden'); if (sec) _id('upSection').value = sec; _id('upFile').value = ''; _id('upNotes').value = ''; }
    function closeUpload() { _id('uploadModal').classList.add('hidden'); }
    function saveUpload() {
        const sec = _id('upSection').value;
        const fileInput = _id('upFile');
        const f = fileInput.files && fileInput.files[0];
        if (!f) { alert('Choose a file'); return; }
        const extOk = /\.(pdf|png|jpg|jpeg)$/i.test(f.name);
        const sizeOk = f.size <= 5 * 1024 * 1024;
        if (!extOk) { alert('Only PDF/PNG/JPG allowed'); return; }
        if (!sizeOk) { alert('Max file size is 5 MB'); return; }

        const rec = PROOFS.find(p => p.sec === sec) || (PROOFS.push({ id: Date.now(), sec, declared: 0, file: '', status: 'pending' }), PROOFS[PROOFS.length - 1]);
        rec.file = f.name;
        rec.status = 'pending';
        persist(); closeUpload(); renderProofs(); addTimeline(`Uploaded ${sec} proof`);
        alert('âœ… Proof uploaded');
    }

    /* ---------- Window Settings ---------- */
    function openWinModal() {
        _id('winOpen').value = WINDOW.open;
        _id('winClose').value = WINDOW.close;
        _id('winModal').classList.remove('hidden');
    }
    function closeWinModal() { _id('winModal').classList.add('hidden'); }
    function saveWindow() {
        const o = _id('winOpen').value, c = _id('winClose').value;
        if (!o || !c) { alert('Select both dates'); return; }
        if (new Date(o) > new Date(c)) { alert('Open date must be before close date'); return; }
        WINDOW = { open: o, close: c }; persist(); closeWinModal();
        renderOverview(); drawStatus(); startTick();
    }

    /* ---------- Utilities ---------- */
    function groupSum(arr, key, val) { return arr.reduce((m, x) => { m[x[key]] = (m[x[key]] || 0) + (x[val] || 0); return m; }, {}); }
    function fmtIN(n) { return (n || 0).toLocaleString('en-IN'); }
    function pad(n) { return String(n).padStart(2, '0'); }
    function _id(id) { return document.getElementById(id); }
    function fmtDate(d) { return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }); }
    function setBadge(el, txt, tone) { const m = { emerald: 'bg-emerald-50 text-emerald-700', amber: 'bg-amber-50 text-amber-700', red: 'bg-red-50 text-red-700' }; el.textContent = txt; el.className = `px-2 py-1 text-xs rounded ${m[tone] || 'bg-slate-100 text-slate-700'}`; }
    function badgePlain(s) { const k = s.toLowerCase(); const m = { approved: 'bg-emerald-50 text-emerald-700', pending: 'bg-amber-50 text-amber-700', rejected: 'bg-red-50 text-red-700' }; const label = k.charAt(0).toUpperCase() + k.slice(1); return `<span class="px-2 py-0.5 rounded-full ${m[k] || 'bg-slate-100 text-slate-700'} text-xs">${label}</span>`; }
    function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

    /* ---------- Downloaders ---------- */
    function downloadChecklist() {
        const lines = [
            'Proof Checklist',
            '----------------',
            '80C: PPF/ELSS/LIC receipts; EPF auto-considered',
            '80D: Health insurance premium with policy no.',
            'HRA: Rent receipts, agreement, landlord PAN (if applicable)',
            'LTA: Tickets + boarding passes (eligible travel)',
            'NPS 80CCD(1B): Contribution receipt'
        ];
        const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'proof-checklist.txt'; a.click(); URL.revokeObjectURL(url);
    }
    function exportCsv() {
        const cols = ['sec', 'declared', 'file', 'status'];
        const header = cols.join(',');
        const body = PROOFS.map(r => cols.map(k => `"${String(r[k] ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([header + '\n' + body], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'proofs.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function makeZip() {
        // client-only stub (no bundler); create a dummy .zip placeholder so the UX flows
        const blob = new Blob(['Receipts will be zipped by the server in production.'], { type: 'application/zip' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'receipts.zip'; a.click(); URL.revokeObjectURL(url);
    }
</script>

<style>
    .psw-tab.active {
        background-color: #1e293b;
        color: #fff;
    }

    .psw-tab:not(.active) {
        color: #64748b;
    }

    .psw-tab:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }
</style>
{% endblock %}