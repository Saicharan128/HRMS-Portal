{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-line mr-2"></i> Performance Management
            </h1>
            <p class="text-slate-600 text-sm">Drive continuous performance reviews and goal tracking for your team</p>
        </div>
        <a href="{{ url_for('dashboard') }}"
            class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </a>
    </div>

    <!-- Overview Cards -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="kpiWrap">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm">Total Goals</p>
                    <p id="kpiGoals" class="text-2xl font-bold text-slate-900">0</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-xl">
                    <i class="fa-solid fa-bullseye text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span id="kpiGoalRate" class="text-sm text-green-600">â€”</span>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm">Total Reviews</p>
                    <p id="kpiReviews" class="text-2xl font-bold text-slate-900">0</p>
                </div>
                <div class="p-3 bg-purple-100 rounded-xl">
                    <i class="fa-solid fa-star text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span id="kpiReviewRate" class="text-sm text-green-600">â€”</span>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm">Active Cycle</p>
                    <p id="kpiCycle" class="text-lg font-semibold text-slate-900">â€”</p>
                </div>
                <div class="p-3 bg-green-100 rounded-xl">
                    <i class="fa-regular fa-calendar text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm">Avg. Progress</p>
                    <p id="kpiAvgProg" class="text-2xl font-bold text-slate-900">â€”</p>
                </div>
                <div class="p-3 bg-orange-100 rounded-xl">
                    <i class="fa-solid fa-chart-bar text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Cycle:</label>
                <select id="fCycle" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">
                    <!-- injected -->
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Department:</label>
                <select id="fDept" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">
                    <option value="all">All Departments</option>
                    <option>Engineering</option>
                    <option>Marketing</option>
                    <option>Sales</option>
                    <option>HR</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">Status:</label>
                <select id="fStatus" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">
                    <option value="all">All Status</option>
                    <option>Draft</option>
                    <option>Open</option>
                    <option>In Progress</option>
                    <option>Submitted</option>
                    <option>Finalized</option>
                    <option>Completed</option>
                    <option>Archived</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnRefresh" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
                    <i class="fa-solid fa-rotate mr-1"></i> Apply
                </button>
                <button id="btnExportGoals"
                    class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-file-csv mr-1"></i> Export Goals
                </button>
                <button id="btnExportReviews"
                    class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-file-csv mr-1"></i> Export Reviews
                </button>
            </div>
        </div>
    </div>

    <!-- Overview Analytics -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Goal Progress Distribution -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-pie mr-2"></i> Goal Progress Distribution
            </h3>
            <div class="relative h-72"><canvas id="progressChart" class="absolute inset-0 w-full h-full"></canvas></div>
        </div>

        <!-- Department Performance -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-building mr-2"></i> Department Performance
            </h3>
            <div id="deptPerf" class="space-y-3"><!-- injected --></div>
        </div>

        <!-- Review Status -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-star mr-2"></i> Review Status
            </h3>
            <div class="relative h-72"><canvas id="reviewChart" class="absolute inset-0 w-full h-full"></canvas></div>
        </div>

        <!-- Top Performers -->
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-trophy mr-2"></i> Top Performers
            </h3>
            <div id="topList" class="space-y-2"><!-- injected --></div>
        </div>
    </div>

    <!-- Team Goals -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-slate-800">
                <i class="fa-solid fa-bullseye mr-2"></i> Team Goals Management
            </h2>
            <div class="flex gap-3">
                <button id="btnCreateGoal"
                    class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Create Goal
                </button>
                <button class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm">
                    <i class="fa-solid fa-users mr-1"></i> Bulk Actions
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-200">
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Employee</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Goal</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Progress</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Status</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Updated</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="goalRows"><!-- injected --></tbody>
            </table>
        </div>
    </div>

    <!-- Reviews -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-slate-800">
                <i class="fa-solid fa-star mr-2"></i> Performance Reviews Management
            </h2>
            <div class="flex gap-3">
                <button id="btnCreateReview"
                    class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Create Review
                </button>
                <button class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm">
                    <i class="fa-solid fa-users mr-1"></i> Bulk Assign
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-200">
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Reviewee</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Reviewer</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Rating</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Status</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Updated</th>
                        <th class="text-left p-3 text-sm font-medium text-slate-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="reviewRows"><!-- injected --></tbody>
            </table>
        </div>
    </div>

    <!-- Cycles -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-slate-800">
                <i class="fa-regular fa-calendar mr-2"></i> Performance Cycles Management
            </h2>
            <button id="btnCreateCycle" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Create Cycle
            </button>
        </div>

        <div class="space-y-4" id="cycleCards"><!-- injected --></div>
    </div>

    <!-- Trends -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-line mr-2"></i> Goal Completion Trends
            </h3>
            <div class="relative h-72"><canvas id="trendsChart" class="absolute inset-0 w-full h-full"></canvas></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-bar mr-2"></i> Department Ratings
            </h3>
            <div class="relative h-72"><canvas id="ratingsChart" class="absolute inset-0 w-full h-full"></canvas></div>
        </div>
    </div>
</div>

<!-- Quick Add Modal -->
<div id="pmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl max-w-lg w-full mx-4">
        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
            <h3 id="pmModalTitle" class="text-lg font-semibold text-slate-800">New</h3>
            <button id="pmClose" class="text-slate-400 hover:text-slate-600"><i
                    class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="p-6 space-y-3" id="pmModalBody"><!-- injected --></div>
        <div class="p-6 pt-0 flex items-center justify-end gap-2">
            <button id="pmCancel"
                class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cancel</button>
            <button id="pmSave" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i
                    class="fa-solid fa-floppy-disk mr-1"></i> Save</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    /* ---------- Data (with localStorage persistence) ---------- */
    const LS = { get: k => JSON.parse(localStorage.getItem(k) || 'null'), set: (k, v) => localStorage.setItem(k, JSON.stringify(v)) };
    const K_GOALS = 'pm_goals', K_REV = 'pm_reviews', K_CYC = 'pm_cycles';

    let GOALS = LS.get(K_GOALS) || [
        { id: 1, emp: 'Alice Johnson', dept: 'Engineering', title: 'Launch new feature', desc: 'Feature rollout by October', weight: 30, progress: 85, status: 'In Progress', updated: '2025-09-10', cycle: 'Q3 2025' },
        { id: 2, emp: 'Bob Smith', dept: 'Marketing', title: 'Campaign reach', desc: 'Target 1M impressions', weight: 20, progress: 50, status: 'Draft', updated: '2025-09-12', cycle: 'Q3 2025' },
        { id: 3, emp: 'Chitra Rao', dept: 'Sales', title: 'Upsell pipeline', desc: 'Close 10 enterprise upsells', weight: 25, progress: 100, status: 'Completed', updated: '2025-09-05', cycle: 'Q3 2025' },
        { id: 4, emp: 'Diego Perez', dept: 'HR', title: 'Hiring pipeline', desc: 'Fill 5 key roles', weight: 25, progress: 30, status: 'Open', updated: '2025-09-08', cycle: 'Q3 2025' }
    ];
    let REVIEWS = LS.get(K_REV) || [
        { id: 11, emp: 'Alice Johnson', dept: 'Engineering', reviewer: 'Sarah Lee', rating: 4, status: 'Finalized', updated: '2025-09-09', cycle: 'Q3 2025' },
        { id: 12, emp: 'Bob Smith', dept: 'Marketing', reviewer: 'Priya Nair', rating: null, status: 'Submitted', updated: '2025-09-12', cycle: 'Q3 2025' },
        { id: 13, emp: 'Diego Perez', dept: 'HR', reviewer: 'Anuj Gupta', rating: 3, status: 'Open', updated: '2025-09-07', cycle: 'Q3 2025' }
    ];
    let CYCLES = LS.get(K_CYC) || [
        { id: 'Q3 2025', start: '2025-07-01', end: '2025-09-30', status: 'Active' },
        { id: 'Q2 2025', start: '2025-04-01', end: '2025-06-30', status: 'Closed' },
        { id: 'Q1 2025', start: '2025-01-01', end: '2025-03-31', status: 'Closed' }
    ];
    function persist() { LS.set(K_GOALS, GOALS); LS.set(K_REV, REVIEWS); LS.set(K_CYC, CYCLES); }

    /* ---------- Filters ---------- */
    const fCycle = document.getElementById('fCycle');
    const fDept = document.getElementById('fDept');
    const fStatus = document.getElementById('fStatus');
    function seedCycleFilter() {
        fCycle.innerHTML = `<option value="all">All Cycles</option>` + CYCLES.map(c => `<option ${c.status === 'Active' ? 'selected' : ''}>${c.id}</option>`).join('');
    }

    /* ---------- KPIs ---------- */
    function updateKPIs() {
        const goals = filterGoals();
        const reviews = filterReviews();
        const completed = goals.filter(g => g.status === 'Completed').length;
        const rate = goals.length ? Math.round((completed / goals.length) * 100) : 0;
        const avgProg = goals.length ? Math.round(goals.reduce((a, g) => a + g.progress, 0) / goals.length) : 0;
        const finalized = reviews.filter(r => r.status === 'Finalized').length;
        const rRate = reviews.length ? Math.round((finalized / reviews.length) * 100) : 0;

        document.getElementById('kpiGoals').textContent = goals.length;
        document.getElementById('kpiGoalRate').textContent = `${rate}% completion rate`;
        document.getElementById('kpiReviews').textContent = reviews.length;
        document.getElementById('kpiReviewRate').textContent = `${rRate}% finalized`;
        const active = CYCLES.find(c => c.status === 'Active');
        document.getElementById('kpiCycle').textContent = active ? active.id : 'â€”';
        document.getElementById('kpiAvgProg').textContent = `${avgProg}%`;
    }

    /* ---------- Tables ---------- */
    const goalRows = document.getElementById('goalRows');
    const reviewRows = document.getElementById('reviewRows');
    const cycleCards = document.getElementById('cycleCards');

    function rowGoal(g) {
        const color = g.progress >= 90 ? 'bg-green-500' : g.progress >= 60 ? 'bg-blue-500' : g.progress >= 40 ? 'bg-yellow-500' : 'bg-orange-500';
        return `
  <tr class="border-b border-slate-100">
    <td class="p-3"><p class="font-medium text-slate-800">${g.emp}</p><p class="text-sm text-slate-600">${g.dept}</p></td>
    <td class="p-3">
      <p class="font-medium text-slate-800">${g.title}</p>
      <p class="text-sm text-slate-600">${g.desc}</p>
      <span class="text-xs bg-slate-100 px-2 py-1 rounded-lg">Weight: ${g.weight}%</span>
    </td>
    <td class="p-3">
      <div class="w-full bg-slate-200 rounded-full h-3"><div class="h-3 rounded-full ${color}" style="width:${g.progress}%"></div></div>
      <p class="text-sm text-slate-600 mt-1">${g.progress}%</p>
    </td>
    <td class="p-3">${badge(g.status)}</td>
    <td class="p-3"><p class="text-sm text-slate-600">${g.updated}</p></td>
    <td class="p-3">
      <button class="text-blue-600 hover:text-blue-800 text-sm mr-2" onclick="editGoal(${g.id})"><i class="fa-solid fa-eye"></i></button>
      <button class="text-slate-600 hover:text-slate-800 text-sm" onclick="quickUpdateGoal(${g.id})"><i class="fa-solid fa-edit"></i></button>
    </td>
  </tr>`;
    }

    function rowReview(r) {
        const stars = r.rating == null ? `<span class="text-sm text-slate-500">Not rated</span>` :
            `<div class="flex items-center">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5 - r.rating)}<span class="ml-2 text-sm text-slate-600">${r.rating}/5</span></div>`;
        return `
  <tr class="border-b border-slate-100">
    <td class="p-3"><p class="font-medium text-slate-800">${r.emp}</p><p class="text-sm text-slate-600">${r.dept}</p></td>
    <td class="p-3"><p class="font-medium text-slate-800">${r.reviewer}</p><p class="text-sm text-slate-600">${r.dept} Manager</p></td>
    <td class="p-3">${stars}</td>
    <td class="p-3">${badge(r.status)}</td>
    <td class="p-3"><p class="text-sm text-slate-600">${r.updated}</p></td>
    <td class="p-3">
      <button class="text-blue-600 hover:text-blue-800 text-sm mr-2" onclick="viewReview(${r.id})"><i class="fa-solid fa-eye"></i></button>
      <button class="text-slate-600 hover:text-slate-800 text-sm" onclick="quickUpdateReview(${r.id})"><i class="fa-solid fa-edit"></i></button>
    </td>
  </tr>`;
    }

    function cardCycle(c) {
        const pill = c.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600';
        return `
  <div class="border border-slate-200 rounded-xl p-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-slate-800">${c.id}</h3>
        <p class="text-sm text-slate-600">${c.start} to ${c.end}</p>
        <span class="px-2 py-1 rounded-lg text-xs font-medium ${pill}">${c.status}</span>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 text-sm" onclick="editCycle('${c.id}')">
          <i class="fa-solid fa-edit mr-1"></i>Edit
        </button>
        ${c.status === 'Active' ? `<button class="px-3 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 text-sm" onclick="closeCycle('${c.id}')">
          <i class="fa-solid fa-lock mr-1"></i>Close
        </button>`: ''}
      </div>
    </div>
  </div>`;
    }

    /* ---------- Rendering ---------- */
    function renderAll() {
        updateKPIs();
        // Goals
        const g = filterGoals();
        goalRows.innerHTML = g.map(rowGoal).join('') || emptyStateRow(6, 'No goals');
        // Reviews
        const r = filterReviews();
        reviewRows.innerHTML = r.map(rowReview).join('') || emptyStateRow(6, 'No reviews');
        // Cycles
        cycleCards.innerHTML = CYCLES.map(cardCycle).join('');
        // Dept cards
        renderDeptPerf(g);
        // Top performers
        renderTop(g);
        // Charts
        drawCharts(g, r);
    }

    function renderDeptPerf(goals) {
        const group = groupBy(goals, x => x.dept);
        const html = Object.entries(group).map(([dept, items]) => {
            const avg = Math.round(items.reduce((a, i) => a + i.progress, 0) / items.length);
            return `
    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
      <div><p class="font-medium text-slate-800">${dept}</p><p class="text-sm text-slate-600">${items.length} goals</p></div>
      <div class="text-right">
        <p class="text-lg font-bold text-blue-600">${avg}%</p>
        <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width:${avg}%"></div></div>
      </div>
    </div>`;
        }).join('');
        document.getElementById('deptPerf').innerHTML = html || `<div class="text-slate-500">No data</div>`;
    }

    function renderTop(goals) {
        const sorted = goals.slice().sort((a, b) => b.progress - a.progress).slice(0, 3);
        document.getElementById('topList').innerHTML = sorted.map((g, idx) => `
    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
      <div class="flex items-center gap-3">
        <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm font-bold flex items-center justify-center">${idx + 1}</span>
        <div><p class="font-medium text-slate-800">${g.emp}</p><p class="text-sm text-slate-600">${g.dept}</p></div>
      </div>
      <div class="text-right"><p class="font-bold text-green-600">${g.progress}%</p><p class="text-xs text-slate-500">${g.weight}% weight</p></div>
    </div>`).join('') || `<div class="text-slate-500">No performers</div>`;
    }

    /* ---------- Filters helpers ---------- */
    function filterGoals() {
        return GOALS.filter(g => {
            if (fCycle.value !== 'all' && g.cycle !== fCycle.value) return false;
            if (fDept.value !== 'all' && g.dept !== fDept.value) return false;
            if (fStatus.value !== 'all' && g.status !== fStatus.value) return false;
            return true;
        });
    }
    function filterReviews() {
        return REVIEWS.filter(r => {
            if (fCycle.value !== 'all' && r.cycle !== fCycle.value) return false;
            if (fDept.value !== 'all' && r.dept !== fDept.value) return false;
            if (fStatus.value !== 'all' && r.status !== fStatus.value) return false;
            return true;
        });
    }

    /* ---------- Charts with lifecycle ---------- */
    let _progressC, _reviewC, _trendsC, _ratingsC;
    function drawCharts(goals, reviews) {
        // Progress chart
        _progressC && _progressC.destroy();
        const counts = { 'Not Started': 0, 'Open': 0, 'In Progress': 0, 'Submitted': 0, 'Finalized': 0, 'Completed': 0, 'Draft': 0, 'Archived': 0 };
        goals.forEach(g => { counts[g.status] = (counts[g.status] || 0) + 1; });
        // re-map to 3 buckets: Not Started / In Progress / Completed
        const ns = (counts['Not Started'] || 0) + (counts['Open'] || 0) + (counts['Draft'] || 0);
        const ip = (counts['In Progress'] || 0) + (counts['Submitted'] || 0);
        const cp = (counts['Completed'] || 0) + (counts['Finalized'] || 0);
        _progressC = new Chart(document.getElementById('progressChart').getContext('2d'), {
            type: 'doughnut', data: { labels: ['Not Started', 'In Progress', 'Completed'], datasets: [{ data: [ns, ip, cp] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, animation: false, cutout: '65%' }
        });

        // Review status chart
        _reviewC && _reviewC.destroy();
        const revCounts = groupCount(reviews, x => x.status);
        const rLabels = ['Open', 'Submitted', 'Finalized'];
        _reviewC = new Chart(document.getElementById('reviewChart').getContext('2d'), {
            type: 'bar', data: { labels: rLabels, datasets: [{ label: 'Count', data: rLabels.map(l => revCounts[l] || 0) }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: false, scales: { y: { beginAtZero: true, precision: 0 } } }
        });

        // Trends (dummy monthly but cycle-aware)
        _trendsC && _trendsC.destroy();
        const months = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
        const series = months.map((_, i) => Math.round(40 + i * 7 + (Math.random() * 6 - 3))); // pretty line
        _trendsC = new Chart(document.getElementById('trendsChart').getContext('2d'), {
            type: 'line', data: { labels: months, datasets: [{ label: 'Completion Rate', data: series, tension: 0.4, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, animation: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        // Ratings by dept
        _ratingsC && _ratingsC.destroy();
        const depts = ['Engineering', 'Marketing', 'Sales', 'HR'];
        const ratings = depts.map(d => {
            const rs = reviews.filter(r => r.dept === d && r.rating != null).map(r => r.rating);
            return rs.length ? (rs.reduce((a, b) => a + b, 0) / rs.length).toFixed(2) : 0;
        });
        _ratingsC = new Chart(document.getElementById('ratingsChart').getContext('2d'), {
            type: 'bar', data: { labels: depts, datasets: [{ label: 'Avg Rating', data: ratings }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, animation: false, scales: { y: { beginAtZero: true, max: 5 } } }
        });
    }

    /* ---------- Modal: quick add/edit (dummy) ---------- */
    const modal = document.getElementById('pmModal'), pmBody = document.getElementById('pmModalBody'), pmTitle = document.getElementById('pmModalTitle');
    document.getElementById('pmClose').onclick = closeModal; document.getElementById('pmCancel').onclick = closeModal;
    document.getElementById('pmSave').onclick = saveModal;

    let modalCtx = { type: null, payload: null };
    document.getElementById('btnCreateGoal').onclick = () => openModal('goal');
    document.getElementById('btnCreateReview').onclick = () => openModal('review');
    document.getElementById('btnCreateCycle').onclick = () => openModal('cycle');

    function openModal(type, payload = null) {
        modalCtx = { type, payload };
        pmTitle.textContent = type === 'goal' ? 'Create Goal' : type === 'review' ? 'Create Review' : 'Create Cycle';
        pmBody.innerHTML = (type === 'goal') ? `
    <input id="mEmp" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Employee">
    <div class="grid grid-cols-2 gap-3 mt-2">
      <input id="mDept" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Department">
      <input id="mCycle" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Cycle (e.g., Q3 2025)">
    </div>
    <input id="mTitle" class="w-full rounded-lg border border-slate-300 px-3 py-2 mt-2" placeholder="Goal title">
    <input id="mDesc" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Description">
    <div class="grid grid-cols-3 gap-3 mt-2">
      <input id="mWeight" type="number" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Weight %">
      <input id="mProg" type="number" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Progress %">
      <select id="mStatus" class="rounded-lg border border-slate-300 px-3 py-2">
        <option>Draft</option><option>Open</option><option>In Progress</option><option>Submitted</option><option>Finalized</option><option>Completed</option><option>Archived</option>
      </select>
    </div>` :
            (type === 'review') ? `
    <div class="grid grid-cols-2 gap-3">
      <input id="rEmp" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Reviewee">
      <input id="rDept" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Department">
    </div>
    <div class="grid grid-cols-2 gap-3 mt-2">
      <input id="rReviewer" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Reviewer">
      <input id="rCycle" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Cycle">
    </div>
    <div class="grid grid-cols-2 gap-3 mt-2">
      <input id="rRating" type="number" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="Rating (1-5)">
      <select id="rStatus" class="rounded-lg border border-slate-300 px-3 py-2">
        <option>Open</option><option>Submitted</option><option>Finalized</option>
      </select>
    </div>` :
                `
    <input id="cId" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Cycle Id (e.g., Q4 2025)">
    <div class="grid grid-cols-2 gap-3 mt-2">
      <input id="cStart" type="date" class="rounded-lg border border-slate-300 px-3 py-2">
      <input id="cEnd" type="date" class="rounded-lg border border-slate-300 px-3 py-2">
    </div>
    <select id="cStatus" class="rounded-lg border border-slate-300 px-3 py-2 mt-2">
      <option>Active</option><option>Closed</option>
    </select>`;
        modal.classList.remove('hidden');
    }
    function closeModal() { modal.classList.add('hidden'); modalCtx = { type: null, payload: null }; }
    function saveModal() {
        if (modalCtx.type === 'goal') {
            const g = {
                id: Date.now(), emp: val('mEmp'), dept: val('mDept'), title: val('mTitle'), desc: val('mDesc'),
                weight: num('mWeight'), progress: num('mProg'), status: val('mStatus') || 'Draft', updated: today(), cycle: val('mCycle') || activeCycle()
            };
            if (!g.emp || !g.title) return alert('Employee & title required'); GOALS.unshift(g);
        } else if (modalCtx.type === 'review') {
            const r = {
                id: Date.now(), emp: val('rEmp'), dept: val('rDept'), reviewer: val('rReviewer'), rating: num('rRating') || null,
                status: val('rStatus') || 'Open', updated: today(), cycle: val('rCycle') || activeCycle()
            };
            if (!r.emp || !r.reviewer) return alert('Reviewee & reviewer required'); REVIEWS.unshift(r);
        } else {
            const c = { id: val('cId'), start: val('cStart'), end: val('cEnd'), status: val('cStatus') || 'Closed' };
            if (!c.id || !c.start || !c.end) return alert('Cycle id, start, end required');
            CYCLES.unshift(c);
        }
        persist(); seedCycleFilter(); closeModal(); renderAll();
    }

    /* ---------- Quick edit helpers (demo) ---------- */
    function quickUpdateGoal(id) {
        const g = GOALS.find(x => x.id === id); if (!g) return;
        const p = prompt('Update progress %', g.progress); if (p === null) return; g.progress = Math.max(0, Math.min(100, Number(p) || 0));
        g.status = g.progress >= 100 ? 'Completed' : (g.status === 'Draft' ? 'Open' : g.status); g.updated = today(); persist(); renderAll();
    }
    function editGoal(id) { alert('ðŸ‘€ Goal details (demo) #' + id); }
    function viewReview(id) { alert('ðŸ‘€ Review details (demo) #' + id); }
    function quickUpdateReview(id) {
        const r = REVIEWS.find(x => x.id === id); if (!r) return; const rating = prompt('New rating (1-5)', r.rating ?? ''); if (rating === null) return;
        const n = Number(rating); r.rating = (n >= 1 && n <= 5) ? n : null; r.updated = today(); persist(); renderAll();
    }
    function editCycle(id) { alert('âœï¸ Edit cycle ' + id + ' (demo)'); }
    function closeCycle(id) { const c = CYCLES.find(x => x.id === id); if (!c) return; c.status = 'Closed'; persist(); renderAll(); }

    /* ---------- Exports ---------- */
    document.getElementById('btnExportGoals').onclick = () => exportCsv(filterGoals(), ['emp', 'dept', 'title', 'weight', 'progress', 'status', 'updated', 'cycle'], 'goals.csv');
    document.getElementById('btnExportReviews').onclick = () => exportCsv(filterReviews(), ['emp', 'dept', 'reviewer', 'rating', 'status', 'updated', 'cycle'], 'reviews.csv');
    function exportCsv(rows, cols, name) {
        const header = cols.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
        const body = rows.map(r => cols.map(k => `"${String(r[k] ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([header + '\n' + body], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
    }

    /* ---------- Events ---------- */
    document.getElementById('btnRefresh').onclick = () => renderAll();
    [fDept, fStatus].forEach(el => el.addEventListener('change', renderAll));

    /* ---------- Utils ---------- */
    function groupBy(arr, fn) { return arr.reduce((m, x) => { (m[fn(x)] ||= []).push(x); return m; }, {}); }
    function groupCount(arr, fn) { return arr.reduce((m, x) => { const k = fn(x); m[k] = (m[k] || 0) + 1; return m; }, {}); }
    function badge(s) { const map = { 'Completed': 'bg-green-100 text-green-700', 'Finalized': 'bg-green-100 text-green-700', 'In Progress': 'bg-blue-100 text-blue-700', 'Open': 'bg-yellow-100 text-yellow-700', 'Submitted': 'bg-blue-100 text-blue-700', 'Draft': 'bg-slate-100 text-slate-600', 'Archived': 'bg-slate-100 text-slate-600' }; const cls = map[s] || 'bg-slate-100 text-slate-600'; return `<span class="px-2 py-1 rounded-lg text-xs font-medium ${cls}">${s}</span>`; }
    function emptyStateRow(cols, msg) { return `<tr><td colspan="${cols}" class="py-6 text-center text-slate-500">${msg}</td></tr>`; }
    function val(id) { return document.getElementById(id)?.value || ''; }
    function num(id) { return Number(val(id) || 0); }
    function today() { return new Date().toISOString().slice(0, 10); }
    function activeCycle() { return (CYCLES.find(c => c.status === 'Active') || {}).id || 'Q3 2025'; }

    /* ---------- Boot ---------- */
    seedCycleFilter();
    renderAll();
</script>
{% endblock %}