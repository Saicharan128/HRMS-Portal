{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-people-group mr-2"></i> Team overview
            </h1>
            <p class="text-slate-600 text-sm">Get a snapshot of team composition, capacity, and status.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-download mr-1"></i> Export CSV
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Summary cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-user-group mr-1"></i> Total Headcount</div>
            <div id="headcount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-briefcase mr-1"></i> Open Jobs</div>
            <div id="openJobs" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-person-digging mr-1"></i> In Pipeline</div>
            <div id="pipeline" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-user-check mr-1"></i> Recent Hires</div>
            <div id="recentHires" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Team Composition -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-pie mr-2"></i> By Employee Type
            </h2>
            <div id="typeComposition" class="space-y-3"></div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fa-solid fa-layer-group mr-2"></i> By Department
            </h2>
            <div id="deptComposition" class="space-y-3"></div>
        </div>
    </div>

    <!-- Team Members Table -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
            <h2 class="text-lg font-semibold text-slate-800">
                <i class="fa-solid fa-users mr-2"></i> Team Members
            </h2>
            <div class="flex flex-wrap items-center gap-2">
                <input id="searchInput" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"
                    placeholder="Search name, email, or ID...">
                <select id="typeFilter" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                    <option value="">All Types</option>
                    <option value="Employees">Employees</option>
                    <option value="HR">HR</option>
                    <option value="Leaders">Leaders</option>
                    <option value="CXOs">CXOs</option>
                    <option value="Contractors / Remote staff">Contractors</option>
                </select>
                <select id="deptFilter" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                    <option value="">All Departments</option>
                </select>
                <button id="refreshBtn"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-rotate mr-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <i class="fa-solid fa-spinner fa-spin text-slate-400 text-2xl mb-2"></i>
            <p class="text-slate-600">Loading team data...</p>
        </div>

        <!-- Table -->
        <div id="tableContainer" class="hidden overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="name">Name <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="employee_id">Employee ID <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="employee_type">Type <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="subposition">Position <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="designation">Designation <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Email</th>
                        <th class="th-sort px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                            data-key="created_at">Joined <i class="fa-solid fa-sort ms-1 text-slate-400"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Status</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody" class="bg-white divide-y divide-slate-200"></tbody>
            </table>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4 text-sm">
                <div class="text-slate-600">Showing <span id="pageInfo">0–0</span> of <span id="totalCount">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPage" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-50"
                        disabled>Prev</button>
                    <span id="pageNum" class="min-w-[3rem] text-center"></span>
                    <button id="nextPage" class="px-3 py-1 rounded border border-slate-300 hover:bg-slate-50"
                        disabled>Next</button>
                    <select id="pageSize" class="ml-2 rounded border border-slate-300 px-2 py-1">
                        <option>10</option>
                        <option>25</option>
                        <option>50</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-8">
            <i class="fa-solid fa-users-slash text-slate-300 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No team members found</h3>
            <p class="text-slate-600">Try adjusting your search criteria or filters.</p>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-8 rounded-2xl border border-slate-200 bg-white p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-clock-rotate-left mr-2"></i> Recent Activity
        </h2>
        <div id="recentActivity" class="space-y-4"></div>
    </div>
</div>

<script>
    /* ---------------- State ---------------- */
    let teamData = [];
    let jobsData = [];
    let candidatesData = [];

    /* Pagination & sort */
    let SORT = { key: 'name', dir: 'asc' };
    let PAGE = { size: 10, index: 1 };

    /* ---------------- Utilities ---------------- */
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    async function fetchJSON(url, { retries = 1, delay = 500 } = {}) {
        try {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return await res.json();
        } catch (e) {
            if (retries > 0) { await sleep(delay); return fetchJSON(url, { retries: retries - 1, delay }); }
            throw e;
        }
    }

    function formatDate(d) {
        if (!d) return '-';
        return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function relTime(d) {
        if (!d) return '';
        const diff = (Date.now() - new Date(d)) / 86400000;
        if (diff < 1) return 'today';
        if (diff < 7) return Math.floor(diff) + 'd ago';
        return formatDate(d);
    }

    function getEmployeeStatus(createdAt) {
        const created = new Date(createdAt);
        const days = Math.floor((Date.now() - created) / 86400000);
        if (isNaN(days)) return { text: '—', class: 'bg-slate-100 text-slate-700' };
        if (days <= 30) return { text: 'New', class: 'bg-emerald-50 text-emerald-700' };
        if (days <= 90) return { text: 'Recent', class: 'bg-blue-50 text-blue-700' };
        return { text: 'Active', class: 'bg-slate-100 text-slate-800' };
    }

    function initials(name = '') {
        const parts = String(name).trim().split(/\s+/).slice(0, 2);
        return parts.map(p => p[0]?.toUpperCase() || '').join('') || '•';
    }

    function groupCount(arr, key) {
        return arr.reduce((m, x) => { const k = (x[key] || 'Unknown'); m[k] = (m[k] || 0) + 1; return m; }, {});
    }

    function renderProgressRow(label, count, total) {
        const pct = total ? Math.round((count / total) * 100) : 0;
        return `
    <div class="py-1.5">
      <div class="flex items-center justify-between text-sm">
        <span class="text-slate-700">${label}</span>
        <span class="text-slate-600">${count} <span class="text-slate-400">(${pct}%)</span></span>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-2 mt-1">
        <div class="bg-slate-600 h-2 rounded-full" style="width:${pct}%"></div>
      </div>
    </div>`;
    }

    /* ---------------- Data loaders ---------------- */
    async function loadTeamData() {
        teamData = await fetchJSON('/api/users', { retries: 1 });
        updateSummaryCards();
        updateCompositions();
        hydrateDeptFilter();
        renderTable();
    }
    async function loadJobsData() {
        jobsData = await fetchJSON('/api/jobs', { retries: 1 });
        const openJobs = jobsData.filter(j => j.status === 'Open').length;
        document.getElementById('openJobs').textContent = openJobs;
    }
    async function loadCandidatesData() {
        candidatesData = await fetchJSON('/api/candidates', { retries: 1 });
        const inPipeline = candidatesData.filter(c => !['Rejected', 'Onboarding'].includes(c.stage)).length;
        const recentHires = candidatesData.filter(c => c.stage === 'Onboarding' && c.created_at).length;
        document.getElementById('pipeline').textContent = inPipeline;
        document.getElementById('recentHires').textContent = recentHires;
    }

    /* ---------------- UI: Summary & Composition ---------------- */
    function updateSummaryCards() {
        document.getElementById('headcount').textContent = teamData.length;
    }

    function updateCompositions() {
        const typeMap = groupCount(teamData, 'employee_type');
        const deptMap = groupCount(teamData, 'subposition');

        const total = teamData.length || 1;
        document.getElementById('typeComposition').innerHTML =
            Object.entries(typeMap).sort((a, b) => b[1] - a[1]).map(([k, v]) => renderProgressRow(k, v, total)).join('') ||
            `<div class="text-sm text-slate-500">No data</div>`;

        document.getElementById('deptComposition').innerHTML =
            Object.entries(deptMap).sort((a, b) => b[1] - a[1]).map(([k, v]) => renderProgressRow(k || 'Unassigned', v, total)).join('') ||
            `<div class="text-sm text-slate-500">No data</div>`;
    }

    function hydrateDeptFilter() {
        const s = document.getElementById('deptFilter');
        const values = Array.from(new Set(teamData.map(x => x.subposition).filter(Boolean))).sort();
        s.innerHTML = `<option value="">All Departments</option>` + values.map(v => `<option>${v}</option>`).join('');
    }

    /* ---------------- Table render ---------------- */
    function getFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        const t = document.getElementById('typeFilter').value;
        const d = document.getElementById('deptFilter').value;
        return { q, t, d };
    }

    function filterSortData() {
        const { q, t, d } = getFilters();

        let data = teamData.filter(m => {
            const matchesQ = !q ||
                String(m.name || '').toLowerCase().includes(q) ||
                String(m.email || '').toLowerCase().includes(q) ||
                String(m.employee_id || '').toLowerCase().includes(q) ||
                String(m.username || '').toLowerCase().includes(q);
            const matchesT = !t || m.employee_type === t;
            const matchesD = !d || m.subposition === d;
            return matchesQ && matchesT && matchesD;
        });

        // sort
        const { key, dir } = SORT;
        data.sort((a, b) => {
            const av = (a[key] ?? '').toString().toLowerCase();
            const bv = (b[key] ?? '').toString().toLowerCase();
            if (key === 'created_at') { return dir === 'asc' ? new Date(a[key]) - new Date(b[key]) : new Date(b[key]) - new Date(a[key]); }
            if (av < bv) return dir === 'asc' ? -1 : 1;
            if (av > bv) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        return data;
    }

    function renderTable() {
        const container = document.getElementById('tableContainer');
        const empty = document.getElementById('emptyState');
        const tbody = document.getElementById('teamTableBody');

        const data = filterSortData();
        const total = data.length;
        document.getElementById('totalCount').textContent = total;

        if (total === 0) {
            container.classList.add('hidden');
            empty.classList.remove('hidden');
            return;
        }
        container.classList.remove('hidden');
        empty.classList.add('hidden');

        // pagination
        const size = PAGE.size;
        const pages = Math.max(1, Math.ceil(total / size));
        PAGE.index = Math.min(PAGE.index, pages);
        const start = (PAGE.index - 1) * size;
        const slice = data.slice(start, start + size);

        tbody.innerHTML = slice.map(m => {
            const status = getEmployeeStatus(m.created_at);
            const mail = m.email || '-';
            return `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center mr-3 text-[11px] font-medium text-slate-700">${initials(m.name)}</div>
            <div>
              <div class="font-medium text-slate-800">${m.name || '-'}</div>
              <div class="text-sm text-slate-500">@${m.username || '-'}</div>
            </div>
          </div>
        </td>
        <td class="px-4 py-3 text-sm text-slate-600">${m.employee_id || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${m.employee_type || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${m.subposition || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${m.designation || '-'}</td>
        <td class="px-4 py-3 text-sm">
          <button class="text-slate-600 hover:text-slate-800 underline decoration-dotted" title="Copy email" onclick="navigator.clipboard.writeText('${mail}').then(()=>showToast('Copied'))">${mail}</button>
        </td>
        <td class="px-4 py-3 text-sm text-slate-600" title="${formatDate(m.created_at)}">${relTime(m.created_at)}</td>
        <td class="px-4 py-3">
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${status.class}">${status.text}</span>
        </td>
      </tr>`;
        }).join('');

        // footer
        document.getElementById('pageInfo').textContent = `${Math.min(total, start + 1)}–${Math.min(total, start + slice.length)}`;
        document.getElementById('pageNum').textContent = `Page ${PAGE.index}/${Math.max(1, Math.ceil(total / size))}`;
        const prev = document.getElementById('prevPage');
        const next = document.getElementById('nextPage');
        prev.disabled = PAGE.index <= 1;
        next.disabled = PAGE.index >= Math.ceil(total / size);
    }

    /* ---------------- Recent Activity ---------------- */
    function loadRecentActivity() {
        const activityContainer = document.getElementById('recentActivity');
        const items = [];

        const recentHires = teamData
            .filter(m => {
                const days = Math.floor((Date.now() - new Date(m.created_at)) / 86400000);
                return days >= 0 && days <= 30;
            })
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(0, 5);

        recentHires.forEach(h => items.push({
            icon: 'fa-user-plus', tone: 'text-green-600 bg-green-100',
            title: `${h.name} joined as ${h.subposition || h.designation || '—'}`,
            desc: `${h.employee_type || 'Employee'}`, time: relTime(h.created_at)
        }));

        activityContainer.innerHTML = items.length
            ? items.map(x => `
      <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-slate-50">
        <div class="w-8 h-8 rounded-full ${x.tone} flex items-center justify-center"><i class="fa-solid ${x.icon} text-sm"></i></div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium text-slate-800">${x.title}</div>
          <div class="text-sm text-slate-500">${x.desc}</div>
          <div class="text-xs text-slate-400 mt-1">${x.time}</div>
        </div>
      </div>`).join('')
            : `<div class="text-center py-6"><i class="fa-solid fa-clock text-slate-300 text-2xl mb-2"></i><p class="text-slate-500">No recent activity to display</p></div>`;
    }

    /* ---------------- CSV export ---------------- */
    function exportCSV(rows) {
        const headers = ['Name', 'Employee ID', 'Type', 'Position', 'Designation', 'Email', 'Joined', 'Status'];
        const data = rows.map(m => [
            m.name || '', m.employee_id || '', m.employee_type || '', m.subposition || '',
            m.designation || '', m.email || '', formatDate(m.created_at), getEmployeeStatus(m.created_at).text
        ]);
        const csv = [headers, ...data].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'team_overview.csv'; a.click(); URL.revokeObjectURL(url);
    }

    /* ---------------- Toaster (minimal) ---------------- */
    let toastTimer;
    function showToast(msg = 'Done') {
        const id = 'miniToast';
        let t = document.getElementById(id);
        if (!t) {
            t = document.createElement('div');
            t.id = id;
            t.className = 'fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm';
            document.body.appendChild(t);
        }
        t.textContent = msg;
        t.style.opacity = '1';
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 1500);
    }

    /* ---------------- Init & events ---------------- */
    async function initializePage() {
        document.getElementById('loadingState').classList.remove('hidden');
        try {
            await Promise.all([loadTeamData(), loadJobsData(), loadCandidatesData()]);
            loadRecentActivity();
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('tableContainer').classList.toggle('hidden', teamData.length === 0);
        } catch (e) {
            console.error(e);
            document.getElementById('loadingState').innerHTML = `
      <div class="text-center py-8">
        <i class="fa-solid fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
        <p class="text-red-600">Failed to load team overview data</p>
        <button onclick="initializePage()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Try Again</button>
      </div>`;
        }
    }

    /* Debounced search */
    let searchTimer;
    document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => { PAGE.index = 1; renderTable(); }, 250);
    });
    document.getElementById('typeFilter').addEventListener('change', () => { PAGE.index = 1; renderTable(); });
    document.getElementById('deptFilter').addEventListener('change', () => { PAGE.index = 1; renderTable(); });
    document.getElementById('refreshBtn').addEventListener('click', initializePage);

    document.getElementById('prevPage').addEventListener('click', () => { if (PAGE.index > 1) { PAGE.index--; renderTable(); } });
    document.getElementById('nextPage').addEventListener('click', () => { PAGE.index++; renderTable(); });
    document.getElementById('pageSize').addEventListener('change', (e) => { PAGE.size = +e.target.value; PAGE.index = 1; renderTable(); });

    /* Sorting */
    document.querySelectorAll('.th-sort').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const key = th.dataset.key;
            SORT = { key, dir: (SORT.key === key && SORT.dir === 'asc') ? 'desc' : 'asc' };
            PAGE.index = 1;
            renderTable();
        });
    });

    /* Export */
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
        const rows = filterSortData();
        exportCSV(rows);
    });

    /* Kick off */
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

<style>
    .th-sort i {
        opacity: .6;
    }

    .th-sort:hover i {
        opacity: 1;
    }
</style>
{% endblock %}