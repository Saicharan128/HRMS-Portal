{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-file-invoice-dollar mr-2"></i> Expense reports
            </h1>
            <p class="text-slate-600 text-sm">Department/BU summaries.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportVisible"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export (visible)
            </button>
            <button id="exportSummaries"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-table mr-1"></i> Export summaries
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Add Expense (Dummy) -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6 mb-8">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">
            <i class="fa-solid fa-plus-square mr-2"></i> Add Expense (Dummy)
        </h2>
        <form id="expForm" class="grid grid-cols-1 md:grid-cols-8 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm text-slate-600 mb-1">Employee *</label>
                <input name="employee" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="E001 - Charan">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Department *</label>
                <input name="department" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Engineering">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">BU *</label>
                <input name="bu" required class="w-full rounded-lg border border-slate-300 px-3 py-2"
                    placeholder="Products / Services">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Date *</label>
                <input name="date" type="date" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Category *</label>
                <select name="category" required class="w-full rounded-lg border border-slate-300 px-3 py-2">
                    <option>Travel</option>
                    <option>Meals</option>
                    <option>Office</option>
                    <option>Software</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Amount *</label>
                <input name="amount" type="number" step="0.01" min="0" required
                    class="w-full rounded-lg border border-slate-300 px-3 py-2">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1">Currency</label>
                <input name="currency" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="INR">
            </div>
            <div class="flex items-center gap-2">
                <input id="reimb" name="reimb" type="checkbox" class="h-4 w-4">
                <label for="reimb" class="text-sm text-slate-700">Reimbursable</label>
            </div>
            <div class="md:col-span-8">
                <label class="block text-sm text-slate-600 mb-1">Notes</label>
                <input name="notes" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Optional">
            </div>
            <div class="md:col-span-8 flex items-center gap-3">
                <button class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900" type="submit">
                    <i class="fa-solid fa-plus mr-1"></i> Add
                </button>
                <span id="formMsg" class="text-sm text-slate-600"></span>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-9 gap-2">
        <input id="q" placeholder="Search employee / notesâ€¦"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fDept" placeholder="Department"
            class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fBU" placeholder="BU" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fCat" placeholder="Category" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="fStatus" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="">Any Status</option>
            <option>Pending</option>
            <option>Approved</option>
            <option>Rejected</option>
        </select>
        <input id="fFrom" type="date" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <input id="fTo" type="date" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
        <select id="sortSel" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="date:desc">Date (newest)</option>
            <option value="date:asc">Date (oldest)</option>
            <option value="amount:desc">Amount (highâ†’low)</option>
            <option value="amount:asc">Amount (lowâ†’high)</option>
            <option value="employee:asc">Employee (Aâ†’Z)</option>
        </select>
        <div class="flex items-center gap-2">
            <button id="clearFilters"
                class="rounded-xl border border-slate-300 bg-white hover:bg-slate-50 px-3 py-2 text-sm">Clear</button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Total Amount</div>
            <div id="kpiTotal" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Reimbursable</div>
            <div id="kpiReimb" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Non-reimb.</div>
            <div id="kpiNonReimb" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Pending</div>
            <div id="kpiPending" class="text-xl font-semibold text-slate-800">0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-xs text-slate-500">Avg / Employee</div>
            <div id="kpiAvgEmp" class="text-xl font-semibold text-slate-800">0</div>
        </div>
    </div>

    <!-- Mini Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-slate-800"><i class="fa-solid fa-chart-pie mr-2"></i> Category Mix</h3>
                <span id="mixHint" class="text-xs text-slate-500">â€”</span>
            </div>
            <canvas id="pieCanvas" height="160"></canvas>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-slate-800"><i class="fa-solid fa-chart-line mr-2"></i> Monthly Trend</h3>
                <span id="trendHint" class="text-xs text-slate-500">â€”</span>
            </div>
            <canvas id="trendCanvas" height="160"></canvas>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-slate-800"><i class="fa-solid fa-bolt mr-2"></i> Bulk Actions</h3>
            </div>
            <div class="space-y-2">
                <button id="approveAll"
                    class="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                    <i class="fa-solid fa-check mr-1"></i> Approve all filtered
                </button>
                <button id="rejectAll"
                    class="w-full px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 text-sm">
                    <i class="fa-solid fa-xmark mr-1"></i> Reject all filtered
                </button>
                <button id="resetSeeds"
                    class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                    <i class="fa-solid fa-rotate mr-1"></i> Reset sample data
                </button>
            </div>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white mb-2">
        <table class="min-w-full text-sm text-left text-slate-700">
            <thead class="bg-slate-50 text-slate-600">
                <tr>
                    <th class="px-4 py-2">Employee</th>
                    <th class="px-4 py-2">Dept</th>
                    <th class="px-4 py-2">BU</th>
                    <th class="px-4 py-2">Date</th>
                    <th class="px-4 py-2">Category</th>
                    <th class="px-4 py-2">Amount</th>
                    <th class="px-4 py-2">Curr</th>
                    <th class="px-4 py-2">Reimb</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2 w-64">Notes</th>
                    <th class="px-4 py-2 w-56">Actions</th>
                </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-slate-200"></tbody>
        </table>
    </div>
    <div class="flex items-center justify-between mb-6">
        <div id="pageInfo" class="text-sm text-slate-600"></div>
        <div class="flex gap-2">
            <select id="pageSizeSel" class="rounded-xl border border-slate-300 bg-white px-3 py-1.5 text-sm">
                <option>10</option>
                <option selected>20</option>
                <option>50</option>
            </select>
            <button id="prevPage"
                class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50 text-sm">Previous</button>
            <button id="nextPage"
                class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50 text-sm">Next</button>
        </div>
    </div>

    <!-- Department Summary -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4 mb-4">
        <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-building mr-2"></i> Department Summary</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-slate-700">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-2">Department</th>
                        <th class="px-4 py-2">Reports</th>
                        <th class="px-4 py-2">Total</th>
                        <th class="px-4 py-2">Reimbursable</th>
                        <th class="px-4 py-2">Non-reimb.</th>
                        <th class="px-4 py-2">Approved</th>
                        <th class="px-4 py-2">Pending</th>
                    </tr>
                </thead>
                <tbody id="deptRows" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </div>

    <!-- BU Summary -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <h3 class="text-slate-800 font-semibold mb-3"><i class="fa-solid fa-sitemap mr-2"></i> BU Summary</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-slate-700">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-2">BU</th>
                        <th class="px-4 py-2">Reports</th>
                        <th class="px-4 py-2">Total</th>
                        <th class="px-4 py-2">Reimbursable</th>
                        <th class="px-4 py-2">Non-reimb.</th>
                        <th class="px-4 py-2">Approved</th>
                        <th class="px-4 py-2">Pending</th>
                    </tr>
                </thead>
                <tbody id="buRows" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </div>

    <div id="listMsg" class="mt-3 text-sm text-slate-600"></div>
</div>

<!-- Detail / Receipt Modal -->
<div id="expModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
                <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                    <h3 id="mTitle" class="text-lg font-semibold text-slate-800">Expense</h3>
                    <button id="mClose" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-3 text-sm">
                    <div id="mMeta" class="text-slate-700"></div>
                    <div class="rounded-lg bg-slate-50 p-3 space-y-1">
                        <div><b>Amount:</b> <span id="mAmt"></span></div>
                        <div><b>Date:</b> <span id="mDate"></span></div>
                        <div><b>Category:</b> <span id="mCat"></span></div>
                        <div><b>Status:</b> <span id="mStatus"></span></div>
                        <div><b>Notes:</b> <span id="mNotes"></span></div>
                    </div>
                    <div class="rounded-lg border border-dashed border-slate-300 p-3">
                        <div class="flex items-center justify-between">
                            <span><i class="fa-solid fa-receipt mr-1"></i> Receipt (dummy)</span>
                            <button id="mDownload"
                                class="px-3 py-1.5 rounded-lg bg-slate-800 text-white hover:bg-slate-900 text-sm">
                                <i class="fa-solid fa-download mr-1"></i> Download PDF
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">Attach real files in your backend; this is a placeholder
                            preview.</p>
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2">
                        <button id="mApprove"
                            class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"><i
                                class="fa-solid fa-check mr-1"></i> Approve</button>
                        <button id="mReject" class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700"><i
                                class="fa-solid fa-xmark mr-1"></i> Reject</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ---------- Dummy store (localStorage) ---------- */
    const KEY = "dummy_expense_reports";
    let STORE = JSON.parse(localStorage.getItem(KEY) || "null") || [
        { id: 1, employee: "E001 - Charan", department: "Engineering", bu: "Products", date: "2025-09-12", category: "Software", amount: 2499, currency: "INR", reimb: true, status: "Approved", notes: "Git hosting" },
        { id: 2, employee: "E014 - Priya", department: "Finance", bu: "Corporate", date: "2025-09-11", category: "Meals", amount: 1200, currency: "INR", reimb: true, status: "Pending", notes: "Client lunch" },
        { id: 3, employee: "E009 - Arjun", department: "Engineering", bu: "Services", date: "2025-09-10", category: "Travel", amount: 5400, currency: "INR", reimb: true, status: "Rejected", notes: "Cab - missing bill" },
        { id: 4, employee: "E021 - Meera", department: "HR", bu: "Corporate", date: "2025-09-09", category: "Office", amount: 1800, currency: "INR", reimb: false, status: "Approved", notes: "Stationery" }
    ];
    function persist() { localStorage.setItem(KEY, JSON.stringify(STORE)); }

    /* ---------- Elements ---------- */
    const rows = document.getElementById("rows");
    const deptRows = document.getElementById("deptRows");
    const buRows = document.getElementById("buRows");
    const listMsg = document.getElementById("listMsg");

    const expForm = document.getElementById("expForm");
    const formMsg = document.getElementById("formMsg");

    const q = document.getElementById("q");
    const fDept = document.getElementById("fDept");
    const fBU = document.getElementById("fBU");
    const fCat = document.getElementById("fCat");
    const fStatus = document.getElementById("fStatus");
    const fFrom = document.getElementById("fFrom");
    const fTo = document.getElementById("fTo");
    const sortSel = document.getElementById("sortSel");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiReimb = document.getElementById("kpiReimb");
    const kpiNonReimb = document.getElementById("kpiNonReimb");
    const kpiPending = document.getElementById("kpiPending");
    const kpiAvgEmp = document.getElementById("kpiAvgEmp");

    const exportVisibleBtn = document.getElementById("exportVisible");
    const exportSummariesBtn = document.getElementById("exportSummaries");
    const clearFiltersBtn = document.getElementById("clearFilters");
    const approveAllBtn = document.getElementById("approveAll");
    const rejectAllBtn = document.getElementById("rejectAll");
    const resetSeedsBtn = document.getElementById("resetSeeds");

    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageSizeSel = document.getElementById("pageSizeSel");

    /* Charts */
    const pieCanvas = document.getElementById("pieCanvas");
    const trendCanvas = document.getElementById("trendCanvas");
    const mixHint = document.getElementById("mixHint");
    const trendHint = document.getElementById("trendHint");

    /* ---------- Helpers ---------- */
    function td(el) { const c = document.createElement("td"); c.className = "px-4 py-2"; c.appendChild(el); return c; }
    function input(v, cls = "w-32") { const i = document.createElement("input"); i.value = v ?? ""; i.className = `rounded-lg border border-slate-300 px-2 py-1 text-sm ${cls}`; return i; }
    function textArea(v) { const t = document.createElement("textarea"); t.value = v ?? ""; t.rows = 1; t.className = "w-full rounded-lg border border-slate-300 px-2 py-1 text-sm"; return t; }
    function select(opts, cur) { const s = document.createElement("select"); s.className = "rounded-lg border border-slate-300 px-2 py-1 text-sm"; opts.forEach(o => { const op = document.createElement("option"); op.value = o; op.textContent = o; if (o === cur) op.selected = true; s.appendChild(op); }); return s; }
    function money(n, cur) { const v = Number(n || 0); return (cur || "INR") + " " + v.toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    function withinDate(d) {
        const v = new Date(d).setHours(0, 0, 0, 0);
        const f1 = fFrom.value ? new Date(fFrom.value).setHours(0, 0, 0, 0) : null;
        const f2 = fTo.value ? new Date(fTo.value).setHours(23, 59, 59, 999) : null;
        if (f1 && v < f1) return false; if (f2 && v > f2) return false; return true;
    }
    function saveFilters() { const o = { q: q.value, fDept: fDept.value, fBU: fBU.value, fCat: fCat.value, fStatus: fStatus.value, fFrom: fFrom.value, fTo: fTo.value, sort: sortSel.value, ps: pageSizeSel.value }; localStorage.setItem("exp_filters", JSON.stringify(o)); }
    function loadFilters() { try { const o = JSON.parse(localStorage.getItem("exp_filters") || "null"); if (!o) return; q.value = o.q || ""; fDept.value = o.fDept || ""; fBU.value = o.fBU || ""; fCat.value = o.fCat || ""; fStatus.value = o.fStatus || ""; fFrom.value = o.fFrom || ""; fTo.value = o.fTo || ""; sortSel.value = o.sort || "date:desc"; pageSizeSel.value = o.ps || "20"; } catch { } }

    /* ---------- Sorting / Paging ---------- */
    let page = 1;
    function sortData(arr) {
        const [key, dir] = sortSel.value.split(":");
        const data = arr.slice();
        data.sort((a, b) => {
            let va = a[key], vb = b[key];
            if (key === "amount") { va = Number(va) || 0; vb = Number(vb) || 0; }
            else if (key === "date") { va = new Date(a.date).getTime(); vb = new Date(b.date).getTime(); }
            else { va = String(va || "").toLowerCase(); vb = String(vb || "").toLowerCase(); }
            if (va < vb) return dir === "asc" ? -1 : 1;
            if (va > vb) return dir === "asc" ? 1 : -1;
            return 0;
        });
        return data;
    }
    function paginate(arr) {
        const ps = Number(pageSizeSel.value || 20);
        const total = arr.length;
        const start = (page - 1) * ps;
        const slice = arr.slice(start, start + ps);
        pageInfo.textContent = total ? `Showing ${start + 1}-${Math.min(start + ps, total)} of ${total}` : "No results";
        prevPageBtn.disabled = page === 1;
        nextPageBtn.disabled = (page * ps) >= total;
        return slice;
    }

    /* ---------- Filtering ---------- */
    function filtered() {
        const qv = (q.value || "").toLowerCase().trim();
        const d = (fDept.value || "").toLowerCase().trim();
        const b = (fBU.value || "").toLowerCase().trim();
        const c = (fCat.value || "").toLowerCase().trim();
        const st = fStatus.value;
        return STORE.filter(r => {
            if (qv && !(`${r.employee} ${r.notes}`.toLowerCase().includes(qv))) return false;
            if (d && !(r.department || "").toLowerCase().includes(d)) return false;
            if (b && !(r.bu || "").toLowerCase().includes(b)) return false;
            if (c && !(r.category || "").toLowerCase().includes(c)) return false;
            if (st && r.status !== st) return false;
            if (!withinDate(r.date)) return false;
            return true;
        });
    }

    /* ---------- KPIs ---------- */
    function updateKPIs(data) {
        const tot = data.reduce((a, r) => a + Number(r.amount || 0), 0);
        const reimb = data.filter(r => r.reimb).reduce((a, r) => a + Number(r.amount || 0), 0);
        const non = tot - reimb;
        const pend = data.filter(r => r.status === "Pending").length;
        const byEmp = {};
        data.forEach(r => { byEmp[r.employee] = (byEmp[r.employee] || 0) + Number(r.amount || 0); });
        const avg = Object.keys(byEmp).length ? (Object.values(byEmp).reduce((a, b) => a + b, 0) / Object.keys(byEmp).length) : 0;
        const cur = data[0]?.currency || "INR";
        kpiTotal.textContent = money(tot, cur);
        kpiReimb.textContent = money(reimb, cur);
        kpiNonReimb.textContent = money(non, cur);
        kpiPending.textContent = String(pend);
        kpiAvgEmp.textContent = money(avg, cur);
    }

    /* ---------- Summaries ---------- */
    function buildSummary(data, key) {
        const map = {};
        data.forEach(r => {
            const k = (r[key] || "â€”");
            map[k] = map[k] || { count: 0, total: 0, reimb: 0, non: 0, approved: 0, pending: 0 };
            map[k].count += 1;
            map[k].total += Number(r.amount || 0);
            if (r.reimb) map[k].reimb += Number(r.amount || 0); else map[k].non += Number(r.amount || 0);
            if (r.status === "Approved") map[k].approved += Number(r.amount || 0);
            if (r.status === "Pending") map[k].pending += Number(r.amount || 0);
        });
        return map;
    }
    function renderSummary(tbody, map, currency) {
        tbody.innerHTML = "";
        Object.entries(map).sort(([a], [b]) => a.localeCompare(b)).forEach(([name, v]) => {
            const tr = document.createElement("tr");
            const tdC = (txt) => { const x = document.createElement("td"); x.className = "px-4 py-2"; x.textContent = txt; return x; };
            tr.append(tdC(name), tdC(v.count), tdC(money(v.total, currency)), tdC(money(v.reimb, currency)), tdC(money(v.non, currency)), tdC(money(v.approved, currency)), tdC(money(v.pending, currency)));
            tbody.appendChild(tr);
        });
    }

    /* ---------- Charts (no deps) ---------- */
    function drawPie(canvas, dataPairs) {
        const ctx = canvas.getContext('2d'); const W = canvas.width = canvas.clientWidth; const H = canvas.height;
        ctx.clearRect(0, 0, W, H); const total = dataPairs.reduce((a, [_l, v]) => a + v, 0); if (!total) { ctx.fillStyle = "#64748b"; ctx.fillText("No data", 10, 20); return; }
        const cx = W / 2, cy = H / 2, r = Math.min(W, H) / 2 - 10; let start = -Math.PI / 2;
        dataPairs.forEach(([label, val], i) => {
            const frac = val / total, ang = frac * 2 * Math.PI; ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, start + ang); ctx.closePath();
            ctx.fillStyle = ["#60a5fa", "#34d399", "#f472b6", "#f59e0b", "#a78bfa", "#fb7185"][i % 6]; ctx.fill(); start += ang;
        });
        // legend (right side)
        const x0 = 10, y0 = 10; ctx.font = "12px sans-serif"; let y = y0;
        dataPairs.forEach(([label, val], i) => {
            ctx.fillStyle = ["#60a5fa", "#34d399", "#f472b6", "#f59e0b", "#a78bfa", "#fb7185"][i % 6]; ctx.fillRect(x0, y, 10, 10);
            ctx.fillStyle = "#334155"; ctx.fillText(`${label} (${Math.round(val / total * 100)}%)`, x0 + 16, y + 10); y += 14;
        });
    }
    function drawLine(canvas, xs, ys) {
        const ctx = canvas.getContext('2d'); const W = canvas.width = canvas.clientWidth; const H = canvas.height; ctx.clearRect(0, 0, W, H);
        if (ys.length < 2) { ctx.fillStyle = "#64748b"; ctx.fillText("Not enough data", 10, 20); return; }
        const min = Math.min(...ys, 0), max = Math.max(...ys, 10), pad = 16, x0 = pad, x1 = W - pad, y0 = H - pad, y1 = pad;
        ctx.strokeStyle = "#e5e7eb"; ctx.lineWidth = 1;
        for (let i = 0; i < 4; i++) { const y = y0 - (i / 3) * (y0 - y1); ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke(); }
        ctx.strokeStyle = "#0ea5e9"; ctx.lineWidth = 2; ctx.beginPath();
        xs.forEach((_, i) => { const x = x0 + (i / (xs.length - 1)) * (x1 - x0); const y = y0 - ((ys[i] - min) / (max - min || 1)) * (y0 - y1); i ? ctx.lineTo(x, y) : ctx.moveTo(x, y); });
        ctx.stroke();
    }

    /* ---------- Render List ---------- */
    let modalRecord = null;
    function openModal(rec) {
        modalRecord = rec;
        document.getElementById('mTitle').textContent = `${rec.employee}`;
        document.getElementById('mMeta').textContent = `${rec.department} â€¢ ${rec.bu}`;
        document.getElementById('mAmt').textContent = money(rec.amount, rec.currency);
        document.getElementById('mDate').textContent = rec.date;
        document.getElementById('mCat').textContent = rec.category;
        document.getElementById('mStatus').textContent = rec.status;
        document.getElementById('mNotes').textContent = rec.notes || '-';
        document.getElementById('expModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('expModal').classList.add('hidden'); modalRecord = null; }
    document.getElementById('mClose').addEventListener('click', closeModal);
    document.getElementById('mApprove').addEventListener('click', () => { if (!modalRecord) return; modalRecord.status = "Approved"; persist(); refresh(); closeModal(); });
    document.getElementById('mReject').addEventListener('click', () => { if (!modalRecord) return; modalRecord.status = "Rejected"; persist(); refresh(); closeModal(); });
    document.getElementById('mDownload').addEventListener('click', () => alert('ðŸ“Ž Receipt PDF (dummy) downloaded'));

    function load() {
        const dataSorted = sortData(filtered());
        const cur = dataSorted[0]?.currency || "INR";

        // Pagination
        const pageData = paginate(dataSorted);

        rows.innerHTML = "";
        pageData.forEach(r => {
            const tr = document.createElement("tr");
            const empI = input(r.employee, "w-44");
            const depI = input(r.department, "w-36");
            const buI = input(r.bu, "w-36");
            const dateI = input(r.date, "w-32"); dateI.type = "date";
            const catI = input(r.category, "w-32");
            const amtI = input(r.amount, "w-28"); amtI.type = "number"; amtI.step = "0.01"; amtI.min = 0;
            const curI = input(r.currency || cur, "w-20");
            const reimbS = select(["true", "false"], r.reimb ? "true" : "false");
            const statusS = select(["Pending", "Approved", "Rejected"], r.status || "Pending");
            const notesT = textArea(r.notes || "");

            const actions = document.createElement("div");
            const viewBtn = document.createElement("button");
            viewBtn.className = "px-2 py-1 mr-2 rounded-md border border-slate-300 text-xs hover:bg-slate-50";
            viewBtn.innerHTML = '<i class="fa-solid fa-eye mr-1"></i>View';
            const approveBtn = document.createElement("button");
            approveBtn.className = "px-2 py-1 mr-2 rounded-md bg-emerald-600 text-white text-xs hover:bg-emerald-700";
            approveBtn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Approve';
            const rejectBtn = document.createElement("button");
            rejectBtn.className = "px-2 py-1 mr-2 rounded-md bg-rose-600 text-white text-xs hover:bg-rose-700";
            rejectBtn.innerHTML = '<i class="fa-solid fa-xmark mr-1"></i>Reject';
            const saveBtn = document.createElement("button");
            saveBtn.className = "px-2 py-1 mr-2 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900";
            saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i>Save';
            const delBtn = document.createElement("button");
            delBtn.className = "px-2 py-1 rounded-md border border-slate-300 text-xs hover:bg-slate-50";
            delBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Delete';
            actions.append(viewBtn, approveBtn, rejectBtn, saveBtn, delBtn);

            tr.append(td(empI), td(depI), td(buI), td(dateI), td(catI), td(amtI), td(curI), td(reimbS), td(statusS), td(notesT), td(actions));
            rows.appendChild(tr);

            function save() {
                r.employee = empI.value.trim();
                r.department = depI.value.trim();
                r.bu = buI.value.trim();
                r.date = dateI.value;
                r.category = catI.value.trim();
                r.amount = Number(amtI.value || 0);
                r.currency = curI.value.trim() || "INR";
                r.reimb = (reimbS.value === "true");
                r.status = statusS.value;
                r.notes = notesT.value;
                persist(); refresh();
                listMsg.className = "mt-3 text-sm text-emerald-700"; listMsg.textContent = "Saved.";
                setTimeout(() => { listMsg.textContent = ""; listMsg.className = "mt-3 text-sm text-slate-600"; }, 1200);
            }
            saveBtn.addEventListener("click", save);
            approveBtn.addEventListener("click", () => { statusS.value = "Approved"; save(); });
            rejectBtn.addEventListener("click", () => { statusS.value = "Rejected"; save(); });
            delBtn.addEventListener("click", () => { if (!confirm("Delete this expense?")) return; STORE = STORE.filter(x => x.id !== r.id); persist(); refresh(); });
            viewBtn.addEventListener("click", () => openModal(r));
        });

        updateKPIs(dataSorted);
        renderSummary(deptRows, buildSummary(dataSorted, "department"), cur);
        renderSummary(buRows, buildSummary(dataSorted, "bu"), cur);
        drawCharts(dataSorted);

        listMsg.textContent = dataSorted.length ? "" : "No expenses.";
    }
    function refresh() { load(); }

    /* ---------- Create (dummy) ---------- */
    expForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(expForm);
        const employee = (fd.get("employee") || "").toString().trim();
        const department = (fd.get("department") || "").toString().trim();
        const bu = (fd.get("bu") || "").toString().trim();
        const date = (fd.get("date") || "").toString();
        const category = (fd.get("category") || "").toString();
        const amount = Number(fd.get("amount") || 0);
        const currency = (fd.get("currency") || "INR").toString().trim();
        const reimb = !!fd.get("reimb");
        const notes = (fd.get("notes") || "").toString().trim();
        if (!employee || !department || !bu || !date || !category || !amount) { formFlash("Missing required fields.", true); return; }
        const id = Math.max(0, ...STORE.map(x => x.id)) + 1;
        STORE.unshift({ id, employee, department, bu, date, category, amount, currency, reimb, status: "Pending", notes });
        persist(); expForm.reset(); formFlash("Added âœ“"); page = 1; refresh();
    });
    function formFlash(msg, bad = false) { formMsg.textContent = msg; formMsg.className = "text-sm " + (bad ? "text-rose-700" : "text-emerald-700"); setTimeout(() => { formMsg.textContent = ""; formMsg.className = "text-sm text-slate-600"; }, 1500); }

    /* ---------- Charts data ---------- */
    function drawCharts(data) {
        // Category mix
        const byCat = {}; data.forEach(r => { byCat[r.category] = (byCat[r.category] || 0) + Number(r.amount || 0); });
        const pairs = Object.entries(byCat).sort((a, b) => b[1] - a[1]).slice(0, 6); // top-6
        drawPie(pieCanvas, pairs);
        const total = data.reduce((a, r) => a + Number(r.amount || 0), 0);
        mixHint.textContent = total ? `Top ${pairs.length} categories â€¢ ${(pairs.reduce((a, [_l, v]) => a + v, 0) / total * 100).toFixed(0)}% of spend` : "â€”";

        // Monthly trend (last 12 months from data)
        const byMonth = {};
        data.forEach(r => { const ym = (r.date || "").slice(0, 7); if (!ym) return; byMonth[ym] = (byMonth[ym] || 0) + Number(r.amount || 0); });
        const months = Object.keys(byMonth).sort(); const ys = months.map(m => byMonth[m]);
        drawLine(trendCanvas, months, ys);
        trendHint.textContent = months.length ? `${months[0]} â†’ ${months[months.length - 1]}` : "â€”";
    }

    /* ---------- Exports ---------- */
    function dlCsv(rows, name) {
        const csv = rows.map(r => r.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
    }
    exportVisibleBtn.addEventListener("click", () => {
        const data = sortData(filtered());
        const rows = [["id", "employee", "department", "bu", "date", "category", "amount", "currency", "reimb", "status", "notes"]];
        data.forEach(r => rows.push([r.id, r.employee, r.department, r.bu, r.date, r.category, r.amount, r.currency, r.reimb ? 1 : 0, r.status, r.notes || ""]));
        dlCsv(rows, "expenses_visible.csv");
    });
    exportSummariesBtn.addEventListener("click", () => {
        const data = sortData(filtered());
        const cur = data[0]?.currency || "INR";
        const mk = (title, map) => { const out = [[title, "", "", "", "", "", ""], ["name", "reports", "total", "reimbursable", "non_reimb", "approved", "pending"]]; Object.entries(map).forEach(([k, v]) => out.push([k, v.count, v.total, v.reimb, v.non, v.approved, v.pending])); return out; };
        const dept = mk("Department Summary", buildSummary(data, "department"));
        const bu = mk("BU Summary", buildSummary(data, "bu"));
        const both = [["currency", cur], [""], ...dept, [""], ...bu];
        dlCsv(both, "expenses_summaries.csv");
    });

    /* ---------- Bulk actions ---------- */
    approveAllBtn.addEventListener("click", () => {
        const data = filtered(); let changed = 0;
        data.forEach(r => { if (r.status !== "Approved") { r.status = "Approved"; changed++; } });
        if (!changed) return alert("No items to approve for current filter.");
        persist(); refresh();
    });
    rejectAllBtn.addEventListener("click", () => {
        const data = filtered(); let changed = 0;
        data.forEach(r => { if (r.status !== "Rejected") { r.status = "Rejected"; changed++; } });
        if (!changed) return alert("No items to reject for current filter.");
        persist(); refresh();
    });
    resetSeedsBtn.addEventListener("click", () => {
        if (!confirm("Reset sample data?")) return;
        localStorage.removeItem(KEY); location.reload();
    });

    /* ---------- Live filters + paging ---------- */
    [q, fDept, fBU, fCat, fStatus, fFrom, fTo, sortSel].forEach(el => el.addEventListener("input", () => { page = 1; saveFilters(); load(); }));
    clearFiltersBtn.addEventListener("click", () => { q.value = ""; fDept.value = ""; fBU.value = ""; fCat.value = ""; fStatus.value = ""; fFrom.value = ""; fTo.value = ""; page = 1; saveFilters(); load(); });

    prevPageBtn.addEventListener("click", () => { if (page > 1) { page--; load(); } });
    nextPageBtn.addEventListener("click", () => { page++; load(); });
    pageSizeSel.addEventListener("change", () => { page = 1; saveFilters(); load(); });

    /* ---------- Init ---------- */
    loadFilters();
    load();
</script>
{% endblock %}