{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-7xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-slate-800">
                <i class="fa-solid fa-chart-simple mr-2"></i> All Reports
            </h1>
            <p class="text-slate-600 text-sm">Generate detailed reports across all HR and payroll modules.</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="exportCsvBtn"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-file-csv mr-1"></i> Export Table (CSV)
            </button>
            <button id="newReportBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">
                <i class="fa-solid fa-plus mr-1"></i> Generate Report
            </button>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-chart-bar mr-1"></i> Total Reports</div>
            <div id="totalReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-clock mr-1"></i> Generated Today</div>
            <div id="todayReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-download mr-1"></i> Downloads</div>
            <div id="totalDownloads" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-calendar-check mr-1"></i> Scheduled</div>
            <div id="scheduledReports" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <div class="text-sm text-slate-500"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Processing</div>
            <div id="processingCount" class="mt-1 text-2xl font-semibold text-slate-800">-</div>
        </div>
    </div>

    <!-- Report Categories (unchanged content trimmed for brevity) -->
    <!-- … keep your categories grid exactly as you had it … -->

    <!-- Filters / Actions Row -->
    <div class="rounded-2xl border border-slate-200 bg-white mt-6">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-semibold text-slate-800">
                        <i class="fa-solid fa-list mr-2"></i> Generated Reports
                    </h2>
                </div>
                <div class="flex items-center gap-2">
                    <input id="searchInput" placeholder="Search name, user, type…"
                        class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                    <label class="text-sm text-slate-600">Type:</label>
                    <select id="reportTypeFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <option value="">All Types</option>
                        <option value="hr">HR Reports</option>
                        <option value="performance">Performance</option>
                        <option value="financial">Financial</option>
                        <option value="attendance">Time & Attendance</option>
                        <option value="compliance">Compliance</option>
                    </select>
                    <label class="text-sm text-slate-600">Period:</label>
                    <select id="periodFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="all">All time</option>
                    </select>
                    <label class="text-sm text-slate-600">Status:</label>
                    <select id="statusFilter" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <option value="">Any</option>
                        <option value="completed">Completed</option>
                        <option value="processing">Processing</option>
                        <option value="failed">Failed</option>
                        <option value="scheduled">Scheduled</option>
                    </select>
                    <label class="text-sm text-slate-600">Page size:</label>
                    <select id="pageSize" class="rounded-lg border border-slate-300 px-3 py-2 text-sm">
                        <option>10</option>
                        <option>25</option>
                        <option>50</option>
                    </select>
                    <button id="refreshReports"
                        class="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-sm">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk bar -->
        <div id="bulkBar"
            class="hidden px-6 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
            <div class="text-sm text-slate-700"><span id="bulkCount">0</span> selected</div>
            <div class="flex items-center gap-2">
                <button id="bulkDownloadBtn"
                    class="px-3 py-1 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-700">
                    <i class="fa-solid fa-download mr-1"></i> Download
                </button>
                <button id="bulkDeleteBtn" class="px-3 py-1 rounded bg-rose-600 text-white text-sm hover:bg-rose-700">
                    <i class="fa-solid fa-trash mr-1"></i> Delete
                </button>
                <button id="bulkClearBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-white">
                    Clear
                </button>
            </div>
        </div>

        <!-- Loading / Empty / Table -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-800"></div>
            <p class="mt-2 text-sm text-slate-600">Loading reports...</p>
        </div>

        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-4"></i>
            <h3 class="text-lg font-medium text-slate-800 mb-2">No Reports Found</h3>
            <p class="text-slate-600 mb-4">Try adjusting filters or generate a new report.</p>
        </div>

        <div id="reportsTable" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 w-10"><input id="masterChk" type="checkbox" class="rounded"></th>
                            <th data-sort="name" class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">
                                Report Name <i class="fa-solid fa-sort text-slate-400"></i></th>
                            <th data-sort="type" class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">
                                Type <i class="fa-solid fa-sort text-slate-400"></i></th>
                            <th data-sort="generated_date"
                                class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">Generated <i
                                    class="fa-solid fa-sort text-slate-400"></i></th>
                            <th data-sort="generated_by"
                                class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">Generated By <i
                                    class="fa-solid fa-sort text-slate-400"></i></th>
                            <th data-sort="file_size_val"
                                class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">Size <i
                                    class="fa-solid fa-sort text-slate-400"></i></th>
                            <th data-sort="status"
                                class="px-6 py-3 text-left font-medium text-slate-700 cursor-pointer">Status <i
                                    class="fa-solid fa-sort text-slate-400"></i></th>
                            <th class="px-6 py-3 text-left font-medium text-slate-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-slate-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="p-6 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">
                    Showing <span id="pageInfo">0-0 of 0</span> reports
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Previous</button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn" class="px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50"
                        disabled>Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal (same structure as yours, fields intact) -->
<!-- Report Preview Modal (same structure as yours, buttons intact) -->

<!-- Success / Error / Info Toasts (same) -->

<script>
    /* ------------------------ Persistence ------------------------ */
    const LS_KEY = "reports_center_v2";
    const SCHED_KEY = "reports_schedules_v2";
    let reports = [];
    let schedules = [];
    let filteredReports = [];
    let currentPage = 1, totalPages = 1;
    let reportIdCounter = 100;
    let sortState = { key: "generated_date", dir: "desc" };
    let selectedIds = new Set();

    function save() { localStorage.setItem(LS_KEY, JSON.stringify(reports)); }
    function saveSched() { localStorage.setItem(SCHED_KEY, JSON.stringify(schedules)); }
    function load() {
        const r = JSON.parse(localStorage.getItem(LS_KEY) || "null");
        const s = JSON.parse(localStorage.getItem(SCHED_KEY) || "null");
        if (Array.isArray(r) && r.length) { reports = r; }
        else { seed(); }
        schedules = Array.isArray(s) ? s : seedSchedules();
    }
    function seed() {
        reports = [
            { id: 1, name: "Employee Roster Q4 2024", type: "hr", generated_date: "2024-01-15T10:30:00", generated_by: "Sarah Johnson", file_size: "2.4 MB", file_size_val: 2.4, format: "pdf", status: "completed", download_count: 15 },
            { id: 2, name: "Performance Summary December", type: "performance", generated_date: "2024-01-14T14:22:00", generated_by: "Mike Davis", file_size: "1.8 MB", file_size_val: 1.8, format: "excel", status: "completed", download_count: 8 },
            { id: 3, name: "Payroll Summary December 2024", type: "financial", generated_date: "2024-01-13T09:15:00", generated_by: "Lisa Brown", file_size: "3.2 MB", file_size_val: 3.2, format: "pdf", status: "completed", download_count: 22 },
            { id: 4, name: "Attendance Analysis Q4", type: "attendance", generated_date: "2024-01-12T16:45:00", generated_by: "Tom Wilson", file_size: "1.5 MB", file_size_val: 1.5, format: "csv", status: "processing", download_count: 0 },
            { id: 5, name: "EEO Compliance Report 2024", type: "compliance", generated_date: "2024-01-11T11:20:00", generated_by: "Sarah Johnson", file_size: "0.97 MB", file_size_val: 0.97, format: "pdf", status: "completed", download_count: 5 }
        ];
        reportIdCounter = 6;
        save();
    }
    function seedSchedules() {
        schedules = [
            { id: "sc1", name: "Monthly Payroll Summary", type: "financial", freq: "monthly", recipients: "payroll@company.com" },
            { id: "sc2", name: "Weekly New Hires", type: "hr", freq: "weekly", recipients: "hrbp@company.com" },
            { id: "sc3", name: "Quarterly Performance", type: "performance", freq: "quarterly", recipients: "exec@company.com" }
        ];
        saveSched(); return schedules;
    }

    /* ------------------------ DOM helpers ------------------------ */
    const $ = (s, rt = document) => rt.querySelector(s);
    const $$ = (s, rt = document) => Array.from(rt.querySelectorAll(s));
    function cls(el, add, remove) { if (add) el.classList.add(...[].concat(add)); if (remove) el.classList.remove(...[].concat(remove)); }
    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

    /* ------------------------ Init ------------------------ */
    document.addEventListener('DOMContentLoaded', () => {
        load();
        initializeReports();
    });

    async function initializeReports() {
        $("#loadingState").classList.remove("hidden");
        await new Promise(r => setTimeout(r, 400));
        setupEventListeners();
        applyFilters(); // will render
        $("#loadingState").classList.add("hidden");
    }

    /* ------------------------ Stats ------------------------ */
    function updateSummaryStats() {
        const todayStr = new Date().toDateString();
        const todayCount = reports.filter(r => new Date(r.generated_date).toDateString() === todayStr).length;
        const totalDownloads = reports.reduce((a, r) => a + (r.download_count || 0), 0);
        const scheduledCount = schedules.length;
        const processing = reports.filter(r => r.status === "processing").length;

        $("#totalReports").textContent = reports.length;
        $("#todayReports").textContent = todayCount;
        $("#totalDownloads").textContent = totalDownloads;
        $("#scheduledReports").textContent = scheduledCount;
        $("#processingCount").textContent = processing;
    }

    /* ------------------------ Templates & helpers ------------------------ */
    function formatType(type) {
        return ({ hr: "HR Report", performance: "Performance", financial: "Financial", attendance: "Time & Attendance", compliance: "Compliance" })[type] || type;
    }
    function badgeCls(type) { return ({ hr: "bg-blue-100 text-blue-700", performance: "bg-green-100 text-green-700", financial: "bg-yellow-100 text-yellow-700", attendance: "bg-purple-100 text-purple-700", compliance: "bg-red-100 text-red-700" })[type] || "bg-slate-100 text-slate-700"; }
    function statusCls(st) { return ({ completed: "bg-green-100 text-green-700", processing: "bg-blue-100 text-blue-700", failed: "bg-red-100 text-red-700", scheduled: "bg-yellow-100 text-yellow-700" })[st] || "bg-slate-100 text-slate-700"; }
    function fmtDate(d) { return new Date(d).toLocaleString('en-US', { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }

    /* ------------------------ Filters / Sorting ------------------------ */
    function applyFilters() {
        const t = $("#reportTypeFilter").value;
        const p = $("#periodFilter").value;
        const s = $("#statusFilter").value;
        const q = ($("#searchInput").value || "").toLowerCase();

        filteredReports = reports.filter(r => {
            const byType = !t || r.type === t;
            const byStatus = !s || r.status === s;
            const byQuery = !q || `${r.name} ${r.generated_by} ${r.type}`.toLowerCase().includes(q);
            let byPeriod = true;
            if (p && p !== "all") {
                const days = parseInt(p, 10);
                const cutoff = new Date(Date.now() - days * 86400000);
                byPeriod = new Date(r.generated_date) >= cutoff;
            }
            return byType && byStatus && byQuery && byPeriod;
        });

        sortAndRender();
    }
    function sortAndRender() {
        const { key, dir } = sortState;
        filteredReports.sort((a, b) => {
            const va = a[key], vb = b[key];
            if (key === "generated_date") return dir === "asc" ? (new Date(va) - new Date(vb)) : (new Date(vb) - new Date(va));
            if (typeof va === "number" && typeof vb === "number") return dir === "asc" ? (va - vb) : (vb - va);
            return dir === "asc" ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
        currentPage = 1;
        renderReports();
    }
    function setSort(nextKey) {
        if (sortState.key === nextKey) { sortState.dir = sortState.dir === "asc" ? "desc" : "asc"; }
        else { sortState.key = nextKey; sortState.dir = "asc"; }
        sortAndRender();
    }

    /* ------------------------ Render ------------------------ */
    function renderReports() {
        updateSummaryStats();
        selectedIds.clear(); updateBulkBar();

        const table = $("#reportsTable");
        const empty = $("#emptyState");
        if (!filteredReports.length) {
            cls(empty, null, "hidden"); cls(table, "hidden");
            $("#pageInfo").textContent = `0-0 of 0`;
            $("#pageNumbers").innerHTML = "";
            $("#prevPageBtn").disabled = true; $("#nextPageBtn").disabled = true;
            return;
        }
        cls(empty, "hidden"); cls(table, null, "hidden");

        renderReportsTable();
        updatePagination();
    }

    function renderReportsTable() {
        const tbody = $("#reportsTableBody");
        tbody.innerHTML = "";
        const itemsPerPage = parseInt($("#pageSize").value, 10) || 10;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageReports = filteredReports.slice(startIndex, endIndex);

        pageReports.forEach(report => {
            // ensure numeric size for sorting
            if (typeof report.file_size_val !== "number") {
                const m = /([\d.]+)\s*(KB|MB)/i.exec(report.file_size || "0 MB");
                const num = m ? parseFloat(m[1]) : 0;
                report.file_size_val = (m && m[2].toUpperCase() === "KB") ? (num / 1024) : num;
            }

            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50";
            tr.innerHTML = `
      <td class="px-4 py-4 w-10">
        <input type="checkbox" class="rowChk rounded" data-id="${report.id}">
      </td>
      <td class="px-6 py-4">
        <div class="font-medium text-slate-800">${report.name}</div>
        <div class="text-xs text-slate-500">ID: #${report.id}</div>
      </td>
      <td class="px-6 py-4">
        <span class="px-2 py-1 rounded text-xs font-medium ${badgeCls(report.type)}">${formatType(report.type)}</span>
      </td>
      <td class="px-6 py-4 text-slate-800">${fmtDate(report.generated_date)}</td>
      <td class="px-6 py-4 text-slate-800">${report.generated_by}</td>
      <td class="px-6 py-4 text-slate-800">${report.file_size}</td>
      <td class="px-6 py-4">
        <span class="px-2 py-1 rounded text-xs font-medium ${statusCls(report.status)}">${report.status[0].toUpperCase() + report.status.slice(1)}</span>
      </td>
      <td class="px-6 py-4">
        <div class="flex items-center gap-2">
          ${report.status === "completed" ? `
            <button class="text-blue-600 hover:text-blue-800" title="Preview" data-act="preview" data-id="${report.id}">
              <i class="fa-solid fa-eye"></i>
            </button>
            <button class="text-green-600 hover:text-green-800" title="Download" data-act="download" data-id="${report.id}">
              <i class="fa-solid fa-download"></i>
            </button>
            <button class="text-purple-600 hover:text-purple-800" title="Share" data-act="share" data-id="${report.id}">
              <i class="fa-solid fa-share"></i>
            </button>
          ` : report.status === "processing" ? `
            <button class="text-slate-500" title="Processing">
              <i class="fa-solid fa-clock"></i>
            </button>
            <button class="text-emerald-600 hover:text-emerald-800" title="Retry now" data-act="retry" data-id="${report.id}">
              <i class="fa-solid fa-rotate-right"></i>
            </button>
          ` : report.status === "failed" ? `
            <button class="text-rose-600 hover:text-rose-800" title="Retry" data-act="retry" data-id="${report.id}">
              <i class="fa-solid fa-arrows-rotate"></i>
            </button>
          ` : `
            <span class="text-slate-400"><i class="fa-solid fa-circle-info" title="Unavailable"></i></span>
          `}
          <button class="text-red-600 hover:text-red-800" title="Delete" data-act="delete" data-id="${report.id}">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </td>
    `;
            tbody.appendChild(tr);
        });

        // row checkbox wiring
        $$(".rowChk", tbody).forEach(cb => {
            cb.addEventListener("change", (e) => {
                const id = Number(e.target.dataset.id);
                if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
                updateBulkBar();
            });
        });

        // actions
        tbody.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-act]");
            if (!btn) return;
            const act = btn.dataset.act, id = Number(btn.dataset.id);
            if (act === "preview") previewReport(id);
            if (act === "download") downloadReport(id);
            if (act === "share") shareReport(id);
            if (act === "delete") deleteReport(id);
            if (act === "retry") retryReport(id);
        });
    }

    /* ------------------------ Pagination ------------------------ */
    function updatePagination() {
        const itemsPerPage = parseInt($("#pageSize").value, 10) || 10;
        totalPages = Math.max(1, Math.ceil(filteredReports.length / itemsPerPage));
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredReports.length);
        $("#pageInfo").textContent = `${start}-${end} of ${filteredReports.length}`;
        $("#prevPageBtn").disabled = currentPage === 1;
        $("#nextPageBtn").disabled = currentPage === totalPages;

        const wrap = $("#pageNumbers"); wrap.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                const b = document.createElement("button");
                b.textContent = i;
                b.className = i === currentPage ? "px-3 py-1 rounded bg-slate-800 text-white text-sm" : "px-3 py-1 rounded border border-slate-300 text-sm hover:bg-slate-50";
                b.addEventListener("click", () => { currentPage = i; renderReports(); });
                wrap.appendChild(b);
            } else if (Math.abs(i - currentPage) === 3) {
                const el = document.createElement("span"); el.textContent = "…"; el.className = "px-2 text-slate-400"; wrap.appendChild(el);
            }
        }
    }

    /* ------------------------ Modals / Preview ------------------------ */
    function openModal(id) { $("#" + id).classList.remove("hidden"); }
    function closeModal(id) { $("#" + id).classList.add("hidden"); }
    function previewReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const content = $("#reportPreviewContent");
        content.innerHTML = generateReportPreview(r);
        openModal("reportPreviewModal");
    }
    function generateReportPreview(report) {
        // minimal, reuse your earlier cards
        const head = `
    <div class="border-b border-slate-200 pb-4 mb-4">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-xl font-semibold text-slate-800">${report.name}</h4>
          <p class="text-slate-600">Generated on ${fmtDate(report.generated_date)} by ${report.generated_by} • ${report.format.toUpperCase()}</p>
        </div>
        <span class="px-2 py-1 rounded text-xs font-medium ${statusCls(report.status)}">${report.status}</span>
      </div>
    </div>`;
        // tiny mock table
        const table = `
    <div class="rounded-xl border border-slate-200 overflow-hidden">
      <div class="bg-slate-50 px-4 py-2 text-sm font-medium">Sample Data (first 5 rows)</div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-white border-b">
            <tr>
              <th class="px-4 py-2 text-left">#</th>
              <th class="px-4 py-2 text-left">Department</th>
              <th class="px-4 py-2 text-left">Value</th>
            </tr>
          </thead>
          <tbody>
            ${["Engineering", "Sales", "Marketing", "HR", "Finance"].map((d, i) => `
              <tr class="border-b">
                <td class="px-4 py-2">${i + 1}</td>
                <td class="px-4 py-2">${d}</td>
                <td class="px-4 py-2">${(Math.random() * 100).toFixed(1)}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>`;
        return head + table;
    }

    /* ------------------------ Actions ------------------------ */
    function downloadReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        showInfo(`Downloading ${r.name}…`);
        // Create a simple text blob as mock file
        const blob = new Blob([`Report: ${r.name}\nType: ${r.type}\nGenerated: ${r.generated_date}\nBy: ${r.generated_by}`], { type: "text/plain" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${r.name.replace(/\s+/g, '_')}.txt`; a.click(); URL.revokeObjectURL(a.href);
        r.download_count = (r.download_count || 0) + 1; save(); updateSummaryStats(); // optional re-render
    }
    function shareReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        const url = location.origin + location.pathname + `?report=${r.id}`;
        if (navigator.share) { navigator.share({ title: r.name, text: r.name, url }); }
        else { navigator.clipboard.writeText(url).then(() => showSuccess("Report link copied to clipboard!")); }
    }
    function deleteReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        if (!confirm(`Delete "${r.name}"? This cannot be undone.`)) return;
        reports = reports.filter(x => x.id !== id);
        filteredReports = filteredReports.filter(x => x.id !== id);
        save(); showSuccess("Report deleted"); applyFilters();
    }
    function retryReport(id) {
        const r = reports.find(x => x.id === id); if (!r) return;
        r.status = "processing"; save(); renderReports();
        setTimeout(() => {
            // 85% success chance
            if (Math.random() < 0.85) {
                r.status = "completed"; r.generated_date = new Date().toISOString();
                r.file_size_val = +(Math.random() * 3 + 0.5).toFixed(2);
                r.file_size = `${r.file_size_val} MB`;
                showSuccess("Report completed");
            } else {
                r.status = "failed"; showError("Report failed to generate");
            }
            save(); applyFilters();
        }, 1200);
    }

    /* ------------------------ Bulk ------------------------ */
    function updateBulkBar() {
        const n = selectedIds.size;
        $("#bulkCount").textContent = n;
        if (n > 0) $("#bulkBar").classList.remove("hidden"); else $("#bulkBar").classList.add("hidden");
        $("#masterChk").checked = n > 0 && n === filteredReportsOnPage().length;
    }
    function filteredReportsOnPage() {
        const itemsPerPage = parseInt($("#pageSize").value, 10) || 10;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        return filteredReports.slice(startIndex, endIndex);
    }

    /* ------------------------ Form / Generate ------------------------ */
    function openGenerateReportModal() { $("#generateReportModal").classList.remove("hidden"); }
    function handleGenerateReport(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        const btn = e.target.querySelector('button[type="submit"]');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Generating…'; btn.disabled = true;

        setTimeout(() => {
            const id = reportIdCounter++;
            const name = data.report_name || `${formatReportName(data.template_id || "Custom")} - ${new Date().toLocaleDateString()}`;
            const size = +(Math.random() * 3 + 0.5).toFixed(1);
            const newRpt = {
                id, name,
                type: data.report_type || getReportTypeFromTemplate(data.template_id),
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${size} MB`,
                file_size_val: size,
                format: data.format || "pdf",
                status: "completed",
                download_count: 0
            };
            reports.unshift(newRpt); save();
            if (fd.get("schedule_report")) {
                schedules.push({ id: "sc_" + id, name, type: newRpt.type, freq: (fd.get("frequency") || "monthly"), recipients: (fd.get("recipients") || "") });
                saveSched();
            }
            showSuccess("Report generated successfully!");
            $("#generateReportForm").reset();
            $("#customDateRange").classList.add("hidden");
            $("#scheduleOptions").classList.add("hidden");
            closeModal("generateReportModal");
            applyFilters();
            btn.innerHTML = original; btn.disabled = false;
        }, 900);
    }

    /* ------------------------ Quick Reports ------------------------ */
    function generateQuickReport(templateId) {
        showInfo(`Generating ${formatReportName(templateId)}…`);
        setTimeout(() => {
            const id = reportIdCounter++;
            const size = +(Math.random() * 3 + 0.5).toFixed(1);
            const rpt = {
                id,
                name: `${formatReportName(templateId)} - ${new Date().toLocaleDateString()}`,
                type: getReportTypeFromTemplate(templateId),
                generated_date: new Date().toISOString(),
                generated_by: "Current User",
                file_size: `${size} MB`,
                file_size_val: size,
                format: "pdf",
                status: "completed",
                download_count: 0
            };
            reports.unshift(rpt); save();
            showSuccess(`${formatReportName(templateId)} generated!`);
            applyFilters();
        }, 700);
    }
    function getReportTypeFromTemplate(t) {
        const map = {
            employee_roster: "hr", headcount_analysis: "hr", turnover_report: "hr", diversity_metrics: "hr", recruitment_pipeline: "hr",
            performance_summary: "performance", goal_achievement: "performance", review_completion: "performance", top_performers: "performance", training_completion: "performance",
            payroll_summary: "financial", cost_analysis: "financial", expense_reports: "financial", budget_variance: "financial", contractor_payments: "financial",
            attendance_summary: "attendance", leave_analysis: "attendance", overtime_report: "attendance", tardiness_report: "attendance",
            eeo_report: "compliance", safety_incidents: "compliance", policy_compliance: "compliance", audit_trail: "compliance"
        };
        return map[t] || "hr";
    }
    function formatReportName(rt) { return (rt || "report").split("_").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" "); }

    /* ------------------------ CSV Export ------------------------ */
    function exportTableCsv() {
        if (!filteredReports.length) { showInfo("Nothing to export"); return; }
        const headers = ["id", "name", "type", "generated_date", "generated_by", "file_size", "format", "status", "download_count"];
        const rows = filteredReports.map(r => headers.map(h => (r[h] ?? "")).join(","));
        const csv = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "reports.csv"; a.click(); URL.revokeObjectURL(a.href);
    }

    /* ------------------------ Toasts ------------------------ */
    function showToast(kind, msg) {
        const el = document.getElementById(`${kind}Toast`);
        const msgEl = document.getElementById(`${kind}Message`);
        msgEl.textContent = msg;
        el.classList.remove("translate-x-full");
        setTimeout(() => el.classList.add("translate-x-full"), 2400);
    }
    const showSuccess = m => showToast("success", m);
    const showError = m => showToast("error", m);
    const showInfo = m => showToast("info", m);

    /* ------------------------ Events ------------------------ */
    function setupEventListeners() {
        // modal open/close
        $("#newReportBtn").addEventListener("click", openGenerateReportModal);
        $("#closeGenerateModal").addEventListener("click", () => closeModal("generateReportModal"));
        $("#cancelGenerate").addEventListener("click", () => closeModal("generateReportModal"));
        $("#closePreviewModal").addEventListener("click", () => closeModal("reportPreviewModal"));
        // generate form
        $("#generateReportForm").addEventListener("submit", handleGenerateReport);
        // template / date range / schedule toggles
        $('select[name="report_type"]').addEventListener('change', updateTemplateOptions);
        $('select[name="date_range"]').addEventListener('change', () => {
            const v = $('select[name="date_range"]').value;
            if (v === "custom") $("#customDateRange").classList.remove("hidden"); else $("#customDateRange").classList.add("hidden");
        });
        $("#scheduleReport").addEventListener("change", (e) => {
            if (e.target.checked) $("#scheduleOptions").classList.remove("hidden"); else $("#scheduleOptions").classList.add("hidden");
        });

        // filters
        $("#reportTypeFilter").addEventListener("change", applyFilters);
        $("#periodFilter").addEventListener("change", applyFilters);
        $("#statusFilter").addEventListener("change", applyFilters);
        $("#pageSize").addEventListener("change", () => { currentPage = 1; renderReports(); });
        $("#refreshReports").addEventListener("click", debounce(() => { load(); applyFilters(); showSuccess("Refreshed"); }, 300));
        $("#searchInput").addEventListener("input", debounce(applyFilters, 200));

        // sorting headers
        $$("#reportsTable thead th[data-sort]").forEach(th => {
            th.addEventListener("click", () => setSort(th.dataset.sort));
        });

        // master checkbox
        $("#masterChk").addEventListener("change", (e) => {
            const onPage = filteredReportsOnPage();
            if (e.target.checked) onPage.forEach(r => selectedIds.add(r.id)); else selectedIds.clear();
            renderReportsTable(); updateBulkBar();
        });

        // bulk bar
        $("#bulkDownloadBtn").addEventListener("click", () => {
            if (!selectedIds.size) return;
            showInfo(`Downloading ${selectedIds.size} report(s)…`);
            setTimeout(() => showSuccess("Download started"), 500);
        });
        $("#bulkDeleteBtn").addEventListener("click", () => {
            if (!selectedIds.size) return;
            if (!confirm(`Delete ${selectedIds.size} selected report(s)?`)) return;
            reports = reports.filter(r => !selectedIds.has(r.id));
            save(); applyFilters(); selectedIds.clear(); updateBulkBar();
            showSuccess("Deleted selected reports");
        });
        $("#bulkClearBtn").addEventListener("click", () => { selectedIds.clear(); updateBulkBar(); renderReportsTable(); });

        // export CSV
        $("#exportCsvBtn").addEventListener("click", exportTableCsv);

        // click outside to close modals
        window.addEventListener("click", (e) => {
            ["generateReportModal", "reportPreviewModal"].forEach(id => {
                const m = document.getElementById(id); if (e.target === m) closeModal(id);
            });
        });

        // Download in preview
        $("#downloadReportBtn").addEventListener("click", () => {
            showInfo("Use the green download icon in the table, or export CSV for the grid data.");
        });
    }

    /* ------------------------ Templates dynamic list ------------------------ */
    function updateTemplateOptions() {
        const reportType = $('select[name="report_type"]').value;
        const sel = $('select[name="template_id"]');
        const byType = {
            hr: [["employee_roster", "Employee Roster"], ["headcount_analysis", "Headcount Analysis"], ["turnover_report", "Turnover Report"], ["diversity_metrics", "Diversity Metrics"], ["recruitment_pipeline", "Recruitment Pipeline"]],
            performance: [["performance_summary", "Performance Summary"], ["goal_achievement", "Goal Achievement"], ["review_completion", "Review Completion"], ["top_performers", "Top Performers"], ["training_completion", "Training Completion"]],
            financial: [["payroll_summary", "Payroll Summary"], ["cost_analysis", "Cost Analysis"], ["expense_reports", "Expense Reports"], ["budget_variance", "Budget Variance"], ["contractor_payments", "Contractor Payments"]],
            attendance: [["attendance_summary", "Attendance Summary"], ["leave_analysis", "Leave Analysis"], ["overtime_report", "Overtime Report"], ["tardiness_report", "Tardiness Report"]],
            compliance: [["eeo_report", "EEO Report"], ["safety_incidents", "Safety Incidents"], ["policy_compliance", "Policy Compliance"], ["audit_trail", "Audit Trail"]]
        };
        sel.innerHTML = '<option value="">Select Template</option>';
        (byType[reportType] || []).forEach(([v, t]) => {
            const o = document.createElement("option"); o.value = v; o.textContent = t; sel.appendChild(o);
        });
    }
</script>
{% endblock %}