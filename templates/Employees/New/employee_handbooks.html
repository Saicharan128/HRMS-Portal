{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-5xl">
    <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-semibold text-slate-800">Employee handbooks</h1>
                <p class="mt-1 text-slate-600">Digitize and distribute employee policies and guidelines.</p>
            </div>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Back</a>
        </div>

        <!-- Search & Filter -->
        <div class="mt-6 flex flex-col sm:flex-row sm:items-end gap-3">
            <div class="sm:w-72">
                <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                <input id="searchInput" placeholder="Search title/category/version..."
                    class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
            </div>
            <div class="sm:w-56">
                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                <select id="categoryFilter" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                    <option value="">All</option>
                    <option>General</option>
                    <option>HR Policies</option>
                    <option>Code of Conduct</option>
                    <option>IT & Security</option>
                    <option>Leave & Attendance</option>
                    <option>Compensation & Benefits</option>
                </select>
            </div>
            <div class="flex-1"></div>

            <!-- Uploader (hidden if user lacks permission; shown via JS) -->
            <button id="toggleUpload"
                class="hidden px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Upload</button>
        </div>

        <!-- Upload form -->
        <form id="uploadForm" class="hidden mt-4 rounded-xl border border-slate-200 p-4" enctype="multipart/form-data">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                    <input name="title" required class="w-full rounded-xl border border-slate-300 px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                    <select name="category" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                        <option>General</option>
                        <option>HR Policies</option>
                        <option>Code of Conduct</option>
                        <option>IT & Security</option>
                        <option>Leave & Attendance</option>
                        <option>Compensation & Benefits</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Version</label>
                    <input name="version" placeholder="v1.0"
                        class="w-full rounded-xl border border-slate-300 px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">PDF *</label>
                    <input type="file" name="file" accept=".pdf" required class="w-full rounded-xl border px-3 py-2">
                </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
                <p id="uploadMsg" class="text-sm"></p>
                <div class="space-x-2">
                    <button type="button" id="cancelUpload"
                        class="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 text-sm">Upload</button>
                </div>
            </div>
        </form>

        <!-- Table -->
        <div class="mt-6 overflow-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-slate-600 border-b">
                    <tr>
                        <th class="py-2 pr-3">Title</th>
                        <th class="py-2 pr-3">Category</th>
                        <th class="py-2 pr-3">Version</th>
                        <th class="py-2 pr-3">Uploaded</th>
                        <th class="py-2 pr-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="tbody" class="align-top"></tbody>
            </table>
            <div id="listMsg" class="mt-3 text-sm"></div>
        </div>
    </div>
</div>

<script>
    async function getJSON(u) { const r = await fetch(u); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    const tbody = document.getElementById("tbody");
    const listMsg = document.getElementById("listMsg");
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const toggleUpload = document.getElementById("toggleUpload");
    const uploadForm = document.getElementById("uploadForm");
    const uploadMsg = document.getElementById("uploadMsg");
    const cancelUpload = document.getElementById("cancelUpload");

    // We can't read server session from here; expose upload UI optimistically and hide delete if 403 is returned.
    // Simple heuristic: try HEAD/POST permission check by making a tiny request when toggling upload.
    toggleUpload.addEventListener("click", () => uploadForm.classList.toggle("hidden"));
    cancelUpload.addEventListener("click", () => uploadForm.classList.add("hidden"));

    async function loadList() {
        try {
            listMsg.textContent = "Loading...";
            const rows = await getJSON("/api/handbooks");
            render(rows);
            listMsg.textContent = rows.length ? "" : "No handbooks yet.";
        } catch (e) {
            listMsg.className = "mt-3 text-sm text-rose-700";
            listMsg.textContent = "Failed to load.";
            console.error(e);
        }
    }

    function render(rows) {
        const q = (searchInput.value || "").toLowerCase().trim();
        const cat = categoryFilter.value;
        const filtered = rows.filter(r => {
            const hay = [r.title, r.category, r.version].map(x => (x || "").toLowerCase()).join(" ");
            const okQ = !q || hay.includes(q);
            const okC = !cat || r.category === cat;
            return okQ && okC;
        });
        tbody.innerHTML = "";
        filtered.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td class="py-2 pr-3 font-medium text-slate-800">${r.title}</td>
      <td class="py-2 pr-3">${r.category || "-"}</td>
      <td class="py-2 pr-3">${r.version || "-"}</td>
      <td class="py-2 pr-3">${new Date(r.uploaded_at).toLocaleString()}</td>
      <td class="py-2 pr-3 space-x-2">
        <a class="px-2 py-1 rounded-md bg-slate-800 text-white text-xs hover:bg-slate-900" href="${r.url}" target="_blank">Open</a>
        <button class="delBtn px-2 py-1 rounded-md border border-rose-300 text-rose-700 text-xs hover:bg-rose-50" data-id="${r.id}">Delete</button>
      </td>
    `;
            tbody.appendChild(tr);
        });

        // Bind delete with graceful 403 handling
        document.querySelectorAll(".delBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                if (!confirm("Delete this handbook?")) return;
                try {
                    const r = await fetch(`/api/handbooks/${id}`, { method: "DELETE" });
                    if (r.status === 403) {
                        alert("You are not authorized to delete handbooks.");
                        return;
                    }
                    if (!r.ok) throw new Error(await r.text());
                    loadList();
                } catch (e) {
                    alert("Failed to delete.");
                    console.error(e);
                }
            });
        });
    }

    // Try to discover upload permission by attempting a 0-byte form submit (will fail at server validation but return 403 if no permission)
    (async function detectPermission() {
        try {
            const fd = new FormData();
            const r = await fetch("/api/handbooks", { method: "POST", body: fd });
            if (r.status === 403) {
                toggleUpload.classList.add("hidden");
            } else {
                toggleUpload.classList.remove("hidden");
            }
        } catch (e) {
            // If network error, hide
            toggleUpload.classList.add("hidden");
        }
    })();

    uploadForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        uploadMsg.textContent = ""; uploadMsg.className = "text-sm";
        const fd = new FormData(uploadForm);
        try {
            const r = await fetch("/api/handbooks", { method: "POST", body: fd });
            if (r.status === 403) {
                uploadMsg.className = "text-sm text-rose-700";
                uploadMsg.textContent = "You are not authorized to upload.";
                return;
            }
            if (!r.ok) throw new Error(await r.text());
            uploadMsg.className = "text-sm text-emerald-700";
            uploadMsg.textContent = "Uploaded.";
            uploadForm.reset();
            uploadForm.classList.add("hidden");
            loadList();
        } catch (e) {
            uploadMsg.className = "text-sm text-rose-700";
            uploadMsg.textContent = "Upload failed.";
            console.error(e);
        }
    });

    searchInput.addEventListener("input", () => { clearTimeout(window.__hb); window.__hb = setTimeout(loadList, 200); });
    categoryFilter.addEventListener("change", loadList);

    loadList();
</script>
{% endblock %}