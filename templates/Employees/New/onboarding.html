{% extends "layout.html" %}
{% block content %}
<div class="mx-auto max-w-4xl">
    <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-semibold text-slate-800">Onboarding</h1>
                <p class="mt-1 text-slate-600">Automate new hire setup with seamless onboarding workflows.</p>
            </div>
            <a href="{{ url_for('dashboard') }}"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-sm">Back</a>
        </div>

        <!-- Progress -->
        <div class="mt-6">
            <div class="flex items-center justify-between text-sm text-slate-600 mb-1">
                <span>Progress</span>
                <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-2">
                <div id="progressBar" class="h-2 bg-slate-800 rounded-full" style="width:0%"></div>
            </div>
            <p id="compMsg" class="mt-2 text-sm text-slate-700"></p>
        </div>

        <!-- Personal Info -->
        <div class="mt-8 rounded-xl border border-slate-200 p-5">
            <h2 class="text-lg font-semibold text-slate-800 mb-3">Personal Information</h2>
            <form id="personalForm" class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                    <input name="full_name" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
                    <input name="dob" type="date" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Address</label>
                    <input name="address" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
                    <input name="phone" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Emergency Contact</label>
                    <input name="emergency_contact" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" type="submit">Save
                        Personal Info</button>
                </div>
            </form>
            <div id="personalMsg" class="mt-2 text-sm"></div>
        </div>

        <!-- Bank Info -->
        <div class="mt-6 rounded-xl border border-slate-200 p-5">
            <h2 class="text-lg font-semibold text-slate-800 mb-3">Bank Information</h2>
            <form id="bankForm" class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Account Holder Name</label>
                    <input name="account_name" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Account Number</label>
                    <input name="account_number" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">IFSC</label>
                    <input name="ifsc" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Bank Name</label>
                    <input name="bank_name" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" type="submit">Save
                        Bank Info</button>
                </div>
            </form>
            <div id="bankMsg" class="mt-2 text-sm"></div>
        </div>

        <!-- Documents -->
        <div class="mt-6 rounded-xl border border-slate-200 p-5">
            <h2 class="text-lg font-semibold text-slate-800 mb-3">Documents</h2>
            <form id="docsForm" class="grid md:grid-cols-2 gap-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">PAN (pdf/jpg/png)</label>
                    <input type="file" name="pan" accept=".pdf,.jpg,.jpeg,.png"
                        class="w-full rounded-xl border px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Aadhaar (pdf/jpg/png)</label>
                    <input type="file" name="aadhaar" accept=".pdf,.jpg,.jpeg,.png"
                        class="w-full rounded-xl border px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Photo (jpg/png)</label>
                    <input type="file" name="photo" accept=".jpg,.jpeg,.png"
                        class="w-full rounded-xl border px-3 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Cancelled Cheque (optional)</label>
                    <input type="file" name="cancelled_cheque" accept=".pdf,.jpg,.jpeg,.png"
                        class="w-full rounded-xl border px-3 py-2" />
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" type="submit">Upload
                        Documents</button>
                </div>
            </form>
            <div id="docsMsg" class="mt-2 text-sm"></div>
            <div id="docsLinks" class="mt-2 text-sm text-slate-700 space-y-1"></div>
        </div>

        <!-- Tasks / Acks -->
        <div class="mt-6 rounded-xl border border-slate-200 p-5">
            <h2 class="text-lg font-semibold text-slate-800 mb-3">Tasks & Acknowledgements</h2>
            <form id="tasksForm" class="space-y-2">
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="policy_ack" class="rounded border-slate-300" />
                    I have read & acknowledge the Employee Policies / Handbook.
                </label>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="code_of_conduct" class="rounded border-slate-300" />
                    I agree to the Code of Conduct.
                </label>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="it_form" class="rounded border-slate-300" />
                    I have submitted the IT Declaration Form.
                </label>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="pf_form" class="rounded border-slate-300" />
                    I have submitted PF/ESI Forms.
                </label>
                <div class="pt-2 flex justify-end">
                    <button class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900" type="submit">Save
                        Tasks</button>
                </div>
            </form>
            <div id="tasksMsg" class="mt-2 text-sm"></div>
        </div>

        <!-- Final -->
        <div class="mt-6 rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900 hidden" id="doneBox">
            <p class="font-semibold">You're all set! âœ…</p>
            <p class="text-sm">HR has everything they need to complete your onboarding.</p>
        </div>
    </div>
</div>

<script>
    async function getJSON(u) { const r = await fetch(u); if (!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(u, d) { const r = await fetch(u, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(d || {}) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }

    function setMsg(el, ok, msg) {
        el.className = "mt-2 text-sm " + (ok ? "text-emerald-700" : "text-rose-700");
        el.textContent = msg;
        setTimeout(() => { el.textContent = ""; }, 1500);
    }

    function pct(n) { return Math.max(0, Math.min(100, Math.round(n))); }

    function computeProgress(data) {
        let steps = 0, done = 0;

        // personal fields (5)
        const p = data.personal || {};
        steps += 5; done += ["full_name", "dob", "address", "phone", "emergency_contact"].filter(k => (p[k] || "").trim()).length;

        // bank fields (4) - optional to count but we will include
        const b = data.bank || {};
        steps += 4; done += ["account_name", "account_number", "ifsc", "bank_name"].filter(k => (b[k] || "").trim()).length;

        // docs (3 mandatory + 1 optional)
        const d = data.documents || {};
        steps += 4; done += ["pan", "aadhaar", "photo", "cancelled_cheque"].filter(k => d[k]).length;

        // tasks (4)
        const t = data.tasks || {};
        steps += 4; done += ["policy_ack", "code_of_conduct", "it_form", "pf_form"].filter(k => !!t[k]).length;

        return pct((done / steps) * 100);
    }

    function fillForm(form, values) {
        if (!values) return;
        [...form.elements].forEach(el => {
            if (el.name && values[el.name] !== undefined) {
                if (el.type === "checkbox") el.checked = !!values[el.name];
                else el.value = values[el.name] || "";
            }
        });
    }

    async function loadAll() {
        const data = await getJSON("/api/self_onboarding");

        // fill forms
        fillForm(document.getElementById("personalForm"), data.personal);
        fillForm(document.getElementById("bankForm"), data.bank);
        const t = data.tasks || {};
        const tf = document.getElementById("tasksForm");
        tf.policy_ack.checked = !!t.policy_ack;
        tf.code_of_conduct.checked = !!t.code_of_conduct;
        tf.it_form.checked = !!t.it_form;
        tf.pf_form.checked = !!t.pf_form;

        // docs links
        const dl = document.getElementById("docsLinks");
        dl.innerHTML = "";
        const docs = data.documents || {};
        Object.entries(docs).forEach(([k, v]) => {
            if (v) {
                const a = document.createElement("a");
                a.href = v; a.target = "_blank"; a.className = "underline text-indigo-700 block";
                a.textContent = k + ": open";
                dl.appendChild(a);
            }
        });

        // progress UI
        const progress = computeProgress(data);
        document.getElementById("progressBar").style.width = progress + "%";
        document.getElementById("progressText").textContent = progress + "%";
        const doneBox = document.getElementById("doneBox");
        const compMsg = document.getElementById("compMsg");
        if (data.completed) {
            doneBox.classList.remove("hidden");
            compMsg.textContent = "All required items complete.";
        } else {
            doneBox.classList.add("hidden");
            compMsg.textContent = "Complete the items below to finish onboarding.";
        }
    }

    document.getElementById("personalForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = { personal: Object.fromEntries(fd.entries()) };
        try {
            await postJSON("/api/self_onboarding", payload);
            setMsg(document.getElementById("personalMsg"), true, "Saved.");
            loadAll();
        } catch (err) { setMsg(document.getElementById("personalMsg"), false, "Save failed."); console.error(err); }
    });

    document.getElementById("bankForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = { bank: Object.fromEntries(fd.entries()) };
        try {
            await postJSON("/api/self_onboarding", payload);
            setMsg(document.getElementById("bankMsg"), true, "Saved.");
            loadAll();
        } catch (err) { setMsg(document.getElementById("bankMsg"), false, "Save failed."); console.error(err); }
    });

    document.getElementById("tasksForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = { tasks: {} };
        ["policy_ack", "code_of_conduct", "it_form", "pf_form"].forEach(k => payload.tasks[k] = fd.get(k) === "on");
        try {
            await postJSON("/api/self_onboarding", payload);
            setMsg(document.getElementById("tasksMsg"), true, "Saved.");
            loadAll();
        } catch (err) { setMsg(document.getElementById("tasksMsg"), false, "Save failed."); console.error(err); }
    });

    document.getElementById("docsForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        try {
            const r = await fetch("/api/self_onboarding/upload", { method: "POST", body: fd });
            if (!r.ok) throw new Error(await r.text());
            await r.json();
            document.getElementById("docsMsg").className = "mt-2 text-sm text-emerald-700";
            document.getElementById("docsMsg").textContent = "Uploaded.";
            setTimeout(() => { document.getElementById("docsMsg").textContent = ""; }, 1500);
            e.target.reset();
            loadAll();
        } catch (err) {
            document.getElementById("docsMsg").className = "mt-2 text-sm text-rose-700";
            document.getElementById("docsMsg").textContent = "Upload failed.";
            console.error(err);
        }
    });

    loadAll();
</script>
{% endblock %}